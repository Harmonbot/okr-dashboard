# 微铸项目管理

OKR + 项目流程 + 团队任务一体化管理系统，数据源基于飞书多维表格，实时同步。

**在线地址**: https://okr-dashboard-eight.vercel.app  
**GitHub**: https://github.com/Harmonbot/okr-dashboard  
**飞书 Base**: https://ox5c0vhqom6.feishu.cn/base/N5OqbwkO1a2PbpsaM05ckGrMnxg

---

## 技术架构

| 层 | 技术 |
|---|------|
| 前端 | React 18 + Tailwind CSS（CDN 引入，单文件 SPA） |
| 后端 | Vercel Serverless Functions (Node.js ESM) |
| 数据源 | 飞书多维表格 (Bitable API) |
| 认证 | 飞书 OAuth 2.0 扫码登录 |
| 部署 | Vercel（GitHub 推送自动部署） |

## 项目结构

```
okr-dashboard/
├── index.html              # 主前端文件（~4150行，React 单文件应用）
├── package.json            # 项目配置（需要 "type": "module"）
├── vercel.json             # Vercel 路由和部署配置
├── api/
│   ├── lark.js             # 获取飞书数据（7张表批量读取）
│   ├── auth-callback.js    # OAuth 回调处理
│   ├── create-task.js      # 创建任务
│   ├── update-task.js      # 更新任务（接受/完成）
│   ├── upload-file.js      # 上传文件到飞书
│   ├── download-file.js    # 下载飞书文件
│   ├── create-objective.js # 创建目标
│   ├── update-objective.js # 更新目标
│   ├── create-kr.js        # 创建关键结果
│   ├── update-kr.js        # 更新关键结果
│   └── create-record.js    # 通用记录创建（项目创建等）
└── README.md
```

## 飞书配置

### 应用信息

| 配置项 | 值 |
|--------|---|
| App ID | `cli_a9f32c79e4f9dbd2` |
| App Token | `N5OqbwkO1a2PbpsaM05ckGrMnxg` |
| 重定向 URL | `https://okr-dashboard-eight.vercel.app/` |

### 数据表

| 表名 | Table ID | 说明 |
|------|----------|------|
| 目标 Objectives | `tbl9TX3RZdLRlEy0` | OKR 目标，含目标周期、层级、负责人 |
| 关键结果 Key Results | `tblW7yKqbgxH0bZV` | KR，关联目标，含目标值/当前值/权重 |
| 项目 Projects | `tblYM02NyVj3rUkR` | 项目卡片，关联 KR（SingleLink），含类型/阶段/状态 |
| 任务 Tasks | `tblFwmxmjRJPzVmV` | 任务，关联项目和节点，含截止日期/完成日期 |
| 流程节点 Process Nodes | `tblvIOdvaYvYJ64y` | DAG 流程节点，关联模板，含前置节点/预计工时 |
| 流程模板 Process Templates | `tblfqKHrRaczsk9A` | 流程模板，按项目类型分（新品开发/系统建设等） |
| 团队成员 Team Members | `tbl1sP46C4DSjSYj` | 成员信息，含部门/组别/职位/飞书用户关联 |

### 关键字段映射

**项目表 (Projects)**:
- `项目名称` / `项目类型`（新品开发/营销推广/供应链优化/系统建设）
- `关联KR`（SingleLink，**写入格式**：`[recordId]` 字符串数组，**读取格式**：`{link_record_ids: [...]}` 对象）
- `项目负责人` / `当前阶段` / `项目状态` / `计划上线日期`

**任务表 (Tasks)**:
- `任务名称` / `所属项目`（SingleLink）/ `所属节点`（SingleLink）
- `负责人` / `协作人` / `状态`（待开始/进行中/已完成/已取消）
- `优先级`（P0-紧急/P1-高优/P2-中等/P3-低优）
- `开始日期` / `截止日期` / `完成日期` / `输出文件`

**流程节点表 (Process Nodes)**:
- `节点名称` / `所属模板`（SingleLink）/ `节点顺序` / `节点类型`
- `前置节点`（文本，用于 DAG 拓扑排序）/ `预计工时(天)` / `默认负责角色`

### 所需飞书权限

- `contact:user.base:readonly` — 获取用户基本信息
- `bitable:app` — 多维表格读写

## 功能模块

### 一、OKR 视图

三级层级展示：**目标 → 关键结果 → 项目**

- 目标卡片：显示周期（Q1/Q2/年度）、层级（公司/部门/个人）、负责人、进度、状态
- KR 卡片：显示目标值/当前值、权重、负责人、关联项目
- 从 KR 直接创建关联项目（`+ 添加项目` 按钮）
- **自动进度计算**：KR 进度 = 关联项目完成数 / 目标值
- **自动状态计算**：目标状态基于 KR 完成情况自动推算
- 创建目标/KR 表单，含负责人选择

### 二、项目管理

两种视图模式：**分组视图** | **管道视图**

#### 分组视图（OKR 分组）
按 OKR 层级分组展示项目卡片：
```
目标 A（紫蓝渐变头部）
├─ KR 1（负责人、项目数）
│  └─ [项目卡片] [项目卡片] [项目卡片]
├─ KR 2
│  └─ [项目卡片]
未关联项目
└─ [项目卡片]
```

紧凑项目卡片（CompactProjectCard）：左边框颜色标识状态（绿=完成/红=逾期/蓝=进行中/灰=未开始），显示类型标签、状态标签、进度条、任务数、负责人、剩余天数。

#### 管道视图
横向列布局，按当前阶段分组（自动计算：最后一个有进行中任务的节点）。

#### 筛选
- 状态筛选：全部 / 进行中 / 已完成 / 逾期
- 逾期判定：计划上线日期 < 当前日期 且 状态 ≠ 已完成

#### 项目详情弹窗
- 项目概览统计（整体进度/已完成/进行中/待开始）
- **DAG 流程进度图**（支持分支和并行节点拓扑分层）
- **按项目类型匹配流程模板**：根据项目类型自动筛选对应模板节点，无模板时显示友好提示
- 节点状态自动着色：🟢已完成 / 🔴进行中(带光圈) / ⚪待开始 / 🟡已跳过(虚线)
- 节点跳过功能（仅项目负责人可操作，localStorage 持久化）
- 甘特图（时间轴展示任务）
- 点击节点 → 任务详情弹窗（创建/接受/完成任务）

### 三、人员任务（团队管理仪表盘）

管理者导向的紧凑表格视图，聚焦问题发现和决策。

#### 筛选和控制
- 部门/组别下拉选择器（精简，一行搞定）
- 「显示无任务成员」开关（默认关闭，只显示有任务的人）

#### 汇总统计（6格）
| 活跃成员 | 总任务 | 进行中 | 待开始 | 已完成 | 逾期任务 |
|---------|--------|--------|--------|--------|---------|
逾期任务 > 0 时红色高亮预警。

#### 成员列表
- 紧凑表格：头像+姓名+职位、部门/组别标签、**工作量条形图**（三色：绿=完成/蓝=进行中/灰=待开始）
- 数据列：📋总任务 / 🔵进行中 / ⏳待开始 / ✅已完成 / ⚠️逾期
- 有逾期任务的成员行背景微红
- 排序：逾期数降序 → 进行中数降序 → 总任务数降序

#### 展开任务详情（点击行展开）
按状态分组显示，优先级从高到低：
1. **⚠️ 逾期**（红底红框，显示逾期天数）
2. **🔵 进行中**
3. **⏳ 待开始**
4. **✅ 已完成**（默认折叠，点击展开）

#### 任务时效标签
每个任务显示智能时效标识：

| 状态 | 条件 | 显示 | 颜色 |
|------|------|------|------|
| 已完成 | 截止前完成 | `提前X天` | 🟢 绿 |
| 已完成 | 当天完成 | `按时完成` | 🟢 绿 |
| 已完成 | 超期完成 | `逾期X天完成` | 🟠 橙 |
| 进行中/待开始 | 已逾期 | `逾期X天` | 🔴 红 |
| 进行中/待开始 | ≤2天 | `今天截止` / `剩X天` | 🟡 黄 |
| 进行中/待开始 | 3-7天 | `剩X天` | 🔵 蓝 |
| 进行中/待开始 | >7天 | `剩X天` | ⚪ 灰 |
| 任意 | 无截止日期 | `未设期限` | ⚪ 灰 |

### 四、顶部 OKR 指标面板

5 个核心指标卡片：

| 指标 | 图标 | 计算方式 |
|------|------|---------|
| 目标达成 | 🎯 | 已完成目标数 / 总目标数 |
| KR 完成 | 🔑 | 已完成KR数 / 总KR数 |
| 项目进度 | 📊 | 所有项目平均进度 % |
| 任务完成 | ✅ | 已完成任务数 / 总任务数 |
| 逾期预警 | ⚠️/🛡️ | 逾期项目数（>0红色，=0绿色） |

### 五、认证与权限

- 飞书 OAuth 2.0 扫码登录
- 用户信息存储 localStorage
- Token 过期自动清除
- 任务操作权限：仅任务负责人可「接受任务」和「完成任务」
- 节点跳过权限：仅项目负责人可操作
- 非负责人看到提示（显示负责人姓名和头像）

### 六、任务生命周期

```
待开始 ──→ 接受任务 ──→ 进行中 ──→ 完成任务 ──→ 已完成
  │          │                        │
  │     自动设置：                需要上传：
  │     · 开始日期=今天           · 输出文件
  │     · 截止日期=今天+工时天数   · 自动设置完成日期
  └──────────────────────────────────────────────┘
```

### 七、自动计算逻辑

**项目进度**：
```
项目进度 = Σ(节点完成度) / 节点总数
节点完成度 = 该节点已完成任务数 / 该节点总任务数 × 100%
```

**项目状态自动推算**：
- 无任务或全部待开始 → `未开始`
- 有进行中或部分完成 → `进行中`
- 全部完成 → `已完成`

**当前阶段自动推算**：
最后一个含有进行中任务的节点，无则取第一个未完成节点。

**KR 状态自动更新**：基于关联项目完成进度。

## 数据流

```
飞书多维表格（7张表）
     ↓ GET /api/lark
transformData() 数据转换
     ↓
React State (data)
     ↓
视图组件渲染（OKR / 项目管理 / 人员任务）
     ↓ 用户操作
POST /api/create-task | update-task | create-record ...
     ↓
飞书多维表格更新
     ↓
fetchData() 自动刷新 + Toast 提示
```

## 部署

### 环境变量（Vercel）

| 变量名 | 说明 |
|--------|------|
| `LARK_APP_ID` | `cli_a9f32c79e4f9dbd2` |
| `LARK_APP_SECRET` | 飞书开放平台获取 |

### 部署步骤

1. 替换 `index.html`（根目录）
2. 确保 `api/` 目录包含所有 serverless 函数
3. 推送到 GitHub → Vercel 自动部署
4. 验证环境变量已配置

### 验证部署

```bash
# 检查文件行数（当前版本约 4150 行）
wc -l index.html

# 检查关键组件存在
grep -c "TeamTaskOverview\|ProductDetailModal\|CompactProjectCard" index.html
```

## 前端组件清单

| 组件 | 说明 |
|------|------|
| `App` | 根组件，管理登录状态、数据加载、Tab 切换 |
| `StatCard` | 顶部统计卡片 |
| `ProductCard` | 项目卡片（含 MiniStageIndicator） |
| `MiniStageIndicator` | 项目卡片内的迷你节点状态指示器 |
| `CompactProjectCard` | 分组视图的紧凑项目卡片 |
| `ProductOverview` | 项目管理 Tab（分组视图 + 管道视图） |
| `ProductDetailModal` | 项目详情弹窗（流程图 + 甘特图 + 模板筛选） |
| `NodeTaskModal` | 节点任务弹窗（任务列表 + 创建/接受/完成） |
| `GanttChart` | 甘特图组件 |
| `MemberTaskCard` | 成员任务卡片（旧版，保留兼容） |
| `TeamTaskOverview` | 人员任务 Tab（表格 + 工作量可视化 + 时效标签） |

## 版本历程

| 版本 | 核心变更 |
|------|---------|
| v1-v14 | 基础架构、飞书集成、三视图搭建 |
| v15-v18 | 任务管理流程（创建/接受/完成/文件上传） |
| v19 | 飞书 OAuth 扫码登录 |
| v20 | 飞书头像同步 |
| v21 | 权限控制（负责人限制） |
| v22 | Toast 提示 + 即时刷新 |
| v23 | 项目状态/节点颜色自动计算 |
| v24 | 当前阶段自动推算、项目负责人提取、节点跳过功能、KR 添加项目 |
| v25 | 项目进度公式计算、KR 状态自动更新、创建目标/KR/项目表单、create-record API |
| v26 | 系统更名「微铸项目管理」、OKR 指标面板（5卡片）、项目管理 Tab 重构（OKR分组视图）、负责人显示 |
| v27 | 人员任务升级（工作量条形图/逾期预警/状态分组/时效标签）、流程模板匹配（按项目类型筛选节点）、任务完成日期字段 |

## 注意事项

1. **飞书 SingleLink 字段写入格式**：写入时用 `["recordId"]`（字符串数组），读取时返回 `{link_record_ids: [...]}`（对象），两者格式不同。
2. **流程模板**：目前只有「新品开发」模板，其他项目类型（系统建设/营销推广/供应链优化）需在飞书多维表格中创建对应模板和节点。
3. **节点跳过状态**：存储在浏览器 localStorage，按项目 ID 隔离，不同设备/浏览器不共享。
4. **单文件架构**：整个前端在一个 index.html 中（~4150行），通过 CDN 加载 React/Tailwind/Babel，适合快速迭代但不适合大规模重构。

---

*最后更新: 2026-02-08*
