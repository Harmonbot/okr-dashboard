<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°å“OKRé¡¹ç›®ç®¡ç†ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    /* Toast åŠ¨ç”» */
    .toast-enter { animation: toastIn 0.3s ease-out; }
    .toast-exit { animation: toastOut 0.3s ease-in forwards; }
    @keyframes toastIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-20px); opacity: 0; } }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, createContext, useContext, useCallback } = React;

    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : '';

    const APP_TOKEN = 'N5OqbwkO1a2PbpsaM05ckGrMnxg';
    
    // é£ä¹¦åº”ç”¨é…ç½®
    const LARK_APP_ID = 'cli_a9f32c79e4f9dbd2';
    const LARK_REDIRECT_URI = window.location.origin + window.location.pathname;
    
    // ç”¨æˆ·ä¸Šä¸‹æ–‡
    const UserContext = createContext(null);
    
    // Toast ä¸Šä¸‹æ–‡
    const ToastContext = createContext(null);
    
    // Toast ç»„ä»¶
    const Toast = ({ message, type, onClose }) => {
      const [isExiting, setIsExiting] = useState(false);
      
      useEffect(() => {
        const timer = setTimeout(() => {
          setIsExiting(true);
          setTimeout(onClose, 300);
        }, 2500);
        return () => clearTimeout(timer);
      }, [onClose]);
      
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
      
      return (
        <div className={`${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${isExiting ? 'toast-exit' : 'toast-enter'}`}>
          <span className="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center text-sm">{icon}</span>
          <span>{message}</span>
        </div>
      );
    };
    
    // Toast å®¹å™¨
    const ToastContainer = ({ children }) => {
      const [toasts, setToasts] = useState([]);
      
      const showToast = useCallback((message, type = 'success') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
      }, []);
      
      const removeToast = useCallback((id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, []);
      
      return (
        <ToastContext.Provider value={showToast}>
          {children}
          <div className="fixed top-4 right-4 z-50 flex flex-col gap-2">
            {toasts.map(toast => (
              <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />
            ))}
          </div>
        </ToastContext.Provider>
      );
    };
    
    // ä½¿ç”¨ Toast çš„ Hook
    const useToast = () => useContext(ToastContext);
    
    // è·å–é£ä¹¦ç™»å½• URL
    const getLarkLoginUrl = () => {
      const state = Math.random().toString(36).substring(7);
      localStorage.setItem('lark_oauth_state', state);
      return `https://open.feishu.cn/open-apis/authen/v1/authorize?app_id=${LARK_APP_ID}&redirect_uri=${encodeURIComponent(LARK_REDIRECT_URI)}&state=${state}`;
    };
    
    // å¤„ç† OAuth å›è°ƒ
    const handleOAuthCallback = async (code) => {
      try {
        const res = await fetch(`${API_BASE}/api/auth-callback?code=${code}`);
        const data = await res.json();
        
        if (data.success) {
          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° localStorage
          localStorage.setItem('lark_user', JSON.stringify(data.data.user));
          localStorage.setItem('lark_access_token', data.data.access_token);
          localStorage.setItem('lark_token_expires', Date.now() + data.data.expires_in * 1000);
          
          // æ¸…é™¤ URL ä¸­çš„ code å‚æ•°
          window.history.replaceState({}, document.title, window.location.pathname);
          
          return data.data.user;
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        console.error('OAuth callback error:', error);
        alert('ç™»å½•å¤±è´¥: ' + error.message);
        return null;
      }
    };
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const checkLoginStatus = () => {
      const user = localStorage.getItem('lark_user');
      const expires = localStorage.getItem('lark_token_expires');
      
      if (user && expires && Date.now() < parseInt(expires)) {
        return JSON.parse(user);
      }
      
      // æ¸…é™¤è¿‡æœŸçš„ç™»å½•ä¿¡æ¯
      localStorage.removeItem('lark_user');
      localStorage.removeItem('lark_access_token');
      localStorage.removeItem('lark_token_expires');
      return null;
    };
    
    // é€€å‡ºç™»å½•
    const logout = () => {
      localStorage.removeItem('lark_user');
      localStorage.removeItem('lark_access_token');
      localStorage.removeItem('lark_token_expires');
      window.location.reload();
    };

    // æ•°æ®è½¬æ¢å‡½æ•°
    const transformData = (rawData) => {
      const data = {
        objectives: [],
        keyResults: [],
        products: [],
        tasks: [],
        members: [],
        processNodes: [],
        processNodeLayers: [], // DAGåˆ†å±‚
        nodeMap: {}, // èŠ‚ç‚¹åç§°åˆ°èŠ‚ç‚¹çš„æ˜ å°„
        nodeToLayer: {}, // èŠ‚ç‚¹åç§°åˆ°å±‚çº§çš„æ˜ å°„
        groups: []
      };

      // è½¬æ¢ç›®æ ‡è¡¨
      if (rawData['ç›®æ ‡ Objectives']) {
        data.objectives = rawData['ç›®æ ‡ Objectives'].records.map(r => {
          // å¤„ç†å¯Œæ–‡æœ¬å­—æ®µæ ¼å¼: [{ text: '...', type: 'text' }]
          let objName = '';
          const nameField = r.fields['ç›®æ ‡åç§°'];
          if (Array.isArray(nameField)) {
            objName = nameField.map(item => item.text || '').join('');
          } else if (typeof nameField === 'string') {
            objName = nameField;
          }
          
          return {
            id: r.record_id,
            name: objName,
            cycle: r.fields['ç›®æ ‡å‘¨æœŸ'] || '',
            level: r.fields['ç›®æ ‡å±‚çº§'] || '',
            progress: r.fields['è¿›åº¦'] || 0,
            status: r.fields['çŠ¶æ€'] || 'æœªå¼€å§‹'
          };
        }).filter(obj => obj.name); // è¿‡æ»¤æ‰ç©ºç›®æ ‡
      }

      // è½¬æ¢å…³é”®ç»“æœè¡¨
      if (rawData['å…³é”®ç»“æœ Key Results']) {
        data.keyResults = rawData['å…³é”®ç»“æœ Key Results'].records.map((r, idx) => {
          // å¤„ç†å…³è”å­—æ®µ - æ”¯æŒå¤šç§æ ¼å¼
          let objectiveId = null;
          const linkedObj = r.fields['æ‰€å±ç›®æ ‡'];
          
          if (linkedObj) {
            // æ ¼å¼1: { link_record_ids: ['recXXX'] } (MCP æ ¼å¼)
            if (linkedObj.link_record_ids?.[0]) {
              objectiveId = linkedObj.link_record_ids[0];
            }
            // æ ¼å¼2: [{ record_ids: ['recXXX'], ... }] (Vercel API æ ¼å¼)
            else if (Array.isArray(linkedObj) && linkedObj[0]?.record_ids?.[0]) {
              objectiveId = linkedObj[0].record_ids[0];
            }
            // æ ¼å¼3: ['recXXX'] æ•°ç»„
            else if (Array.isArray(linkedObj) && typeof linkedObj[0] === 'string') {
              objectiveId = linkedObj[0];
            }
            // æ ¼å¼4: ç›´æ¥å­—ç¬¦ä¸²
            else if (typeof linkedObj === 'string') {
              objectiveId = linkedObj;
            }
          }
          
          // å¤„ç†å¯Œæ–‡æœ¬å­—æ®µæ ¼å¼: [{ text: '...', type: 'text' }]
          let krName = '';
          const krDesc = r.fields['KRæè¿°'];
          if (Array.isArray(krDesc)) {
            krName = krDesc.map(item => item.text || '').join('');
          } else if (typeof krDesc === 'string') {
            krName = krDesc;
          }
          
          return {
            id: r.record_id,
            name: krName,
            target: r.fields['ç›®æ ‡å€¼'] || 0,
            current: r.fields['å½“å‰å€¼'] || 0,
            weight: r.fields['æƒé‡'] || 0,
            status: r.fields['çŠ¶æ€'] || 'æœªå¼€å§‹',
            objectiveId: objectiveId
          };
        });
      }

      // è½¬æ¢é¡¹ç›®è¡¨ä¸ºäº§å“
      if (rawData['é¡¹ç›® Projects']) {
        const projectEmojis = ['ğŸ“¦', 'ğŸ¯', 'ğŸš€', 'ğŸ’¡', 'ğŸ”§', 'ğŸ“±', 'ğŸ¨', 'ğŸ›’'];
        data.products = rawData['é¡¹ç›® Projects'].records.map((r, idx) => {
          // ä¿®å¤è¿›åº¦è®¡ç®—
          let progress = r.fields['æ•´ä½“è¿›åº¦'] || 0;
          if (progress > 0 && progress <= 1) {
            progress = Math.round(progress * 100);
          } else if (progress > 100) {
            progress = 100;
          }
          progress = Math.round(progress);
          
          // å¤„ç†å…³è”KRå­—æ®µ - æ”¯æŒå¤šç§æ ¼å¼
          let krId = null;
          const linkedKR = r.fields['å…³è”KR'];
          if (linkedKR) {
            if (linkedKR.link_record_ids?.[0]) {
              krId = linkedKR.link_record_ids[0];
            } else if (Array.isArray(linkedKR) && linkedKR[0]?.record_ids?.[0]) {
              krId = linkedKR[0].record_ids[0];
            } else if (Array.isArray(linkedKR) && typeof linkedKR[0] === 'string') {
              krId = linkedKR[0];
            }
          }
          
          // å¤„ç†é¡¹ç›®è´Ÿè´£äºº
          const ownerField = r.fields['é¡¹ç›®è´Ÿè´£äºº'];
          let ownerId = null;
          let ownerName = '';
          if (ownerField) {
            if (Array.isArray(ownerField) && ownerField[0]) {
              ownerId = ownerField[0].id || null;
              ownerName = ownerField[0].name || '';
            } else if (ownerField.id) {
              ownerId = ownerField.id;
              ownerName = ownerField.name || '';
            }
          }
          
          return {
            id: r.record_id,
            name: r.fields['é¡¹ç›®åç§°'] || '',
            category: r.fields['é¡¹ç›®ç±»å‹'] || '',
            image: projectEmojis[idx % projectEmojis.length],
            currentStage: r.fields['å½“å‰é˜¶æ®µ'] || 'äº§å“è°ƒç ”',
            progress: progress,
            status: r.fields['é¡¹ç›®çŠ¶æ€'] || 'è¿›è¡Œä¸­',
            startDate: r.fields['å¼€å§‹æ—¥æœŸ'] ? new Date(r.fields['å¼€å§‹æ—¥æœŸ']).toISOString().split('T')[0] : '',
            targetDate: r.fields['è®¡åˆ’ä¸Šçº¿æ—¥æœŸ'] ? new Date(r.fields['è®¡åˆ’ä¸Šçº¿æ—¥æœŸ']).toISOString().split('T')[0] : '',
            krId: krId,
            ownerId: ownerId,
            ownerName: ownerName
          };
        });
      }

      // è½¬æ¢ä»»åŠ¡è¡¨ - ä¼˜å…ˆä½¿ç”¨ã€Œæ‰€å±èŠ‚ç‚¹ã€å…³è”å­—æ®µ
      if (rawData['ä»»åŠ¡ Tasks']) {
        // å…ˆå»ºç«‹èŠ‚ç‚¹ record_id åˆ°èŠ‚ç‚¹åç§°çš„æ˜ å°„
        const nodeRecordMap = {};
        if (rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes']) {
          rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes'].records.forEach(r => {
            let nodeName = r.fields['èŠ‚ç‚¹åç§°'];
            if (Array.isArray(nodeName)) {
              nodeName = nodeName.map(n => n.text || n).join('');
            }
            nodeRecordMap[r.record_id] = nodeName;
          });
        }
        
        data.tasks = rawData['ä»»åŠ¡ Tasks'].records.map(r => {
          // ä¼˜å…ˆä½¿ç”¨ã€Œæ‰€å±èŠ‚ç‚¹ã€å…³è”å­—æ®µ
          let stage = '';
          const linkedNode = r.fields['æ‰€å±èŠ‚ç‚¹'];
          
          if (linkedNode) {
            // Vercel API æ ¼å¼: [{record_ids: [...], text: "èŠ‚ç‚¹åç§°", ...}]
            if (Array.isArray(linkedNode) && linkedNode.length > 0) {
              const firstItem = linkedNode[0];
              // ç›´æ¥ä½¿ç”¨ text å­—æ®µï¼ˆæœ€ç®€å•ï¼‰
              if (firstItem.text) {
                stage = firstItem.text;
              } else if (firstItem.record_ids && firstItem.record_ids.length > 0) {
                stage = nodeRecordMap[firstItem.record_ids[0]] || '';
              }
            }
            // é£ä¹¦ MCP æ ¼å¼: {link_record_ids: [...]}
            else if (linkedNode.link_record_ids && linkedNode.link_record_ids.length > 0) {
              stage = nodeRecordMap[linkedNode.link_record_ids[0]] || '';
            }
          }
          
          // å¦‚æœæ²¡æœ‰è®¾ç½®æ‰€å±èŠ‚ç‚¹ï¼Œå›é€€åˆ°æ—§çš„ã€Œæ‰€å±é˜¶æ®µã€å•é€‰å­—æ®µ
          if (!stage) {
            stage = r.fields['æ‰€å±é˜¶æ®µ'] || '';
          }
          
          // å¤„ç†ä»»åŠ¡åç§°ï¼ˆå¯èƒ½æ˜¯æ•°ç»„æ ¼å¼æˆ–å­—ç¬¦ä¸²ï¼‰
          let taskName = r.fields['ä»»åŠ¡åç§°'] || '';
          if (Array.isArray(taskName)) {
            taskName = taskName.map(n => n.text || n).join('');
          }
          
          // è§£ææ‰€å±é¡¹ç›®
          let productId = null;
          const projectField = r.fields['æ‰€å±é¡¹ç›®'];
          if (projectField) {
            // Vercel API æ ¼å¼: [{record_ids: [...], text: "é¡¹ç›®åç§°", ...}]
            if (Array.isArray(projectField) && projectField.length > 0) {
              const firstItem = projectField[0];
              if (firstItem.record_ids && firstItem.record_ids.length > 0) {
                productId = firstItem.record_ids[0];
              }
            }
            // é£ä¹¦ MCP æ ¼å¼: {link_record_ids: [...]}
            else if (projectField.link_record_ids && projectField.link_record_ids.length > 0) {
              productId = projectField.link_record_ids[0];
            }
          }
          
          return {
            id: r.record_id,
            name: taskName,
            stage: stage,
            priority: (r.fields['ä¼˜å…ˆçº§'] || 'P2').replace(/-.*$/, ''),
            status: r.fields['çŠ¶æ€'] || 'å¾…å¼€å§‹',
            productId: productId,
            assignee: r.fields['è´Ÿè´£äºº']?.[0]?.id || null,
            assigneeName: r.fields['è´Ÿè´£äºº']?.[0]?.name || '',
            startDate: r.fields['å¼€å§‹æ—¥æœŸ'] ? new Date(r.fields['å¼€å§‹æ—¥æœŸ']).toISOString().split('T')[0] : '',
            dueDate: r.fields['æˆªæ­¢æ—¥æœŸ'] ? new Date(r.fields['æˆªæ­¢æ—¥æœŸ']).toISOString().split('T')[0] : '',
            outputFile: r.fields['è¾“å‡ºæ–‡ä»¶']?.[0] || null // é™„ä»¶å­—æ®µæ˜¯æ•°ç»„ï¼Œå–ç¬¬ä¸€ä¸ª
          };
        });
      }

      // è½¬æ¢å›¢é˜Ÿæˆå‘˜è¡¨ - æ–°å¢ç»„åˆ«å­—æ®µ
      if (rawData['å›¢é˜Ÿæˆå‘˜ Team Members']) {
        const memberColors = ['bg-blue-500', 'bg-pink-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-teal-500', 'bg-red-500', 'bg-indigo-500'];
        const memberAvatars = ['ğŸ‘¨â€ğŸ’¼', 'ğŸ‘©â€ğŸ¨', 'ğŸ‘¨â€ğŸ’»', 'ğŸ‘©â€ğŸ“Š', 'ğŸ‘¨â€ğŸ”§', 'ğŸ‘©â€ğŸ’»', 'ğŸ‘¨â€ğŸ“', 'ğŸ‘©â€ğŸ”¬'];
        
        data.members = rawData['å›¢é˜Ÿæˆå‘˜ Team Members'].records.map((r, idx) => {
          // æå–é£ä¹¦ç”¨æˆ·ä¿¡æ¯
          const larkUser = r.fields['é£ä¹¦ç”¨æˆ·']?.[0] || {};
          
          // å¤„ç†å§“åå­—æ®µï¼ˆå¯èƒ½æ˜¯å¯Œæ–‡æœ¬æ•°ç»„ï¼‰
          let name = r.fields['å§“å'] || '';
          if (Array.isArray(name)) {
            name = name.map(n => n.text || n).join('');
          }
          
          // å¤„ç†èŒä½å­—æ®µï¼ˆå¯èƒ½æ˜¯å¯Œæ–‡æœ¬æ•°ç»„ï¼‰
          let position = r.fields['èŒä½'] || '';
          if (Array.isArray(position)) {
            position = position.map(p => p.text || p).join('');
          }
          
          return {
            id: larkUser.id || r.record_id,
            name: name,
            larkName: larkUser.name || '', // é£ä¹¦çœŸå®å§“å
            department: r.fields['éƒ¨é—¨'] || '',
            group: r.fields['ç»„åˆ«'] || 'æœªåˆ†ç»„',
            position: position,
            avatarUrl: larkUser.avatar_url || '', // é£ä¹¦å¤´åƒURL
            avatar: memberAvatars[idx % memberAvatars.length],
            color: memberColors[idx % memberColors.length]
          };
        });

        // æå–æ‰€æœ‰ç»„åˆ«
        const groupSet = new Set(data.members.map(m => m.group));
        data.groups = Array.from(groupSet).filter(g => g);
      }

      // è½¬æ¢æµç¨‹èŠ‚ç‚¹è¡¨ - æ”¯æŒDAGç»“æ„
      if (rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes']) {
        const rawNodes = rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes'].records
          .filter(r => r.fields['èŠ‚ç‚¹åç§°'])
          .map(r => {
            let nodeName = r.fields['èŠ‚ç‚¹åç§°'];
            if (Array.isArray(nodeName)) {
              nodeName = nodeName.map(n => n.text || n).join('');
            }
            let prevNode = r.fields['å‰ç½®èŠ‚ç‚¹'];
            if (Array.isArray(prevNode)) {
              prevNode = prevNode.map(n => n.text || n).join('');
            }
            // ç¡®ä¿ days æ˜¯æ•°å­—
            let days = r.fields['é¢„è®¡å·¥æ—¶(å¤©)'] || 0;
            if (typeof days === 'string') {
              days = parseInt(days, 10) || 0;
            }
            return {
              id: r.record_id,
              name: nodeName || '',
              order: r.fields['èŠ‚ç‚¹é¡ºåº'] || 0,
              type: r.fields['èŠ‚ç‚¹ç±»å‹'] || 'ä¸­é—´èŠ‚ç‚¹',
              days: days,
              role: r.fields['é»˜è®¤è´Ÿè´£è§’è‰²'] || '',
              prevNode: prevNode || null // å‰ç½®èŠ‚ç‚¹åç§°
            };
          });
        
        // æ„å»ºèŠ‚ç‚¹æ˜ å°„
        const nodeMap = {};
        rawNodes.forEach(n => { nodeMap[n.name] = n; });
        
        // æ·»åŠ åç»§èŠ‚ç‚¹ä¿¡æ¯
        rawNodes.forEach(n => {
          n.children = rawNodes.filter(c => c.prevNode === n.name).map(c => c.name);
        });
        
        // æ‹“æ‰‘æ’åºåˆ†å±‚
        const layers = [];
        const visited = new Set();
        const nodeToLayer = {};
        
        // æ‰¾åˆ°èµ·å§‹èŠ‚ç‚¹ï¼ˆæ— å‰ç½®èŠ‚ç‚¹ï¼‰
        const startNodes = rawNodes.filter(n => !n.prevNode);
        if (startNodes.length > 0) {
          layers.push(startNodes);
          startNodes.forEach(n => {
            visited.add(n.name);
            nodeToLayer[n.name] = 0;
          });
        }
        
        // é€å±‚æ„å»º
        let layerIndex = 1;
        while (visited.size < rawNodes.length && layerIndex < 20) {
          const nextLayer = rawNodes.filter(n => {
            if (visited.has(n.name)) return false;
            if (!n.prevNode) return false;
            return visited.has(n.prevNode);
          });
          
          if (nextLayer.length === 0) break;
          
          layers.push(nextLayer);
          nextLayer.forEach(n => {
            visited.add(n.name);
            nodeToLayer[n.name] = layerIndex;
          });
          layerIndex++;
        }
        
        data.processNodes = rawNodes;
        data.processNodeLayers = layers;
        data.nodeMap = nodeMap;
        data.nodeToLayer = nodeToLayer;
      }

      if (data.processNodes.length === 0) {
        data.processNodes = [
          { id: 'n1', name: 'äº§å“ç«‹é¡¹', order: 1, type: 'å¼€å§‹', prevNode: null, children: ['é£æ§ç­›æŸ¥', 'åº—é“ºåˆ†é…'] },
          { id: 'n2', name: 'é£æ§ç­›æŸ¥', order: 2, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'äº§å“ç«‹é¡¹', children: [] },
          { id: 'n3', name: 'åº—é“ºåˆ†é…', order: 2, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'äº§å“ç«‹é¡¹', children: ['é“¾æ¥åˆ›å»º'] },
          { id: 'n4', name: 'é“¾æ¥åˆ›å»º', order: 3, type: 'ä¸­é—´èŠ‚ç‚¹', prevNode: 'åº—é“ºåˆ†é…', children: ['å‚¨è¯„è®¡åˆ’', 'å›¾éœ€', 'å¤‡è´§è®¡åˆ’'] },
          { id: 'n5', name: 'å‚¨è¯„è®¡åˆ’', order: 4, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'é“¾æ¥åˆ›å»º', children: [] },
          { id: 'n6', name: 'å›¾éœ€', order: 4, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'é“¾æ¥åˆ›å»º', children: ['è‰å›¾åˆ¶ä½œ'] },
          { id: 'n7', name: 'å¤‡è´§è®¡åˆ’', order: 4, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'é“¾æ¥åˆ›å»º', children: [] }
        ];
        data.processNodeLayers = [[data.processNodes[0]], [data.processNodes[1], data.processNodes[2]], [data.processNodes[3]], [data.processNodes[4], data.processNodes[5], data.processNodes[6]]];
        data.nodeMap = {};
        data.processNodes.forEach(n => { data.nodeMap[n.name] = n; });
        data.nodeToLayer = { 'äº§å“ç«‹é¡¹': 0, 'é£æ§ç­›æŸ¥': 1, 'åº—é“ºåˆ†é…': 1, 'é“¾æ¥åˆ›å»º': 2, 'å‚¨è¯„è®¡åˆ’': 3, 'å›¾éœ€': 3, 'å¤‡è´§è®¡åˆ’': 3 };
      }

      return data;
    };

    // è·å–èŠ‚ç‚¹çŠ¶æ€
    const getNodeStatus = (nodeName, currentStage, nodes) => {
      const currentIndex = nodes.findIndex(n => n.name === currentStage);
      const nodeIndex = nodes.findIndex(n => n.name === nodeName);
      if (nodeIndex < currentIndex) return 'completed';
      if (nodeIndex === currentIndex) return 'current';
      return 'pending';
    };

    // åŠ è½½ä¸­ç»„ä»¶
    const LoadingScreen = () => (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full loading-spinner mx-auto mb-4"></div>
          <div className="text-gray-600">æ­£åœ¨ä»é£ä¹¦åŠ è½½æ•°æ®...</div>
        </div>
      </div>
    );

    // è¿·ä½ é˜¶æ®µæŒ‡ç¤ºå™¨
    const MiniStageIndicator = ({ currentStage, nodes, tasks = [] }) => {
      // è®¡ç®—èŠ‚ç‚¹çŠ¶æ€ï¼šæ ¹æ®ä»»åŠ¡æƒ…å†µ
      const getNodeTaskStatus = (nodeName) => {
        const nodeTasks = tasks.filter(t => t.stage === nodeName);
        if (nodeTasks.length === 0) return 'pending'; // æ— ä»»åŠ¡
        const completedCount = nodeTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
        const inProgressCount = nodeTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
        if (completedCount === nodeTasks.length) return 'completed'; // å…¨éƒ¨å®Œæˆ
        if (inProgressCount > 0 || completedCount > 0) return 'inProgress'; // æœ‰è¿›è¡Œä¸­æˆ–éƒ¨åˆ†å®Œæˆ
        return 'pending'; // å…¨éƒ¨æœªå¼€å§‹
      };
      
      return (
        <div className="flex items-center gap-1">
          {nodes.map((node, index) => {
            const taskStatus = getNodeTaskStatus(node.name);
            return (
              <div key={node.id} className="flex items-center">
                <div 
                  className={`w-2.5 h-2.5 rounded-full ${
                    taskStatus === 'completed' ? 'bg-green-500' :
                    taskStatus === 'inProgress' ? 'bg-red-500' :
                    'bg-gray-200'
                  }`}
                  title={node.name}
                />
                {index < nodes.length - 1 && (
                  <div className={`w-3 h-0.5 ${taskStatus === 'completed' ? 'bg-green-500' : 'bg-gray-200'}`} />
                )}
              </div>
            );
          })}
        </div>
      );
    };

    // äº§å“å¡ç‰‡
    const ProductCard = ({ product, nodes, members, tasks, onClick }) => {
      const productTasks = tasks.filter(t => t.productId === product.id);
      const completedTasks = productTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
      const inProgressTasks = productTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
      const daysRemaining = product.targetDate 
        ? Math.ceil((new Date(product.targetDate) - new Date()) / (1000 * 60 * 60 * 24))
        : null;
      
      // è‡ªåŠ¨è®¡ç®—é¡¹ç›®çŠ¶æ€
      const getAutoStatus = () => {
        if (productTasks.length === 0) return 'æœªå¼€å§‹';
        if (completedTasks === productTasks.length) return 'å·²å®Œæˆ';
        if (inProgressTasks > 0 || completedTasks > 0) return 'è¿›è¡Œä¸­';
        return 'æœªå¼€å§‹';
      };
      const autoStatus = getAutoStatus();

      // è‡ªåŠ¨è®¡ç®—å½“å‰é˜¶æ®µï¼šæœ€åä¸€ä¸ªæœ‰è¿›è¡Œä¸­ä»»åŠ¡çš„èŠ‚ç‚¹
      const getAutoCurrentStage = () => {
        let lastActiveNode = null;
        // æŒ‰èŠ‚ç‚¹é¡ºåºéå†ï¼Œæ‰¾æœ€åä¸€ä¸ªæœ‰è¿›è¡Œä¸­/éƒ¨åˆ†å®Œæˆä»»åŠ¡çš„èŠ‚ç‚¹
        for (const node of nodes) {
          const nodeTasks = productTasks.filter(t => t.stage === node.name);
          const hasActive = nodeTasks.some(t => t.status === 'è¿›è¡Œä¸­');
          const hasCompleted = nodeTasks.some(t => t.status === 'å·²å®Œæˆ');
          const hasIncomplete = nodeTasks.some(t => t.status !== 'å·²å®Œæˆ');
          if (hasActive || (hasCompleted && hasIncomplete)) {
            lastActiveNode = node.name;
          }
        }
        return lastActiveNode || product.currentStage;
      };
      const autoCurrentStage = getAutoCurrentStage();
      
      const isOverdue = daysRemaining !== null && daysRemaining < 0 && autoStatus !== 'å·²å®Œæˆ';

      // æ‰¾åˆ°é¡¹ç›®è´Ÿè´£äººçš„æˆå‘˜ä¿¡æ¯ï¼ˆç”¨äºæ˜¾ç¤ºå¤´åƒï¼‰
      const ownerMember = members.find(m => m.id === product.ownerId || m.name === product.ownerName || m.larkName === product.ownerName);

      return (
        <div 
          className={`bg-white rounded-xl card-shadow overflow-hidden cursor-pointer hover:shadow-lg transition-all hover:-translate-y-1 ${
            autoStatus === 'å·²å®Œæˆ' ? 'border-2 border-green-200' : ''
          }`}
          onClick={() => onClick(product)}
        >
          <div className={`h-1.5 ${
            autoStatus === 'å·²å®Œæˆ' ? 'bg-green-500' :
            isOverdue ? 'bg-red-500' : 'bg-blue-500'
          }`} />
          
          <div className="p-4">
            <div className="flex items-start gap-3 mb-3">
              <div className="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-2xl">
                {product.image}
              </div>
              <div className="flex-1 min-w-0">
                <div className="font-semibold text-gray-800 truncate">{product.name}</div>
                <div className="text-xs text-gray-400">{product.category}</div>
              </div>
              <span className={`text-xs px-2 py-1 rounded-full ${
                autoStatus === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-600' : 
                autoStatus === 'æœªå¼€å§‹' ? 'bg-gray-100 text-gray-500' :
                'bg-blue-100 text-blue-600'
              }`}>
                {autoStatus}
              </span>
            </div>

            <div className="mb-3">
              <div className="flex items-center justify-between mb-1.5">
                <span className="text-xs text-gray-500">å½“å‰é˜¶æ®µ</span>
                <span className="text-sm font-medium text-blue-600">{autoCurrentStage}</span>
              </div>
              <MiniStageIndicator currentStage={autoCurrentStage} nodes={nodes} tasks={productTasks} />
            </div>

            <div className="mb-3">
              <div className="flex items-center justify-between mb-1">
                <span className="text-xs text-gray-500">æ•´ä½“è¿›åº¦</span>
                <span className="text-sm font-medium text-gray-800">{product.progress}%</span>
              </div>
              <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                <div 
                  className={`h-full rounded-full transition-all ${
                    product.progress === 100 ? 'bg-green-500' : 'bg-blue-500'
                  }`}
                  style={{ width: `${product.progress}%` }}
                />
              </div>
            </div>

            <div className="flex items-center justify-between pt-3 border-t border-gray-100">
              <div className="flex items-center gap-2">
                <div className="text-xs text-gray-500">
                  ä»»åŠ¡ {completedTasks}/{productTasks.length}
                </div>
                {product.ownerName && (
                  <div className="flex items-center gap-1 text-xs text-gray-400">
                    {ownerMember?.avatarUrl ? (
                      <img src={ownerMember.avatarUrl} alt="" className="w-4 h-4 rounded-full" />
                    ) : (
                      <span className="w-4 h-4 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-[10px]">
                        {product.ownerName.charAt(0)}
                      </span>
                    )}
                    {product.ownerName}
                  </div>
                )}
              </div>
              <div className={`text-xs ${isOverdue ? 'text-red-500 font-medium' : 'text-gray-400'}`}>
                {autoStatus === 'å·²å®Œæˆ' ? (
                  <span className="text-green-600">âœ“ å·²ä¸Šçº¿</span>
                ) : daysRemaining !== null ? (
                  isOverdue ? `âš ï¸ é€¾æœŸ ${Math.abs(daysRemaining)} å¤©` : `ğŸ“… å‰©ä½™ ${daysRemaining} å¤©`
                ) : ''}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ç”˜ç‰¹å›¾ç»„ä»¶
    const GanttChart = ({ tasks, members, product }) => {
      // è®¡ç®—æ—¶é—´èŒƒå›´
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // è·å–æ‰€æœ‰æœ‰æ•ˆæ—¥æœŸ
      const allDates = [];
      tasks.forEach(t => {
        if (t.startDate) allDates.push(new Date(t.startDate));
        if (t.dueDate) allDates.push(new Date(t.dueDate));
      });
      
      // å¦‚æœæ²¡æœ‰æ—¥æœŸæ•°æ®ï¼Œä½¿ç”¨é¡¹ç›®æ—¥æœŸæˆ–é»˜è®¤èŒƒå›´
      if (allDates.length === 0) {
        if (product.startDate) allDates.push(new Date(product.startDate));
        if (product.targetDate) allDates.push(new Date(product.targetDate));
      }
      
      // é»˜è®¤æ˜¾ç¤ºå‰åå„2å‘¨
      if (allDates.length === 0) {
        allDates.push(new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000));
        allDates.push(new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000));
      }
      
      const minDate = new Date(Math.min(...allDates.map(d => d.getTime())) - 7 * 24 * 60 * 60 * 1000);
      const maxDate = new Date(Math.max(...allDates.map(d => d.getTime())) + 7 * 24 * 60 * 60 * 1000);
      
      // ç¡®ä¿åŒ…å«ä»Šå¤©
      if (today < minDate) minDate.setTime(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      if (today > maxDate) maxDate.setTime(today.getTime() + 7 * 24 * 60 * 60 * 1000);
      
      const totalDays = Math.ceil((maxDate - minDate) / (24 * 60 * 60 * 1000));
      const dayWidth = Math.max(30, 800 / totalDays); // æ¯å¤©è‡³å°‘30px
      
      // ç”Ÿæˆæ—¥æœŸåˆ»åº¦
      const dateMarkers = [];
      const currentDate = new Date(minDate);
      while (currentDate <= maxDate) {
        dateMarkers.push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      // è®¡ç®—ä»Šå¤©çš„ä½ç½®
      const todayOffset = Math.max(0, (today - minDate) / (24 * 60 * 60 * 1000)) * dayWidth;
      
      // æ ¼å¼åŒ–æ—¥æœŸ
      const formatDate = (date) => {
        const d = new Date(date);
        return `${d.getMonth() + 1}/${d.getDate()}`;
      };
      
      // è·å–æ˜ŸæœŸå‡ 
      const getWeekday = (date) => {
        const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        return days[new Date(date).getDay()];
      };
      
      // åˆ¤æ–­æ˜¯å¦æ˜¯å‘¨æœ«
      const isWeekend = (date) => {
        const day = new Date(date).getDay();
        return day === 0 || day === 6;
      };

      return (
        <div className="bg-gray-50 rounded-xl overflow-hidden">
          {/* å›¾ä¾‹ */}
          <div className="flex gap-4 px-4 py-2 bg-white border-b text-xs text-gray-500">
            <span className="flex items-center gap-1">
              <span className="w-3 h-3 rounded bg-green-500"></span> å·²å®Œæˆ
            </span>
            <span className="flex items-center gap-1">
              <span className="w-3 h-3 rounded bg-blue-500"></span> è¿›è¡Œä¸­
            </span>
            <span className="flex items-center gap-1">
              <span className="w-3 h-3 rounded bg-gray-300"></span> å¾…å¼€å§‹
            </span>
            <span className="flex items-center gap-1">
              <span className="w-0.5 h-3 bg-red-500"></span> ä»Šå¤©
            </span>
          </div>
          
          <div className="overflow-x-auto">
            <div style={{ minWidth: `${totalDays * dayWidth + 200}px` }}>
              {/* æ—¶é—´è½´å¤´éƒ¨ */}
              <div className="flex border-b bg-white sticky top-0">
                <div className="w-48 flex-shrink-0 px-3 py-2 font-medium text-gray-600 border-r bg-gray-50">
                  ä»»åŠ¡åç§°
                </div>
                <div className="flex-1 relative">
                  <div className="flex">
                    {dateMarkers.map((date, idx) => (
                      <div 
                        key={idx} 
                        className={`text-center border-r ${isWeekend(date) ? 'bg-gray-100' : 'bg-white'}`}
                        style={{ width: `${dayWidth}px`, minWidth: `${dayWidth}px` }}
                      >
                        <div className="text-xs text-gray-400 py-1">
                          {formatDate(date)}
                        </div>
                        <div className={`text-xs pb-1 ${isWeekend(date) ? 'text-red-400' : 'text-gray-300'}`}>
                          {getWeekday(date)}
                        </div>
                      </div>
                    ))}
                  </div>
                  {/* ä»Šå¤©çš„æ ‡è®°çº¿ */}
                  <div 
                    className="absolute top-0 bottom-0 w-0.5 bg-red-500 z-10"
                    style={{ left: `${todayOffset}px` }}
                  />
                </div>
              </div>
              
              {/* ä»»åŠ¡è¡Œ */}
              {tasks.map((task, taskIdx) => {
                const assignee = members.find(m => m.id === task.assignee || m.name === task.assigneeName);
                
                // è®¡ç®—ä»»åŠ¡æ¡çš„ä½ç½®å’Œå®½åº¦
                let taskStart = task.startDate ? new Date(task.startDate) : null;
                let taskEnd = task.dueDate ? new Date(task.dueDate) : null;
                
                // å¦‚æœæ²¡æœ‰å¼€å§‹æ—¥æœŸï¼Œä½¿ç”¨æˆªæ­¢æ—¥æœŸå‰7å¤©
                if (!taskStart && taskEnd) {
                  taskStart = new Date(taskEnd.getTime() - 7 * 24 * 60 * 60 * 1000);
                }
                // å¦‚æœæ²¡æœ‰æˆªæ­¢æ—¥æœŸï¼Œä½¿ç”¨å¼€å§‹æ—¥æœŸå7å¤©
                if (taskStart && !taskEnd) {
                  taskEnd = new Date(taskStart.getTime() + 7 * 24 * 60 * 60 * 1000);
                }
                // å¦‚æœéƒ½æ²¡æœ‰ï¼Œæ˜¾ç¤ºä¸€ä¸ªé»˜è®¤æ¡
                if (!taskStart && !taskEnd) {
                  taskStart = new Date(today.getTime() - 3 * 24 * 60 * 60 * 1000);
                  taskEnd = new Date(today.getTime() + 4 * 24 * 60 * 60 * 1000);
                }
                
                const startOffset = Math.max(0, (taskStart - minDate) / (24 * 60 * 60 * 1000)) * dayWidth;
                const duration = Math.max(1, (taskEnd - taskStart) / (24 * 60 * 60 * 1000) + 1);
                const barWidth = duration * dayWidth;
                
                // ä»»åŠ¡æ¡é¢œè‰²
                const barColor = task.status === 'å·²å®Œæˆ' ? 'bg-green-500' :
                                 task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500' :
                                 'bg-gray-300';
                
                // åˆ¤æ–­æ˜¯å¦é€¾æœŸ
                const isOverdue = task.status !== 'å·²å®Œæˆ' && taskEnd && taskEnd < today;

                return (
                  <div key={task.id} className={`flex border-b hover:bg-blue-50/50 ${taskIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'}`}>
                    {/* ä»»åŠ¡åç§° */}
                    <div className="w-48 flex-shrink-0 px-3 py-2 border-r flex items-center gap-2">
                      <div className={`w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 ${
                        task.status === 'å·²å®Œæˆ' ? 'bg-green-500 text-white' :
                        task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500 text-white' :
                        'bg-gray-200 text-gray-500'
                      }`}>
                        {task.status === 'å·²å®Œæˆ' ? 'âœ“' : task.status === 'è¿›è¡Œä¸­' ? 'â—' : 'â—‹'}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className={`text-sm truncate ${task.status === 'å·²å®Œæˆ' ? 'text-gray-400 line-through' : 'text-gray-800'}`}>
                          {task.name}
                        </div>
                        <div className="text-xs text-gray-400 truncate">{task.stage}</div>
                      </div>
                    </div>
                    
                    {/* ç”˜ç‰¹æ¡ */}
                    <div className="flex-1 relative py-2">
                      {/* èƒŒæ™¯ç½‘æ ¼ */}
                      <div className="absolute inset-0 flex">
                        {dateMarkers.map((date, idx) => (
                          <div 
                            key={idx}
                            className={`border-r ${isWeekend(date) ? 'bg-gray-100/50' : ''}`}
                            style={{ width: `${dayWidth}px`, minWidth: `${dayWidth}px` }}
                          />
                        ))}
                      </div>
                      
                      {/* ä»Šå¤©çš„æ ‡è®°çº¿ */}
                      <div 
                        className="absolute top-0 bottom-0 w-0.5 bg-red-500/30 z-10"
                        style={{ left: `${todayOffset}px` }}
                      />
                      
                      {/* ä»»åŠ¡æ¡ */}
                      <div 
                        className={`absolute top-1/2 -translate-y-1/2 h-6 rounded-full ${barColor} ${isOverdue ? 'ring-2 ring-red-400' : ''} shadow-sm flex items-center px-2 text-xs text-white font-medium overflow-hidden z-20 cursor-pointer hover:brightness-110 transition-all`}
                        style={{ 
                          left: `${startOffset}px`, 
                          width: `${Math.max(barWidth, 60)}px`
                        }}
                        title={`${task.name}\n${task.startDate || 'æœªè®¾ç½®'} ~ ${task.dueDate || 'æœªè®¾ç½®'}\nçŠ¶æ€: ${task.status}`}
                      >
                        {assignee && (
                          assignee.avatarUrl ? (
                            <img src={assignee.avatarUrl} alt="" className="w-4 h-4 rounded-full object-cover mr-1 flex-shrink-0" />
                          ) : (
                            <span className="w-4 h-4 rounded-full bg-white/30 flex items-center justify-center text-xs mr-1 flex-shrink-0">
                              {assignee.avatar}
                            </span>
                          )
                        )}
                        <span className="truncate">{barWidth > 80 ? task.name : ''}</span>
                      </div>
                    </div>
                  </div>
                );
              })}
              
              {/* é¡¹ç›®é‡Œç¨‹ç¢‘ */}
              {product.targetDate && (
                <div className="flex border-b bg-purple-50/50">
                  <div className="w-48 flex-shrink-0 px-3 py-2 border-r flex items-center gap-2">
                    <div className="w-5 h-5 rounded flex items-center justify-center text-xs bg-purple-500 text-white">
                      ğŸ¯
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="text-sm font-medium text-purple-700">è®¡åˆ’ä¸Šçº¿</div>
                      <div className="text-xs text-purple-500">{product.targetDate}</div>
                    </div>
                  </div>
                  <div className="flex-1 relative py-2">
                    {/* èƒŒæ™¯ç½‘æ ¼ */}
                    <div className="absolute inset-0 flex">
                      {dateMarkers.map((date, idx) => (
                        <div 
                          key={idx}
                          className={`border-r ${isWeekend(date) ? 'bg-gray-100/50' : ''}`}
                          style={{ width: `${dayWidth}px`, minWidth: `${dayWidth}px` }}
                        />
                      ))}
                    </div>
                    {/* é‡Œç¨‹ç¢‘æ ‡è®° */}
                    {(() => {
                      const targetDate = new Date(product.targetDate);
                      const offset = Math.max(0, (targetDate - minDate) / (24 * 60 * 60 * 1000)) * dayWidth;
                      return (
                        <div 
                          className="absolute top-1/2 -translate-y-1/2 z-20"
                          style={{ left: `${offset}px` }}
                        >
                          <div className="w-6 h-6 bg-purple-500 rotate-45 transform -translate-x-1/2"></div>
                          <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-0.5 h-10 bg-purple-500"></div>
                        </div>
                      );
                    })()}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // èŠ‚ç‚¹ä»»åŠ¡è¯¦æƒ…å¼¹çª— - æ”¯æŒæ–°å¢ä»»åŠ¡å’Œä»»åŠ¡æµç¨‹ç®¡ç†
    const NodeTaskModal = ({ node, tasks, members, product, nodeRecordId, nodes, skippedNodes = new Set(), onClose, onTaskCreated }) => {
      const currentUser = useContext(UserContext);
      const showToast = useToast();
      const [showAddForm, setShowAddForm] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [actionTaskId, setActionTaskId] = useState(null); // æ­£åœ¨æ“ä½œçš„ä»»åŠ¡ID
      const [showCompleteForm, setShowCompleteForm] = useState(null); // æ˜¾ç¤ºå®Œæˆè¡¨å•çš„ä»»åŠ¡ID
      const [outputFile, setOutputFile] = useState(null); // è¾“å‡ºæ–‡ä»¶å¯¹è±¡
      const [formData, setFormData] = useState({
        name: '',
        priority: 'P2-ä¸­ç­‰',
        assignee: '',
        collaborators: [], // åä½œäººï¼ˆå¤šé€‰ï¼‰
        description: ''
      });
      
      if (!node) return null;

      // æ£€æŸ¥å‰ç½®èŠ‚ç‚¹ä»»åŠ¡æ˜¯å¦å…¨éƒ¨å®Œæˆ
      const checkPredecessorCompleted = () => {
        if (!node.prevNode || !nodes) return { canAccept: true, blockedBy: null };
        
        // æ‰¾åˆ°å‰ç½®èŠ‚ç‚¹
        const prevNodeName = node.prevNode;
        
        // å‰ç½®èŠ‚ç‚¹å·²è·³è¿‡ â†’ å…è®¸æ¥å—
        if (skippedNodes.has(prevNodeName)) {
          return { canAccept: true, blockedBy: null };
        }
        
        const prevNodeTasks = tasks.filter(t => t.stage === prevNodeName);
        
        // å‰ç½®èŠ‚ç‚¹æ— ä»»åŠ¡ â†’ ä¸èƒ½æ¥
        if (prevNodeTasks.length === 0) {
          return { canAccept: false, blockedBy: prevNodeName, reason: 'no_tasks', message: `å‰ç½®èŠ‚ç‚¹ã€Œ${prevNodeName}ã€è¿˜æ²¡æœ‰åˆ›å»ºä»»åŠ¡` };
        }
        
        // å‰ç½®èŠ‚ç‚¹æœ‰æœªå®Œæˆä»»åŠ¡ â†’ ä¸èƒ½æ¥
        const unfinished = prevNodeTasks.filter(t => t.status !== 'å·²å®Œæˆ');
        if (unfinished.length > 0) {
          return { canAccept: false, blockedBy: prevNodeName, reason: 'incomplete', message: `å‰ç½®èŠ‚ç‚¹ã€Œ${prevNodeName}ã€è¿˜æœ‰ ${unfinished.length} ä¸ªä»»åŠ¡æœªå®Œæˆ`, unfinishedTasks: unfinished };
        }
        
        return { canAccept: true, blockedBy: null };
      };

      const predecessorCheck = checkPredecessorCompleted();
      
      // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ä»»åŠ¡è´Ÿè´£äºº
      const isTaskAssignee = (task) => {
        if (!currentUser) return false;
        // æ¯”è¾ƒå¤šç§æ–¹å¼ï¼šopen_idã€ä¸­æ–‡åã€è‹±æ–‡å
        return task.assignee === currentUser.open_id ||
               task.assigneeName === currentUser.name ||
               task.assigneeName === currentUser.en_name;
      };
      
      // ç­›é€‰è¯¥èŠ‚ç‚¹çš„ä»»åŠ¡
      const nodeTasks = tasks.filter(t => t.stage === node.name);
      const completedCount = nodeTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
      const inProgressCount = nodeTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
      const pendingCount = nodeTasks.filter(t => t.status === 'å¾…å¼€å§‹' || t.status === 'æœªå¼€å§‹').length;
      const progress = nodeTasks.length > 0 ? Math.round((completedCount / nodeTasks.length) * 100) : 0;

      // æäº¤æ–°ä»»åŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼šä¸å«æ—¥æœŸå’ŒçŠ¶æ€ï¼‰
      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.name.trim()) {
          alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
          return;
        }
        
        setIsSubmitting(true);
        try {
          const res = await fetch(API_BASE + '/api/create-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblFwmxmjRJPzVmV',
              task: {
                name: formData.name,
                priority: formData.priority,
                status: 'å¾…å¼€å§‹', // é»˜è®¤å¾…å¼€å§‹
                assignee: formData.assignee,
                collaborators: formData.collaborators,
                description: formData.description,
                projectId: product?.id,
                nodeId: nodeRecordId
              }
            })
          });
          
          const result = await res.json();
          if (result.success) {
            // å…ˆåˆ·æ–°æ•°æ®ï¼Œå†é‡ç½®è¡¨å•
            if (onTaskCreated) onTaskCreated();
            setShowAddForm(false);
            setFormData({
              name: '',
              priority: 'P2-ä¸­ç­‰',
              assignee: '',
              collaborators: [],
              description: ''
            });
            showToast?.('ä»»åŠ¡åˆ›å»ºæˆåŠŸ', 'success');
          } else {
            throw new Error(result.error || 'åˆ›å»ºå¤±è´¥');
          }
        } catch (err) {
          showToast?.('åˆ›å»ºå¤±è´¥: ' + err.message, 'error');
        }
        setIsSubmitting(false);
      };

      // æ¥å—ä»»åŠ¡ï¼šè®¾ç½®å¼€å§‹æ—¥æœŸä¸ºä»Šå¤©ï¼Œæˆªæ­¢æ—¥æœŸæ ¹æ®èŠ‚ç‚¹é¢„è®¡å·¥æ—¶è®¡ç®—ï¼ŒçŠ¶æ€æ”¹ä¸ºè¿›è¡Œä¸­
      const handleAcceptTask = async (task) => {
        // æ£€æŸ¥å‰ç½®èŠ‚ç‚¹æ˜¯å¦å®Œæˆ
        if (!predecessorCheck.canAccept) {
          showToast?.(`âš ï¸ ${predecessorCheck.message}ï¼Œè¯·ç­‰å¾…å‰ç½®èŠ‚ç‚¹å®Œæˆåå†æ¥å—ä»»åŠ¡`, 'error');
          return;
        }
        
        const nodeDays = parseInt(node.days, 10) || 7; // ç¡®ä¿æ˜¯æ•°å­—ï¼Œé»˜è®¤7å¤©
        if (!confirm(`ç¡®è®¤æ¥å—ä»»åŠ¡ã€Œ${task.name}ã€ï¼Ÿ\n\nå¼€å§‹æ—¥æœŸå°†è®¾ä¸ºä»Šå¤©ï¼Œæˆªæ­¢æ—¥æœŸæ ¹æ®èŠ‚ç‚¹é¢„è®¡å·¥æ—¶ï¼ˆ${nodeDays}å¤©ï¼‰è‡ªåŠ¨è®¡ç®—ã€‚`)) {
          return;
        }
        
        setActionTaskId(task.id);
        try {
          const today = new Date();
          const dueDate = new Date(today);
          dueDate.setDate(dueDate.getDate() + nodeDays); // ä½¿ç”¨å·²è½¬æ¢çš„æ•°å­—
          
          const res = await fetch(API_BASE + '/api/update-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblFwmxmjRJPzVmV',
              record_id: task.id,
              fields: {
                status: 'è¿›è¡Œä¸­',
                startDate: today.toISOString().split('T')[0],
                dueDate: dueDate.toISOString().split('T')[0]
              }
            })
          });
          
          const result = await res.json();
          if (result.success) {
            if (onTaskCreated) onTaskCreated(); // ç«‹å³åˆ·æ–°
            showToast?.('å·²æ¥å—ä»»åŠ¡', 'success');
          } else {
            throw new Error(result.error || 'æ“ä½œå¤±è´¥');
          }
        } catch (err) {
          showToast?.('æ“ä½œå¤±è´¥: ' + err.message, 'error');
        }
        setActionTaskId(null);
      };

      // å®Œæˆä»»åŠ¡ï¼šéœ€è¦ä¸Šä¼ è¾“å‡ºæ–‡ä»¶
      const handleCompleteTask = async (task) => {
        if (!outputFile) {
          showToast?.('è¯·ä¸Šä¼ è¾“å‡ºæ–‡ä»¶', 'error');
          return;
        }
        
        setActionTaskId(task.id);
        try {
          // å°†æ–‡ä»¶è½¬æ¢ä¸º Base64
          const toBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]); // å»æ‰ data:xxx;base64, å‰ç¼€
            reader.onerror = error => reject(error);
          });
          
          const fileBase64 = await toBase64(outputFile);
          
          // 1. ä¸Šä¼ æ–‡ä»¶åˆ°é£ä¹¦
          const uploadRes = await fetch(API_BASE + '/api/upload-file', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblFwmxmjRJPzVmV',
              record_id: task.id,
              file_name: outputFile.name,
              file_data: fileBase64,
              file_size: outputFile.size
            })
          });
          
          const uploadResult = await uploadRes.json();
          if (!uploadResult.success) {
            throw new Error(uploadResult.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
          }
          
          // 2. æ›´æ–°ä»»åŠ¡çŠ¶æ€ä¸ºå·²å®Œæˆ
          const res = await fetch(API_BASE + '/api/update-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblFwmxmjRJPzVmV',
              record_id: task.id,
              fields: {
                status: 'å·²å®Œæˆ',
                completeDate: new Date().toISOString().split('T')[0]
              }
            })
          });
          
          const result = await res.json();
          if (result.success) {
            if (onTaskCreated) onTaskCreated(); // ç«‹å³åˆ·æ–°
            setShowCompleteForm(null);
            setOutputFile(null);
            showToast?.('ä»»åŠ¡å·²å®Œæˆ', 'success');
          } else {
            throw new Error(result.error || 'æ“ä½œå¤±è´¥');
          }
        } catch (err) {
          showToast?.('æ“ä½œå¤±è´¥: ' + err.message, 'error');
        }
        setActionTaskId(null);
      };

      // åä½œäººå¤šé€‰å¤„ç†
      const handleCollaboratorChange = (memberId) => {
        setFormData(prev => {
          const exists = prev.collaborators.includes(memberId);
          return {
            ...prev,
            collaborators: exists 
              ? prev.collaborators.filter(id => id !== memberId)
              : [...prev.collaborators, memberId]
          };
        });
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4" onClick={onClose}>
          <div className="bg-white rounded-xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
            {/* å¤´éƒ¨ */}
            <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center font-bold">
                    {node.order}
                  </div>
                  <div>
                    <h3 className="font-bold text-lg">{node.name}</h3>
                    <div className="text-white/70 text-sm">
                      {node.role && `é»˜è®¤è´Ÿè´£ï¼š${node.role}`}
                      {node.days > 0 && ` Â· é¢„è®¡ ${node.days} å¤©`}
                    </div>
                  </div>
                </div>
                <button onClick={onClose} className="text-white/80 hover:text-white text-xl">Ã—</button>
              </div>
            </div>

            {/* ç»Ÿè®¡å¡ç‰‡ */}
            <div className="grid grid-cols-4 gap-2 p-4 bg-gray-50">
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-blue-600">{progress}%</div>
                <div className="text-xs text-gray-500">å®Œæˆç‡</div>
              </div>
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-green-600">{completedCount}</div>
                <div className="text-xs text-gray-500">å·²å®Œæˆ</div>
              </div>
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-orange-600">{inProgressCount}</div>
                <div className="text-xs text-gray-500">è¿›è¡Œä¸­</div>
              </div>
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-gray-600">{pendingCount}</div>
                <div className="text-xs text-gray-500">å¾…å¼€å§‹</div>
              </div>
            </div>

            {/* è¿›åº¦æ¡ */}
            <div className="px-4 py-2 bg-gray-50">
              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-gradient-to-r from-green-400 to-green-500 rounded-full transition-all"
                  style={{ width: `${progress}%` }}
                />
              </div>
            </div>

            {/* ä»»åŠ¡åˆ—è¡¨ */}
            <div className="p-4 max-h-[40vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h4 className="text-sm font-semibold text-gray-700">ğŸ“‹ ä»»åŠ¡åˆ—è¡¨ ({nodeTasks.length})</h4>
                <button
                  onClick={() => setShowAddForm(true)}
                  className="px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded-lg flex items-center gap-1 transition-colors"
                >
                  â• æ–°å¢ä»»åŠ¡
                </button>
              </div>
              
              {/* æ–°å¢ä»»åŠ¡è¡¨å• - ç®€åŒ–ç‰ˆ */}
              {showAddForm && (
                <div className="bg-purple-50 rounded-lg p-4 mb-4 border border-purple-200">
                  <div className="flex items-center justify-between mb-3">
                    <h5 className="font-medium text-purple-700">æ–°å¢ä»»åŠ¡</h5>
                    <button 
                      onClick={() => setShowAddForm(false)}
                      className="text-gray-400 hover:text-gray-600"
                    >Ã—</button>
                  </div>
                  <form onSubmit={handleSubmit} className="space-y-3">
                    {/* ä»»åŠ¡åç§° */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">ä»»åŠ¡åç§° *</label>
                      <input
                        type="text"
                        value={formData.name}
                        onChange={e => setFormData({...formData, name: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none"
                        placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°"
                        required
                      />
                    </div>
                    
                    {/* ä¼˜å…ˆçº§ */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">ä¼˜å…ˆçº§</label>
                      <select
                        value={formData.priority}
                        onChange={e => setFormData({...formData, priority: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none"
                      >
                        <option value="P0-ç´§æ€¥">P0-ç´§æ€¥</option>
                        <option value="P1-é«˜ä¼˜">P1-é«˜ä¼˜</option>
                        <option value="P2-ä¸­ç­‰">P2-ä¸­ç­‰</option>
                        <option value="P3-ä½ä¼˜">P3-ä½ä¼˜</option>
                      </select>
                    </div>
                    
                    {/* è´Ÿè´£äºº */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">è´Ÿè´£äºº</label>
                      <select
                        value={formData.assignee}
                        onChange={e => setFormData({...formData, assignee: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none"
                      >
                        <option value="">è¯·é€‰æ‹©è´Ÿè´£äºº</option>
                        {members.map(m => (
                          <option key={m.id} value={m.id}>{m.name} - {m.position}</option>
                        ))}
                      </select>
                    </div>
                    
                    {/* åä½œäººï¼ˆå¤šé€‰ï¼‰ */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">åä½œäºº</label>
                      <div className="border rounded-lg p-2 max-h-32 overflow-y-auto">
                        {members.map(m => (
                          <label key={m.id} className="flex items-center gap-2 py-1 px-2 hover:bg-gray-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              checked={formData.collaborators.includes(m.id)}
                              onChange={() => handleCollaboratorChange(m.id)}
                              className="rounded text-purple-500 focus:ring-purple-300"
                            />
                            {m.avatarUrl ? (
                              <img src={m.avatarUrl} alt="" className="w-5 h-5 rounded-full object-cover" />
                            ) : (
                              <span className={`w-5 h-5 ${m.color} rounded-full flex items-center justify-center text-white text-xs`}>
                                {m.avatar}
                              </span>
                            )}
                            <span className="text-sm">{m.name}</span>
                          </label>
                        ))}
                      </div>
                      {formData.collaborators.length > 0 && (
                        <div className="text-xs text-gray-400 mt-1">
                          å·²é€‰ {formData.collaborators.length} äºº
                        </div>
                      )}
                    </div>
                    
                    {/* æè¿° */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">ä»»åŠ¡æè¿°</label>
                      <textarea
                        value={formData.description}
                        onChange={e => setFormData({...formData, description: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none resize-none"
                        rows={2}
                        placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°ï¼ˆé€‰å¡«ï¼‰"
                      />
                    </div>
                    
                    {/* æäº¤æŒ‰é’® */}
                    <div className="flex gap-2 pt-2">
                      <button
                        type="button"
                        onClick={() => setShowAddForm(false)}
                        className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg text-sm hover:bg-gray-50 transition-colors"
                      >
                        å–æ¶ˆ
                      </button>
                      <button
                        type="submit"
                        disabled={isSubmitting}
                        className="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {isSubmitting ? 'æäº¤ä¸­...' : 'åˆ›å»ºä»»åŠ¡'}
                      </button>
                    </div>
                  </form>
                </div>
              )}
              
              {nodeTasks.length > 0 ? (
                <div className="space-y-2">
                  {nodeTasks.map(task => {
                    const assignee = members.find(m => m.id === task.assignee || m.name === task.assigneeName);
                    const isActioning = actionTaskId === task.id;
                    
                    return (
                      <div key={task.id} className="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors">
                        <div className="flex items-start gap-3">
                          {/* çŠ¶æ€å›¾æ ‡ */}
                          <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5 ${
                            task.status === 'å·²å®Œæˆ' ? 'bg-green-500 text-white' :
                            task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500 text-white' :
                            'bg-gray-300 text-gray-600'
                          }`}>
                            {task.status === 'å·²å®Œæˆ' ? 'âœ“' : task.status === 'è¿›è¡Œä¸­' ? 'â—' : 'â—‹'}
                          </div>
                          
                          {/* ä»»åŠ¡ä¿¡æ¯ */}
                          <div className="flex-1 min-w-0">
                            <div className={`font-medium ${task.status === 'å·²å®Œæˆ' ? 'text-gray-400 line-through' : 'text-gray-800'}`}>
                              {task.name}
                            </div>
                            <div className="flex items-center gap-2 mt-1 flex-wrap">
                              {assignee ? (
                                <span className="inline-flex items-center gap-1 text-xs bg-white px-2 py-0.5 rounded-full border">
                                  {assignee.avatarUrl ? (
                                    <img src={assignee.avatarUrl} alt="" className="w-4 h-4 rounded-full object-cover" />
                                  ) : (
                                    <span className={`w-4 h-4 ${assignee.color} rounded-full flex items-center justify-center text-white text-xs`}>
                                      {assignee.avatar}
                                    </span>
                                  )}
                                  {assignee.name}
                                </span>
                              ) : task.assigneeName ? (
                                <span className="inline-flex items-center gap-1 text-xs bg-white px-2 py-0.5 rounded-full border">
                                  ğŸ‘¤ {task.assigneeName}
                                </span>
                              ) : null}
                              
                              <span className={`text-xs px-2 py-0.5 rounded-full ${
                                task.priority === 'P0' || task.priority === 'P1' ? 'bg-red-100 text-red-600' :
                                task.priority === 'P2' ? 'bg-yellow-100 text-yellow-600' :
                                'bg-gray-100 text-gray-500'
                              }`}>
                                {task.priority}
                              </span>
                              
                              {task.dueDate && (
                                <span className="text-xs text-gray-400">
                                  ğŸ“… {task.dueDate}
                                </span>
                              )}
                            </div>
                            
                            {/* æ“ä½œæŒ‰é’®åŒºåŸŸ */}
                            <div className="mt-2 flex gap-2">
                              {/* å¾…å¼€å§‹çŠ¶æ€ï¼šæ˜¾ç¤ºæ¥å—ä»»åŠ¡æŒ‰é’®ï¼ˆä»…è´Ÿè´£äººå¯è§ï¼‰ */}
                              {(task.status === 'å¾…å¼€å§‹' || task.status === 'æœªå¼€å§‹') && isTaskAssignee(task) && (
                                predecessorCheck.canAccept ? (
                                  <button
                                    onClick={() => handleAcceptTask(task)}
                                    disabled={isActioning}
                                    className="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg transition-colors disabled:opacity-50"
                                  >
                                    {isActioning ? 'å¤„ç†ä¸­...' : 'ğŸš€ æ¥å—ä»»åŠ¡'}
                                  </button>
                                ) : (
                                  <div className="flex flex-col gap-1">
                                    <span className="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded-lg flex items-center gap-1">
                                      âš ï¸ {predecessorCheck.message}
                                    </span>
                                    {predecessorCheck.unfinishedTasks && (
                                      <div className="text-xs text-gray-400 pl-2">
                                        æœªå®Œæˆ: {predecessorCheck.unfinishedTasks.map(t => t.name).join('ã€')}
                                      </div>
                                    )}
                                  </div>
                                )
                              )}
                              
                              {/* éè´Ÿè´£äººçœ‹åˆ°çš„æç¤º */}
                              {(task.status === 'å¾…å¼€å§‹' || task.status === 'æœªå¼€å§‹') && !isTaskAssignee(task) && (
                                <span className="text-xs text-gray-400 italic flex items-center gap-1">
                                  {assignee?.avatarUrl && (
                                    <img src={assignee.avatarUrl} alt="" className="w-4 h-4 rounded-full" />
                                  )}
                                  ä»… {task.assigneeName || assignee?.name || 'è´Ÿè´£äºº'} å¯æ¥å—
                                </span>
                              )}
                              
                              {/* è¿›è¡Œä¸­çŠ¶æ€ï¼šæ˜¾ç¤ºå®Œæˆä»»åŠ¡æŒ‰é’®ï¼ˆä»…è´Ÿè´£äººå¯è§ï¼‰ */}
                              {task.status === 'è¿›è¡Œä¸­' && isTaskAssignee(task) && (
                                <>
                                  {showCompleteForm === task.id ? (
                                    <div className="flex-1 flex flex-col gap-2">
                                      <div className="flex items-center gap-2">
                                        <label className="flex-1 flex items-center gap-2 px-3 py-2 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer hover:border-green-400 hover:bg-green-50 transition-colors">
                                          <span className="text-gray-400">ğŸ“</span>
                                          <span className="text-xs text-gray-500 truncate">
                                            {outputFile ? outputFile.name : 'ç‚¹å‡»é€‰æ‹©æ–‡ä»¶...'}
                                          </span>
                                          <input
                                            type="file"
                                            onChange={e => setOutputFile(e.target.files[0] || null)}
                                            className="hidden"
                                          />
                                        </label>
                                        <button
                                          onClick={() => handleCompleteTask(task)}
                                          disabled={isActioning || !outputFile}
                                          className="px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                          {isActioning ? 'ä¸Šä¼ ä¸­...' : 'âœ“ æäº¤'}
                                        </button>
                                        <button
                                          onClick={() => { setShowCompleteForm(null); setOutputFile(null); }}
                                          className="px-2 py-2 bg-gray-200 hover:bg-gray-300 text-gray-600 text-xs rounded-lg transition-colors"
                                        >
                                          âœ•
                                        </button>
                                      </div>
                                      {outputFile && (
                                        <div className="text-xs text-green-600">
                                          âœ“ å·²é€‰æ‹©: {outputFile.name} ({(outputFile.size / 1024).toFixed(1)} KB)
                                        </div>
                                      )}
                                    </div>
                                  ) : (
                                    <button
                                      onClick={() => setShowCompleteForm(task.id)}
                                      className="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg transition-colors"
                                    >
                                      âœ… å®Œæˆä»»åŠ¡
                                    </button>
                                  )}
                                </>
                              )}
                              
                              {/* è¿›è¡Œä¸­çŠ¶æ€ï¼šéè´Ÿè´£äººçœ‹åˆ°çš„æç¤º */}
                              {task.status === 'è¿›è¡Œä¸­' && !isTaskAssignee(task) && (
                                <span className="text-xs text-gray-400 italic flex items-center gap-1">
                                  {assignee?.avatarUrl && (
                                    <img src={assignee.avatarUrl} alt="" className="w-4 h-4 rounded-full" />
                                  )}
                                  ä»… {task.assigneeName || assignee?.name || 'è´Ÿè´£äºº'} å¯å®Œæˆ
                                </span>
                              )}
                              
                              {/* å·²å®ŒæˆçŠ¶æ€ï¼šæ˜¾ç¤ºè¾“å‡ºæ–‡ä»¶ */}
                              {task.status === 'å·²å®Œæˆ' && task.outputFile && (
                                <a 
                                  href={`${API_BASE}/api/download-file?file_token=${task.outputFile.file_token}&file_name=${encodeURIComponent(task.outputFile.name || 'file')}`}
                                  target="_blank" 
                                  rel="noopener noreferrer"
                                  className="text-xs text-green-600 hover:text-green-700 hover:underline inline-flex items-center gap-1"
                                >
                                  ğŸ“ {task.outputFile.name || 'æŸ¥çœ‹é™„ä»¶'}
                                </a>
                              )}
                            </div>
                          </div>

                          {/* çŠ¶æ€æ ‡ç­¾ */}
                          <span className={`text-xs px-2 py-1 rounded flex-shrink-0 ${
                            task.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-600' :
                            task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-100 text-blue-600' :
                            'bg-gray-100 text-gray-500'
                          }`}>
                            {task.status}
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : !showAddForm && (
                <div className="text-center py-8 text-gray-400">
                  <div className="text-4xl mb-2">ğŸ“­</div>
                  <div>è¯¥èŠ‚ç‚¹æš‚æ— ä»»åŠ¡</div>
                  <button
                    onClick={() => setShowAddForm(true)}
                    className="mt-3 px-4 py-2 bg-purple-100 text-purple-600 rounded-lg text-sm hover:bg-purple-200 transition-colors"
                  >
                    â• åˆ›å»ºç¬¬ä¸€ä¸ªä»»åŠ¡
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // äº§å“è¯¦æƒ…å¼¹çª— - æ”¯æŒDAGæµç¨‹å›¾ï¼ˆè¡Œè½¨é“å¯¹é½ï¼‰+ èŠ‚ç‚¹ç‚¹å‡»
    const ProductDetailModal = ({ product, nodes, nodeLayers, nodeMap, nodeToLayer, members, tasks, onClose, onRefresh }) => {
      const [selectedNode, setSelectedNode] = useState(null);
      const [skippedNodes, setSkippedNodes] = useState(new Set());
      const currentUser = useContext(UserContext);
      const showToast = useToast();
      
      if (!product) return null;
      const productTasks = tasks.filter(t => t.productId === product.id);

      // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯é¡¹ç›®è´Ÿè´£äºº
      const isProjectOwner = currentUser && (
        currentUser.open_id === product.ownerId ||
        currentUser.name === product.ownerName ||
        currentUser.en_name === product.ownerName
      );

      // è‡ªåŠ¨è®¡ç®—å½“å‰é˜¶æ®µ
      const getAutoCurrentStage = () => {
        let lastActiveNode = null;
        for (const node of nodes) {
          const nodeTasks = productTasks.filter(t => t.stage === node.name);
          const hasActive = nodeTasks.some(t => t.status === 'è¿›è¡Œä¸­');
          const hasCompleted = nodeTasks.some(t => t.status === 'å·²å®Œæˆ');
          const hasIncomplete = nodeTasks.some(t => t.status !== 'å·²å®Œæˆ');
          if (hasActive || (hasCompleted && hasIncomplete)) {
            lastActiveNode = node.name;
          }
        }
        return lastActiveNode || product.currentStage;
      };
      const autoCurrentStage = getAutoCurrentStage();

      // æ‰¾åˆ°é¡¹ç›®è´Ÿè´£äººçš„æˆå‘˜ä¿¡æ¯
      const ownerMember = members.find(m => m.id === product.ownerId || m.name === product.ownerName || m.larkName === product.ownerName);

      // è·å–èŠ‚ç‚¹çŠ¶æ€ï¼ˆåŸºäºä»»åŠ¡çŠ¶æ€ï¼‰
      const getNodeStatus = (nodeName) => {
        if (skippedNodes.has(nodeName)) return 'skipped'; // å·²è·³è¿‡
        const nodeTasks = productTasks.filter(t => t.stage === nodeName);
        if (nodeTasks.length === 0) return 'pending'; // æ— ä»»åŠ¡ â†’ ç°è‰²
        const completedCount = nodeTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
        const inProgressCount = nodeTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
        if (completedCount === nodeTasks.length) return 'completed'; // å…¨éƒ¨å®Œæˆ â†’ ç»¿è‰²
        if (inProgressCount > 0 || completedCount > 0) return 'inProgress'; // æœ‰è¿›è¡Œä¸­æˆ–éƒ¨åˆ†å®Œæˆ â†’ çº¢è‰²
        return 'pending'; // å…¨éƒ¨æœªå¼€å§‹ â†’ ç°è‰²
      };

      // è·³è¿‡èŠ‚ç‚¹ï¼ˆä»…é¡¹ç›®è´Ÿè´£äººå¯æ“ä½œï¼‰
      const handleSkipNode = (nodeName, e) => {
        e.stopPropagation();
        if (!isProjectOwner) {
          showToast?.('åªæœ‰é¡¹ç›®è´Ÿè´£äººæ‰èƒ½è·³è¿‡èŠ‚ç‚¹', 'error');
          return;
        }
        if (!confirm(`ç¡®è®¤è·³è¿‡èŠ‚ç‚¹ã€Œ${nodeName}ã€ï¼Ÿ\n\nè·³è¿‡åï¼Œåç»­èŠ‚ç‚¹å°†ä¸å—æ­¤èŠ‚ç‚¹é™åˆ¶ã€‚`)) return;
        setSkippedNodes(prev => {
          const next = new Set(prev);
          if (next.has(nodeName)) {
            next.delete(nodeName);
          } else {
            next.add(nodeName);
          }
          return next;
        });
        showToast?.(`èŠ‚ç‚¹ã€Œ${nodeName}ã€å·²è·³è¿‡`, 'success');
      };

      // æ„å»ºæµç¨‹é“¾ï¼ˆæ¯æ¡é“¾æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¡Œï¼‰
      const buildFlowChains = () => {
        if (!nodes || nodes.length === 0) return [];
        
        // æ‰¾åˆ°æ‰€æœ‰èµ·å§‹èŠ‚ç‚¹
        const startNodes = nodes.filter(n => !n.prevNode);
        if (startNodes.length === 0) return [];
        
        const chains = [];
        const visited = new Set();
        
        // é€’å½’æ„å»ºé“¾
        const buildChain = (node, chain = []) => {
          if (!node || visited.has(node.name)) return;
          
          chain.push(node);
          visited.add(node.name);
          
          // è·å–åç»§èŠ‚ç‚¹
          const children = nodes.filter(n => n.prevNode === node.name);
          
          if (children.length === 0) {
            // é“¾ç»“æŸ
            chains.push([...chain]);
          } else if (children.length === 1) {
            // å•ä¸€åç»§ï¼Œç»§ç»­å½“å‰é“¾
            buildChain(children[0], chain);
          } else {
            // å¤šä¸ªåç»§ï¼ˆåˆ†æ”¯ç‚¹ï¼‰ï¼Œä¸ºæ¯ä¸ªåç»§åˆ›å»ºæ–°é“¾
            // å…ˆä¿å­˜å½“å‰é“¾åˆ°åˆ†æ”¯ç‚¹
            const branchPoint = [...chain];
            
            children.forEach((child, idx) => {
              if (idx === 0) {
                // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ç»§ç»­å½“å‰é“¾
                buildChain(child, chain);
              } else {
                // å…¶ä»–å­èŠ‚ç‚¹å¼€å§‹æ–°é“¾ï¼ˆåŒ…å«çˆ¶èŠ‚ç‚¹è·¯å¾„ï¼‰
                visited.delete(child.name); // å…è®¸é‡æ–°è®¿é—®
                const newChain = [...branchPoint];
                buildChain(child, newChain);
              }
            });
          }
        };
        
        // ä»æ¯ä¸ªèµ·å§‹èŠ‚ç‚¹å¼€å§‹æ„å»º
        startNodes.forEach(startNode => {
          buildChain(startNode, []);
        });
        
        return chains;
      };

      // ä½¿ç”¨ç®€åŒ–çš„ç½‘æ ¼å¸ƒå±€
      const buildGridLayout = () => {
        if (!nodes || nodes.length === 0) return { grid: [], maxCol: 0 };
        
        // è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„åˆ—ä½ç½®ï¼ˆåŸºäºå±‚çº§ï¼‰
        const nodePositions = {};
        nodes.forEach(n => {
          nodePositions[n.name] = {
            node: n,
            col: nodeToLayer[n.name] || 0,
            row: -1
          };
        });
        
        // åˆ†é…è¡Œä½ç½®
        // ç­–ç•¥ï¼šåŒä¸€å‰ç½®èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å ç”¨ä¸åŒè¡Œï¼Œä½†åˆ†æ”¯å»¶ç»­åœ¨åŒä¸€è¡Œ
        let currentRow = 0;
        const assignRows = (nodeName, row) => {
          if (nodePositions[nodeName].row !== -1) return;
          nodePositions[nodeName].row = row;
          
          const children = nodes.filter(n => n.prevNode === nodeName);
          if (children.length === 1) {
            // å•ä¸€åç»§ï¼ŒåŒè¡Œå»¶ç»­
            assignRows(children[0].name, row);
          } else if (children.length > 1) {
            // å¤šä¸ªåç»§ï¼Œåˆ†é…ä¸åŒè¡Œ
            children.forEach((child, idx) => {
              if (idx === 0) {
                assignRows(child.name, row);
              } else {
                currentRow++;
                assignRows(child.name, currentRow);
              }
            });
          }
        };
        
        // ä»èµ·å§‹èŠ‚ç‚¹å¼€å§‹åˆ†é…
        const startNodes = nodes.filter(n => !n.prevNode);
        startNodes.forEach((startNode, idx) => {
          if (idx > 0) currentRow++;
          assignRows(startNode.name, currentRow);
        });
        
        // æ‰¾å‡ºæœ€å¤§åˆ—æ•°å’Œè¡Œæ•°
        const maxCol = Math.max(...Object.values(nodePositions).map(p => p.col)) + 1;
        const maxRow = Math.max(...Object.values(nodePositions).map(p => p.row)) + 1;
        
        // æ„å»ºç½‘æ ¼
        const grid = Array(maxRow).fill(null).map(() => Array(maxCol).fill(null));
        Object.values(nodePositions).forEach(pos => {
          if (pos.row >= 0 && pos.col >= 0) {
            grid[pos.row][pos.col] = pos.node;
          }
        });
        
        return { grid, maxCol, maxRow, nodePositions };
      };

      const { grid, maxCol, maxRow, nodePositions } = buildGridLayout();

      // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”»è¿æ¥çº¿
      const shouldDrawLine = (row, col) => {
        if (col >= maxCol - 1) return false;
        const currentNode = grid[row][col];
        const nextNode = grid[row][col + 1];
        if (!currentNode) return false;
        // æ£€æŸ¥ä¸‹ä¸€åˆ—æ˜¯å¦æœ‰èŠ‚ç‚¹æ˜¯å½“å‰èŠ‚ç‚¹çš„åç»§
        if (nextNode && nextNode.prevNode === currentNode.name) return true;
        // æˆ–è€…å½“å‰èŠ‚ç‚¹æœ‰åç»§åœ¨ä¸‹ä¸€åˆ—
        const hasChildInNextCol = nodes.some(n => n.prevNode === currentNode.name && nodePositions[n.name]?.col === col + 1);
        return hasChildInNextCol;
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center text-4xl">
                    {product.image}
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold">{product.name}</h2>
                    <div className="flex items-center gap-3 mt-1">
                      <span className="text-white/80 text-sm">{product.category}</span>
                      <span className="text-white/60 text-sm">|</span>
                      <span className="text-white/80 text-sm">ğŸ“ {autoCurrentStage}</span>
                      {product.ownerName && (
                        <>
                          <span className="text-white/60 text-sm">|</span>
                          <span className="flex items-center gap-1.5 text-sm text-white/90">
                            {ownerMember?.avatarUrl ? (
                              <img src={ownerMember.avatarUrl} alt="" className="w-5 h-5 rounded-full border border-white/30" />
                            ) : (
                              <span className="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center text-xs">
                                {product.ownerName.charAt(0)}
                              </span>
                            )}
                            ğŸ‘¤ {product.ownerName}
                          </span>
                        </>
                      )}
                    </div>
                  </div>
                </div>
                <button onClick={onClose} className="text-white/80 hover:text-white text-2xl">Ã—</button>
              </div>
            </div>

            <div className="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
              <div className="grid grid-cols-4 gap-4 mb-6">
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-blue-600">{product.progress}%</div>
                  <div className="text-sm text-gray-500">æ•´ä½“è¿›åº¦</div>
                </div>
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-green-600">
                    {productTasks.filter(t => t.status === 'å·²å®Œæˆ').length}
                  </div>
                  <div className="text-sm text-gray-500">å·²å®Œæˆ</div>
                </div>
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-orange-600">
                    {productTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length}
                  </div>
                  <div className="text-sm text-gray-500">è¿›è¡Œä¸­</div>
                </div>
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-gray-600">
                    {productTasks.filter(t => t.status === 'å¾…å¼€å§‹' || t.status === 'æœªå¼€å§‹').length}
                  </div>
                  <div className="text-sm text-gray-500">å¾…å¼€å§‹</div>
                </div>
              </div>

              <div className="mb-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">ğŸ“ˆ æµç¨‹è¿›åº¦</h3>
                <div className="bg-gray-50 rounded-xl p-4 overflow-x-auto">
                  <div className="min-w-max">
                    {/* ç½‘æ ¼å¸ƒå±€ */}
                    {grid.map((row, rowIndex) => (
                      <div key={rowIndex} className="flex items-center mb-3 last:mb-0">
                        {row.map((node, colIndex) => (
                          <div key={colIndex} className="flex items-center">
                            {/* èŠ‚ç‚¹å•å…ƒæ ¼ */}
                            <div className="w-24 flex flex-col items-center">
                              {node ? (
                                <div 
                                  className="flex flex-col items-center cursor-pointer group relative"
                                  onClick={() => setSelectedNode(node)}
                                >
                                  <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all group-hover:scale-110 group-hover:shadow-lg ${
                                    getNodeStatus(node.name) === 'skipped' ? 'bg-yellow-100 text-yellow-600 border-2 border-dashed border-yellow-400' :
                                    getNodeStatus(node.name) === 'completed' ? 'bg-green-500 text-white group-hover:bg-green-600' :
                                    getNodeStatus(node.name) === 'inProgress' ? 'bg-red-500 text-white ring-4 ring-red-200 group-hover:bg-red-600' :
                                    'bg-gray-200 text-gray-400 group-hover:bg-gray-300'
                                  }`}>
                                    {getNodeStatus(node.name) === 'completed' ? 'âœ“' : 
                                     getNodeStatus(node.name) === 'skipped' ? 'â­' : node.order}
                                  </div>
                                  <div className={`text-xs mt-1 text-center leading-tight group-hover:font-semibold ${
                                    getNodeStatus(node.name) === 'skipped' ? 'text-yellow-600 line-through' :
                                    getNodeStatus(node.name) === 'inProgress' ? 'text-red-600 font-semibold' :
                                    getNodeStatus(node.name) === 'completed' ? 'text-green-600' : 'text-gray-500'
                                  }`}>
                                    {node.name}
                                  </div>
                                  {/* ä»»åŠ¡æ•°é‡æç¤º */}
                                  {(() => {
                                    const nodeTaskCount = productTasks.filter(t => t.stage === node.name).length;
                                    if (nodeTaskCount > 0) {
                                      return (
                                        <div className="text-xs text-purple-500 mt-0.5 opacity-70 group-hover:opacity-100">
                                          {nodeTaskCount} ä»»åŠ¡
                                        </div>
                                      );
                                    }
                                    return null;
                                  })()}
                                  {/* è·³è¿‡æŒ‰é’® - ä»…é¡¹ç›®è´Ÿè´£äººå¯è§ */}
                                  {isProjectOwner && getNodeStatus(node.name) === 'pending' && (
                                    <button
                                      onClick={(e) => handleSkipNode(node.name, e)}
                                      className="absolute -top-1 -right-1 w-4 h-4 bg-yellow-400 text-white rounded-full text-[8px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-yellow-500"
                                      title="è·³è¿‡æ­¤èŠ‚ç‚¹"
                                    >
                                      â­
                                    </button>
                                  )}
                                  {/* å–æ¶ˆè·³è¿‡æŒ‰é’® */}
                                  {isProjectOwner && getNodeStatus(node.name) === 'skipped' && (
                                    <button
                                      onClick={(e) => handleSkipNode(node.name, e)}
                                      className="absolute -top-1 -right-1 w-4 h-4 bg-gray-400 text-white rounded-full text-[8px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity hover:bg-gray-500"
                                      title="å–æ¶ˆè·³è¿‡"
                                    >
                                      â†©
                                    </button>
                                  )}
                                </div>
                              ) : (
                                <div className="w-10 h-10"></div>
                              )}
                            </div>
                            {/* è¿æ¥çº¿ */}
                            {colIndex < maxCol - 1 && (
                              <div className="w-8 flex items-center justify-center">
                                {node && shouldDrawLine(rowIndex, colIndex) ? (
                                  <div className={`w-full h-0.5 ${
                                    getNodeStatus(node.name) === 'completed' ? 'bg-green-400' : 
                                    getNodeStatus(node.name) === 'inProgress' ? 'bg-red-400' : 'bg-gray-300'
                                  }`}></div>
                                ) : (
                                  <div className="w-full h-0.5 bg-transparent"></div>
                                )}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    ))}
                  </div>
                </div>
                
                {/* å›¾ä¾‹ */}
                <div className="flex gap-4 mt-3 text-xs text-gray-500 items-center justify-between">
                  <div className="flex gap-4">
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-green-500"></span> å·²å®Œæˆ
                    </span>
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-red-500 ring-2 ring-red-200"></span> è¿›è¡Œä¸­
                    </span>
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-gray-200"></span> å¾…å¼€å§‹
                    </span>
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-yellow-100 border border-dashed border-yellow-400"></span> å·²è·³è¿‡
                    </span>
                  </div>
                  <span className="text-purple-500">ğŸ’¡ ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…{isProjectOwner && ' | æ‚¬æµ®èŠ‚ç‚¹å¯è·³è¿‡'}</span>
                </div>
              </div>

              <div>
                <h3 className="text-lg font-semibold text-gray-800 mb-4">ğŸ“… é¡¹ç›®ç”˜ç‰¹å›¾</h3>
                {productTasks.length > 0 ? (
                  <GanttChart tasks={productTasks} members={members} product={product} />
                ) : (
                  <div className="text-center text-gray-400 py-8 bg-gray-50 rounded-xl">
                    æš‚æ— ä»»åŠ¡æ•°æ®
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* èŠ‚ç‚¹ä»»åŠ¡è¯¦æƒ…å¼¹çª— */}
          {selectedNode && (
            <NodeTaskModal
              node={selectedNode}
              tasks={productTasks}
              members={members}
              product={product}
              nodeRecordId={selectedNode.id}
              nodes={nodes}
              skippedNodes={skippedNodes}
              onClose={() => setSelectedNode(null)}
              onTaskCreated={onRefresh}
            />
          )}
        </div>
      );
    };

    // OKR è§†å›¾ç»„ä»¶ - å±•ç¤ºç›®æ ‡ â†’ å…³é”®ç»“æœ â†’ é¡¹ç›®çš„å±‚çº§å…³ç³»
    const OKROverview = ({ objectives, keyResults, products, onRefresh }) => {
      const [expandedObjectives, setExpandedObjectives] = useState(new Set(objectives.map(o => o.id)));
      const [expandedKRs, setExpandedKRs] = useState(new Set());
      const [showAddObjective, setShowAddObjective] = useState(false);
      const [showAddKR, setShowAddKR] = useState(null); // objectiveId
      const [editingObjective, setEditingObjective] = useState(null);
      const [editingKR, setEditingKR] = useState(null);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [showAddProject, setShowAddProject] = useState(null); // krId
      const showToast = useToast();
      
      // è¡¨å•æ•°æ®
      const [objectiveForm, setObjectiveForm] = useState({
        name: '', cycle: 'Q1 2026', level: 'å…¬å¸çº§', status: 'è¿›è¡Œä¸­'
      });
      const [krForm, setKRForm] = useState({
        name: '', target: 100, current: 0, weight: 1, status: 'æœªå¼€å§‹', objectiveId: ''
      });
      const [projectForm, setProjectForm] = useState({
        name: '', category: 'æ–°å“å¼€å‘', targetDate: ''
      });

      // åˆ›å»ºæ–°é¡¹ç›®å¹¶å…³è”åˆ° KR
      const handleCreateProject = async (krId) => {
        if (!projectForm.name.trim()) {
          showToast?.('è¯·è¾“å…¥é¡¹ç›®åç§°', 'error');
          return;
        }
        setIsSubmitting(true);
        try {
          const fields = {
            'é¡¹ç›®åç§°': projectForm.name,
            'é¡¹ç›®ç±»å‹': projectForm.category,
            'é¡¹ç›®çŠ¶æ€': 'æœªå¼€å§‹',
            'å…³è”KR': { link_record_ids: [krId] }
          };
          if (projectForm.targetDate) {
            fields['è®¡åˆ’ä¸Šçº¿æ—¥æœŸ'] = new Date(projectForm.targetDate).getTime();
          }
          
          const res = await fetch(API_BASE + '/api/create-record', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblYM02NyVj3rUkR',
              fields: fields
            })
          });
          const result = await res.json();
          if (result.success) {
            showToast?.('é¡¹ç›®åˆ›å»ºæˆåŠŸ', 'success');
            setShowAddProject(null);
            setProjectForm({ name: '', category: 'æ–°å“å¼€å‘', targetDate: '' });
            if (onRefresh) onRefresh();
          } else {
            throw new Error(result.error || 'åˆ›å»ºå¤±è´¥');
          }
        } catch (err) {
          showToast?.('åˆ›å»ºå¤±è´¥: ' + err.message, 'error');
        }
        setIsSubmitting(false);
      };

      // åˆ‡æ¢ç›®æ ‡å±•å¼€çŠ¶æ€
      const toggleObjective = (id) => {
        setExpandedObjectives(prev => {
          const next = new Set(prev);
          if (next.has(id)) next.delete(id);
          else next.add(id);
          return next;
        });
      };

      // åˆ‡æ¢ KR å±•å¼€çŠ¶æ€
      const toggleKR = (id) => {
        setExpandedKRs(prev => {
          const next = new Set(prev);
          if (next.has(id)) next.delete(id);
          else next.add(id);
          return next;
        });
      };

      // è·å–æŸç›®æ ‡ä¸‹çš„å…³é”®ç»“æœ
      const getKRsForObjective = (objectiveId) => {
        return keyResults.filter(kr => kr.objectiveId === objectiveId);
      };

      // è·å–æŸ KR ä¸‹çš„é¡¹ç›®
      const getProjectsForKR = (krId) => {
        return products.filter(p => p.krId === krId);
      };

      // è®¡ç®— KR çš„è‡ªåŠ¨è¿›åº¦å’ŒçŠ¶æ€ï¼ˆåŸºäºå…³è”é¡¹ç›®å®Œæˆæƒ…å†µï¼‰
      const getKRAutoProgress = (kr) => {
        const relatedProjects = getProjectsForKR(kr.id);
        
        if (relatedProjects.length > 0) {
          // æœ‰å…³è”é¡¹ç›®ï¼šå½“å‰å€¼ = å·²å®Œæˆé¡¹ç›®æ•°
          const completedCount = relatedProjects.filter(p => 
            p.progress >= 100 || p.status === 'å·²å®Œæˆ'
          ).length;
          const inProgressCount = relatedProjects.filter(p => 
            p.progress > 0 && p.progress < 100 && p.status !== 'å·²å®Œæˆ'
          ).length;
          const progress = kr.target > 0 ? Math.min(100, Math.round((completedCount / kr.target) * 100)) : 0;
          
          // è‡ªåŠ¨è®¡ç®—çŠ¶æ€
          let autoStatus = 'æœªå¼€å§‹';
          if (completedCount >= kr.target || completedCount >= relatedProjects.length) {
            // æ‰€æœ‰å…³è”é¡¹ç›®éƒ½å®Œæˆï¼Œæˆ–å·²å®Œæˆæ•°é‡è¾¾åˆ°ç›®æ ‡å€¼
            autoStatus = 'å·²å®Œæˆ';
          } else if (inProgressCount > 0 || completedCount > 0) {
            // æœ‰è¿›è¡Œä¸­çš„é¡¹ç›®ï¼Œæˆ–éƒ¨åˆ†å·²å®Œæˆ
            autoStatus = 'è¿›è¡Œä¸­';
          }
          
          return {
            current: completedCount,
            progress: progress,
            autoCalculated: true,
            totalProjects: relatedProjects.length,
            completedProjects: completedCount,
            inProgressProjects: inProgressCount,
            autoStatus: autoStatus
          };
        } else {
          // æ— å…³è”é¡¹ç›®ï¼šä½¿ç”¨æ‰‹åŠ¨å¡«å†™çš„å€¼å’ŒçŠ¶æ€
          const progress = kr.target > 0 ? Math.min(100, Math.round((kr.current / kr.target) * 100)) : 0;
          return {
            current: kr.current,
            progress: progress,
            autoCalculated: false,
            totalProjects: 0,
            completedProjects: 0,
            inProgressProjects: 0,
            autoStatus: kr.status // ä¿æŒæ‰‹åŠ¨è®¾ç½®çš„çŠ¶æ€
          };
        }
      };

      // è®¡ç®—ç›®æ ‡è¿›åº¦å’ŒçŠ¶æ€ï¼ˆåŸºäº KR è¿›åº¦åŠ æƒå¹³å‡ï¼‰
      const calculateObjectiveProgressAndStatus = (objectiveId) => {
        const krs = getKRsForObjective(objectiveId);
        if (krs.length === 0) {
          return { progress: 0, autoStatus: 'æœªå¼€å§‹' };
        }
        
        const totalWeight = krs.reduce((sum, kr) => sum + (kr.weight || 1), 0);
        let allCompleted = true;
        let hasInProgress = false;
        
        const weightedProgress = krs.reduce((sum, kr) => {
          const krAuto = getKRAutoProgress(kr);
          
          // æ£€æŸ¥ KR çŠ¶æ€
          if (krAuto.autoStatus === 'å·²å®Œæˆ') {
            // å·²å®Œæˆ
          } else if (krAuto.autoStatus === 'è¿›è¡Œä¸­') {
            allCompleted = false;
            hasInProgress = true;
          } else {
            allCompleted = false;
          }
          
          return sum + krAuto.progress * (kr.weight || 1);
        }, 0);
        
        const progress = Math.round(weightedProgress / totalWeight);
        
        // è‡ªåŠ¨è®¡ç®—ç›®æ ‡çŠ¶æ€
        let autoStatus = 'æœªå¼€å§‹';
        if (allCompleted && krs.length > 0) {
          autoStatus = 'å·²å®Œæˆ';
        } else if (hasInProgress) {
          autoStatus = 'è¿›è¡Œä¸­';
        }
        
        return { progress, autoStatus };
      };

      // åˆ›å»ºç›®æ ‡
      const handleCreateObjective = async (e) => {
        e.preventDefault();
        if (!objectiveForm.name.trim()) return alert('è¯·è¾“å…¥ç›®æ ‡åç§°');
        
        setIsSubmitting(true);
        try {
          const res = await fetch(API_BASE + '/api/create-objective', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tbl9TX3RZdLRlEy0',
              objective: objectiveForm
            })
          });
          const result = await res.json();
          if (result.success) {
            alert('âœ… ç›®æ ‡åˆ›å»ºæˆåŠŸï¼');
            setShowAddObjective(false);
            setObjectiveForm({ name: '', cycle: 'Q1 2026', level: 'å…¬å¸çº§', status: 'è¿›è¡Œä¸­' });
            onRefresh();
          } else {
            throw new Error(result.error);
          }
        } catch (err) {
          alert('âŒ åˆ›å»ºå¤±è´¥: ' + err.message);
        }
        setIsSubmitting(false);
      };

      // æ›´æ–°ç›®æ ‡
      const handleUpdateObjective = async (e) => {
        e.preventDefault();
        setIsSubmitting(true);
        try {
          const res = await fetch(API_BASE + '/api/update-objective', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tbl9TX3RZdLRlEy0',
              record_id: editingObjective.id,
              objective: objectiveForm
            })
          });
          const result = await res.json();
          if (result.success) {
            alert('âœ… ç›®æ ‡æ›´æ–°æˆåŠŸï¼');
            setEditingObjective(null);
            onRefresh();
          } else {
            throw new Error(result.error);
          }
        } catch (err) {
          alert('âŒ æ›´æ–°å¤±è´¥: ' + err.message);
        }
        setIsSubmitting(false);
      };

      // åˆ›å»ºå…³é”®ç»“æœ
      const handleCreateKR = async (e) => {
        e.preventDefault();
        if (!krForm.name.trim()) return alert('è¯·è¾“å…¥å…³é”®ç»“æœæè¿°');
        
        setIsSubmitting(true);
        try {
          const res = await fetch(API_BASE + '/api/create-kr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblW7yKqbgxH0bZV',
              kr: { ...krForm, objectiveId: showAddKR }
            })
          });
          const result = await res.json();
          if (result.success) {
            alert('âœ… å…³é”®ç»“æœåˆ›å»ºæˆåŠŸï¼');
            setShowAddKR(null);
            setKRForm({ name: '', target: 100, current: 0, weight: 1, status: 'æœªå¼€å§‹', objectiveId: '' });
            onRefresh();
          } else {
            throw new Error(result.error);
          }
        } catch (err) {
          alert('âŒ åˆ›å»ºå¤±è´¥: ' + err.message);
        }
        setIsSubmitting(false);
      };

      // æ›´æ–°å…³é”®ç»“æœ
      const handleUpdateKR = async (e) => {
        e.preventDefault();
        setIsSubmitting(true);
        try {
          const res = await fetch(API_BASE + '/api/update-kr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblW7yKqbgxH0bZV',
              record_id: editingKR.id,
              kr: krForm
            })
          });
          const result = await res.json();
          if (result.success) {
            alert('âœ… å…³é”®ç»“æœæ›´æ–°æˆåŠŸï¼');
            setEditingKR(null);
            onRefresh();
          } else {
            throw new Error(result.error);
          }
        } catch (err) {
          alert('âŒ æ›´æ–°å¤±è´¥: ' + err.message);
        }
        setIsSubmitting(false);
      };

      // å¼€å§‹ç¼–è¾‘ç›®æ ‡
      const startEditObjective = (obj) => {
        setEditingObjective(obj);
        setObjectiveForm({
          name: obj.name,
          cycle: obj.cycle || 'Q1 2026',
          level: obj.level || 'å…¬å¸çº§',
          status: obj.status || 'è¿›è¡Œä¸­'
        });
      };

      // å¼€å§‹ç¼–è¾‘ KR
      const startEditKR = (kr) => {
        setEditingKR(kr);
        setKRForm({
          name: kr.name,
          target: kr.target || 100,
          current: kr.current || 0,
          weight: kr.weight || 1,
          status: kr.status || 'æœªå¼€å§‹'
        });
      };

      // è¿›åº¦é¢œè‰²
      const getProgressColor = (progress) => {
        if (progress >= 80) return 'bg-green-500';
        if (progress >= 50) return 'bg-blue-500';
        if (progress >= 20) return 'bg-yellow-500';
        return 'bg-gray-300';
      };

      // çŠ¶æ€é¢œè‰²
      const getStatusColor = (status) => {
        switch (status) {
          case 'å·²å®Œæˆ': return 'bg-green-100 text-green-700';
          case 'è¿›è¡Œä¸­': return 'bg-blue-100 text-blue-700';
          case 'æœ‰é£é™©': return 'bg-red-100 text-red-700';
          default: return 'bg-gray-100 text-gray-600';
        }
      };

      return (
        <div className="space-y-4">
          {/* é¡¶éƒ¨æ“ä½œæ  */}
          <div className="flex items-center justify-between bg-white rounded-xl p-4 shadow-sm">
            <div>
              <h2 className="text-lg font-bold text-gray-800">ğŸ¯ OKR ç›®æ ‡ç®¡ç†</h2>
              <p className="text-sm text-gray-500 mt-1">ç›®æ ‡ â†’ å…³é”®ç»“æœ â†’ é¡¹ç›® å±‚çº§è§†å›¾</p>
            </div>
            <button
              onClick={() => setShowAddObjective(true)}
              className="px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg hover:opacity-90 transition-opacity flex items-center gap-2"
            >
              â• æ–°å»ºç›®æ ‡
            </button>
          </div>

          {/* æ–°å»ºç›®æ ‡è¡¨å• */}
          {showAddObjective && (
            <div className="bg-purple-50 rounded-xl p-5 border border-purple-200">
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-purple-700">ğŸ¯ æ–°å»ºç›®æ ‡</h3>
                <button onClick={() => setShowAddObjective(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
              </div>
              <form onSubmit={handleCreateObjective} className="space-y-4">
                <div>
                  <label className="block text-sm text-gray-600 mb-1">ç›®æ ‡åç§° *</label>
                  <input
                    type="text"
                    value={objectiveForm.name}
                    onChange={e => setObjectiveForm({ ...objectiveForm, name: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-300 outline-none"
                    placeholder="ä¾‹å¦‚ï¼šæå‡äº§å“å¸‚åœºç«äº‰åŠ›"
                    required
                  />
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">ç›®æ ‡å‘¨æœŸ</label>
                    <select
                      value={objectiveForm.cycle}
                      onChange={e => setObjectiveForm({ ...objectiveForm, cycle: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-300 outline-none"
                    >
                      <option>Q1 2026</option>
                      <option>Q2 2026</option>
                      <option>Q3 2026</option>
                      <option>Q4 2026</option>
                      <option>2026å¹´åº¦</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">ç›®æ ‡å±‚çº§</label>
                    <select
                      value={objectiveForm.level}
                      onChange={e => setObjectiveForm({ ...objectiveForm, level: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-300 outline-none"
                    >
                      <option>å…¬å¸çº§</option>
                      <option>éƒ¨é—¨çº§</option>
                      <option>å›¢é˜Ÿçº§</option>
                      <option>ä¸ªäººçº§</option>
                    </select>
                  </div>
                </div>
                <div className="text-xs text-purple-600 bg-purple-100 px-3 py-2 rounded-lg">
                  ğŸ’¡ çŠ¶æ€è‡ªåŠ¨è®¡ç®—ï¼šæœ‰è¿›è¡Œä¸­çš„KRâ†’è¿›è¡Œä¸­ï¼Œæ‰€æœ‰KRå®Œæˆâ†’å·²å®Œæˆ
                </div>
                <div className="flex gap-2 pt-2">
                  <button type="button" onClick={() => setShowAddObjective(false)} className="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">å–æ¶ˆ</button>
                  <button type="submit" disabled={isSubmitting} className="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:opacity-50">
                    {isSubmitting ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºç›®æ ‡'}
                  </button>
                </div>
              </form>
            </div>
          )}

          {/* ç›®æ ‡åˆ—è¡¨ */}
          {objectives.length === 0 ? (
            <div className="bg-white rounded-xl p-12 text-center">
              <div className="text-6xl mb-4">ğŸ¯</div>
              <div className="text-gray-500 mb-4">æš‚æ— ç›®æ ‡ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªç›®æ ‡</div>
            </div>
          ) : (
            <div className="space-y-4">
              {objectives.map(objective => {
                const krs = getKRsForObjective(objective.id);
                const { progress, autoStatus } = calculateObjectiveProgressAndStatus(objective.id);
                const isExpanded = expandedObjectives.has(objective.id);
                const isEditing = editingObjective?.id === objective.id;

                return (
                  <div key={objective.id} className="bg-white rounded-xl shadow-sm overflow-hidden">
                    {/* ç›®æ ‡å¤´éƒ¨ */}
                    <div 
                      className="p-4 cursor-pointer hover:bg-gray-50 transition-colors"
                      onClick={() => !isEditing && toggleObjective(objective.id)}
                    >
                      {isEditing ? (
                        <form onSubmit={handleUpdateObjective} className="space-y-4" onClick={e => e.stopPropagation()}>
                          <div>
                            <input
                              type="text"
                              value={objectiveForm.name}
                              onChange={e => setObjectiveForm({ ...objectiveForm, name: e.target.value })}
                              className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-300 outline-none text-lg font-semibold"
                            />
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <select
                              value={objectiveForm.cycle}
                              onChange={e => setObjectiveForm({ ...objectiveForm, cycle: e.target.value })}
                              className="px-3 py-2 border rounded-lg text-sm"
                            >
                              <option>Q1 2026</option>
                              <option>Q2 2026</option>
                              <option>Q3 2026</option>
                              <option>Q4 2026</option>
                              <option>2026å¹´åº¦</option>
                            </select>
                            <select
                              value={objectiveForm.level}
                              onChange={e => setObjectiveForm({ ...objectiveForm, level: e.target.value })}
                              className="px-3 py-2 border rounded-lg text-sm"
                            >
                              <option>å…¬å¸çº§</option>
                              <option>éƒ¨é—¨çº§</option>
                              <option>å›¢é˜Ÿçº§</option>
                              <option>ä¸ªäººçº§</option>
                            </select>
                          </div>
                          <div className="text-xs text-gray-500">ğŸ’¡ çŠ¶æ€æ ¹æ®å…³é”®ç»“æœè‡ªåŠ¨è®¡ç®—ï¼šæœ‰è¿›è¡Œä¸­KRâ†’è¿›è¡Œä¸­ï¼Œå…¨éƒ¨KRå®Œæˆâ†’å·²å®Œæˆ</div>
                          <div className="flex gap-2">
                            <button type="button" onClick={() => setEditingObjective(null)} className="px-3 py-1.5 border rounded-lg text-sm hover:bg-gray-50">å–æ¶ˆ</button>
                            <button type="submit" disabled={isSubmitting} className="px-3 py-1.5 bg-purple-500 text-white rounded-lg text-sm hover:bg-purple-600 disabled:opacity-50">
                              {isSubmitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
                            </button>
                          </div>
                        </form>
                      ) : (
                        <div className="flex items-center gap-4">
                          <div className="text-xl">{isExpanded ? 'â–¼' : 'â–¶'}</div>
                          <div className="flex-1">
                            <div className="flex items-center gap-3">
                              <span className="text-2xl">ğŸ¯</span>
                              <h3 className="text-lg font-bold text-gray-800">{objective.name}</h3>
                              <span className={`text-xs px-2 py-0.5 rounded-full ${getStatusColor(autoStatus)}`}>
                                {autoStatus}
                                {krs.length > 0 && <span className="ml-1">ğŸ”„</span>}
                              </span>
                            </div>
                            <div className="flex items-center gap-4 mt-2 text-sm text-gray-500">
                              <span>ğŸ“… {objective.cycle || 'æœªè®¾ç½®å‘¨æœŸ'}</span>
                              <span>ğŸ“Š {objective.level || 'æœªè®¾ç½®å±‚çº§'}</span>
                              <span>ğŸ”‘ {krs.length} ä¸ªå…³é”®ç»“æœ</span>
                            </div>
                          </div>
                          <div className="text-right">
                            <div className="text-2xl font-bold text-purple-600">{progress}%</div>
                            <div className="w-32 h-2 bg-gray-200 rounded-full mt-1 overflow-hidden">
                              <div className={`h-full ${getProgressColor(progress)} transition-all`} style={{ width: `${progress}%` }} />
                            </div>
                          </div>
                          <button
                            onClick={(e) => { e.stopPropagation(); startEditObjective(objective); }}
                            className="p-2 text-gray-400 hover:text-purple-600 hover:bg-purple-50 rounded-lg"
                          >
                            âœï¸
                          </button>
                        </div>
                      )}
                    </div>

                    {/* å…³é”®ç»“æœåˆ—è¡¨ */}
                    {isExpanded && !isEditing && (
                      <div className="border-t bg-gray-50 p-4">
                        {/* æ·»åŠ  KR æŒ‰é’® */}
                        <div className="flex items-center justify-between mb-3">
                          <h4 className="text-sm font-semibold text-gray-600">ğŸ”‘ å…³é”®ç»“æœ ({krs.length})</h4>
                          <button
                            onClick={() => setShowAddKR(objective.id)}
                            className="text-xs px-3 py-1.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                          >
                            â• æ·»åŠ  KR
                          </button>
                        </div>

                        {/* æ–°å»º KR è¡¨å• */}
                        {showAddKR === objective.id && (
                          <div className="bg-blue-50 rounded-lg p-4 mb-4 border border-blue-200">
                            <form onSubmit={handleCreateKR} className="space-y-3">
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">å…³é”®ç»“æœæè¿° *</label>
                                <input
                                  type="text"
                                  value={krForm.name}
                                  onChange={e => setKRForm({ ...krForm, name: e.target.value })}
                                  className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-300 outline-none"
                                  placeholder="ä¾‹å¦‚ï¼šæ–°å“ä¸Šçº¿æ•°é‡è¾¾åˆ° 10 ä¸ª"
                                  required
                                />
                              </div>
                              <div className="grid grid-cols-2 gap-3">
                                <div>
                                  <label className="block text-xs text-gray-600 mb-1">ç›®æ ‡å€¼ *</label>
                                  <input
                                    type="number"
                                    value={krForm.target}
                                    onChange={e => setKRForm({ ...krForm, target: Number(e.target.value) })}
                                    className="w-full px-3 py-2 border rounded-lg text-sm"
                                    placeholder="å¦‚: 5"
                                    required
                                  />
                                  <div className="text-xs text-gray-400 mt-1">éœ€å®Œæˆçš„é¡¹ç›®æ•°é‡</div>
                                </div>
                                <div>
                                  <label className="block text-xs text-gray-600 mb-1">æƒé‡</label>
                                  <input
                                    type="number"
                                    value={krForm.weight}
                                    onChange={e => setKRForm({ ...krForm, weight: Number(e.target.value) })}
                                    className="w-full px-3 py-2 border rounded-lg text-sm"
                                    min="1" max="100"
                                  />
                                  <div className="text-xs text-gray-400 mt-1">å½±å“ç›®æ ‡æ•´ä½“è¿›åº¦</div>
                                </div>
                              </div>
                              <div className="text-xs text-blue-600 bg-blue-50 px-3 py-2 rounded-lg">
                                ğŸ’¡ <strong>è‡ªåŠ¨è®¡ç®—è§„åˆ™ï¼š</strong>
                                <br />â€¢ å½“å‰å€¼ = å…³è”é¡¹ç›®ä¸­å·²å®Œæˆçš„æ•°é‡
                                <br />â€¢ çŠ¶æ€ï¼šæ— é¡¹ç›®â†’æœªå¼€å§‹ï¼Œæœ‰è¿›è¡Œä¸­â†’è¿›è¡Œä¸­ï¼Œå…¨éƒ¨å®Œæˆâ†’å·²å®Œæˆ
                              </div>
                              <div className="flex gap-2">
                                <button type="button" onClick={() => setShowAddKR(null)} className="flex-1 px-3 py-2 border rounded-lg text-sm hover:bg-gray-50">å–æ¶ˆ</button>
                                <button type="submit" disabled={isSubmitting} className="flex-1 px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 disabled:opacity-50">
                                  {isSubmitting ? 'åˆ›å»ºä¸­...' : 'åˆ›å»º KR'}
                                </button>
                              </div>
                            </form>
                          </div>
                        )}

                        {/* KR åˆ—è¡¨ */}
                        {krs.length === 0 ? (
                          <div className="text-center py-6 text-gray-400 text-sm">
                            æš‚æ— å…³é”®ç»“æœï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ 
                          </div>
                        ) : (
                          <div className="space-y-3">
                            {krs.map(kr => {
                              const krAuto = getKRAutoProgress(kr);
                              const krProgress = krAuto.progress;
                              const krCurrent = krAuto.current;
                              const krProjects = getProjectsForKR(kr.id);
                              const isKRExpanded = expandedKRs.has(kr.id);
                              const isKREditing = editingKR?.id === kr.id;

                              return (
                                <div key={kr.id} className="bg-white rounded-lg border overflow-hidden">
                                  {/* KR å¤´éƒ¨ */}
                                  <div 
                                    className="p-3 cursor-pointer hover:bg-gray-50"
                                    onClick={() => !isKREditing && toggleKR(kr.id)}
                                  >
                                    {isKREditing ? (
                                      <form onSubmit={handleUpdateKR} className="space-y-3" onClick={e => e.stopPropagation()}>
                                        <input
                                          type="text"
                                          value={krForm.name}
                                          onChange={e => setKRForm({ ...krForm, name: e.target.value })}
                                          className="w-full px-3 py-2 border rounded-lg text-sm"
                                        />
                                        <div className="grid grid-cols-2 gap-3">
                                          <input
                                            type="number"
                                            value={krForm.target}
                                            onChange={e => setKRForm({ ...krForm, target: Number(e.target.value) })}
                                            className="px-3 py-2 border rounded-lg text-sm"
                                            placeholder="ç›®æ ‡å€¼"
                                          />
                                          <input
                                            type="number"
                                            value={krForm.weight}
                                            onChange={e => setKRForm({ ...krForm, weight: Number(e.target.value) })}
                                            className="px-3 py-2 border rounded-lg text-sm"
                                            placeholder="æƒé‡"
                                          />
                                        </div>
                                        <div className="text-xs text-gray-500">ğŸ’¡ çŠ¶æ€å’Œå½“å‰å€¼æ ¹æ®å…³è”é¡¹ç›®è‡ªåŠ¨è®¡ç®—</div>
                                        <div className="flex gap-2">
                                          <button type="button" onClick={() => setEditingKR(null)} className="px-3 py-1.5 border rounded text-xs hover:bg-gray-50">å–æ¶ˆ</button>
                                          <button type="submit" disabled={isSubmitting} className="px-3 py-1.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 disabled:opacity-50">
                                            {isSubmitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
                                          </button>
                                        </div>
                                      </form>
                                    ) : (
                                      <div className="flex items-center gap-3">
                                        <div className="text-sm text-gray-400">{isKRExpanded ? 'â–¼' : 'â–¶'}</div>
                                        <div className="flex-1">
                                          <div className="flex items-center gap-2">
                                            <span className="text-lg">ğŸ”‘</span>
                                            <span className="font-medium text-gray-800">{kr.name}</span>
                                            <span className={`text-xs px-2 py-0.5 rounded-full ${getStatusColor(krAuto.autoStatus)}`}>
                                              {krAuto.autoStatus}
                                              {krAuto.autoCalculated && <span className="ml-1">ğŸ”„</span>}
                                            </span>
                                            {kr.weight > 1 && (
                                              <span className="text-xs px-2 py-0.5 bg-purple-100 text-purple-600 rounded-full">
                                                æƒé‡ {kr.weight}
                                              </span>
                                            )}
                                          </div>
                                          <div className="flex items-center gap-4 mt-1 text-xs text-gray-500">
                                            <span>ç›®æ ‡: {kr.target}</span>
                                            <span className={krAuto.autoCalculated ? 'text-green-600 font-medium' : ''}>
                                              å½“å‰: {krCurrent}
                                            </span>
                                            <span>ğŸ“¦ {krProjects.length} ä¸ªé¡¹ç›® {krAuto.autoCalculated && `(${krAuto.completedProjects}å·²å®Œæˆ)`}</span>
                                          </div>
                                        </div>
                                        <div className="text-right">
                                          <div className="text-xl font-bold text-blue-600">{krProgress}%</div>
                                          <div className="w-24 h-1.5 bg-gray-200 rounded-full mt-1 overflow-hidden">
                                            <div className={`h-full ${getProgressColor(krProgress)} transition-all`} style={{ width: `${krProgress}%` }} />
                                          </div>
                                        </div>
                                        <button
                                          onClick={(e) => { e.stopPropagation(); startEditKR(kr); }}
                                          className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded"
                                        >
                                          âœï¸
                                        </button>
                                      </div>
                                    )}
                                  </div>

                                  {/* é¡¹ç›®åˆ—è¡¨ */}
                                  {isKRExpanded && !isKREditing && (
                                    <div className="border-t bg-gray-50 p-3">
                                      <div className="flex items-center justify-between mb-2">
                                        <div className="text-xs font-semibold text-gray-500">
                                          ğŸ“¦ å…³è”é¡¹ç›® ({krProjects.length}) 
                                          {krAuto.autoCalculated && (
                                            <span className="ml-2 text-green-600">
                                              âœ… {krAuto.completedProjects}/{krProjects.length} å·²å®Œæˆ
                                            </span>
                                          )}
                                        </div>
                                        <button
                                          onClick={(e) => { e.stopPropagation(); setShowAddProject(showAddProject === kr.id ? null : kr.id); }}
                                          className="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                                        >
                                          â• æ·»åŠ é¡¹ç›®
                                        </button>
                                      </div>
                                      
                                      {/* æ·»åŠ é¡¹ç›®è¡¨å• */}
                                      {showAddProject === kr.id && (
                                        <div className="bg-white rounded-lg border p-3 mb-3" onClick={e => e.stopPropagation()}>
                                          <div className="space-y-2">
                                            <input
                                              type="text"
                                              value={projectForm.name}
                                              onChange={e => setProjectForm({ ...projectForm, name: e.target.value })}
                                              className="w-full px-3 py-2 border rounded-lg text-sm"
                                              placeholder="é¡¹ç›®åç§° *"
                                            />
                                            <div className="grid grid-cols-2 gap-2">
                                              <select
                                                value={projectForm.category}
                                                onChange={e => setProjectForm({ ...projectForm, category: e.target.value })}
                                                className="px-3 py-2 border rounded-lg text-sm"
                                              >
                                                <option value="æ–°å“å¼€å‘">æ–°å“å¼€å‘</option>
                                                <option value="è¥é”€æ¨å¹¿">è¥é”€æ¨å¹¿</option>
                                                <option value="ä¾›åº”é“¾ä¼˜åŒ–">ä¾›åº”é“¾ä¼˜åŒ–</option>
                                                <option value="ç³»ç»Ÿå»ºè®¾">ç³»ç»Ÿå»ºè®¾</option>
                                              </select>
                                              <input
                                                type="date"
                                                value={projectForm.targetDate}
                                                onChange={e => setProjectForm({ ...projectForm, targetDate: e.target.value })}
                                                className="px-3 py-2 border rounded-lg text-sm"
                                                placeholder="è®¡åˆ’ä¸Šçº¿æ—¥æœŸ"
                                              />
                                            </div>
                                            <div className="flex gap-2">
                                              <button 
                                                onClick={() => setShowAddProject(null)} 
                                                className="px-3 py-1.5 border rounded text-xs hover:bg-gray-50"
                                              >
                                                å–æ¶ˆ
                                              </button>
                                              <button 
                                                onClick={() => handleCreateProject(kr.id)} 
                                                disabled={isSubmitting}
                                                className="px-3 py-1.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 disabled:opacity-50"
                                              >
                                                {isSubmitting ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºé¡¹ç›®'}
                                              </button>
                                            </div>
                                          </div>
                                        </div>
                                      )}
                                      
                                      {krProjects.length === 0 && showAddProject !== kr.id ? (
                                        <div className="text-xs text-gray-400 text-center py-3">
                                          æš‚æ— å…³è”é¡¹ç›® - ç‚¹å‡»ä¸Šæ–¹ã€Œæ·»åŠ é¡¹ç›®ã€åˆ›å»º
                                        </div>
                                      ) : (
                                        <div className="grid grid-cols-2 gap-2">
                                          {krProjects.map(project => {
                                            const isCompleted = project.progress >= 100 || project.status === 'å·²å®Œæˆ';
                                            return (
                                              <div key={project.id} className={`bg-white rounded-lg p-3 border flex items-center gap-3 ${isCompleted ? 'border-green-300 bg-green-50' : ''}`}>
                                                <span className="text-2xl">{project.image}</span>
                                                <div className="flex-1 min-w-0">
                                                  <div className="font-medium text-sm text-gray-800 truncate">{project.name}</div>
                                                  <div className="text-xs text-gray-500">{project.currentStage}</div>
                                                </div>
                                                <div className="text-right">
                                                  {isCompleted ? (
                                                    <div className="text-sm font-bold text-green-600">âœ… å®Œæˆ</div>
                                                  ) : (
                                                    <div className="text-sm font-bold text-blue-600">{project.progress}%</div>
                                                  )}
                                                </div>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      )}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      );
    };

    // äº§å“æ€»è§ˆ
    const ProductOverview = ({ products, nodes, nodeLayers, nodeMap, nodeToLayer, members, tasks, onRefresh }) => {
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [filterStatus, setFilterStatus] = useState('all');
      const [viewMode, setViewMode] = useState('grid');

      const filteredProducts = filterStatus === 'all'
        ? products
        : products.filter(p => p.status === filterStatus);

      // è‡ªåŠ¨è®¡ç®—æ¯ä¸ªäº§å“çš„å½“å‰é˜¶æ®µ
      const getProductAutoStage = (product) => {
        const productTasks = tasks.filter(t => t.productId === product.id);
        let lastActiveNode = null;
        for (const node of nodes) {
          const nodeTasks = productTasks.filter(t => t.stage === node.name);
          const hasActive = nodeTasks.some(t => t.status === 'è¿›è¡Œä¸­');
          const hasCompleted = nodeTasks.some(t => t.status === 'å·²å®Œæˆ');
          const hasIncomplete = nodeTasks.some(t => t.status !== 'å·²å®Œæˆ');
          if (hasActive || (hasCompleted && hasIncomplete)) {
            lastActiveNode = node.name;
          }
        }
        return lastActiveNode || product.currentStage;
      };

      const productsByStage = nodes.reduce((acc, node) => {
        acc[node.name] = products.filter(p => getProductAutoStage(p) === node.name);
        return acc;
      }, {});

      return (
        <div>
          <div className="flex items-center justify-between mb-6">
            <div className="flex gap-2">
              {['all', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'].map(status => (
                <button
                  key={status}
                  onClick={() => setFilterStatus(status)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                    filterStatus === status ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {status === 'all' ? 'å…¨éƒ¨äº§å“' : status}
                </button>
              ))}
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => setViewMode('grid')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                  viewMode === 'grid' ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-400'
                }`}
              >
                å¡ç‰‡
              </button>
              <button
                onClick={() => setViewMode('pipeline')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                  viewMode === 'pipeline' ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-400'
                }`}
              >
                ç®¡é“
              </button>
            </div>
          </div>

          {viewMode === 'grid' && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
              {filteredProducts.map(product => (
                <ProductCard
                  key={product.id}
                  product={product}
                  nodes={nodes}
                  members={members}
                  tasks={tasks}
                  onClick={setSelectedProduct}
                />
              ))}
              {filteredProducts.length === 0 && (
                <div className="col-span-full text-center text-gray-400 py-12">æš‚æ— äº§å“æ•°æ®</div>
              )}
            </div>
          )}

          {viewMode === 'pipeline' && (
            <div className="overflow-x-auto pb-4">
              <div className="flex gap-4 min-w-max">
                {nodes.map(node => (
                  <div key={node.id} className="w-64 flex-shrink-0">
                    <div className="bg-gray-100 rounded-t-xl px-4 py-3 flex items-center justify-between">
                      <span className="font-medium text-gray-700">{node.name}</span>
                      <span className="bg-white text-gray-500 text-sm px-2 py-0.5 rounded-full">
                        {productsByStage[node.name]?.length || 0}
                      </span>
                    </div>
                    <div className="bg-gray-50 rounded-b-xl p-3 min-h-[300px] space-y-3">
                      {productsByStage[node.name]?.map(product => (
                        <div
                          key={product.id}
                          className="bg-white rounded-lg p-3 card-shadow cursor-pointer hover:shadow-md"
                          onClick={() => setSelectedProduct(product)}
                        >
                          <div className="flex items-center gap-2 mb-2">
                            <span className="text-xl">{product.image}</span>
                            <div className="flex-1 min-w-0">
                              <div className="font-medium text-gray-800 text-sm truncate">{product.name}</div>
                            </div>
                          </div>
                          <div className="flex items-center justify-between">
                            <div className="h-1.5 flex-1 bg-gray-100 rounded-full overflow-hidden mr-2">
                              <div className="h-full bg-blue-500 rounded-full" style={{ width: `${product.progress}%` }} />
                            </div>
                            <span className="text-xs text-gray-500">{product.progress}%</span>
                          </div>
                        </div>
                      ))}
                      {(!productsByStage[node.name] || productsByStage[node.name].length === 0) && (
                        <div className="text-center text-gray-400 text-sm py-8">æš‚æ— äº§å“</div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {selectedProduct && (
            <ProductDetailModal
              product={selectedProduct}
              nodes={nodes}
              nodeLayers={nodeLayers}
              nodeMap={nodeMap}
              nodeToLayer={nodeToLayer}
              members={members}
              tasks={tasks}
              onClose={() => setSelectedProduct(null)}
              onRefresh={onRefresh}
            />
          )}
        </div>
      );
    };

    // äººå‘˜ä»»åŠ¡å¡ç‰‡
    const MemberTaskCard = ({ member, tasks, products }) => {
      const memberTasks = tasks.filter(t => t.assignee === member.id || t.assigneeName === member.name);
      const completedCount = memberTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
      const inProgressCount = memberTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
      const completionRate = memberTasks.length > 0 ? Math.round((completedCount / memberTasks.length) * 100) : 0;

      return (
        <div className="bg-white rounded-xl card-shadow overflow-hidden">
          <div className={`${member.color} p-4 text-white`}>
            <div className="flex items-center gap-3">
              {/* ä¼˜å…ˆä½¿ç”¨é£ä¹¦å¤´åƒï¼Œæ— åˆ™ä½¿ç”¨ emoji */}
              {member.avatarUrl ? (
                <img 
                  src={member.avatarUrl} 
                  alt={member.name}
                  className="w-12 h-12 rounded-full object-cover border-2 border-white/30"
                />
              ) : (
                <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-2xl">
                  {member.avatar}
                </div>
              )}
              <div>
                <div className="font-bold text-lg">{member.name}</div>
                <div className="text-white/80 text-sm">{member.position}</div>
                <div className="flex gap-2 mt-1">
                  <span className="text-white/60 text-xs bg-white/20 px-1.5 py-0.5 rounded">{member.department}</span>
                  <span className="text-white/60 text-xs bg-white/20 px-1.5 py-0.5 rounded">{member.group}</span>
                </div>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-3 divide-x border-b">
            <div className="p-3 text-center">
              <div className="text-xl font-bold text-gray-800">{memberTasks.length}</div>
              <div className="text-xs text-gray-500">æ€»ä»»åŠ¡</div>
            </div>
            <div className="p-3 text-center">
              <div className="text-xl font-bold text-blue-600">{inProgressCount}</div>
              <div className="text-xs text-gray-500">è¿›è¡Œä¸­</div>
            </div>
            <div className="p-3 text-center">
              <div className="text-xl font-bold text-green-600">{completedCount}</div>
              <div className="text-xs text-gray-500">å·²å®Œæˆ</div>
            </div>
          </div>

          <div className="px-4 py-3">
            <div className="flex items-center justify-between text-sm mb-1">
              <span className="text-gray-500">å®Œæˆç‡</span>
              <span className="font-medium">{completionRate}%</span>
            </div>
            <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
              <div className={`h-full ${member.color} rounded-full`} style={{ width: `${completionRate}%` }} />
            </div>
          </div>

          <div className="p-4 max-h-48 overflow-y-auto border-t">
            {memberTasks.slice(0, 5).map(task => {
              const product = products.find(p => p.id === task.productId);
              return (
                <div key={task.id} className="flex items-center justify-between py-2 border-b last:border-0">
                  <div className="flex-1 min-w-0">
                    <div className="text-sm text-gray-800 truncate">{task.name}</div>
                    <div className="text-xs text-gray-400">{product?.name}</div>
                  </div>
                  <span className={`text-xs px-2 py-0.5 rounded ml-2 ${
                    task.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-600' :
                    task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-100 text-blue-600' :
                    'bg-gray-100 text-gray-500'
                  }`}>
                    {task.status}
                  </span>
                </div>
              );
            })}
            {memberTasks.length === 0 && (
              <div className="text-center text-gray-400 py-4">æš‚æ— ä»»åŠ¡</div>
            )}
          </div>
        </div>
      );
    };

    // äººå‘˜ä»»åŠ¡æ€»è§ˆ - éƒ¨é—¨ä¸€çº§ + ç»„åˆ«äºŒçº§ç­›é€‰
    const TeamTaskOverview = ({ members, tasks, products, groups }) => {
      const [filterDept, setFilterDept] = useState('all'); // ä¸€çº§ï¼šéƒ¨é—¨
      const [filterGroup, setFilterGroup] = useState('all'); // äºŒçº§ï¼šç»„åˆ«
      const [viewMode, setViewMode] = useState('grid'); // grid | list

      // æå–æ‰€æœ‰éƒ¨é—¨
      const departments = [...new Set(members.map(m => m.department).filter(d => d))];
      
      // æ ¹æ®é€‰ä¸­çš„éƒ¨é—¨ï¼Œè·å–è¯¥éƒ¨é—¨ä¸‹çš„ç»„åˆ«
      const availableGroups = filterDept === 'all' 
        ? groups 
        : [...new Set(members.filter(m => m.department === filterDept).map(m => m.group).filter(g => g))];

      // å½“éƒ¨é—¨æ”¹å˜æ—¶ï¼Œé‡ç½®ç»„åˆ«ç­›é€‰
      const handleDeptChange = (dept) => {
        setFilterDept(dept);
        setFilterGroup('all');
      };

      // ç­›é€‰æˆå‘˜ï¼šå…ˆæŒ‰éƒ¨é—¨ï¼Œå†æŒ‰ç»„åˆ«
      const filteredMembers = members.filter(m => {
        const deptMatch = filterDept === 'all' || m.department === filterDept;
        const groupMatch = filterGroup === 'all' || m.group === filterGroup;
        return deptMatch && groupMatch;
      });

      return (
        <div>
          {/* ä¸€çº§ç­›é€‰ï¼šéƒ¨é—¨ */}
          <div className="mb-4">
            <div className="text-sm text-gray-500 mb-2">ğŸ“‚ éƒ¨é—¨</div>
            <div className="flex gap-2 flex-wrap">
              <button
                onClick={() => handleDeptChange('all')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                  filterDept === 'all' ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                }`}
              >
                å…¨éƒ¨éƒ¨é—¨
              </button>
              {departments.map(dept => (
                <button
                  key={dept}
                  onClick={() => handleDeptChange(dept)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                    filterDept === dept ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {dept}
                </button>
              ))}
            </div>
          </div>

          {/* äºŒçº§ç­›é€‰ï¼šç»„åˆ« */}
          <div className="mb-4">
            <div className="text-sm text-gray-500 mb-2">ğŸ‘¥ ç»„åˆ«</div>
            <div className="flex gap-2 flex-wrap items-center">
              <button
                onClick={() => setFilterGroup('all')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                  filterGroup === 'all' ? 'bg-purple-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                }`}
              >
                å…¨éƒ¨ç»„åˆ«
              </button>
              {availableGroups.map(group => (
                <button
                  key={group}
                  onClick={() => setFilterGroup(group)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                    filterGroup === group ? 'bg-purple-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {group}
                </button>
              ))}
              {availableGroups.length === 0 && filterDept !== 'all' && (
                <span className="text-sm text-gray-400">è¯¥éƒ¨é—¨æš‚æ— ç»„åˆ«</span>
              )}
            </div>
          </div>

          {/* è§†å›¾åˆ‡æ¢å’Œç»Ÿè®¡ */}
          <div className="flex items-center justify-between mb-6">
            <div className="text-sm text-gray-500">
              å…± <span className="font-medium text-gray-800">{filteredMembers.length}</span> åæˆå‘˜
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => setViewMode('grid')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                  viewMode === 'grid' ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-400'
                }`}
              >
                å¡ç‰‡
              </button>
              <button
                onClick={() => setViewMode('list')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                  viewMode === 'list' ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-400'
                }`}
              >
                åˆ—è¡¨
              </button>
            </div>
          </div>

          {/* å¡ç‰‡è§†å›¾ */}
          {viewMode === 'grid' && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {filteredMembers.map(member => (
                <MemberTaskCard
                  key={member.id}
                  member={member}
                  tasks={tasks}
                  products={products}
                />
              ))}
              {filteredMembers.length === 0 && (
                <div className="col-span-full text-center text-gray-400 py-12">æš‚æ— æˆå‘˜æ•°æ®</div>
              )}
            </div>
          )}

          {/* åˆ—è¡¨è§†å›¾ */}
          {viewMode === 'list' && (
            <div className="bg-white rounded-xl card-shadow overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">æˆå‘˜</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">éƒ¨é—¨</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">ç»„åˆ«</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">èŒä½</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-500">æ€»ä»»åŠ¡</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-500">è¿›è¡Œä¸­</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-500">å·²å®Œæˆ</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-500">å®Œæˆç‡</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {filteredMembers.map(member => {
                    const memberTasks = tasks.filter(t => t.assignee === member.id || t.assigneeName === member.name);
                    const completedCount = memberTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
                    const inProgressCount = memberTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
                    const completionRate = memberTasks.length > 0 ? Math.round((completedCount / memberTasks.length) * 100) : 0;
                    
                    return (
                      <tr key={member.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3">
                          <div className="flex items-center gap-2">
                            <span className={`w-8 h-8 ${member.color} rounded-full flex items-center justify-center text-white text-sm`}>
                              {member.avatar}
                            </span>
                            <span className="font-medium text-gray-800">{member.name}</span>
                          </div>
                        </td>
                        <td className="px-4 py-3">
                          <span className="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs">
                            {member.department}
                          </span>
                        </td>
                        <td className="px-4 py-3">
                          <span className="px-2 py-1 bg-purple-50 text-purple-600 rounded text-xs">
                            {member.group}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-gray-600 text-sm">{member.position}</td>
                        <td className="px-4 py-3 text-center font-medium text-gray-800">{memberTasks.length}</td>
                        <td className="px-4 py-3 text-center font-medium text-blue-600">{inProgressCount}</td>
                        <td className="px-4 py-3 text-center font-medium text-green-600">{completedCount}</td>
                        <td className="px-4 py-3">
                          <div className="flex items-center gap-2">
                            <div className="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                              <div className={`h-full ${member.color} rounded-full`} style={{ width: `${completionRate}%` }} />
                            </div>
                            <span className="text-sm font-medium text-gray-600 w-10">{completionRate}%</span>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              {filteredMembers.length === 0 && (
                <div className="text-center text-gray-400 py-12">æš‚æ— æˆå‘˜æ•°æ®</div>
              )}
            </div>
          )}
        </div>
      );
    };

    // ç»Ÿè®¡å¡ç‰‡
    const StatCard = ({ title, value, subtitle, color, icon }) => (
      <div className="bg-white rounded-xl p-5 card-shadow">
        <div className="flex items-center justify-between">
          <div>
            <div className="text-sm text-gray-500">{title}</div>
            <div className={`text-3xl font-bold ${color} mt-1`}>{value}</div>
            {subtitle && <div className="text-xs text-gray-400 mt-1">{subtitle}</div>}
          </div>
          <div className="text-3xl">{icon}</div>
        </div>
      </div>
    );

    // ä¸»åº”ç”¨
    // ç™»å½•é¡µé¢ç»„ä»¶
    const LoginPage = () => {
      const [loading, setLoading] = useState(false);
      
      const handleLogin = () => {
        setLoading(true);
        window.location.href = getLarkLoginUrl();
      };
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div className="text-center">
              <div className="text-6xl mb-4">ğŸ¯</div>
              <h1 className="text-2xl font-bold text-gray-800 mb-2">æ–°å“OKRé¡¹ç›®ç®¡ç†ç³»ç»Ÿ</h1>
              <p className="text-gray-500 mb-8">è¯·ä½¿ç”¨é£ä¹¦è´¦å·ç™»å½•</p>
              
              <button
                onClick={handleLogin}
                disabled={loading}
                className="w-full py-3 px-6 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-medium transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
              >
                {loading ? (
                  <>
                    <span className="loading-spinner inline-block w-5 h-5 border-2 border-white/30 border-t-white rounded-full" />
                    æ­£åœ¨è·³è½¬...
                  </>
                ) : (
                  <>
                    <svg className="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    é£ä¹¦æ‰«ç ç™»å½•
                  </>
                )}
              </button>
              
              <p className="mt-6 text-xs text-gray-400">
                ç™»å½•å³è¡¨ç¤ºæ‚¨åŒæ„ä½¿ç”¨é£ä¹¦è´¦å·è¿›è¡Œèº«ä»½éªŒè¯
              </p>
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [activeTab, setActiveTab] = useState('okr');
      const [lastUpdate, setLastUpdate] = useState(null);
      const [currentUser, setCurrentUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);

      // å¤„ç†ç™»å½•çŠ¶æ€
      useEffect(() => {
        const initAuth = async () => {
          // æ£€æŸ¥ URL ä¸­æ˜¯å¦æœ‰ OAuth å›è°ƒçš„ code
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get('code');
          
          if (code) {
            // å¤„ç† OAuth å›è°ƒ
            const user = await handleOAuthCallback(code);
            if (user) {
              setCurrentUser(user);
            }
          } else {
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç™»å½•çŠ¶æ€
            const user = checkLoginStatus();
            setCurrentUser(user);
          }
          setAuthLoading(false);
        };
        
        initAuth();
      }, []);

      const fetchData = async () => {
        setLoading(true);
        setError(null);
        try {
          const res = await fetch(API_BASE + '/api/lark?app_token=' + APP_TOKEN);
          const json = await res.json();
          
          if (json.success) {
            const transformed = transformData(json.data);
            setData(transformed);
            setLastUpdate(new Date().toLocaleTimeString());
          } else {
            throw new Error(json.error || 'æ•°æ®åŠ è½½å¤±è´¥');
          }
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      useEffect(() => {
        if (currentUser) {
          fetchData();
          const interval = setInterval(fetchData, 5 * 60 * 1000);
          return () => clearInterval(interval);
        }
      }, [currentUser]);

      // è®¤è¯åŠ è½½ä¸­
      if (authLoading) return <LoadingScreen />;
      
      // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
      if (!currentUser) return <LoginPage />;
      
      // æ•°æ®åŠ è½½ä¸­
      if (loading && !data) return <LoadingScreen />;

      const stats = data ? {
        totalProducts: data.products.length,
        completedProducts: data.products.filter(p => p.status === 'å·²å®Œæˆ').length,
        completedTasks: data.tasks.filter(t => t.status === 'å·²å®Œæˆ').length,
        totalTasks: data.tasks.length,
        avgProgress: data.products.length > 0 
          ? Math.round(data.products.reduce((sum, p) => sum + p.progress, 0) / data.products.length) 
          : 0,
        teamMembers: data.members.length
      } : {};

      return (
        <UserContext.Provider value={currentUser}>
        <div className="min-h-screen bg-gray-50">
          <div className="gradient-bg text-white py-6 px-8">
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold">æ–°å“OKRé¡¹ç›®ç®¡ç†ç³»ç»Ÿ</h1>
                <p className="text-white/80 mt-1">å®æ—¶æ•°æ® Â· é£ä¹¦åŒæ­¥</p>
              </div>
              <div className="flex items-center gap-4">
                {lastUpdate && (
                  <span className="text-white/60 text-sm">æ›´æ–°äº {lastUpdate}</span>
                )}
                <button 
                  onClick={fetchData}
                  className="px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg text-sm flex items-center gap-1"
                >
                  ğŸ”„ åˆ·æ–°
                </button>
                {/* ç”¨æˆ·ä¿¡æ¯ */}
                <div className="flex items-center gap-3 bg-white/10 rounded-lg px-3 py-1.5">
                  {currentUser.avatar_url ? (
                    <img src={currentUser.avatar_url} className="w-7 h-7 rounded-full" alt="" />
                  ) : (
                    <div className="w-7 h-7 rounded-full bg-white/30 flex items-center justify-center text-sm">
                      {currentUser.name?.charAt(0) || 'ğŸ‘¤'}
                    </div>
                  )}
                  <span className="text-sm font-medium">{currentUser.name}</span>
                  <button 
                    onClick={logout}
                    className="text-white/60 hover:text-white text-xs ml-1"
                    title="é€€å‡ºç™»å½•"
                  >
                    é€€å‡º
                  </button>
                </div>
              </div>
            </div>
          </div>

          {error && (
            <div className="max-w-7xl mx-auto px-8 py-2">
              <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-2 rounded-lg text-sm">
                âš ï¸ {error}
              </div>
            </div>
          )}

          {data && (
            <div className="max-w-7xl mx-auto px-8 py-6">
              <div className="grid grid-cols-5 gap-4 mb-6">
                <StatCard title="äº§å“æ€»æ•°" value={stats.totalProducts} subtitle={`å·²ä¸Šçº¿ ${stats.completedProducts}`} color="text-purple-600" icon="ğŸ“¦" />
                <StatCard title="å¹³å‡è¿›åº¦" value={`${stats.avgProgress}%`} subtitle="æ‰€æœ‰äº§å“" color="text-blue-600" icon="ğŸ“Š" />
                <StatCard title="ä»»åŠ¡å®Œæˆ" value={`${stats.completedTasks}/${stats.totalTasks}`} color="text-green-600" icon="âœ…" />
                <StatCard title="è¿›è¡Œä¸­" value={stats.totalProducts - stats.completedProducts} subtitle="å¼€å‘ä¸­äº§å“" color="text-orange-600" icon="ğŸš€" />
                <StatCard title="å›¢é˜Ÿæˆå‘˜" value={stats.teamMembers} color="text-pink-600" icon="ğŸ‘¥" />
              </div>

              <div className="flex gap-2 mb-6">
                {[
                  { key: 'okr', label: 'ğŸ¯ OKR è§†å›¾' },
                  { key: 'products', label: 'ğŸ“¦ äº§å“è¿›åº¦' },
                  { key: 'team', label: 'ğŸ‘¥ äººå‘˜ä»»åŠ¡' }
                ].map(tab => (
                  <button
                    key={tab.key}
                    onClick={() => setActiveTab(tab.key)}
                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                      activeTab === tab.key ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    {tab.label}
                  </button>
                ))}
              </div>

              {activeTab === 'okr' && (
                <OKROverview
                  objectives={data.objectives}
                  keyResults={data.keyResults}
                  products={data.products}
                  onRefresh={fetchData}
                />
              )}

              {activeTab === 'products' && (
                <ProductOverview
                  products={data.products}
                  nodes={data.processNodes}
                  nodeLayers={data.processNodeLayers}
                  nodeMap={data.nodeMap}
                  nodeToLayer={data.nodeToLayer}
                  members={data.members}
                  tasks={data.tasks}
                  onRefresh={fetchData}
                />
              )}

              {activeTab === 'team' && (
                <TeamTaskOverview
                  members={data.members}
                  tasks={data.tasks}
                  products={data.products}
                  groups={data.groups}
                />
              )}
            </div>
          )}

          <div className="text-center py-6 text-gray-400 text-sm">
            æ•°æ®æ¥æºï¼šé£ä¹¦å¤šç»´è¡¨æ ¼ Â· æ¯5åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥
          </div>
        </div>
        </UserContext.Provider>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(
      <ToastContainer>
        <App />
      </ToastContainer>
    );
  </script>
</body>
</html>
