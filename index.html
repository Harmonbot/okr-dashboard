<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–°å“OKRé¡¹ç›®ç®¡ç†ç³»ç»Ÿ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : '';

    const APP_TOKEN = 'N5OqbwkO1a2PbpsaM05ckGrMnxg';

    // æ•°æ®è½¬æ¢å‡½æ•°
    const transformData = (rawData) => {
      const data = {
        objectives: [],
        keyResults: [],
        products: [],
        tasks: [],
        members: [],
        processNodes: [],
        processNodeLayers: [], // DAGåˆ†å±‚
        nodeMap: {}, // èŠ‚ç‚¹åç§°åˆ°èŠ‚ç‚¹çš„æ˜ å°„
        nodeToLayer: {}, // èŠ‚ç‚¹åç§°åˆ°å±‚çº§çš„æ˜ å°„
        groups: []
      };

      // è½¬æ¢ç›®æ ‡è¡¨
      if (rawData['ç›®æ ‡ Objectives']) {
        data.objectives = rawData['ç›®æ ‡ Objectives'].records.map(r => ({
          id: r.record_id,
          name: r.fields['ç›®æ ‡åç§°'] || '',
          cycle: r.fields['ç›®æ ‡å‘¨æœŸ'] || '',
          level: r.fields['ç›®æ ‡å±‚çº§'] || '',
          progress: r.fields['è¿›åº¦'] || 0,
          status: r.fields['çŠ¶æ€'] || 'æœªå¼€å§‹'
        }));
      }

      // è½¬æ¢å…³é”®ç»“æœè¡¨
      if (rawData['å…³é”®ç»“æœ Key Results']) {
        data.keyResults = rawData['å…³é”®ç»“æœ Key Results'].records.map(r => ({
          id: r.record_id,
          name: r.fields['KRæè¿°'] || '',
          target: r.fields['ç›®æ ‡å€¼'] || 0,
          current: r.fields['å½“å‰å€¼'] || 0,
          weight: r.fields['æƒé‡'] || 0,
          status: r.fields['çŠ¶æ€'] || 'æœªå¼€å§‹',
          objectiveId: r.fields['æ‰€å±ç›®æ ‡']?.[0] || null
        }));
      }

      // è½¬æ¢é¡¹ç›®è¡¨ä¸ºäº§å“
      if (rawData['é¡¹ç›® Projects']) {
        const projectEmojis = ['ğŸ“¦', 'ğŸ¯', 'ğŸš€', 'ğŸ’¡', 'ğŸ”§', 'ğŸ“±', 'ğŸ¨', 'ğŸ›’'];
        data.products = rawData['é¡¹ç›® Projects'].records.map((r, idx) => {
          // ä¿®å¤è¿›åº¦è®¡ç®—
          let progress = r.fields['æ•´ä½“è¿›åº¦'] || 0;
          if (progress > 0 && progress <= 1) {
            progress = Math.round(progress * 100);
          } else if (progress > 100) {
            progress = 100;
          }
          progress = Math.round(progress);
          
          return {
            id: r.record_id,
            name: r.fields['é¡¹ç›®åç§°'] || '',
            category: r.fields['é¡¹ç›®ç±»å‹'] || '',
            image: projectEmojis[idx % projectEmojis.length],
            currentStage: r.fields['å½“å‰é˜¶æ®µ'] || 'äº§å“è°ƒç ”',
            progress: progress,
            status: r.fields['é¡¹ç›®çŠ¶æ€'] || 'è¿›è¡Œä¸­',
            startDate: r.fields['å¼€å§‹æ—¥æœŸ'] ? new Date(r.fields['å¼€å§‹æ—¥æœŸ']).toISOString().split('T')[0] : '',
            targetDate: r.fields['è®¡åˆ’ä¸Šçº¿æ—¥æœŸ'] ? new Date(r.fields['è®¡åˆ’ä¸Šçº¿æ—¥æœŸ']).toISOString().split('T')[0] : '',
            krId: r.fields['å…³è”KR']?.[0] || null
          };
        });
      }

      // è½¬æ¢ä»»åŠ¡è¡¨ - ä¼˜å…ˆä½¿ç”¨ã€Œæ‰€å±èŠ‚ç‚¹ã€å…³è”å­—æ®µ
      if (rawData['ä»»åŠ¡ Tasks']) {
        // å…ˆå»ºç«‹èŠ‚ç‚¹ record_id åˆ°èŠ‚ç‚¹åç§°çš„æ˜ å°„
        const nodeRecordMap = {};
        if (rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes']) {
          rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes'].records.forEach(r => {
            let nodeName = r.fields['èŠ‚ç‚¹åç§°'];
            if (Array.isArray(nodeName)) {
              nodeName = nodeName.map(n => n.text || n).join('');
            }
            nodeRecordMap[r.record_id] = nodeName;
          });
        }
        
        data.tasks = rawData['ä»»åŠ¡ Tasks'].records.map(r => {
          // ä¼˜å…ˆä½¿ç”¨ã€Œæ‰€å±èŠ‚ç‚¹ã€å…³è”å­—æ®µ
          let stage = '';
          const linkedNode = r.fields['æ‰€å±èŠ‚ç‚¹'];
          
          if (linkedNode) {
            // Vercel API æ ¼å¼: [{record_ids: [...], text: "èŠ‚ç‚¹åç§°", ...}]
            if (Array.isArray(linkedNode) && linkedNode.length > 0) {
              const firstItem = linkedNode[0];
              // ç›´æ¥ä½¿ç”¨ text å­—æ®µï¼ˆæœ€ç®€å•ï¼‰
              if (firstItem.text) {
                stage = firstItem.text;
              } else if (firstItem.record_ids && firstItem.record_ids.length > 0) {
                stage = nodeRecordMap[firstItem.record_ids[0]] || '';
              }
            }
            // é£ä¹¦ MCP æ ¼å¼: {link_record_ids: [...]}
            else if (linkedNode.link_record_ids && linkedNode.link_record_ids.length > 0) {
              stage = nodeRecordMap[linkedNode.link_record_ids[0]] || '';
            }
          }
          
          // å¦‚æœæ²¡æœ‰è®¾ç½®æ‰€å±èŠ‚ç‚¹ï¼Œå›é€€åˆ°æ—§çš„ã€Œæ‰€å±é˜¶æ®µã€å•é€‰å­—æ®µ
          if (!stage) {
            stage = r.fields['æ‰€å±é˜¶æ®µ'] || '';
          }
          
          // å¤„ç†ä»»åŠ¡åç§°ï¼ˆå¯èƒ½æ˜¯æ•°ç»„æ ¼å¼æˆ–å­—ç¬¦ä¸²ï¼‰
          let taskName = r.fields['ä»»åŠ¡åç§°'] || '';
          if (Array.isArray(taskName)) {
            taskName = taskName.map(n => n.text || n).join('');
          }
          
          // è§£ææ‰€å±é¡¹ç›®
          let productId = null;
          const projectField = r.fields['æ‰€å±é¡¹ç›®'];
          if (projectField) {
            // Vercel API æ ¼å¼: [{record_ids: [...], text: "é¡¹ç›®åç§°", ...}]
            if (Array.isArray(projectField) && projectField.length > 0) {
              const firstItem = projectField[0];
              if (firstItem.record_ids && firstItem.record_ids.length > 0) {
                productId = firstItem.record_ids[0];
              }
            }
            // é£ä¹¦ MCP æ ¼å¼: {link_record_ids: [...]}
            else if (projectField.link_record_ids && projectField.link_record_ids.length > 0) {
              productId = projectField.link_record_ids[0];
            }
          }
          
          return {
            id: r.record_id,
            name: taskName,
            stage: stage,
            priority: (r.fields['ä¼˜å…ˆçº§'] || 'P2').replace(/-.*$/, ''),
            status: r.fields['çŠ¶æ€'] || 'å¾…å¼€å§‹',
            productId: productId,
            assignee: r.fields['è´Ÿè´£äºº']?.[0]?.id || null,
            assigneeName: r.fields['è´Ÿè´£äºº']?.[0]?.name || '',
            startDate: r.fields['å¼€å§‹æ—¥æœŸ'] ? new Date(r.fields['å¼€å§‹æ—¥æœŸ']).toISOString().split('T')[0] : '',
            dueDate: r.fields['æˆªæ­¢æ—¥æœŸ'] ? new Date(r.fields['æˆªæ­¢æ—¥æœŸ']).toISOString().split('T')[0] : '',
            outputFile: r.fields['è¾“å‡ºæ–‡ä»¶'] || ''
          };
        });
      }

      // è½¬æ¢å›¢é˜Ÿæˆå‘˜è¡¨ - æ–°å¢ç»„åˆ«å­—æ®µ
      if (rawData['å›¢é˜Ÿæˆå‘˜ Team Members']) {
        const memberColors = ['bg-blue-500', 'bg-pink-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-teal-500', 'bg-red-500', 'bg-indigo-500'];
        const memberAvatars = ['ğŸ‘¨â€ğŸ’¼', 'ğŸ‘©â€ğŸ¨', 'ğŸ‘¨â€ğŸ’»', 'ğŸ‘©â€ğŸ“Š', 'ğŸ‘¨â€ğŸ”§', 'ğŸ‘©â€ğŸ’»', 'ğŸ‘¨â€ğŸ“', 'ğŸ‘©â€ğŸ”¬'];
        
        data.members = rawData['å›¢é˜Ÿæˆå‘˜ Team Members'].records.map((r, idx) => ({
          id: r.fields['é£ä¹¦ç”¨æˆ·']?.[0]?.id || r.record_id,
          name: r.fields['å§“å'] || '',
          department: r.fields['éƒ¨é—¨'] || '',
          group: r.fields['ç»„åˆ«'] || 'æœªåˆ†ç»„', // æ–°å¢ç»„åˆ«
          position: r.fields['èŒä½'] || '',
          avatar: memberAvatars[idx % memberAvatars.length],
          color: memberColors[idx % memberColors.length]
        }));

        // æå–æ‰€æœ‰ç»„åˆ«
        const groupSet = new Set(data.members.map(m => m.group));
        data.groups = Array.from(groupSet).filter(g => g);
      }

      // è½¬æ¢æµç¨‹èŠ‚ç‚¹è¡¨ - æ”¯æŒDAGç»“æ„
      if (rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes']) {
        const rawNodes = rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes'].records
          .filter(r => r.fields['èŠ‚ç‚¹åç§°'])
          .map(r => {
            let nodeName = r.fields['èŠ‚ç‚¹åç§°'];
            if (Array.isArray(nodeName)) {
              nodeName = nodeName.map(n => n.text || n).join('');
            }
            let prevNode = r.fields['å‰ç½®èŠ‚ç‚¹'];
            if (Array.isArray(prevNode)) {
              prevNode = prevNode.map(n => n.text || n).join('');
            }
            return {
              id: r.record_id,
              name: nodeName || '',
              order: r.fields['èŠ‚ç‚¹é¡ºåº'] || 0,
              type: r.fields['èŠ‚ç‚¹ç±»å‹'] || 'ä¸­é—´èŠ‚ç‚¹',
              days: r.fields['é¢„è®¡å·¥æ—¶(å¤©)'] || 0,
              role: r.fields['é»˜è®¤è´Ÿè´£è§’è‰²'] || '',
              prevNode: prevNode || null // å‰ç½®èŠ‚ç‚¹åç§°
            };
          });
        
        // æ„å»ºèŠ‚ç‚¹æ˜ å°„
        const nodeMap = {};
        rawNodes.forEach(n => { nodeMap[n.name] = n; });
        
        // æ·»åŠ åç»§èŠ‚ç‚¹ä¿¡æ¯
        rawNodes.forEach(n => {
          n.children = rawNodes.filter(c => c.prevNode === n.name).map(c => c.name);
        });
        
        // æ‹“æ‰‘æ’åºåˆ†å±‚
        const layers = [];
        const visited = new Set();
        const nodeToLayer = {};
        
        // æ‰¾åˆ°èµ·å§‹èŠ‚ç‚¹ï¼ˆæ— å‰ç½®èŠ‚ç‚¹ï¼‰
        const startNodes = rawNodes.filter(n => !n.prevNode);
        if (startNodes.length > 0) {
          layers.push(startNodes);
          startNodes.forEach(n => {
            visited.add(n.name);
            nodeToLayer[n.name] = 0;
          });
        }
        
        // é€å±‚æ„å»º
        let layerIndex = 1;
        while (visited.size < rawNodes.length && layerIndex < 20) {
          const nextLayer = rawNodes.filter(n => {
            if (visited.has(n.name)) return false;
            if (!n.prevNode) return false;
            return visited.has(n.prevNode);
          });
          
          if (nextLayer.length === 0) break;
          
          layers.push(nextLayer);
          nextLayer.forEach(n => {
            visited.add(n.name);
            nodeToLayer[n.name] = layerIndex;
          });
          layerIndex++;
        }
        
        data.processNodes = rawNodes;
        data.processNodeLayers = layers;
        data.nodeMap = nodeMap;
        data.nodeToLayer = nodeToLayer;
      }

      if (data.processNodes.length === 0) {
        data.processNodes = [
          { id: 'n1', name: 'äº§å“ç«‹é¡¹', order: 1, type: 'å¼€å§‹', prevNode: null, children: ['é£æ§ç­›æŸ¥', 'åº—é“ºåˆ†é…'] },
          { id: 'n2', name: 'é£æ§ç­›æŸ¥', order: 2, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'äº§å“ç«‹é¡¹', children: [] },
          { id: 'n3', name: 'åº—é“ºåˆ†é…', order: 2, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'äº§å“ç«‹é¡¹', children: ['é“¾æ¥åˆ›å»º'] },
          { id: 'n4', name: 'é“¾æ¥åˆ›å»º', order: 3, type: 'ä¸­é—´èŠ‚ç‚¹', prevNode: 'åº—é“ºåˆ†é…', children: ['å‚¨è¯„è®¡åˆ’', 'å›¾éœ€', 'å¤‡è´§è®¡åˆ’'] },
          { id: 'n5', name: 'å‚¨è¯„è®¡åˆ’', order: 4, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'é“¾æ¥åˆ›å»º', children: [] },
          { id: 'n6', name: 'å›¾éœ€', order: 4, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'é“¾æ¥åˆ›å»º', children: ['è‰å›¾åˆ¶ä½œ'] },
          { id: 'n7', name: 'å¤‡è´§è®¡åˆ’', order: 4, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'é“¾æ¥åˆ›å»º', children: [] }
        ];
        data.processNodeLayers = [[data.processNodes[0]], [data.processNodes[1], data.processNodes[2]], [data.processNodes[3]], [data.processNodes[4], data.processNodes[5], data.processNodes[6]]];
        data.nodeMap = {};
        data.processNodes.forEach(n => { data.nodeMap[n.name] = n; });
        data.nodeToLayer = { 'äº§å“ç«‹é¡¹': 0, 'é£æ§ç­›æŸ¥': 1, 'åº—é“ºåˆ†é…': 1, 'é“¾æ¥åˆ›å»º': 2, 'å‚¨è¯„è®¡åˆ’': 3, 'å›¾éœ€': 3, 'å¤‡è´§è®¡åˆ’': 3 };
      }

      return data;
    };

    // è·å–èŠ‚ç‚¹çŠ¶æ€
    const getNodeStatus = (nodeName, currentStage, nodes) => {
      const currentIndex = nodes.findIndex(n => n.name === currentStage);
      const nodeIndex = nodes.findIndex(n => n.name === nodeName);
      if (nodeIndex < currentIndex) return 'completed';
      if (nodeIndex === currentIndex) return 'current';
      return 'pending';
    };

    // åŠ è½½ä¸­ç»„ä»¶
    const LoadingScreen = () => (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full loading-spinner mx-auto mb-4"></div>
          <div className="text-gray-600">æ­£åœ¨ä»é£ä¹¦åŠ è½½æ•°æ®...</div>
        </div>
      </div>
    );

    // è¿·ä½ é˜¶æ®µæŒ‡ç¤ºå™¨
    const MiniStageIndicator = ({ currentStage, nodes }) => (
      <div className="flex items-center gap-1">
        {nodes.map((node, index) => {
          const status = getNodeStatus(node.name, currentStage, nodes);
          return (
            <div key={node.id} className="flex items-center">
              <div 
                className={`w-2.5 h-2.5 rounded-full ${
                  status === 'completed' ? 'bg-green-500' :
                  status === 'current' ? 'bg-blue-500 ring-2 ring-blue-200' :
                  'bg-gray-200'
                }`}
                title={node.name}
              />
              {index < nodes.length - 1 && (
                <div className={`w-3 h-0.5 ${status === 'completed' ? 'bg-green-500' : 'bg-gray-200'}`} />
              )}
            </div>
          );
        })}
      </div>
    );

    // äº§å“å¡ç‰‡
    const ProductCard = ({ product, nodes, members, tasks, onClick }) => {
      const productTasks = tasks.filter(t => t.productId === product.id);
      const completedTasks = productTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
      const daysRemaining = product.targetDate 
        ? Math.ceil((new Date(product.targetDate) - new Date()) / (1000 * 60 * 60 * 24))
        : null;
      const isOverdue = daysRemaining !== null && daysRemaining < 0 && product.status !== 'å·²å®Œæˆ';

      return (
        <div 
          className={`bg-white rounded-xl card-shadow overflow-hidden cursor-pointer hover:shadow-lg transition-all hover:-translate-y-1 ${
            product.status === 'å·²å®Œæˆ' ? 'border-2 border-green-200' : ''
          }`}
          onClick={() => onClick(product)}
        >
          <div className={`h-1.5 ${
            product.status === 'å·²å®Œæˆ' ? 'bg-green-500' :
            isOverdue ? 'bg-red-500' : 'bg-blue-500'
          }`} />
          
          <div className="p-4">
            <div className="flex items-start gap-3 mb-3">
              <div className="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center text-2xl">
                {product.image}
              </div>
              <div className="flex-1 min-w-0">
                <div className="font-semibold text-gray-800 truncate">{product.name}</div>
                <div className="text-xs text-gray-400">{product.category}</div>
              </div>
              <span className={`text-xs px-2 py-1 rounded-full ${
                product.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-600' : 
                product.status === 'æœªå¼€å§‹' ? 'bg-gray-100 text-gray-500' :
                'bg-blue-100 text-blue-600'
              }`}>
                {product.status}
              </span>
            </div>

            <div className="mb-3">
              <div className="flex items-center justify-between mb-1.5">
                <span className="text-xs text-gray-500">å½“å‰é˜¶æ®µ</span>
                <span className="text-sm font-medium text-blue-600">{product.currentStage}</span>
              </div>
              <MiniStageIndicator currentStage={product.currentStage} nodes={nodes} />
            </div>

            <div className="mb-3">
              <div className="flex items-center justify-between mb-1">
                <span className="text-xs text-gray-500">æ•´ä½“è¿›åº¦</span>
                <span className="text-sm font-medium text-gray-800">{product.progress}%</span>
              </div>
              <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                <div 
                  className={`h-full rounded-full transition-all ${
                    product.progress === 100 ? 'bg-green-500' : 'bg-blue-500'
                  }`}
                  style={{ width: `${product.progress}%` }}
                />
              </div>
            </div>

            <div className="flex items-center justify-between pt-3 border-t border-gray-100">
              <div className="text-xs text-gray-500">
                ä»»åŠ¡ {completedTasks}/{productTasks.length}
              </div>
              <div className={`text-xs ${isOverdue ? 'text-red-500 font-medium' : 'text-gray-400'}`}>
                {product.status === 'å·²å®Œæˆ' ? (
                  <span className="text-green-600">âœ“ å·²ä¸Šçº¿</span>
                ) : daysRemaining !== null ? (
                  isOverdue ? `âš ï¸ é€¾æœŸ ${Math.abs(daysRemaining)} å¤©` : `ğŸ“… å‰©ä½™ ${daysRemaining} å¤©`
                ) : ''}
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ç”˜ç‰¹å›¾ç»„ä»¶
    const GanttChart = ({ tasks, members, product }) => {
      // è®¡ç®—æ—¶é—´èŒƒå›´
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // è·å–æ‰€æœ‰æœ‰æ•ˆæ—¥æœŸ
      const allDates = [];
      tasks.forEach(t => {
        if (t.startDate) allDates.push(new Date(t.startDate));
        if (t.dueDate) allDates.push(new Date(t.dueDate));
      });
      
      // å¦‚æœæ²¡æœ‰æ—¥æœŸæ•°æ®ï¼Œä½¿ç”¨é¡¹ç›®æ—¥æœŸæˆ–é»˜è®¤èŒƒå›´
      if (allDates.length === 0) {
        if (product.startDate) allDates.push(new Date(product.startDate));
        if (product.targetDate) allDates.push(new Date(product.targetDate));
      }
      
      // é»˜è®¤æ˜¾ç¤ºå‰åå„2å‘¨
      if (allDates.length === 0) {
        allDates.push(new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000));
        allDates.push(new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000));
      }
      
      const minDate = new Date(Math.min(...allDates.map(d => d.getTime())) - 7 * 24 * 60 * 60 * 1000);
      const maxDate = new Date(Math.max(...allDates.map(d => d.getTime())) + 7 * 24 * 60 * 60 * 1000);
      
      // ç¡®ä¿åŒ…å«ä»Šå¤©
      if (today < minDate) minDate.setTime(today.getTime() - 7 * 24 * 60 * 60 * 1000);
      if (today > maxDate) maxDate.setTime(today.getTime() + 7 * 24 * 60 * 60 * 1000);
      
      const totalDays = Math.ceil((maxDate - minDate) / (24 * 60 * 60 * 1000));
      const dayWidth = Math.max(30, 800 / totalDays); // æ¯å¤©è‡³å°‘30px
      
      // ç”Ÿæˆæ—¥æœŸåˆ»åº¦
      const dateMarkers = [];
      const currentDate = new Date(minDate);
      while (currentDate <= maxDate) {
        dateMarkers.push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
      }
      
      // è®¡ç®—ä»Šå¤©çš„ä½ç½®
      const todayOffset = Math.max(0, (today - minDate) / (24 * 60 * 60 * 1000)) * dayWidth;
      
      // æ ¼å¼åŒ–æ—¥æœŸ
      const formatDate = (date) => {
        const d = new Date(date);
        return `${d.getMonth() + 1}/${d.getDate()}`;
      };
      
      // è·å–æ˜ŸæœŸå‡ 
      const getWeekday = (date) => {
        const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
        return days[new Date(date).getDay()];
      };
      
      // åˆ¤æ–­æ˜¯å¦æ˜¯å‘¨æœ«
      const isWeekend = (date) => {
        const day = new Date(date).getDay();
        return day === 0 || day === 6;
      };

      return (
        <div className="bg-gray-50 rounded-xl overflow-hidden">
          {/* å›¾ä¾‹ */}
          <div className="flex gap-4 px-4 py-2 bg-white border-b text-xs text-gray-500">
            <span className="flex items-center gap-1">
              <span className="w-3 h-3 rounded bg-green-500"></span> å·²å®Œæˆ
            </span>
            <span className="flex items-center gap-1">
              <span className="w-3 h-3 rounded bg-blue-500"></span> è¿›è¡Œä¸­
            </span>
            <span className="flex items-center gap-1">
              <span className="w-3 h-3 rounded bg-gray-300"></span> å¾…å¼€å§‹
            </span>
            <span className="flex items-center gap-1">
              <span className="w-0.5 h-3 bg-red-500"></span> ä»Šå¤©
            </span>
          </div>
          
          <div className="overflow-x-auto">
            <div style={{ minWidth: `${totalDays * dayWidth + 200}px` }}>
              {/* æ—¶é—´è½´å¤´éƒ¨ */}
              <div className="flex border-b bg-white sticky top-0">
                <div className="w-48 flex-shrink-0 px-3 py-2 font-medium text-gray-600 border-r bg-gray-50">
                  ä»»åŠ¡åç§°
                </div>
                <div className="flex-1 relative">
                  <div className="flex">
                    {dateMarkers.map((date, idx) => (
                      <div 
                        key={idx} 
                        className={`text-center border-r ${isWeekend(date) ? 'bg-gray-100' : 'bg-white'}`}
                        style={{ width: `${dayWidth}px`, minWidth: `${dayWidth}px` }}
                      >
                        <div className="text-xs text-gray-400 py-1">
                          {formatDate(date)}
                        </div>
                        <div className={`text-xs pb-1 ${isWeekend(date) ? 'text-red-400' : 'text-gray-300'}`}>
                          {getWeekday(date)}
                        </div>
                      </div>
                    ))}
                  </div>
                  {/* ä»Šå¤©çš„æ ‡è®°çº¿ */}
                  <div 
                    className="absolute top-0 bottom-0 w-0.5 bg-red-500 z-10"
                    style={{ left: `${todayOffset}px` }}
                  />
                </div>
              </div>
              
              {/* ä»»åŠ¡è¡Œ */}
              {tasks.map((task, taskIdx) => {
                const assignee = members.find(m => m.id === task.assignee || m.name === task.assigneeName);
                
                // è®¡ç®—ä»»åŠ¡æ¡çš„ä½ç½®å’Œå®½åº¦
                let taskStart = task.startDate ? new Date(task.startDate) : null;
                let taskEnd = task.dueDate ? new Date(task.dueDate) : null;
                
                // å¦‚æœæ²¡æœ‰å¼€å§‹æ—¥æœŸï¼Œä½¿ç”¨æˆªæ­¢æ—¥æœŸå‰7å¤©
                if (!taskStart && taskEnd) {
                  taskStart = new Date(taskEnd.getTime() - 7 * 24 * 60 * 60 * 1000);
                }
                // å¦‚æœæ²¡æœ‰æˆªæ­¢æ—¥æœŸï¼Œä½¿ç”¨å¼€å§‹æ—¥æœŸå7å¤©
                if (taskStart && !taskEnd) {
                  taskEnd = new Date(taskStart.getTime() + 7 * 24 * 60 * 60 * 1000);
                }
                // å¦‚æœéƒ½æ²¡æœ‰ï¼Œæ˜¾ç¤ºä¸€ä¸ªé»˜è®¤æ¡
                if (!taskStart && !taskEnd) {
                  taskStart = new Date(today.getTime() - 3 * 24 * 60 * 60 * 1000);
                  taskEnd = new Date(today.getTime() + 4 * 24 * 60 * 60 * 1000);
                }
                
                const startOffset = Math.max(0, (taskStart - minDate) / (24 * 60 * 60 * 1000)) * dayWidth;
                const duration = Math.max(1, (taskEnd - taskStart) / (24 * 60 * 60 * 1000) + 1);
                const barWidth = duration * dayWidth;
                
                // ä»»åŠ¡æ¡é¢œè‰²
                const barColor = task.status === 'å·²å®Œæˆ' ? 'bg-green-500' :
                                 task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500' :
                                 'bg-gray-300';
                
                // åˆ¤æ–­æ˜¯å¦é€¾æœŸ
                const isOverdue = task.status !== 'å·²å®Œæˆ' && taskEnd && taskEnd < today;

                return (
                  <div key={task.id} className={`flex border-b hover:bg-blue-50/50 ${taskIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50/50'}`}>
                    {/* ä»»åŠ¡åç§° */}
                    <div className="w-48 flex-shrink-0 px-3 py-2 border-r flex items-center gap-2">
                      <div className={`w-5 h-5 rounded-full flex items-center justify-center text-xs flex-shrink-0 ${
                        task.status === 'å·²å®Œæˆ' ? 'bg-green-500 text-white' :
                        task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500 text-white' :
                        'bg-gray-200 text-gray-500'
                      }`}>
                        {task.status === 'å·²å®Œæˆ' ? 'âœ“' : task.status === 'è¿›è¡Œä¸­' ? 'â—' : 'â—‹'}
                      </div>
                      <div className="flex-1 min-w-0">
                        <div className={`text-sm truncate ${task.status === 'å·²å®Œæˆ' ? 'text-gray-400 line-through' : 'text-gray-800'}`}>
                          {task.name}
                        </div>
                        <div className="text-xs text-gray-400 truncate">{task.stage}</div>
                      </div>
                    </div>
                    
                    {/* ç”˜ç‰¹æ¡ */}
                    <div className="flex-1 relative py-2">
                      {/* èƒŒæ™¯ç½‘æ ¼ */}
                      <div className="absolute inset-0 flex">
                        {dateMarkers.map((date, idx) => (
                          <div 
                            key={idx}
                            className={`border-r ${isWeekend(date) ? 'bg-gray-100/50' : ''}`}
                            style={{ width: `${dayWidth}px`, minWidth: `${dayWidth}px` }}
                          />
                        ))}
                      </div>
                      
                      {/* ä»Šå¤©çš„æ ‡è®°çº¿ */}
                      <div 
                        className="absolute top-0 bottom-0 w-0.5 bg-red-500/30 z-10"
                        style={{ left: `${todayOffset}px` }}
                      />
                      
                      {/* ä»»åŠ¡æ¡ */}
                      <div 
                        className={`absolute top-1/2 -translate-y-1/2 h-6 rounded-full ${barColor} ${isOverdue ? 'ring-2 ring-red-400' : ''} shadow-sm flex items-center px-2 text-xs text-white font-medium overflow-hidden z-20 cursor-pointer hover:brightness-110 transition-all`}
                        style={{ 
                          left: `${startOffset}px`, 
                          width: `${Math.max(barWidth, 60)}px`
                        }}
                        title={`${task.name}\n${task.startDate || 'æœªè®¾ç½®'} ~ ${task.dueDate || 'æœªè®¾ç½®'}\nçŠ¶æ€: ${task.status}`}
                      >
                        {assignee && (
                          <span className="w-4 h-4 rounded-full bg-white/30 flex items-center justify-center text-xs mr-1 flex-shrink-0">
                            {assignee.avatar}
                          </span>
                        )}
                        <span className="truncate">{barWidth > 80 ? task.name : ''}</span>
                      </div>
                    </div>
                  </div>
                );
              })}
              
              {/* é¡¹ç›®é‡Œç¨‹ç¢‘ */}
              {product.targetDate && (
                <div className="flex border-b bg-purple-50/50">
                  <div className="w-48 flex-shrink-0 px-3 py-2 border-r flex items-center gap-2">
                    <div className="w-5 h-5 rounded flex items-center justify-center text-xs bg-purple-500 text-white">
                      ğŸ¯
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="text-sm font-medium text-purple-700">è®¡åˆ’ä¸Šçº¿</div>
                      <div className="text-xs text-purple-500">{product.targetDate}</div>
                    </div>
                  </div>
                  <div className="flex-1 relative py-2">
                    {/* èƒŒæ™¯ç½‘æ ¼ */}
                    <div className="absolute inset-0 flex">
                      {dateMarkers.map((date, idx) => (
                        <div 
                          key={idx}
                          className={`border-r ${isWeekend(date) ? 'bg-gray-100/50' : ''}`}
                          style={{ width: `${dayWidth}px`, minWidth: `${dayWidth}px` }}
                        />
                      ))}
                    </div>
                    {/* é‡Œç¨‹ç¢‘æ ‡è®° */}
                    {(() => {
                      const targetDate = new Date(product.targetDate);
                      const offset = Math.max(0, (targetDate - minDate) / (24 * 60 * 60 * 1000)) * dayWidth;
                      return (
                        <div 
                          className="absolute top-1/2 -translate-y-1/2 z-20"
                          style={{ left: `${offset}px` }}
                        >
                          <div className="w-6 h-6 bg-purple-500 rotate-45 transform -translate-x-1/2"></div>
                          <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-0.5 h-10 bg-purple-500"></div>
                        </div>
                      );
                    })()}
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // èŠ‚ç‚¹ä»»åŠ¡è¯¦æƒ…å¼¹çª— - æ”¯æŒæ–°å¢ä»»åŠ¡å’Œä»»åŠ¡æµç¨‹ç®¡ç†
    const NodeTaskModal = ({ node, tasks, members, product, nodeRecordId, onClose, onTaskCreated }) => {
      const [showAddForm, setShowAddForm] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [actionTaskId, setActionTaskId] = useState(null); // æ­£åœ¨æ“ä½œçš„ä»»åŠ¡ID
      const [showCompleteForm, setShowCompleteForm] = useState(null); // æ˜¾ç¤ºå®Œæˆè¡¨å•çš„ä»»åŠ¡ID
      const [outputFile, setOutputFile] = useState('');
      const [formData, setFormData] = useState({
        name: '',
        priority: 'P2-ä¸­ç­‰',
        assignee: '',
        collaborators: [], // åä½œäººï¼ˆå¤šé€‰ï¼‰
        description: ''
      });
      
      if (!node) return null;
      
      // ç­›é€‰è¯¥èŠ‚ç‚¹çš„ä»»åŠ¡
      const nodeTasks = tasks.filter(t => t.stage === node.name);
      const completedCount = nodeTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
      const inProgressCount = nodeTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
      const pendingCount = nodeTasks.filter(t => t.status === 'å¾…å¼€å§‹' || t.status === 'æœªå¼€å§‹').length;
      const progress = nodeTasks.length > 0 ? Math.round((completedCount / nodeTasks.length) * 100) : 0;

      // æäº¤æ–°ä»»åŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼šä¸å«æ—¥æœŸå’ŒçŠ¶æ€ï¼‰
      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.name.trim()) {
          alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
          return;
        }
        
        setIsSubmitting(true);
        try {
          const res = await fetch(API_BASE + '/api/create-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblFwmxmjRJPzVmV',
              task: {
                name: formData.name,
                priority: formData.priority,
                status: 'å¾…å¼€å§‹', // é»˜è®¤å¾…å¼€å§‹
                assignee: formData.assignee,
                collaborators: formData.collaborators,
                description: formData.description,
                projectId: product?.id,
                nodeId: nodeRecordId
              }
            })
          });
          
          const result = await res.json();
          if (result.success) {
            alert('âœ… ä»»åŠ¡åˆ›å»ºæˆåŠŸï¼');
            setShowAddForm(false);
            setFormData({
              name: '',
              priority: 'P2-ä¸­ç­‰',
              assignee: '',
              collaborators: [],
              description: ''
            });
            if (onTaskCreated) onTaskCreated();
          } else {
            throw new Error(result.error || 'åˆ›å»ºå¤±è´¥');
          }
        } catch (err) {
          alert('âŒ åˆ›å»ºå¤±è´¥: ' + err.message);
        }
        setIsSubmitting(false);
      };

      // æ¥å—ä»»åŠ¡ï¼šè®¾ç½®å¼€å§‹æ—¥æœŸä¸ºä»Šå¤©ï¼Œæˆªæ­¢æ—¥æœŸæ ¹æ®èŠ‚ç‚¹é¢„è®¡å·¥æ—¶è®¡ç®—ï¼ŒçŠ¶æ€æ”¹ä¸ºè¿›è¡Œä¸­
      const handleAcceptTask = async (task) => {
        if (!confirm(`ç¡®è®¤æ¥å—ä»»åŠ¡ã€Œ${task.name}ã€ï¼Ÿ\n\nå¼€å§‹æ—¥æœŸå°†è®¾ä¸ºä»Šå¤©ï¼Œæˆªæ­¢æ—¥æœŸæ ¹æ®èŠ‚ç‚¹é¢„è®¡å·¥æ—¶ï¼ˆ${node.days || 7}å¤©ï¼‰è‡ªåŠ¨è®¡ç®—ã€‚`)) {
          return;
        }
        
        setActionTaskId(task.id);
        try {
          const today = new Date();
          const dueDate = new Date(today);
          dueDate.setDate(dueDate.getDate() + (node.days || 7)); // ä½¿ç”¨èŠ‚ç‚¹é¢„è®¡å·¥æ—¶
          
          const res = await fetch(API_BASE + '/api/update-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblFwmxmjRJPzVmV',
              record_id: task.id,
              fields: {
                status: 'è¿›è¡Œä¸­',
                startDate: today.toISOString().split('T')[0],
                dueDate: dueDate.toISOString().split('T')[0]
              }
            })
          });
          
          const result = await res.json();
          if (result.success) {
            alert('âœ… å·²æ¥å—ä»»åŠ¡ï¼');
            if (onTaskCreated) onTaskCreated();
          } else {
            throw new Error(result.error || 'æ“ä½œå¤±è´¥');
          }
        } catch (err) {
          alert('âŒ æ“ä½œå¤±è´¥: ' + err.message);
        }
        setActionTaskId(null);
      };

      // å®Œæˆä»»åŠ¡ï¼šéœ€è¦å¡«å†™è¾“å‡ºæ–‡ä»¶
      const handleCompleteTask = async (task) => {
        if (!outputFile.trim()) {
          alert('è¯·å¡«å†™è¾“å‡ºæ–‡ä»¶é“¾æ¥æˆ–æè¿°');
          return;
        }
        
        setActionTaskId(task.id);
        try {
          const res = await fetch(API_BASE + '/api/update-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblFwmxmjRJPzVmV',
              record_id: task.id,
              fields: {
                status: 'å·²å®Œæˆ',
                outputFile: outputFile,
                completeDate: new Date().toISOString().split('T')[0]
              }
            })
          });
          
          const result = await res.json();
          if (result.success) {
            alert('âœ… ä»»åŠ¡å·²å®Œæˆï¼');
            setShowCompleteForm(null);
            setOutputFile('');
            if (onTaskCreated) onTaskCreated();
          } else {
            throw new Error(result.error || 'æ“ä½œå¤±è´¥');
          }
        } catch (err) {
          alert('âŒ æ“ä½œå¤±è´¥: ' + err.message);
        }
        setActionTaskId(null);
      };

      // åä½œäººå¤šé€‰å¤„ç†
      const handleCollaboratorChange = (memberId) => {
        setFormData(prev => {
          const exists = prev.collaborators.includes(memberId);
          return {
            ...prev,
            collaborators: exists 
              ? prev.collaborators.filter(id => id !== memberId)
              : [...prev.collaborators, memberId]
          };
        });
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4" onClick={onClose}>
          <div className="bg-white rounded-xl max-w-lg w-full max-h-[80vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
            {/* å¤´éƒ¨ */}
            <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center font-bold">
                    {node.order}
                  </div>
                  <div>
                    <h3 className="font-bold text-lg">{node.name}</h3>
                    <div className="text-white/70 text-sm">
                      {node.role && `é»˜è®¤è´Ÿè´£ï¼š${node.role}`}
                      {node.days > 0 && ` Â· é¢„è®¡ ${node.days} å¤©`}
                    </div>
                  </div>
                </div>
                <button onClick={onClose} className="text-white/80 hover:text-white text-xl">Ã—</button>
              </div>
            </div>

            {/* ç»Ÿè®¡å¡ç‰‡ */}
            <div className="grid grid-cols-4 gap-2 p-4 bg-gray-50">
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-blue-600">{progress}%</div>
                <div className="text-xs text-gray-500">å®Œæˆç‡</div>
              </div>
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-green-600">{completedCount}</div>
                <div className="text-xs text-gray-500">å·²å®Œæˆ</div>
              </div>
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-orange-600">{inProgressCount}</div>
                <div className="text-xs text-gray-500">è¿›è¡Œä¸­</div>
              </div>
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-gray-600">{pendingCount}</div>
                <div className="text-xs text-gray-500">å¾…å¼€å§‹</div>
              </div>
            </div>

            {/* è¿›åº¦æ¡ */}
            <div className="px-4 py-2 bg-gray-50">
              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-gradient-to-r from-green-400 to-green-500 rounded-full transition-all"
                  style={{ width: `${progress}%` }}
                />
              </div>
            </div>

            {/* ä»»åŠ¡åˆ—è¡¨ */}
            <div className="p-4 max-h-[40vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h4 className="text-sm font-semibold text-gray-700">ğŸ“‹ ä»»åŠ¡åˆ—è¡¨ ({nodeTasks.length})</h4>
                <button
                  onClick={() => setShowAddForm(true)}
                  className="px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded-lg flex items-center gap-1 transition-colors"
                >
                  â• æ–°å¢ä»»åŠ¡
                </button>
              </div>
              
              {/* æ–°å¢ä»»åŠ¡è¡¨å• - ç®€åŒ–ç‰ˆ */}
              {showAddForm && (
                <div className="bg-purple-50 rounded-lg p-4 mb-4 border border-purple-200">
                  <div className="flex items-center justify-between mb-3">
                    <h5 className="font-medium text-purple-700">æ–°å¢ä»»åŠ¡</h5>
                    <button 
                      onClick={() => setShowAddForm(false)}
                      className="text-gray-400 hover:text-gray-600"
                    >Ã—</button>
                  </div>
                  <form onSubmit={handleSubmit} className="space-y-3">
                    {/* ä»»åŠ¡åç§° */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">ä»»åŠ¡åç§° *</label>
                      <input
                        type="text"
                        value={formData.name}
                        onChange={e => setFormData({...formData, name: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none"
                        placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°"
                        required
                      />
                    </div>
                    
                    {/* ä¼˜å…ˆçº§ */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">ä¼˜å…ˆçº§</label>
                      <select
                        value={formData.priority}
                        onChange={e => setFormData({...formData, priority: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none"
                      >
                        <option value="P0-ç´§æ€¥">P0-ç´§æ€¥</option>
                        <option value="P1-é«˜ä¼˜">P1-é«˜ä¼˜</option>
                        <option value="P2-ä¸­ç­‰">P2-ä¸­ç­‰</option>
                        <option value="P3-ä½ä¼˜">P3-ä½ä¼˜</option>
                      </select>
                    </div>
                    
                    {/* è´Ÿè´£äºº */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">è´Ÿè´£äºº</label>
                      <select
                        value={formData.assignee}
                        onChange={e => setFormData({...formData, assignee: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none"
                      >
                        <option value="">è¯·é€‰æ‹©è´Ÿè´£äºº</option>
                        {members.map(m => (
                          <option key={m.id} value={m.id}>{m.name} - {m.position}</option>
                        ))}
                      </select>
                    </div>
                    
                    {/* åä½œäººï¼ˆå¤šé€‰ï¼‰ */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">åä½œäºº</label>
                      <div className="border rounded-lg p-2 max-h-32 overflow-y-auto">
                        {members.map(m => (
                          <label key={m.id} className="flex items-center gap-2 py-1 px-2 hover:bg-gray-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              checked={formData.collaborators.includes(m.id)}
                              onChange={() => handleCollaboratorChange(m.id)}
                              className="rounded text-purple-500 focus:ring-purple-300"
                            />
                            <span className={`w-5 h-5 ${m.color} rounded-full flex items-center justify-center text-white text-xs`}>
                              {m.avatar}
                            </span>
                            <span className="text-sm">{m.name}</span>
                          </label>
                        ))}
                      </div>
                      {formData.collaborators.length > 0 && (
                        <div className="text-xs text-gray-400 mt-1">
                          å·²é€‰ {formData.collaborators.length} äºº
                        </div>
                      )}
                    </div>
                    
                    {/* æè¿° */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">ä»»åŠ¡æè¿°</label>
                      <textarea
                        value={formData.description}
                        onChange={e => setFormData({...formData, description: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none resize-none"
                        rows={2}
                        placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°ï¼ˆé€‰å¡«ï¼‰"
                      />
                    </div>
                    
                    {/* æäº¤æŒ‰é’® */}
                    <div className="flex gap-2 pt-2">
                      <button
                        type="button"
                        onClick={() => setShowAddForm(false)}
                        className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg text-sm hover:bg-gray-50 transition-colors"
                      >
                        å–æ¶ˆ
                      </button>
                      <button
                        type="submit"
                        disabled={isSubmitting}
                        className="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {isSubmitting ? 'æäº¤ä¸­...' : 'åˆ›å»ºä»»åŠ¡'}
                      </button>
                    </div>
                  </form>
                </div>
              )}
              
              {nodeTasks.length > 0 ? (
                <div className="space-y-2">
                  {nodeTasks.map(task => {
                    const assignee = members.find(m => m.id === task.assignee || m.name === task.assigneeName);
                    const isActioning = actionTaskId === task.id;
                    
                    return (
                      <div key={task.id} className="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors">
                        <div className="flex items-start gap-3">
                          {/* çŠ¶æ€å›¾æ ‡ */}
                          <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5 ${
                            task.status === 'å·²å®Œæˆ' ? 'bg-green-500 text-white' :
                            task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500 text-white' :
                            'bg-gray-300 text-gray-600'
                          }`}>
                            {task.status === 'å·²å®Œæˆ' ? 'âœ“' : task.status === 'è¿›è¡Œä¸­' ? 'â—' : 'â—‹'}
                          </div>
                          
                          {/* ä»»åŠ¡ä¿¡æ¯ */}
                          <div className="flex-1 min-w-0">
                            <div className={`font-medium ${task.status === 'å·²å®Œæˆ' ? 'text-gray-400 line-through' : 'text-gray-800'}`}>
                              {task.name}
                            </div>
                            <div className="flex items-center gap-2 mt-1 flex-wrap">
                              {assignee ? (
                                <span className="inline-flex items-center gap-1 text-xs bg-white px-2 py-0.5 rounded-full border">
                                  <span className={`w-4 h-4 ${assignee.color} rounded-full flex items-center justify-center text-white text-xs`}>
                                    {assignee.avatar}
                                  </span>
                                  {assignee.name}
                                </span>
                              ) : task.assigneeName ? (
                                <span className="inline-flex items-center gap-1 text-xs bg-white px-2 py-0.5 rounded-full border">
                                  ğŸ‘¤ {task.assigneeName}
                                </span>
                              ) : null}
                              
                              <span className={`text-xs px-2 py-0.5 rounded-full ${
                                task.priority === 'P0' || task.priority === 'P1' ? 'bg-red-100 text-red-600' :
                                task.priority === 'P2' ? 'bg-yellow-100 text-yellow-600' :
                                'bg-gray-100 text-gray-500'
                              }`}>
                                {task.priority}
                              </span>
                              
                              {task.dueDate && (
                                <span className="text-xs text-gray-400">
                                  ğŸ“… {task.dueDate}
                                </span>
                              )}
                            </div>
                            
                            {/* æ“ä½œæŒ‰é’®åŒºåŸŸ */}
                            <div className="mt-2 flex gap-2">
                              {/* å¾…å¼€å§‹çŠ¶æ€ï¼šæ˜¾ç¤ºæ¥å—ä»»åŠ¡æŒ‰é’® */}
                              {(task.status === 'å¾…å¼€å§‹' || task.status === 'æœªå¼€å§‹') && (
                                <button
                                  onClick={() => handleAcceptTask(task)}
                                  disabled={isActioning}
                                  className="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg transition-colors disabled:opacity-50"
                                >
                                  {isActioning ? 'å¤„ç†ä¸­...' : 'ğŸš€ æ¥å—ä»»åŠ¡'}
                                </button>
                              )}
                              
                              {/* è¿›è¡Œä¸­çŠ¶æ€ï¼šæ˜¾ç¤ºå®Œæˆä»»åŠ¡æŒ‰é’® */}
                              {task.status === 'è¿›è¡Œä¸­' && (
                                <>
                                  {showCompleteForm === task.id ? (
                                    <div className="flex-1 flex gap-2">
                                      <input
                                        type="text"
                                        value={outputFile}
                                        onChange={e => setOutputFile(e.target.value)}
                                        placeholder="è¾“å…¥è¾“å‡ºæ–‡ä»¶é“¾æ¥..."
                                        className="flex-1 px-2 py-1 border rounded text-xs focus:ring-1 focus:ring-green-300 outline-none"
                                      />
                                      <button
                                        onClick={() => handleCompleteTask(task)}
                                        disabled={isActioning}
                                        className="px-2 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded transition-colors disabled:opacity-50"
                                      >
                                        {isActioning ? '...' : 'âœ“'}
                                      </button>
                                      <button
                                        onClick={() => { setShowCompleteForm(null); setOutputFile(''); }}
                                        className="px-2 py-1 bg-gray-300 hover:bg-gray-400 text-gray-700 text-xs rounded transition-colors"
                                      >
                                        âœ•
                                      </button>
                                    </div>
                                  ) : (
                                    <button
                                      onClick={() => setShowCompleteForm(task.id)}
                                      className="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg transition-colors"
                                    >
                                      âœ… å®Œæˆä»»åŠ¡
                                    </button>
                                  )}
                                </>
                              )}
                              
                              {/* å·²å®ŒæˆçŠ¶æ€ï¼šæ˜¾ç¤ºè¾“å‡ºæ–‡ä»¶ */}
                              {task.status === 'å·²å®Œæˆ' && task.outputFile && (
                                <span className="text-xs text-green-600">
                                  ğŸ“ {task.outputFile}
                                </span>
                              )}
                            </div>
                          </div>

                          {/* çŠ¶æ€æ ‡ç­¾ */}
                          <span className={`text-xs px-2 py-1 rounded flex-shrink-0 ${
                            task.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-600' :
                            task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-100 text-blue-600' :
                            'bg-gray-100 text-gray-500'
                          }`}>
                            {task.status}
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : !showAddForm && (
                <div className="text-center py-8 text-gray-400">
                  <div className="text-4xl mb-2">ğŸ“­</div>
                  <div>è¯¥èŠ‚ç‚¹æš‚æ— ä»»åŠ¡</div>
                  <button
                    onClick={() => setShowAddForm(true)}
                    className="mt-3 px-4 py-2 bg-purple-100 text-purple-600 rounded-lg text-sm hover:bg-purple-200 transition-colors"
                  >
                    â• åˆ›å»ºç¬¬ä¸€ä¸ªä»»åŠ¡
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // äº§å“è¯¦æƒ…å¼¹çª— - æ”¯æŒDAGæµç¨‹å›¾ï¼ˆè¡Œè½¨é“å¯¹é½ï¼‰+ èŠ‚ç‚¹ç‚¹å‡»
    const ProductDetailModal = ({ product, nodes, nodeLayers, nodeMap, nodeToLayer, members, tasks, onClose, onRefresh }) => {
      const [selectedNode, setSelectedNode] = useState(null);
      
      if (!product) return null;
      const productTasks = tasks.filter(t => t.productId === product.id);

      // è·å–èŠ‚ç‚¹çŠ¶æ€
      const getNodeStatus = (nodeName) => {
        if (!nodeMap || !nodeToLayer) return 'pending';
        
        const currentNode = nodeMap[product.currentStage];
        const targetNode = nodeMap[nodeName];
        
        if (!currentNode || !targetNode) return 'pending';
        if (nodeName === product.currentStage) return 'current';
        
        const currentLayer = nodeToLayer[product.currentStage] || 0;
        const targetLayer = nodeToLayer[nodeName] || 0;
        
        if (targetLayer < currentLayer) return 'completed';
        if (targetLayer === currentLayer && targetNode.order < currentNode.order) {
          return 'completed';
        }
        
        return 'pending';
      };

      // æ„å»ºæµç¨‹é“¾ï¼ˆæ¯æ¡é“¾æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¡Œï¼‰
      const buildFlowChains = () => {
        if (!nodes || nodes.length === 0) return [];
        
        // æ‰¾åˆ°æ‰€æœ‰èµ·å§‹èŠ‚ç‚¹
        const startNodes = nodes.filter(n => !n.prevNode);
        if (startNodes.length === 0) return [];
        
        const chains = [];
        const visited = new Set();
        
        // é€’å½’æ„å»ºé“¾
        const buildChain = (node, chain = []) => {
          if (!node || visited.has(node.name)) return;
          
          chain.push(node);
          visited.add(node.name);
          
          // è·å–åç»§èŠ‚ç‚¹
          const children = nodes.filter(n => n.prevNode === node.name);
          
          if (children.length === 0) {
            // é“¾ç»“æŸ
            chains.push([...chain]);
          } else if (children.length === 1) {
            // å•ä¸€åç»§ï¼Œç»§ç»­å½“å‰é“¾
            buildChain(children[0], chain);
          } else {
            // å¤šä¸ªåç»§ï¼ˆåˆ†æ”¯ç‚¹ï¼‰ï¼Œä¸ºæ¯ä¸ªåç»§åˆ›å»ºæ–°é“¾
            // å…ˆä¿å­˜å½“å‰é“¾åˆ°åˆ†æ”¯ç‚¹
            const branchPoint = [...chain];
            
            children.forEach((child, idx) => {
              if (idx === 0) {
                // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ç»§ç»­å½“å‰é“¾
                buildChain(child, chain);
              } else {
                // å…¶ä»–å­èŠ‚ç‚¹å¼€å§‹æ–°é“¾ï¼ˆåŒ…å«çˆ¶èŠ‚ç‚¹è·¯å¾„ï¼‰
                visited.delete(child.name); // å…è®¸é‡æ–°è®¿é—®
                const newChain = [...branchPoint];
                buildChain(child, newChain);
              }
            });
          }
        };
        
        // ä»æ¯ä¸ªèµ·å§‹èŠ‚ç‚¹å¼€å§‹æ„å»º
        startNodes.forEach(startNode => {
          buildChain(startNode, []);
        });
        
        return chains;
      };

      // ä½¿ç”¨ç®€åŒ–çš„ç½‘æ ¼å¸ƒå±€
      const buildGridLayout = () => {
        if (!nodes || nodes.length === 0) return { grid: [], maxCol: 0 };
        
        // è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„åˆ—ä½ç½®ï¼ˆåŸºäºå±‚çº§ï¼‰
        const nodePositions = {};
        nodes.forEach(n => {
          nodePositions[n.name] = {
            node: n,
            col: nodeToLayer[n.name] || 0,
            row: -1
          };
        });
        
        // åˆ†é…è¡Œä½ç½®
        // ç­–ç•¥ï¼šåŒä¸€å‰ç½®èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å ç”¨ä¸åŒè¡Œï¼Œä½†åˆ†æ”¯å»¶ç»­åœ¨åŒä¸€è¡Œ
        let currentRow = 0;
        const assignRows = (nodeName, row) => {
          if (nodePositions[nodeName].row !== -1) return;
          nodePositions[nodeName].row = row;
          
          const children = nodes.filter(n => n.prevNode === nodeName);
          if (children.length === 1) {
            // å•ä¸€åç»§ï¼ŒåŒè¡Œå»¶ç»­
            assignRows(children[0].name, row);
          } else if (children.length > 1) {
            // å¤šä¸ªåç»§ï¼Œåˆ†é…ä¸åŒè¡Œ
            children.forEach((child, idx) => {
              if (idx === 0) {
                assignRows(child.name, row);
              } else {
                currentRow++;
                assignRows(child.name, currentRow);
              }
            });
          }
        };
        
        // ä»èµ·å§‹èŠ‚ç‚¹å¼€å§‹åˆ†é…
        const startNodes = nodes.filter(n => !n.prevNode);
        startNodes.forEach((startNode, idx) => {
          if (idx > 0) currentRow++;
          assignRows(startNode.name, currentRow);
        });
        
        // æ‰¾å‡ºæœ€å¤§åˆ—æ•°å’Œè¡Œæ•°
        const maxCol = Math.max(...Object.values(nodePositions).map(p => p.col)) + 1;
        const maxRow = Math.max(...Object.values(nodePositions).map(p => p.row)) + 1;
        
        // æ„å»ºç½‘æ ¼
        const grid = Array(maxRow).fill(null).map(() => Array(maxCol).fill(null));
        Object.values(nodePositions).forEach(pos => {
          if (pos.row >= 0 && pos.col >= 0) {
            grid[pos.row][pos.col] = pos.node;
          }
        });
        
        return { grid, maxCol, maxRow, nodePositions };
      };

      const { grid, maxCol, maxRow, nodePositions } = buildGridLayout();

      // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”»è¿æ¥çº¿
      const shouldDrawLine = (row, col) => {
        if (col >= maxCol - 1) return false;
        const currentNode = grid[row][col];
        const nextNode = grid[row][col + 1];
        if (!currentNode) return false;
        // æ£€æŸ¥ä¸‹ä¸€åˆ—æ˜¯å¦æœ‰èŠ‚ç‚¹æ˜¯å½“å‰èŠ‚ç‚¹çš„åç»§
        if (nextNode && nextNode.prevNode === currentNode.name) return true;
        // æˆ–è€…å½“å‰èŠ‚ç‚¹æœ‰åç»§åœ¨ä¸‹ä¸€åˆ—
        const hasChildInNextCol = nodes.some(n => n.prevNode === currentNode.name && nodePositions[n.name]?.col === col + 1);
        return hasChildInNextCol;
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
          <div className="bg-white rounded-2xl max-w-6xl w-full max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 bg-white/20 rounded-xl flex items-center justify-center text-4xl">
                    {product.image}
                  </div>
                  <div>
                    <h2 className="text-2xl font-bold">{product.name}</h2>
                    <div className="text-white/80 text-sm">{product.category}</div>
                  </div>
                </div>
                <button onClick={onClose} className="text-white/80 hover:text-white text-2xl">Ã—</button>
              </div>
            </div>

            <div className="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
              <div className="grid grid-cols-4 gap-4 mb-6">
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-blue-600">{product.progress}%</div>
                  <div className="text-sm text-gray-500">æ•´ä½“è¿›åº¦</div>
                </div>
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-green-600">
                    {productTasks.filter(t => t.status === 'å·²å®Œæˆ').length}
                  </div>
                  <div className="text-sm text-gray-500">å·²å®Œæˆ</div>
                </div>
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-orange-600">
                    {productTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length}
                  </div>
                  <div className="text-sm text-gray-500">è¿›è¡Œä¸­</div>
                </div>
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-gray-600">
                    {productTasks.filter(t => t.status === 'å¾…å¼€å§‹' || t.status === 'æœªå¼€å§‹').length}
                  </div>
                  <div className="text-sm text-gray-500">å¾…å¼€å§‹</div>
                </div>
              </div>

              <div className="mb-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">ğŸ“ˆ æµç¨‹è¿›åº¦</h3>
                <div className="bg-gray-50 rounded-xl p-4 overflow-x-auto">
                  <div className="min-w-max">
                    {/* ç½‘æ ¼å¸ƒå±€ */}
                    {grid.map((row, rowIndex) => (
                      <div key={rowIndex} className="flex items-center mb-3 last:mb-0">
                        {row.map((node, colIndex) => (
                          <div key={colIndex} className="flex items-center">
                            {/* èŠ‚ç‚¹å•å…ƒæ ¼ */}
                            <div className="w-24 flex flex-col items-center">
                              {node ? (
                                <div 
                                  className="flex flex-col items-center cursor-pointer group"
                                  onClick={() => setSelectedNode(node)}
                                >
                                  <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all group-hover:scale-110 group-hover:shadow-lg ${
                                    getNodeStatus(node.name) === 'completed' ? 'bg-green-500 text-white group-hover:bg-green-600' :
                                    getNodeStatus(node.name) === 'current' ? 'bg-blue-500 text-white ring-4 ring-blue-200 group-hover:bg-blue-600' :
                                    'bg-gray-200 text-gray-400 group-hover:bg-gray-300'
                                  }`}>
                                    {getNodeStatus(node.name) === 'completed' ? 'âœ“' : node.order}
                                  </div>
                                  <div className={`text-xs mt-1 text-center leading-tight group-hover:font-semibold ${
                                    getNodeStatus(node.name) === 'current' ? 'text-blue-600 font-semibold' :
                                    getNodeStatus(node.name) === 'completed' ? 'text-green-600' : 'text-gray-500'
                                  }`}>
                                    {node.name}
                                  </div>
                                  {/* ä»»åŠ¡æ•°é‡æç¤º */}
                                  {(() => {
                                    const nodeTaskCount = productTasks.filter(t => t.stage === node.name).length;
                                    if (nodeTaskCount > 0) {
                                      return (
                                        <div className="text-xs text-purple-500 mt-0.5 opacity-70 group-hover:opacity-100">
                                          {nodeTaskCount} ä»»åŠ¡
                                        </div>
                                      );
                                    }
                                    return null;
                                  })()}
                                </div>
                              ) : (
                                <div className="w-10 h-10"></div>
                              )}
                            </div>
                            {/* è¿æ¥çº¿ */}
                            {colIndex < maxCol - 1 && (
                              <div className="w-8 flex items-center justify-center">
                                {node && shouldDrawLine(rowIndex, colIndex) ? (
                                  <div className={`w-full h-0.5 ${
                                    getNodeStatus(node.name) === 'completed' ? 'bg-green-400' : 'bg-gray-300'
                                  }`}></div>
                                ) : (
                                  <div className="w-full h-0.5 bg-transparent"></div>
                                )}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    ))}
                  </div>
                </div>
                
                {/* å›¾ä¾‹ */}
                <div className="flex gap-4 mt-3 text-xs text-gray-500 items-center justify-between">
                  <div className="flex gap-4">
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-green-500"></span> å·²å®Œæˆ
                    </span>
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-blue-500 ring-2 ring-blue-200"></span> å½“å‰
                    </span>
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-gray-200"></span> å¾…å¼€å§‹
                    </span>
                  </div>
                  <span className="text-purple-500">ğŸ’¡ ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…</span>
                </div>
              </div>

              <div>
                <h3 className="text-lg font-semibold text-gray-800 mb-4">ğŸ“… é¡¹ç›®ç”˜ç‰¹å›¾</h3>
                {productTasks.length > 0 ? (
                  <GanttChart tasks={productTasks} members={members} product={product} />
                ) : (
                  <div className="text-center text-gray-400 py-8 bg-gray-50 rounded-xl">
                    æš‚æ— ä»»åŠ¡æ•°æ®
                  </div>
                )}
              </div>
            </div>
          </div>

          {/* èŠ‚ç‚¹ä»»åŠ¡è¯¦æƒ…å¼¹çª— */}
          {selectedNode && (
            <NodeTaskModal
              node={selectedNode}
              tasks={productTasks}
              members={members}
              product={product}
              nodeRecordId={selectedNode.id}
              onClose={() => setSelectedNode(null)}
              onTaskCreated={onRefresh}
            />
          )}
        </div>
      );
    };

    // äº§å“æ€»è§ˆ
    const ProductOverview = ({ products, nodes, nodeLayers, nodeMap, nodeToLayer, members, tasks, onRefresh }) => {
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [filterStatus, setFilterStatus] = useState('all');
      const [viewMode, setViewMode] = useState('grid');

      const filteredProducts = filterStatus === 'all'
        ? products
        : products.filter(p => p.status === filterStatus);

      const productsByStage = nodes.reduce((acc, node) => {
        acc[node.name] = products.filter(p => p.currentStage === node.name);
        return acc;
      }, {});

      return (
        <div>
          <div className="flex items-center justify-between mb-6">
            <div className="flex gap-2">
              {['all', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ'].map(status => (
                <button
                  key={status}
                  onClick={() => setFilterStatus(status)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                    filterStatus === status ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {status === 'all' ? 'å…¨éƒ¨äº§å“' : status}
                </button>
              ))}
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => setViewMode('grid')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                  viewMode === 'grid' ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-400'
                }`}
              >
                å¡ç‰‡
              </button>
              <button
                onClick={() => setViewMode('pipeline')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                  viewMode === 'pipeline' ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-400'
                }`}
              >
                ç®¡é“
              </button>
            </div>
          </div>

          {viewMode === 'grid' && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
              {filteredProducts.map(product => (
                <ProductCard
                  key={product.id}
                  product={product}
                  nodes={nodes}
                  members={members}
                  tasks={tasks}
                  onClick={setSelectedProduct}
                />
              ))}
              {filteredProducts.length === 0 && (
                <div className="col-span-full text-center text-gray-400 py-12">æš‚æ— äº§å“æ•°æ®</div>
              )}
            </div>
          )}

          {viewMode === 'pipeline' && (
            <div className="overflow-x-auto pb-4">
              <div className="flex gap-4 min-w-max">
                {nodes.map(node => (
                  <div key={node.id} className="w-64 flex-shrink-0">
                    <div className="bg-gray-100 rounded-t-xl px-4 py-3 flex items-center justify-between">
                      <span className="font-medium text-gray-700">{node.name}</span>
                      <span className="bg-white text-gray-500 text-sm px-2 py-0.5 rounded-full">
                        {productsByStage[node.name]?.length || 0}
                      </span>
                    </div>
                    <div className="bg-gray-50 rounded-b-xl p-3 min-h-[300px] space-y-3">
                      {productsByStage[node.name]?.map(product => (
                        <div
                          key={product.id}
                          className="bg-white rounded-lg p-3 card-shadow cursor-pointer hover:shadow-md"
                          onClick={() => setSelectedProduct(product)}
                        >
                          <div className="flex items-center gap-2 mb-2">
                            <span className="text-xl">{product.image}</span>
                            <div className="flex-1 min-w-0">
                              <div className="font-medium text-gray-800 text-sm truncate">{product.name}</div>
                            </div>
                          </div>
                          <div className="flex items-center justify-between">
                            <div className="h-1.5 flex-1 bg-gray-100 rounded-full overflow-hidden mr-2">
                              <div className="h-full bg-blue-500 rounded-full" style={{ width: `${product.progress}%` }} />
                            </div>
                            <span className="text-xs text-gray-500">{product.progress}%</span>
                          </div>
                        </div>
                      ))}
                      {(!productsByStage[node.name] || productsByStage[node.name].length === 0) && (
                        <div className="text-center text-gray-400 text-sm py-8">æš‚æ— äº§å“</div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {selectedProduct && (
            <ProductDetailModal
              product={selectedProduct}
              nodes={nodes}
              nodeLayers={nodeLayers}
              nodeMap={nodeMap}
              nodeToLayer={nodeToLayer}
              members={members}
              tasks={tasks}
              onClose={() => setSelectedProduct(null)}
              onRefresh={onRefresh}
            />
          )}
        </div>
      );
    };

    // äººå‘˜ä»»åŠ¡å¡ç‰‡
    const MemberTaskCard = ({ member, tasks, products }) => {
      const memberTasks = tasks.filter(t => t.assignee === member.id || t.assigneeName === member.name);
      const completedCount = memberTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
      const inProgressCount = memberTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
      const completionRate = memberTasks.length > 0 ? Math.round((completedCount / memberTasks.length) * 100) : 0;

      return (
        <div className="bg-white rounded-xl card-shadow overflow-hidden">
          <div className={`${member.color} p-4 text-white`}>
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-2xl">
                {member.avatar}
              </div>
              <div>
                <div className="font-bold text-lg">{member.name}</div>
                <div className="text-white/80 text-sm">{member.position}</div>
                <div className="flex gap-2 mt-1">
                  <span className="text-white/60 text-xs bg-white/20 px-1.5 py-0.5 rounded">{member.department}</span>
                  <span className="text-white/60 text-xs bg-white/20 px-1.5 py-0.5 rounded">{member.group}</span>
                </div>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-3 divide-x border-b">
            <div className="p-3 text-center">
              <div className="text-xl font-bold text-gray-800">{memberTasks.length}</div>
              <div className="text-xs text-gray-500">æ€»ä»»åŠ¡</div>
            </div>
            <div className="p-3 text-center">
              <div className="text-xl font-bold text-blue-600">{inProgressCount}</div>
              <div className="text-xs text-gray-500">è¿›è¡Œä¸­</div>
            </div>
            <div className="p-3 text-center">
              <div className="text-xl font-bold text-green-600">{completedCount}</div>
              <div className="text-xs text-gray-500">å·²å®Œæˆ</div>
            </div>
          </div>

          <div className="px-4 py-3">
            <div className="flex items-center justify-between text-sm mb-1">
              <span className="text-gray-500">å®Œæˆç‡</span>
              <span className="font-medium">{completionRate}%</span>
            </div>
            <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
              <div className={`h-full ${member.color} rounded-full`} style={{ width: `${completionRate}%` }} />
            </div>
          </div>

          <div className="p-4 max-h-48 overflow-y-auto border-t">
            {memberTasks.slice(0, 5).map(task => {
              const product = products.find(p => p.id === task.productId);
              return (
                <div key={task.id} className="flex items-center justify-between py-2 border-b last:border-0">
                  <div className="flex-1 min-w-0">
                    <div className="text-sm text-gray-800 truncate">{task.name}</div>
                    <div className="text-xs text-gray-400">{product?.name}</div>
                  </div>
                  <span className={`text-xs px-2 py-0.5 rounded ml-2 ${
                    task.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-600' :
                    task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-100 text-blue-600' :
                    'bg-gray-100 text-gray-500'
                  }`}>
                    {task.status}
                  </span>
                </div>
              );
            })}
            {memberTasks.length === 0 && (
              <div className="text-center text-gray-400 py-4">æš‚æ— ä»»åŠ¡</div>
            )}
          </div>
        </div>
      );
    };

    // äººå‘˜ä»»åŠ¡æ€»è§ˆ - éƒ¨é—¨ä¸€çº§ + ç»„åˆ«äºŒçº§ç­›é€‰
    const TeamTaskOverview = ({ members, tasks, products, groups }) => {
      const [filterDept, setFilterDept] = useState('all'); // ä¸€çº§ï¼šéƒ¨é—¨
      const [filterGroup, setFilterGroup] = useState('all'); // äºŒçº§ï¼šç»„åˆ«
      const [viewMode, setViewMode] = useState('grid'); // grid | list

      // æå–æ‰€æœ‰éƒ¨é—¨
      const departments = [...new Set(members.map(m => m.department).filter(d => d))];
      
      // æ ¹æ®é€‰ä¸­çš„éƒ¨é—¨ï¼Œè·å–è¯¥éƒ¨é—¨ä¸‹çš„ç»„åˆ«
      const availableGroups = filterDept === 'all' 
        ? groups 
        : [...new Set(members.filter(m => m.department === filterDept).map(m => m.group).filter(g => g))];

      // å½“éƒ¨é—¨æ”¹å˜æ—¶ï¼Œé‡ç½®ç»„åˆ«ç­›é€‰
      const handleDeptChange = (dept) => {
        setFilterDept(dept);
        setFilterGroup('all');
      };

      // ç­›é€‰æˆå‘˜ï¼šå…ˆæŒ‰éƒ¨é—¨ï¼Œå†æŒ‰ç»„åˆ«
      const filteredMembers = members.filter(m => {
        const deptMatch = filterDept === 'all' || m.department === filterDept;
        const groupMatch = filterGroup === 'all' || m.group === filterGroup;
        return deptMatch && groupMatch;
      });

      return (
        <div>
          {/* ä¸€çº§ç­›é€‰ï¼šéƒ¨é—¨ */}
          <div className="mb-4">
            <div className="text-sm text-gray-500 mb-2">ğŸ“‚ éƒ¨é—¨</div>
            <div className="flex gap-2 flex-wrap">
              <button
                onClick={() => handleDeptChange('all')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                  filterDept === 'all' ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                }`}
              >
                å…¨éƒ¨éƒ¨é—¨
              </button>
              {departments.map(dept => (
                <button
                  key={dept}
                  onClick={() => handleDeptChange(dept)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                    filterDept === dept ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {dept}
                </button>
              ))}
            </div>
          </div>

          {/* äºŒçº§ç­›é€‰ï¼šç»„åˆ« */}
          <div className="mb-4">
            <div className="text-sm text-gray-500 mb-2">ğŸ‘¥ ç»„åˆ«</div>
            <div className="flex gap-2 flex-wrap items-center">
              <button
                onClick={() => setFilterGroup('all')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                  filterGroup === 'all' ? 'bg-purple-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                }`}
              >
                å…¨éƒ¨ç»„åˆ«
              </button>
              {availableGroups.map(group => (
                <button
                  key={group}
                  onClick={() => setFilterGroup(group)}
                  className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                    filterGroup === group ? 'bg-purple-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {group}
                </button>
              ))}
              {availableGroups.length === 0 && filterDept !== 'all' && (
                <span className="text-sm text-gray-400">è¯¥éƒ¨é—¨æš‚æ— ç»„åˆ«</span>
              )}
            </div>
          </div>

          {/* è§†å›¾åˆ‡æ¢å’Œç»Ÿè®¡ */}
          <div className="flex items-center justify-between mb-6">
            <div className="text-sm text-gray-500">
              å…± <span className="font-medium text-gray-800">{filteredMembers.length}</span> åæˆå‘˜
            </div>
            <div className="flex gap-2">
              <button
                onClick={() => setViewMode('grid')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                  viewMode === 'grid' ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-400'
                }`}
              >
                å¡ç‰‡
              </button>
              <button
                onClick={() => setViewMode('list')}
                className={`px-3 py-1.5 rounded-lg text-sm font-medium ${
                  viewMode === 'list' ? 'bg-blue-100 text-blue-600' : 'bg-white text-gray-400'
                }`}
              >
                åˆ—è¡¨
              </button>
            </div>
          </div>

          {/* å¡ç‰‡è§†å›¾ */}
          {viewMode === 'grid' && (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              {filteredMembers.map(member => (
                <MemberTaskCard
                  key={member.id}
                  member={member}
                  tasks={tasks}
                  products={products}
                />
              ))}
              {filteredMembers.length === 0 && (
                <div className="col-span-full text-center text-gray-400 py-12">æš‚æ— æˆå‘˜æ•°æ®</div>
              )}
            </div>
          )}

          {/* åˆ—è¡¨è§†å›¾ */}
          {viewMode === 'list' && (
            <div className="bg-white rounded-xl card-shadow overflow-hidden">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">æˆå‘˜</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">éƒ¨é—¨</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">ç»„åˆ«</th>
                    <th className="px-4 py-3 text-left text-sm font-medium text-gray-500">èŒä½</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-500">æ€»ä»»åŠ¡</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-500">è¿›è¡Œä¸­</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-500">å·²å®Œæˆ</th>
                    <th className="px-4 py-3 text-center text-sm font-medium text-gray-500">å®Œæˆç‡</th>
                  </tr>
                </thead>
                <tbody className="divide-y">
                  {filteredMembers.map(member => {
                    const memberTasks = tasks.filter(t => t.assignee === member.id || t.assigneeName === member.name);
                    const completedCount = memberTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
                    const inProgressCount = memberTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
                    const completionRate = memberTasks.length > 0 ? Math.round((completedCount / memberTasks.length) * 100) : 0;
                    
                    return (
                      <tr key={member.id} className="hover:bg-gray-50">
                        <td className="px-4 py-3">
                          <div className="flex items-center gap-2">
                            <span className={`w-8 h-8 ${member.color} rounded-full flex items-center justify-center text-white text-sm`}>
                              {member.avatar}
                            </span>
                            <span className="font-medium text-gray-800">{member.name}</span>
                          </div>
                        </td>
                        <td className="px-4 py-3">
                          <span className="px-2 py-1 bg-blue-50 text-blue-600 rounded text-xs">
                            {member.department}
                          </span>
                        </td>
                        <td className="px-4 py-3">
                          <span className="px-2 py-1 bg-purple-50 text-purple-600 rounded text-xs">
                            {member.group}
                          </span>
                        </td>
                        <td className="px-4 py-3 text-gray-600 text-sm">{member.position}</td>
                        <td className="px-4 py-3 text-center font-medium text-gray-800">{memberTasks.length}</td>
                        <td className="px-4 py-3 text-center font-medium text-blue-600">{inProgressCount}</td>
                        <td className="px-4 py-3 text-center font-medium text-green-600">{completedCount}</td>
                        <td className="px-4 py-3">
                          <div className="flex items-center gap-2">
                            <div className="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                              <div className={`h-full ${member.color} rounded-full`} style={{ width: `${completionRate}%` }} />
                            </div>
                            <span className="text-sm font-medium text-gray-600 w-10">{completionRate}%</span>
                          </div>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
              {filteredMembers.length === 0 && (
                <div className="text-center text-gray-400 py-12">æš‚æ— æˆå‘˜æ•°æ®</div>
              )}
            </div>
          )}
        </div>
      );
    };

    // ç»Ÿè®¡å¡ç‰‡
    const StatCard = ({ title, value, subtitle, color, icon }) => (
      <div className="bg-white rounded-xl p-5 card-shadow">
        <div className="flex items-center justify-between">
          <div>
            <div className="text-sm text-gray-500">{title}</div>
            <div className={`text-3xl font-bold ${color} mt-1`}>{value}</div>
            {subtitle && <div className="text-xs text-gray-400 mt-1">{subtitle}</div>}
          </div>
          <div className="text-3xl">{icon}</div>
        </div>
      </div>
    );

    // ä¸»åº”ç”¨
    const App = () => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [activeTab, setActiveTab] = useState('products');
      const [lastUpdate, setLastUpdate] = useState(null);

      const fetchData = async () => {
        setLoading(true);
        setError(null);
        try {
          const res = await fetch(API_BASE + '/api/lark?app_token=' + APP_TOKEN);
          const json = await res.json();
          
          if (json.success) {
            const transformed = transformData(json.data);
            setData(transformed);
            setLastUpdate(new Date().toLocaleTimeString());
          } else {
            throw new Error(json.error || 'æ•°æ®åŠ è½½å¤±è´¥');
          }
        } catch (err) {
          setError(err.message);
        }
        setLoading(false);
      };

      useEffect(() => {
        fetchData();
        const interval = setInterval(fetchData, 5 * 60 * 1000);
        return () => clearInterval(interval);
      }, []);

      if (loading && !data) return <LoadingScreen />;

      const stats = data ? {
        totalProducts: data.products.length,
        completedProducts: data.products.filter(p => p.status === 'å·²å®Œæˆ').length,
        completedTasks: data.tasks.filter(t => t.status === 'å·²å®Œæˆ').length,
        totalTasks: data.tasks.length,
        avgProgress: data.products.length > 0 
          ? Math.round(data.products.reduce((sum, p) => sum + p.progress, 0) / data.products.length) 
          : 0,
        teamMembers: data.members.length
      } : {};

      return (
        <div className="min-h-screen bg-gray-50">
          <div className="gradient-bg text-white py-6 px-8">
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold">æ–°å“OKRé¡¹ç›®ç®¡ç†ç³»ç»Ÿ</h1>
                <p className="text-white/80 mt-1">å®æ—¶æ•°æ® Â· é£ä¹¦åŒæ­¥</p>
              </div>
              <div className="flex items-center gap-4">
                {lastUpdate && (
                  <span className="text-white/60 text-sm">æ›´æ–°äº {lastUpdate}</span>
                )}
                <button 
                  onClick={fetchData}
                  className="px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg text-sm flex items-center gap-1"
                >
                  ğŸ”„ åˆ·æ–°
                </button>
              </div>
            </div>
          </div>

          {error && (
            <div className="max-w-7xl mx-auto px-8 py-2">
              <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-2 rounded-lg text-sm">
                âš ï¸ {error}
              </div>
            </div>
          )}

          {data && (
            <div className="max-w-7xl mx-auto px-8 py-6">
              <div className="grid grid-cols-5 gap-4 mb-6">
                <StatCard title="äº§å“æ€»æ•°" value={stats.totalProducts} subtitle={`å·²ä¸Šçº¿ ${stats.completedProducts}`} color="text-purple-600" icon="ğŸ“¦" />
                <StatCard title="å¹³å‡è¿›åº¦" value={`${stats.avgProgress}%`} subtitle="æ‰€æœ‰äº§å“" color="text-blue-600" icon="ğŸ“Š" />
                <StatCard title="ä»»åŠ¡å®Œæˆ" value={`${stats.completedTasks}/${stats.totalTasks}`} color="text-green-600" icon="âœ…" />
                <StatCard title="è¿›è¡Œä¸­" value={stats.totalProducts - stats.completedProducts} subtitle="å¼€å‘ä¸­äº§å“" color="text-orange-600" icon="ğŸš€" />
                <StatCard title="å›¢é˜Ÿæˆå‘˜" value={stats.teamMembers} color="text-pink-600" icon="ğŸ‘¥" />
              </div>

              <div className="flex gap-2 mb-6">
                {[
                  { key: 'products', label: 'ğŸ“¦ äº§å“è¿›åº¦' },
                  { key: 'team', label: 'ğŸ‘¥ äººå‘˜ä»»åŠ¡' }
                ].map(tab => (
                  <button
                    key={tab.key}
                    onClick={() => setActiveTab(tab.key)}
                    className={`px-4 py-2 rounded-lg font-medium transition-colors ${
                      activeTab === tab.key ? 'bg-blue-500 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'
                    }`}
                  >
                    {tab.label}
                  </button>
                ))}
              </div>

              {activeTab === 'products' && (
                <ProductOverview
                  products={data.products}
                  nodes={data.processNodes}
                  nodeLayers={data.processNodeLayers}
                  nodeMap={data.nodeMap}
                  nodeToLayer={data.nodeToLayer}
                  members={data.members}
                  tasks={data.tasks}
                  onRefresh={fetchData}
                />
              )}

              {activeTab === 'team' && (
                <TeamTaskOverview
                  members={data.members}
                  tasks={data.tasks}
                  products={data.products}
                  groups={data.groups}
                />
              )}
            </div>
          )}

          <div className="text-center py-6 text-gray-400 text-sm">
            æ•°æ®æ¥æºï¼šé£ä¹¦å¤šç»´è¡¨æ ¼ Â· æ¯5åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥
          </div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
