<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¾®é“¸é¡¹ç›®ç®¡ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --c-bg: #f5f5f7;
      --c-surface: #ffffff;
      --c-border: #d2d2d7;
      --c-text: #1d1d1f;
      --c-text-secondary: #6e6e73;
      --c-text-muted: #86868b;
      --c-accent: #6c5ce7;
      --c-accent-light: #a29bfe;
      --c-accent-bg: #f0eeff;
      --c-success: #34c759;
      --c-warning: #ff9f0a;
      --c-danger: #ff3b30;
      --c-info: #007aff;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
      --shadow-md: 0 4px 14px rgba(0,0,0,0.06), 0 1px 3px rgba(0,0,0,0.03);
      --shadow-lg: 0 12px 40px rgba(0,0,0,0.08), 0 2px 6px rgba(0,0,0,0.03);
      --radius: 12px;
      --radius-sm: 8px;
      --font: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', system-ui, sans-serif;
    }
    * { font-family: var(--font); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    body { background: var(--c-bg); color: var(--c-text); font-size: 14px; line-height: 1.47059; letter-spacing: -0.022em; }
    .gradient-bg { background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 50%, #007aff 100%); }
    .card-shadow { box-shadow: var(--shadow-sm); }
    .card { background: var(--c-surface); border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--c-border); transition: box-shadow 0.25s cubic-bezier(.4,0,.2,1), transform 0.25s cubic-bezier(.4,0,.2,1); }
    .card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
    .card-flat { background: var(--c-surface); border-radius: var(--radius); border: 1px solid var(--c-border); }
    .stat-card { background: var(--c-surface); border-radius: var(--radius); box-shadow: var(--shadow-sm); border: 1px solid var(--c-border); padding: 12px 10px; position: relative; overflow: hidden; }
    @media (min-width: 640px) { .stat-card { padding: 18px 20px; } }
    .stat-card::after { content:''; position: absolute; top: 0; left: 0; right: 0; height: 2px; }
    .stat-card.purple::after { background: var(--c-accent); }
    .stat-card.blue::after { background: var(--c-info); }
    .stat-card.indigo::after { background: #5856d6; }
    .stat-card.green::after { background: var(--c-success); }
    .stat-card.red::after { background: var(--c-danger); }
    .tab-btn { padding: 8px 16px; border-radius: var(--radius-sm); font-weight: 500; font-size: 13px; transition: all 0.2s; border: 1px solid transparent; letter-spacing: -0.01em; }
    .tab-btn.active { background: var(--c-accent); color: white; border-color: var(--c-accent); box-shadow: 0 2px 8px rgba(108,92,231,0.25); }
    .tab-btn:not(.active) { color: var(--c-text-secondary); background: var(--c-surface); border-color: var(--c-border); }
    .tab-btn:not(.active):hover { background: var(--c-accent-bg); color: var(--c-accent); border-color: var(--c-accent-light); }
    .section-header { font-size: 14px; font-weight: 600; color: var(--c-text); letter-spacing: -0.01em; }
    .badge { padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 500; letter-spacing: 0; }
    .badge-purple { background: var(--c-accent-bg); color: var(--c-accent); }
    .badge-blue { background: #e8f0fe; color: #007aff; }
    .badge-green { background: #e5f8ed; color: #34c759; }
    .badge-red { background: #ffeae8; color: #ff3b30; }
    .badge-gray { background: #f5f5f7; color: var(--c-text-secondary); }
    .badge-yellow { background: #fff8e1; color: #ff9f0a; }
    .pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    @keyframes pulseSubtle { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.3); } 50% { box-shadow: 0 0 0 4px rgba(239,68,68,0.1); } }
    .animate-pulse-subtle { animation: pulseSubtle 2s ease-in-out infinite; }
    .loading-spinner { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .toast-enter { animation: toastIn 0.3s ease-out; }
    .toast-exit { animation: toastOut 0.3s ease-in forwards; }
    @keyframes toastIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-20px); opacity: 0; } }
    input, select { border-color: var(--c-border) !important; }
    input:focus, select:focus { border-color: var(--c-accent-light) !important; box-shadow: 0 0 0 3px rgba(108,92,231,0.1) !important; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #d1d5e4; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #b0b6cc; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, createContext, useContext, useCallback } = React;

    const API_BASE = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : '';

    const APP_TOKEN = 'N5OqbwkO1a2PbpsaM05ckGrMnxg';
    
    // é£ä¹¦åº”ç”¨é…ç½®
    const LARK_APP_ID = 'cli_a9f32c79e4f9dbd2';
    const LARK_REDIRECT_URI = window.location.origin + window.location.pathname;
    
    // ç”¨æˆ·ä¸Šä¸‹æ–‡
    const UserContext = createContext(null);
    
    // Toast ä¸Šä¸‹æ–‡
    const ToastContext = createContext(null);
    
    // Toast ç»„ä»¶
    const Toast = ({ message, type, onClose }) => {
      const [isExiting, setIsExiting] = useState(false);
      
      useEffect(() => {
        const timer = setTimeout(() => {
          setIsExiting(true);
          setTimeout(onClose, 300);
        }, 2500);
        return () => clearTimeout(timer);
      }, [onClose]);
      
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      const icon = type === 'success' ? 'âœ“' : type === 'error' ? 'âœ•' : 'â„¹';
      
      return (
        <div className={`${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${isExiting ? 'toast-exit' : 'toast-enter'}`}>
          <span className="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center text-sm">{icon}</span>
          <span>{message}</span>
        </div>
      );
    };
    
    // Toast å®¹å™¨
    const ToastContainer = ({ children }) => {
      const [toasts, setToasts] = useState([]);
      
      const showToast = useCallback((message, type = 'success') => {
        const id = Date.now();
        setToasts(prev => [...prev, { id, message, type }]);
      }, []);
      
      const removeToast = useCallback((id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      }, []);
      
      return (
        <ToastContext.Provider value={showToast}>
          {children}
          <div className="fixed top-4 right-4 z-50 flex flex-col gap-2">
            {toasts.map(toast => (
              <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />
            ))}
          </div>
        </ToastContext.Provider>
      );
    };
    
    // ä½¿ç”¨ Toast çš„ Hook
    const useToast = () => useContext(ToastContext);
    
    // è·å–é£ä¹¦ç™»å½• URL
    const getLarkLoginUrl = () => {
      const state = Math.random().toString(36).substring(7);
      localStorage.setItem('lark_oauth_state', state);
      return `https://open.feishu.cn/open-apis/authen/v1/authorize?app_id=${LARK_APP_ID}&redirect_uri=${encodeURIComponent(LARK_REDIRECT_URI)}&state=${state}`;
    };
    
    // å¤„ç† OAuth å›è°ƒ
    const handleOAuthCallback = async (code) => {
      try {
        const res = await fetch(`${API_BASE}/api/auth-callback?code=${code}`);
        const data = await res.json();
        
        if (data.success) {
          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° localStorage
          localStorage.setItem('lark_user', JSON.stringify(data.data.user));
          localStorage.setItem('lark_access_token', data.data.access_token);
          localStorage.setItem('lark_token_expires', Date.now() + data.data.expires_in * 1000);
          
          // æ¸…é™¤ URL ä¸­çš„ code å‚æ•°
          window.history.replaceState({}, document.title, window.location.pathname);
          
          return data.data.user;
        } else {
          throw new Error(data.error);
        }
      } catch (error) {
        console.error('OAuth callback error:', error);
        alert('ç™»å½•å¤±è´¥: ' + error.message);
        return null;
      }
    };
    
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const checkLoginStatus = () => {
      const user = localStorage.getItem('lark_user');
      const expires = localStorage.getItem('lark_token_expires');
      
      if (user && expires && Date.now() < parseInt(expires)) {
        return JSON.parse(user);
      }
      
      // æ¸…é™¤è¿‡æœŸçš„ç™»å½•ä¿¡æ¯
      localStorage.removeItem('lark_user');
      localStorage.removeItem('lark_access_token');
      localStorage.removeItem('lark_token_expires');
      return null;
    };
    
    // é€€å‡ºç™»å½•
    const logout = () => {
      localStorage.removeItem('lark_user');
      localStorage.removeItem('lark_access_token');
      localStorage.removeItem('lark_token_expires');
      window.location.reload();
    };

    // æ•°æ®è½¬æ¢å‡½æ•°
    const transformData = (rawData) => {
      const data = {
        objectives: [],
        keyResults: [],
        products: [],
        tasks: [],
        members: [],
        processNodes: [],
        processNodeLayers: [], // DAGåˆ†å±‚
        nodeMap: {}, // èŠ‚ç‚¹åç§°åˆ°èŠ‚ç‚¹çš„æ˜ å°„
        nodeToLayer: {}, // èŠ‚ç‚¹åç§°åˆ°å±‚çº§çš„æ˜ å°„
        templates: {}, // templateId -> { name, type }
        groups: []
      };

      // è½¬æ¢ç›®æ ‡è¡¨
      if (rawData['ç›®æ ‡ Objectives']) {
        data.objectives = rawData['ç›®æ ‡ Objectives'].records.map(r => {
          // å¤„ç†å¯Œæ–‡æœ¬å­—æ®µæ ¼å¼: [{ text: '...', type: 'text' }]
          let objName = '';
          const nameField = r.fields['ç›®æ ‡åç§°'];
          if (Array.isArray(nameField)) {
            objName = nameField.map(item => item.text || '').join('');
          } else if (typeof nameField === 'string') {
            objName = nameField;
          }
          
          // æå–è´Ÿè´£äºº
          const ownerField = r.fields['è´Ÿè´£äºº'];
          let ownerId = null, ownerName = '';
          if (ownerField) {
            if (Array.isArray(ownerField) && ownerField[0]) {
              ownerId = ownerField[0].id;
              ownerName = ownerField[0].name || '';
            } else if (ownerField.id) {
              ownerId = ownerField.id;
              ownerName = ownerField.name || '';
            }
          }
          
          return {
            id: r.record_id,
            name: objName,
            cycle: r.fields['ç›®æ ‡å‘¨æœŸ'] || '',
            level: r.fields['ç›®æ ‡å±‚çº§'] || '',
            department: r.fields['æ‰€å±éƒ¨é—¨'] || '',
            progress: r.fields['è¿›åº¦'] || 0,
            status: r.fields['çŠ¶æ€'] || 'æœªå¼€å§‹',
            ownerId,
            ownerName
          };
        }).filter(obj => obj.name); // è¿‡æ»¤æ‰ç©ºç›®æ ‡
      }

      // è½¬æ¢å…³é”®ç»“æœè¡¨
      if (rawData['å…³é”®ç»“æœ Key Results']) {
        data.keyResults = rawData['å…³é”®ç»“æœ Key Results'].records.map((r, idx) => {
          // å¤„ç†å…³è”å­—æ®µ - æ”¯æŒå¤šç§æ ¼å¼
          let objectiveId = null;
          const linkedObj = r.fields['æ‰€å±ç›®æ ‡'];
          
          if (linkedObj) {
            // æ ¼å¼1: { link_record_ids: ['recXXX'] } (MCP æ ¼å¼)
            if (linkedObj.link_record_ids?.[0]) {
              objectiveId = linkedObj.link_record_ids[0];
            }
            // æ ¼å¼2: [{ record_ids: ['recXXX'], ... }] (Vercel API æ ¼å¼)
            else if (Array.isArray(linkedObj) && linkedObj[0]?.record_ids?.[0]) {
              objectiveId = linkedObj[0].record_ids[0];
            }
            // æ ¼å¼3: ['recXXX'] æ•°ç»„
            else if (Array.isArray(linkedObj) && typeof linkedObj[0] === 'string') {
              objectiveId = linkedObj[0];
            }
            // æ ¼å¼4: ç›´æ¥å­—ç¬¦ä¸²
            else if (typeof linkedObj === 'string') {
              objectiveId = linkedObj;
            }
          }
          
          // å¤„ç†å¯Œæ–‡æœ¬å­—æ®µæ ¼å¼: [{ text: '...', type: 'text' }]
          let krName = '';
          const krDesc = r.fields['KRæè¿°'];
          if (Array.isArray(krDesc)) {
            krName = krDesc.map(item => item.text || '').join('');
          } else if (typeof krDesc === 'string') {
            krName = krDesc;
          }
          
          // æå–KRè´Ÿè´£äºº
          const krOwnerField = r.fields['è´Ÿè´£äºº'];
          let krOwnerId = null, krOwnerName = '';
          if (krOwnerField) {
            if (Array.isArray(krOwnerField) && krOwnerField[0]) {
              krOwnerId = krOwnerField[0].id;
              krOwnerName = krOwnerField[0].name || '';
            } else if (krOwnerField.id) {
              krOwnerId = krOwnerField.id;
              krOwnerName = krOwnerField.name || '';
            }
          }

          return {
            id: r.record_id,
            name: krName,
            target: r.fields['ç›®æ ‡å€¼'] || 0,
            current: r.fields['å½“å‰å€¼'] || 0,
            weight: r.fields['æƒé‡'] || 0,
            status: r.fields['çŠ¶æ€'] || 'æœªå¼€å§‹',
            objectiveId: objectiveId,
            ownerId: krOwnerId,
            ownerName: krOwnerName,
            unit: r.fields['å•ä½'] || '',
            // ä»åç§°æ¨æ–­è¿ç®—ç¬¦å’ŒKRç±»å‹
            operator: krName.includes('â‰¤') ? 'â‰¤' : krName.includes('â‰¥') ? 'â‰¥' : krName.includes('è¾¾åˆ°') ? 'è¾¾åˆ°' : krName.includes('å®Œæˆ') ? 'å®Œæˆ' : 'â‰¥',
            krType: (r.fields['å•ä½'] === 'å¤©') ? 'metric_duration' : 
                    (r.fields['å•ä½'] === '%' || r.fields['å•ä½'] === 'ä¸‡å…ƒ') ? 'metric_value' : 'project_count'
          };
        });
      }

      // è½¬æ¢é¡¹ç›®è¡¨ä¸ºäº§å“
      if (rawData['é¡¹ç›® Projects']) {
        const projectEmojis = ['ğŸ“¦', 'ğŸ¯', 'ğŸš€', 'ğŸ’¡', 'ğŸ”§', 'ğŸ“±', 'ğŸ¨', 'ğŸ›’'];
        data.products = rawData['é¡¹ç›® Projects'].records.map((r, idx) => {
          // ä¿®å¤è¿›åº¦è®¡ç®—
          let progress = r.fields['æ•´ä½“è¿›åº¦'] || 0;
          if (progress > 0 && progress <= 1) {
            progress = Math.round(progress * 100);
          } else if (progress > 100) {
            progress = 100;
          }
          progress = Math.round(progress);
          
          // å¤„ç†å…³è”KRå­—æ®µ - æ”¯æŒå¤šç§æ ¼å¼
          let krId = null;
          const linkedKR = r.fields['å…³è”KR'];
          if (linkedKR) {
            if (linkedKR.link_record_ids?.[0]) {
              krId = linkedKR.link_record_ids[0];
            } else if (Array.isArray(linkedKR) && linkedKR[0]?.record_ids?.[0]) {
              krId = linkedKR[0].record_ids[0];
            } else if (Array.isArray(linkedKR) && typeof linkedKR[0] === 'string') {
              krId = linkedKR[0];
            }
          }
          
          // å¤„ç†é¡¹ç›®è´Ÿè´£äºº
          const ownerField = r.fields['é¡¹ç›®è´Ÿè´£äºº'];
          let ownerId = null;
          let ownerName = '';
          if (ownerField) {
            if (Array.isArray(ownerField) && ownerField[0]) {
              ownerId = ownerField[0].id || null;
              ownerName = ownerField[0].name || '';
            } else if (ownerField.id) {
              ownerId = ownerField.id;
              ownerName = ownerField.name || '';
            }
          }
          
          // å¤„ç†çˆ¶é¡¹ç›®å…³è”
          let parentId = null;
          const parentField = r.fields['çˆ¶é¡¹ç›®'];
          if (parentField) {
            if (parentField.link_record_ids?.[0]) {
              parentId = parentField.link_record_ids[0];
            } else if (Array.isArray(parentField) && parentField[0]?.record_ids?.[0]) {
              parentId = parentField[0].record_ids[0];
            }
          }
          
          return {
            id: r.record_id,
            name: r.fields['é¡¹ç›®åç§°'] || '',
            category: r.fields['é¡¹ç›®ç±»å‹'] || '',
            templateType: r.fields['æ¨¡ç‰ˆç±»å‹'] || '',
            image: projectEmojis[idx % projectEmojis.length],
            currentStage: r.fields['å½“å‰é˜¶æ®µ'] || '',
            progress: progress,
            status: r.fields['é¡¹ç›®çŠ¶æ€'] || 'è¿›è¡Œä¸­',
            startDate: r.fields['å¼€å§‹æ—¥æœŸ'] ? new Date(r.fields['å¼€å§‹æ—¥æœŸ']).toISOString().split('T')[0] : '',
            targetDate: r.fields['è®¡åˆ’ä¸Šçº¿æ—¥æœŸ'] ? new Date(r.fields['è®¡åˆ’ä¸Šçº¿æ—¥æœŸ']).toISOString().split('T')[0] : '',
            priority: r.fields['é‡è¦ç¨‹åº¦'] || '',
            krId: krId,
            ownerId: ownerId,
            ownerName: ownerName,
            parentId: parentId,
            childIds: [], // åé¢ä» parentId åæ¨
            responsibleDept: r.fields['è´Ÿè´£éƒ¨é—¨'] || '',
            initiatorGroup: r.fields['å‘èµ·ç»„'] || '', // å‘èµ·ç»„åˆ«
            skippedNodes: (() => {
              try {
                const v = r.fields['è·³è¿‡èŠ‚ç‚¹'];
                if (!v) return [];
                if (Array.isArray(v)) {
                  // å¯Œæ–‡æœ¬æ ¼å¼: [{ text: '...', type: 'text' }]
                  const txt = v.map(item => item.text || '').join('');
                  return txt ? JSON.parse(txt) : [];
                }
                if (typeof v === 'string') return JSON.parse(v);
                return [];
              } catch(e) { return []; }
            })() // è·³è¿‡çš„èŠ‚ç‚¹åç§°åˆ—è¡¨
          };
        });

        // ä» parentId åæ¨ childIdsï¼ˆé£ä¹¦DuplexLinkåå‘å­—æ®µä¸åœ¨APIè¿”å›ä¸­ï¼‰
        data.products.forEach(p => {
          if (p.parentId) {
            const parent = data.products.find(pp => pp.id === p.parentId);
            if (parent) parent.childIds.push(p.id);
          }
        });
      }

      // è½¬æ¢ä»»åŠ¡è¡¨ - ä¼˜å…ˆä½¿ç”¨ã€Œæ‰€å±èŠ‚ç‚¹ã€å…³è”å­—æ®µ
      if (rawData['ä»»åŠ¡ Tasks']) {
        // å…ˆå»ºç«‹èŠ‚ç‚¹ record_id åˆ°èŠ‚ç‚¹åç§°çš„æ˜ å°„
        const nodeRecordMap = {};
        if (rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes']) {
          rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes'].records.forEach(r => {
            let nodeName = r.fields['èŠ‚ç‚¹åç§°'];
            if (Array.isArray(nodeName)) {
              nodeName = nodeName.map(n => n.text || n).join('');
            }
            nodeRecordMap[r.record_id] = nodeName;
          });
        }
        
        data.tasks = rawData['ä»»åŠ¡ Tasks'].records.map((r) => {
          // ä¼˜å…ˆä½¿ç”¨ã€Œæ‰€å±èŠ‚ç‚¹ã€å…³è”å­—æ®µ
          let stage = '';
          const linkedNode = r.fields['æ‰€å±èŠ‚ç‚¹'];
          
          if (linkedNode) {
            // Vercel API æ ¼å¼: [{record_ids: [...], text: "èŠ‚ç‚¹åç§°", ...}]
            if (Array.isArray(linkedNode) && linkedNode.length > 0) {
              const firstItem = linkedNode[0];
              // ç›´æ¥ä½¿ç”¨ text å­—æ®µï¼ˆæœ€ç®€å•ï¼‰
              if (firstItem.text) {
                stage = firstItem.text;
              } else if (firstItem.record_ids && firstItem.record_ids.length > 0) {
                stage = nodeRecordMap[firstItem.record_ids[0]] || '';
              }
            }
            // é£ä¹¦ MCP æ ¼å¼: {link_record_ids: [...]}
            else if (linkedNode.link_record_ids && linkedNode.link_record_ids.length > 0) {
              stage = nodeRecordMap[linkedNode.link_record_ids[0]] || '';
            }
          }
          
          // å¦‚æœæ²¡æœ‰è®¾ç½®æ‰€å±èŠ‚ç‚¹ï¼Œå›é€€åˆ°æ—§çš„ã€Œæ‰€å±é˜¶æ®µã€å•é€‰å­—æ®µ
          if (!stage) {
            stage = r.fields['æ‰€å±é˜¶æ®µ'] || '';
          }
          
          // å¤„ç†ä»»åŠ¡åç§°ï¼ˆå¯èƒ½æ˜¯æ•°ç»„æ ¼å¼æˆ–å­—ç¬¦ä¸²ï¼‰
          let taskName = r.fields['ä»»åŠ¡åç§°'] || '';
          if (Array.isArray(taskName)) {
            taskName = taskName.map(n => n.text || n).join('');
          }
          
          // è§£ææ‰€å±é¡¹ç›®
          let productId = null;
          const projectField = r.fields['æ‰€å±é¡¹ç›®'];
          if (projectField) {
            // Vercel API æ ¼å¼: [{record_ids: [...], text: "é¡¹ç›®åç§°", ...}]
            if (Array.isArray(projectField) && projectField.length > 0) {
              const firstItem = projectField[0];
              if (firstItem.record_ids && firstItem.record_ids.length > 0) {
                productId = firstItem.record_ids[0];
              }
            }
            // é£ä¹¦ MCP æ ¼å¼: {link_record_ids: [...]}
            else if (projectField.link_record_ids && projectField.link_record_ids.length > 0) {
              productId = projectField.link_record_ids[0];
            }
          }
          
          return {
            id: r.record_id,
            name: taskName,
            stage: stage,
            priority: (r.fields['ä¼˜å…ˆçº§'] || 'P2').replace(/-.*$/, ''),
            status: (() => { const s = r.fields['çŠ¶æ€']; if (typeof s === 'object' && s !== null) return s.text || s.value || s.name || JSON.stringify(s); return s || 'å¾…å¼€å§‹'; })(),
            productId: productId,
            assignee: r.fields['è´Ÿè´£äºº']?.[0]?.id || null,
            assigneeName: r.fields['è´Ÿè´£äºº']?.[0]?.name || '',
            collaborators: (r.fields['åä½œäºº'] || []).map(c => c.name || '').filter(Boolean),
            description: (() => { let d = r.fields['ä»»åŠ¡æè¿°'] || ''; if (Array.isArray(d)) d = d.map(x => x.text || x).join(''); return d; })(),
            startDate: r.fields['å¼€å§‹æ—¥æœŸ'] ? new Date(r.fields['å¼€å§‹æ—¥æœŸ']).toISOString().split('T')[0] : '',
            plannedStartDate: r.fields['é¢„è®¡å¼€å§‹æ—¥æœŸ'] ? new Date(r.fields['é¢„è®¡å¼€å§‹æ—¥æœŸ']).toISOString().split('T')[0] : '',
            dueDate: r.fields['æˆªæ­¢æ—¥æœŸ'] ? new Date(r.fields['æˆªæ­¢æ—¥æœŸ']).toISOString().split('T')[0] : '',
            completeDate: r.fields['å®Œæˆæ—¥æœŸ'] ? new Date(r.fields['å®Œæˆæ—¥æœŸ']).toISOString().split('T')[0] : '',
            outputFile: r.fields['è¾“å‡ºæ–‡ä»¶']?.[0] || null,
            outputUrl: (() => { const u = r.fields['è¾“å‡ºé“¾æ¥']; if (!u) return ''; if (typeof u === 'string') return u; if (u.link) return u.link; if (u.text) return u.text; return ''; })(),
            outputText: (() => { let t = r.fields['è¾“å‡ºæ–‡å­—'] || ''; if (Array.isArray(t)) t = t.map(x => x.text || x).join(''); return t; })()
          };
        });
      }

      // è½¬æ¢å›¢é˜Ÿæˆå‘˜è¡¨ - æ–°å¢ç»„åˆ«å­—æ®µ
      if (rawData['å›¢é˜Ÿæˆå‘˜ Team Members']) {
        const memberColors = ['bg-blue-500', 'bg-pink-500', 'bg-green-500', 'bg-purple-500', 'bg-orange-500', 'bg-teal-500', 'bg-red-500', 'bg-indigo-500'];
        const memberAvatars = ['ğŸ‘¨â€ğŸ’¼', 'ğŸ‘©â€ğŸ¨', 'ğŸ‘¨â€ğŸ’»', 'ğŸ‘©â€ğŸ“Š', 'ğŸ‘¨â€ğŸ”§', 'ğŸ‘©â€ğŸ’»', 'ğŸ‘¨â€ğŸ“', 'ğŸ‘©â€ğŸ”¬'];
        
        data.members = rawData['å›¢é˜Ÿæˆå‘˜ Team Members'].records.map((r, idx) => {
          // æå–é£ä¹¦ç”¨æˆ·ä¿¡æ¯
          const larkUser = r.fields['é£ä¹¦ç”¨æˆ·']?.[0] || {};
          
          // å¤„ç†å§“åå­—æ®µï¼ˆå¯èƒ½æ˜¯å¯Œæ–‡æœ¬æ•°ç»„ï¼‰
          let name = r.fields['å§“å'] || '';
          if (Array.isArray(name)) {
            name = name.map(n => n.text || n).join('');
          }
          
          // å¤„ç†èŒä½å­—æ®µï¼ˆå¯èƒ½æ˜¯å¯Œæ–‡æœ¬æ•°ç»„ï¼‰
          let position = r.fields['èŒä½'] || '';
          if (Array.isArray(position)) {
            position = position.map(p => p.text || p).join('');
          }
          
          return {
            id: larkUser.id || r.record_id,
            name: name,
            larkName: larkUser.name || '', // é£ä¹¦çœŸå®å§“å
            department: r.fields['éƒ¨é—¨'] || '',
            group: r.fields['ç»„åˆ«'] || 'æœªåˆ†ç»„',
            position: position,
            permRole: r.fields['æƒé™è®¾ç½®'] || 'ç»„å‘˜', // æƒé™è§’è‰²
            linkedGroups: r.fields['å…³è”ç»„åˆ«'] || [], // å…³è”è¿è¥ç»„åˆ«ï¼ˆäº§å“éƒ¨ç”¨ï¼‰
            status: r.fields['çŠ¶æ€'] || '',
            avatarUrl: larkUser.avatar_url || '', // é£ä¹¦å¤´åƒURL
            avatar: memberAvatars[idx % memberAvatars.length],
            color: memberColors[idx % memberColors.length]
          };
        });

        // æå–æ‰€æœ‰ç»„åˆ«
        const groupSet = new Set(data.members.map(m => m.group));
        data.groups = Array.from(groupSet).filter(g => g);
      }

      // è½¬æ¢æµç¨‹æ¨¡æ¿è¡¨
      if (rawData['æµç¨‹æ¨¡æ¿ Process Templates']) {
        rawData['æµç¨‹æ¨¡æ¿ Process Templates'].records.forEach(r => {
          let tplName = r.fields['æ¨¡æ¿åç§°'];
          if (Array.isArray(tplName)) tplName = tplName.map(n => n.text || n).join('');
          let parentTpl = r.fields['çˆ¶é¡¹ç›®'];
          if (Array.isArray(parentTpl)) parentTpl = parentTpl.map(n => n.text || n).join('');
          const prereqRaw = r.fields['å‰ç½®å­çº¿'];
          let prereqNames = [];
          if (Array.isArray(prereqRaw)) {
            prereqRaw.forEach(item => {
              if (item?.text) prereqNames.push(item.text);
              else if (typeof item === 'string') prereqNames.push(item);
            });
          } else if (prereqRaw && typeof prereqRaw === 'object' && Array.isArray(prereqRaw.link_record_ids)) {
            // DuplexLink å¯¹è±¡æ ¼å¼: {link_record_ids: ["recXXX"]}
            // æš‚å­˜ record_idï¼Œåç»­è½¬æ¢ä¸ºæ¨¡æ¿åç§°
            prereqNames = prereqRaw.link_record_ids || [];
          }
          data.templates[r.record_id] = {
            name: tplName || '',
            type: r.fields['æ¨¡æ¿ç±»å‹'] || '',
            ownership: r.fields['æ¨¡ç‰ˆå½’å±'] || '',
            parentTemplate: parentTpl || '',
            cycleDays: r.fields['é¢„è®¡å‘¨æœŸ(å¤©)'] || 0,
            prerequisiteNames: prereqNames.filter(Boolean),
            participantRoles: r.fields['å‚ä¸è§’è‰²'] || []
          };
        });
        // å°† prerequisiteNames ä¸­çš„ record_id è½¬æ¢ä¸ºæ¨¡æ¿åç§°
        Object.values(data.templates).forEach(tpl => {
          tpl.prerequisiteNames = tpl.prerequisiteNames.map(n => {
            if (n.startsWith('rec') && data.templates[n]) return data.templates[n].name;
            return n;
          }).filter(Boolean);
        });
      }

      // è½¬æ¢æµç¨‹èŠ‚ç‚¹è¡¨ - æ”¯æŒDAGç»“æ„
      if (rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes']) {
        const rawNodes = rawData['æµç¨‹èŠ‚ç‚¹ Process Nodes'].records
          .filter(r => r.fields['èŠ‚ç‚¹åç§°'])
          .map(r => {
            let nodeName = r.fields['èŠ‚ç‚¹åç§°'];
            if (Array.isArray(nodeName)) {
              nodeName = nodeName.map(n => n.text || n).join('');
            }
            let prevNode = r.fields['å‰ç½®èŠ‚ç‚¹'];
            if (Array.isArray(prevNode)) {
              prevNode = prevNode.map(n => n.text || n).join('');
            }
            // ç¡®ä¿ days æ˜¯æ•°å­—
            let days = r.fields['é¢„è®¡å·¥æ—¶(å¤©)'] || 0;
            if (typeof days === 'string') {
              days = parseInt(days, 10) || 0;
            }
            // æå–æ‰€å±æ¨¡æ¿ID
            let templateId = null;
            const templateField = r.fields['æ‰€å±æ¨¡æ¿'];
            if (templateField) {
              if (templateField.link_record_ids?.[0]) templateId = templateField.link_record_ids[0];
              else if (Array.isArray(templateField) && typeof templateField[0] === 'string') templateId = templateField[0];
              else if (Array.isArray(templateField) && templateField[0]?.record_ids?.[0]) templateId = templateField[0].record_ids[0];
            }
            // æå–æŒ‡å¯¼è¯´æ˜é“¾æ¥
            let guideUrl = null;
            const guideField = r.fields['æŒ‡å¯¼è¯´æ˜'];
            if (guideField) {
              if (typeof guideField === 'string') guideUrl = guideField;
              else if (guideField.link) guideUrl = guideField.link;
              else if (guideField.text) guideUrl = guideField.text;
              else if (Array.isArray(guideField) && guideField[0]) {
                const g = guideField[0];
                guideUrl = g.link || g.text || (typeof g === 'string' ? g : null);
              }
            }
            return {
              id: r.record_id,
              name: nodeName || '',
              order: r.fields['èŠ‚ç‚¹é¡ºåº'] || 0,
              type: r.fields['èŠ‚ç‚¹ç±»å‹'] || 'ä¸­é—´èŠ‚ç‚¹',
              days: days,
              role: r.fields['é»˜è®¤è´Ÿè´£è§’è‰²'] || '',
              prevNode: prevNode || null, // å‰ç½®èŠ‚ç‚¹åç§°
              templateId: templateId,
              guideUrl: guideUrl
            };
          });
        
        // æ„å»ºèŠ‚ç‚¹æ˜ å°„
        const nodeMap = {};
        rawNodes.forEach(n => { nodeMap[n.name] = n; });
        
        // æ·»åŠ åç»§èŠ‚ç‚¹ä¿¡æ¯
        rawNodes.forEach(n => {
          n.children = rawNodes.filter(c => c.prevNode === n.name).map(c => c.name);
        });
        
        // æ‹“æ‰‘æ’åºåˆ†å±‚
        const layers = [];
        const visited = new Set();
        const nodeToLayer = {};
        
        // æ‰¾åˆ°èµ·å§‹èŠ‚ç‚¹ï¼ˆæ— å‰ç½®èŠ‚ç‚¹ï¼‰
        const startNodes = rawNodes.filter(n => !n.prevNode);
        if (startNodes.length > 0) {
          layers.push(startNodes);
          startNodes.forEach(n => {
            visited.add(n.name);
            nodeToLayer[n.name] = 0;
          });
        }
        
        // é€å±‚æ„å»º
        let layerIndex = 1;
        while (visited.size < rawNodes.length && layerIndex < 20) {
          const nextLayer = rawNodes.filter(n => {
            if (visited.has(n.name)) return false;
            if (!n.prevNode) return false;
            return visited.has(n.prevNode);
          });
          
          if (nextLayer.length === 0) break;
          
          layers.push(nextLayer);
          nextLayer.forEach(n => {
            visited.add(n.name);
            nodeToLayer[n.name] = layerIndex;
          });
          layerIndex++;
        }
        
        data.processNodes = rawNodes;
        data.processNodeLayers = layers;
        data.nodeMap = nodeMap;
        data.nodeToLayer = nodeToLayer;
      }

      if (data.processNodes.length === 0) {
        data.processNodes = [
          { id: 'n1', name: 'äº§å“ç«‹é¡¹', order: 1, type: 'å¼€å§‹', prevNode: null, children: ['é£æ§ç­›æŸ¥', 'åº—é“ºåˆ†é…'] },
          { id: 'n2', name: 'é£æ§ç­›æŸ¥', order: 2, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'äº§å“ç«‹é¡¹', children: [] },
          { id: 'n3', name: 'åº—é“ºåˆ†é…', order: 2, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'äº§å“ç«‹é¡¹', children: ['é“¾æ¥åˆ›å»º'] },
          { id: 'n4', name: 'é“¾æ¥åˆ›å»º', order: 3, type: 'ä¸­é—´èŠ‚ç‚¹', prevNode: 'åº—é“ºåˆ†é…', children: ['å‚¨è¯„è®¡åˆ’', 'å›¾éœ€', 'å¤‡è´§è®¡åˆ’'] },
          { id: 'n5', name: 'å‚¨è¯„è®¡åˆ’', order: 4, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'é“¾æ¥åˆ›å»º', children: [] },
          { id: 'n6', name: 'å›¾éœ€', order: 4, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'é“¾æ¥åˆ›å»º', children: ['è‰å›¾åˆ¶ä½œ'] },
          { id: 'n7', name: 'å¤‡è´§è®¡åˆ’', order: 4, type: 'å¹¶è¡ŒèŠ‚ç‚¹', prevNode: 'é“¾æ¥åˆ›å»º', children: [] }
        ];
        data.processNodeLayers = [[data.processNodes[0]], [data.processNodes[1], data.processNodes[2]], [data.processNodes[3]], [data.processNodes[4], data.processNodes[5], data.processNodes[6]]];
        data.nodeMap = {};
        data.processNodes.forEach(n => { data.nodeMap[n.name] = n; });
        data.nodeToLayer = { 'äº§å“ç«‹é¡¹': 0, 'é£æ§ç­›æŸ¥': 1, 'åº—é“ºåˆ†é…': 1, 'é“¾æ¥åˆ›å»º': 2, 'å‚¨è¯„è®¡åˆ’': 3, 'å›¾éœ€': 3, 'å¤‡è´§è®¡åˆ’': 3 };
      }

      return data;
    };

    // åˆ¤æ–­æ˜¯å¦æ˜¯çˆ¶é¡¹ç›®ï¼ˆçº¯å®¹å™¨ï¼Œä¸æŒ‚æµç¨‹ï¼‰
    const isParentProject = (product) => product?.category === 'çˆ¶é¡¹ç›®' || (product?.childIds?.length > 0 && !product?.parentId);

    // å·¥ä½œæ—¥è®¡ç®—ï¼ˆè·³è¿‡å‘¨å…­æ—¥ï¼‰
    const addWorkingDays = (startDate, workDays) => {
      if (!startDate || !workDays || workDays <= 0) return startDate;
      const d = new Date(startDate);
      let added = 0;
      while (added < workDays) {
        d.setDate(d.getDate() + 1);
        const day = d.getDay();
        if (day !== 0 && day !== 6) added++;
      }
      return d;
    };

    // è®¡ç®—ä¸¤ä¸ªæ—¥æœŸä¹‹é—´çš„å·¥ä½œæ—¥æ•°
    const getWorkingDaysBetween = (start, end) => {
      if (!start || !end) return 0;
      const s = new Date(start); const e = new Date(end);
      let count = 0;
      const d = new Date(s);
      while (d < e) {
        d.setDate(d.getDate() + 1);
        if (d.getDay() !== 0 && d.getDay() !== 6) count++;
      }
      return count;
    };

    // è®¡ç®—å­é¡¹ç›®çš„æ—¶é—´çº¿ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„é¢„è®¡å¼€å§‹/æˆªæ­¢æ—¥æœŸ
    // èµ·ç‚¹ = çˆ¶é¡¹ç›®çš„å¼€å§‹æ—¥æœŸï¼ˆäº§å“ç«‹é¡¹å®Œæˆå³T=0ï¼‰
    const calcSubProjectTimeline = (child, parentStartDate, allNodes, templates) => {
      const cNodes = getNodesForProduct(child, allNodes, templates);
      
      // ä¼˜å…ˆä½¿ç”¨å­é¡¹ç›®è‡ªèº«çš„å¼€å§‹/ç»“æŸæ—¥æœŸ
      const projectStart = child.startDate ? new Date(child.startDate) : parentStartDate ? new Date(parentStartDate) : null;
      const projectEnd = child.targetDate ? new Date(child.targetDate) : null;
      
      if (!projectStart) return { nodes: [], totalDays: 0, deadline: null };
      
      if (projectEnd && cNodes.length > 0) {
        // æœ‰é¡¹ç›®æ—¥æœŸå’ŒèŠ‚ç‚¹ï¼šæŒ‰é¡¹ç›®æ€»å·¥æœŸç­‰æ¯”åˆ†é…èŠ‚ç‚¹æ—¶é—´
        const totalProjectWorkDays = getWorkingDaysBetween(projectStart, projectEnd);
        const totalNodeDays = cNodes.reduce((s, nd) => s + (nd.days || 1), 0);
        let currentStart = new Date(projectStart);
        const timeline = cNodes.map(nd => {
          const ratio = (nd.days || 1) / totalNodeDays;
          const workDays = Math.max(1, Math.round(totalProjectWorkDays * ratio));
          const nodeStart = new Date(currentStart);
          const nodeEnd = addWorkingDays(nodeStart, workDays);
          currentStart = nodeEnd;
          return { ...nd, planStart: nodeStart, planEnd: nodeEnd, workDays };
        });
        return { nodes: timeline, totalDays: totalProjectWorkDays, deadline: projectEnd };
      }
      
      if (projectEnd) {
        // æœ‰æ—¥æœŸä½†æ— èŠ‚ç‚¹
        const totalDays = getWorkingDaysBetween(projectStart, projectEnd);
        return { nodes: [], totalDays, deadline: projectEnd };
      }
      
      if (cNodes.length === 0) return { nodes: [], totalDays: 0, deadline: null };
      
      // fallback: æ— é¡¹ç›®ç»“æŸæ—¥æœŸï¼Œç”¨èŠ‚ç‚¹ç´¯åŠ 
      let currentStart = new Date(projectStart);
      let totalWorkDays = 0;
      const timeline = cNodes.map(nd => {
        const workDays = nd.days || 1;
        const nodeStart = new Date(currentStart);
        const nodeEnd = addWorkingDays(nodeStart, workDays);
        totalWorkDays += workDays;
        currentStart = nodeEnd;
        return { ...nd, planStart: nodeStart, planEnd: nodeEnd, workDays };
      });
      
      return { nodes: timeline, totalDays: totalWorkDays, deadline: timeline[timeline.length - 1]?.planEnd || null };
    };

    // æ ¹æ®é¡¹ç›®æ¨¡ç‰ˆç±»å‹è·å–å¯¹åº”æ¨¡æ¿çš„æµç¨‹èŠ‚ç‚¹
    const getNodesForProduct = (product, allNodes, templates) => {
      if (!product || !templates) return allNodes;
      // çˆ¶é¡¹ç›®ä¸åŒ¹é…ä»»ä½•æ¨¡æ¿
      if (isParentProject(product)) return [];
      const matchType = product.templateType;
      const matchingTemplateId = Object.keys(templates).find(tplId => 
        templates[tplId].type === matchType
      );
      if (!matchingTemplateId) return [];
      return allNodes.filter(n => n.templateId === matchingTemplateId);
    };

    // æ ¹æ®ä»»åŠ¡è®¡ç®—é¡¹ç›®è¿›åº¦ï¼ˆæ¨¡æ¿æ„ŸçŸ¥ï¼‰
    const calcProjectProgress = (product, allNodes, templates, tasks, allProducts) => {
      // çˆ¶é¡¹ç›®ï¼šèšåˆå­é¡¹ç›®è¿›åº¦ï¼ˆæœ‰parentIdçš„æ˜¯å­é¡¹ç›®ï¼Œä¸èµ°æ­¤åˆ†æ”¯ï¼‰
      if (product.childIds?.length > 0 && !product.parentId && allProducts) {
        const children = allProducts.filter(p => product.childIds.includes(p.id));
        if (children.length > 0) {
          const total = children.reduce((sum, c) => sum + calcProjectProgress(c, allNodes, templates, tasks), 0);
          return Math.round(total / children.length);
        }
      }
      const pTasks = tasks.filter(t => t.productId === product.id);
      const pNodes = getNodesForProduct(product, allNodes, templates);
      const skipped = new Set(product.skippedNodes || []);
      if (pNodes.length === 0) {
        // æ— æ¨¡æ¿ï¼šç›´æ¥ç”¨ä»»åŠ¡å®Œæˆç‡
        if (pTasks.length === 0) return 0;
        return Math.round(pTasks.filter(t => t.status === 'å·²å®Œæˆ').length / pTasks.length * 100);
      }
      let total = 0;
      for (const nd of pNodes) {
        if (skipped.has(nd.name)) {
          total += 100; // è·³è¿‡çš„èŠ‚ç‚¹æŒ‰100%
          continue;
        }
        const nt = pTasks.filter(t => t.stage === nd.name);
        if (nt.length > 0) total += (nt.filter(t => t.status === 'å·²å®Œæˆ').length / nt.length) * 100;
      }
      return Math.round(total / pNodes.length);
    };

    // è‡ªåŠ¨è®¡ç®—é¡¹ç›®çŠ¶æ€
    const calcProjectStatus = (product, tasks, allNodes, templates, allProducts) => {
      // çˆ¶é¡¹ç›®ï¼šèšåˆå­é¡¹ç›®çŠ¶æ€ï¼ˆæœ‰parentIdçš„æ˜¯å­é¡¹ç›®ï¼Œä¸èµ°æ­¤åˆ†æ”¯ï¼‰
      if (product.childIds?.length > 0 && !product.parentId && allProducts) {
        const children = allProducts.filter(p => product.childIds.includes(p.id));
        if (children.length > 0) {
          const childStatuses = children.map(c => calcProjectStatus(c, tasks, allNodes, templates, allProducts));
          const allDone = childStatuses.every(s => s === 'å·²å®Œæˆ');
          const anyProgress = childStatuses.some(s => s !== 'æœªå¼€å§‹');
          if (allDone) return 'å·²å®Œæˆ';
          if (anyProgress) return 'è¿›è¡Œä¸­';
          // å…œåº•ï¼šç›´æ¥æ£€æŸ¥çˆ¶é¡¹ç›®æ€»è¿›åº¦
          const parentProgress = calcProjectProgress(product, allNodes, templates, tasks, allProducts);
          return parentProgress > 0 ? 'è¿›è¡Œä¸­' : 'æœªå¼€å§‹';
        }
      }
      const pTasks = tasks.filter(t => t.productId === product.id);
      if (pTasks.length === 0) {
        // æ— ä»»åŠ¡ â†’ åŸºäºè¿›åº¦åˆ¤æ–­
        const progress = calcProjectProgress(product, allNodes, templates, tasks);
        if (progress > 0) return progress >= 100 ? 'å·²å®Œæˆ' : 'è¿›è¡Œä¸­';
        return 'æœªå¼€å§‹';
      }
      const completed = pTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
      const inProgress = pTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
      // æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œè¿˜è¦æ£€æŸ¥æ˜¯å¦æ‰€æœ‰èŠ‚ç‚¹éƒ½æœ‰ä»»åŠ¡ï¼ˆé¿å…åªå®Œæˆéƒ¨åˆ†èŠ‚ç‚¹å°±æ˜¾ç¤ºå·²å®Œæˆï¼‰
      if (completed === pTasks.length) {
        // å¦‚æœæœ‰æ¨¡æ¿èŠ‚ç‚¹ï¼Œæ£€æŸ¥é¡¹ç›®è¿›åº¦æ˜¯å¦çœŸæ­£100%
        if (allNodes && templates) {
          const progress = calcProjectProgress(product, allNodes, templates, tasks);
          if (progress < 100) return 'è¿›è¡Œä¸­'; // è¿˜æœ‰èŠ‚ç‚¹æ²¡åˆ†é…ä»»åŠ¡
        }
        return 'å·²å®Œæˆ';
      }
      if (inProgress > 0 || completed > 0) return 'è¿›è¡Œä¸­';
      return 'æœªå¼€å§‹';
    };

    // è‡ªåŠ¨è®¡ç®—å½“å‰é˜¶æ®µ
    const calcCurrentStage = (product, allNodes, templates, tasks) => {
      const pTasks = tasks.filter(t => t.productId === product.id);
      const pNodes = getNodesForProduct(product, allNodes, templates);
      let lastActiveNode = null;
      for (const node of pNodes) {
        const nodeTasks = pTasks.filter(t => t.stage === node.name);
        const hasActive = nodeTasks.some(t => t.status === 'è¿›è¡Œä¸­');
        const hasCompleted = nodeTasks.some(t => t.status === 'å·²å®Œæˆ');
        const hasIncomplete = nodeTasks.some(t => t.status !== 'å·²å®Œæˆ');
        if (hasActive || (hasCompleted && hasIncomplete)) {
          lastActiveNode = node.name;
        }
      }
      return lastActiveNode || (pNodes.length > 0 ? pNodes[0].name : '');
    };

    // è·å–èŠ‚ç‚¹çŠ¶æ€
    const getNodeStatus = (nodeName, currentStage, nodes) => {
      const currentIndex = nodes.findIndex(n => n.name === currentStage);
      const nodeIndex = nodes.findIndex(n => n.name === nodeName);
      if (nodeIndex < currentIndex) return 'completed';
      if (nodeIndex === currentIndex) return 'current';
      return 'pending';
    };

    // === å…¨å±€: é¡¹ç›®é‡è¦æ€§è¯„åˆ† ===
    const LEVEL_SCORE = { 'å…¬å¸çº§': 100, 'éƒ¨é—¨çº§': 60, 'ä¸ªäººçº§': 30 };
    const PRIORITY_SCORE = { 'P0': 100, 'P1': 70, 'P2': 40, 'P3': 10 };
    
    const calcProjectImportanceScore = (product, objectives, keyResults) => {
      const kr = keyResults.find(k => k.id === product.krId);
      const objective = kr ? objectives.find(o => o.id === kr.objectiveId) : null;
      const maxW = Math.max(1, ...keyResults.map(k => k.weight || 1));
      const levelScore = objective ? (LEVEL_SCORE[objective.level] || 30) : 0;
      const krWeightScore = kr ? ((kr.weight || 1) / maxW) * 100 : 0;
      const priorityScore = PRIORITY_SCORE[product.priority] || 10;
      return levelScore * 0.35 + krWeightScore * 0.30 + priorityScore * 0.35;
    };

    // === å…¨å±€: ä»»åŠ¡ç»¼åˆç´§æ€¥åº¦è¯„åˆ† ===
    // é¡¹ç›®é‡è¦æ€§(30%) + ä»»åŠ¡ä¼˜å…ˆçº§(30%) + æ—¶é—´ç´§è¿«åº¦(40%)
    const calcTaskUrgencyScore = (task, products, objectives, keyResults) => {
      // 1. é¡¹ç›®é‡è¦æ€§åˆ† (0~100)
      const product = products.find(p => p.id === task.productId);
      const projectScore = product ? calcProjectImportanceScore(product, objectives, keyResults) : 0;
      
      // 2. ä»»åŠ¡ä¼˜å…ˆçº§åˆ† (0~100)
      const taskPriorityScore = PRIORITY_SCORE[task.priority] || 40;
      
      // 3. æ—¶é—´ç´§è¿«åº¦åˆ† (0~120, é€¾æœŸå¯è¶…100)
      let timeScore = 10; // æ— æˆªæ­¢æ—¥æœŸ
      if (task.dueDate) {
        const daysLeft = Math.ceil((new Date(task.dueDate) - new Date()) / 86400000);
        if (daysLeft < 0) timeScore = Math.min(120, 100 + Math.abs(daysLeft) * 2); // é€¾æœŸ
        else if (daysLeft === 0) timeScore = 100; // ä»Šå¤©åˆ°æœŸ
        else if (daysLeft <= 3) timeScore = 85;   // 3å¤©å†…
        else if (daysLeft <= 7) timeScore = 65;   // ä¸€å‘¨å†…
        else if (daysLeft <= 14) timeScore = 45;  // ä¸¤å‘¨å†…
        else timeScore = 25;                       // æ›´è¿œ
      }
      
      const composite = projectScore * 0.30 + taskPriorityScore * 0.30 + timeScore * 0.40;
      return { composite: Math.round(composite * 10) / 10, projectScore: Math.round(projectScore), taskPriorityScore, timeScore };
    };

    // åŠ è½½ä¸­ç»„ä»¶
    const LoadingScreen = () => (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full loading-spinner mx-auto mb-4"></div>
          <div className="text-gray-600">æ­£åœ¨ä»é£ä¹¦åŠ è½½æ•°æ®...</div>
        </div>
      </div>
    );

    // è¿·ä½ é˜¶æ®µæŒ‡ç¤ºå™¨
    const MiniStageIndicator = ({ currentStage, nodes, tasks = [] }) => {
      // è®¡ç®—èŠ‚ç‚¹çŠ¶æ€ï¼šæ ¹æ®ä»»åŠ¡æƒ…å†µ
      const getNodeTaskStatus = (nodeName) => {
        const nodeTasks = tasks.filter(t => t.stage === nodeName);
        if (nodeTasks.length === 0) return 'pending'; // æ— ä»»åŠ¡
        const completedCount = nodeTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
        const inProgressCount = nodeTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
        if (completedCount === nodeTasks.length) return 'completed'; // å…¨éƒ¨å®Œæˆ
        if (inProgressCount > 0 || completedCount > 0) return 'inProgress'; // æœ‰è¿›è¡Œä¸­æˆ–éƒ¨åˆ†å®Œæˆ
        return 'pending'; // å…¨éƒ¨æœªå¼€å§‹
      };
      
      return (
        <div className="flex items-center gap-1">
          {nodes.map((node, index) => {
            const taskStatus = getNodeTaskStatus(node.name);
            return (
              <div key={node.id} className="flex items-center">
                <div 
                  className={`w-2.5 h-2.5 rounded-full ${
                    taskStatus === 'completed' ? 'bg-green-500' :
                    taskStatus === 'inProgress' ? 'bg-red-500' :
                    'bg-gray-200'
                  }`}
                  title={node.name}
                />
                {index < nodes.length - 1 && (
                  <div className={`w-3 h-0.5 ${taskStatus === 'completed' ? 'bg-green-500' : 'bg-gray-200'}`} />
                )}
              </div>
            );
          })}
        </div>
      );
    };

    // äº§å“å¡ç‰‡
    // ç”˜ç‰¹å›¾ç»„ä»¶ - V29 å…¨é¢ä¼˜åŒ–ç‰ˆ
    const GanttChart = ({ tasks, members, product, nodes = [] }) => {
      const scrollContainerRef = React.useRef(null);
      const [collapsedStages, setCollapsedStages] = React.useState({});
      const [hoveredTask, setHoveredTask] = React.useState(null);
      const [tooltipPos, setTooltipPos] = React.useState(null);
      const [statusFilter, setStatusFilter] = React.useState('all'); // all, overdue, inProgress, pending, completed
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const allDates = [];
      tasks.forEach(t => {
        if (t.startDate) allDates.push(new Date(t.startDate));
        if (t.plannedStartDate) allDates.push(new Date(t.plannedStartDate));
        if (t.dueDate) allDates.push(new Date(t.dueDate));
      });
      if (allDates.length === 0) {
        if (product.startDate) allDates.push(new Date(product.startDate));
        if (product.targetDate) allDates.push(new Date(product.targetDate));
      }
      if (allDates.length === 0) {
        allDates.push(new Date(today.getTime() - 14 * 86400000));
        allDates.push(new Date(today.getTime() + 30 * 86400000));
      }
      
      const minDate = new Date(Math.min(...allDates.map(d => d.getTime())) - 7 * 86400000);
      const maxDate = new Date(Math.max(...allDates.map(d => d.getTime())) + 7 * 86400000);
      if (today < minDate) minDate.setTime(today.getTime() - 7 * 86400000);
      if (today > maxDate) maxDate.setTime(today.getTime() + 7 * 86400000);
      
      const totalDays = Math.ceil((maxDate - minDate) / 86400000);
      const dayWidth = Math.max(34, 800 / totalDays);
      
      const dateMarkers = [];
      const _cd = new Date(minDate);
      while (_cd <= maxDate) { dateMarkers.push(new Date(_cd)); _cd.setDate(_cd.getDate() + 1); }
      
      const todayOffset = Math.max(0, (today - minDate) / 86400000) * dayWidth;
      const formatDate = (d) => `${new Date(d).getMonth()+1}/${new Date(d).getDate()}`;
      const getWeekday = (d) => ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(d).getDay()];
      const isWeekend = (d) => { const day = new Date(d).getDay(); return day === 0 || day === 6; };
      
      // è‡ªåŠ¨æ»šåŠ¨åˆ°ä»Šå¤©
      React.useEffect(() => {
        if (scrollContainerRef.current) {
          const cw = scrollContainerRef.current.clientWidth;
          scrollContainerRef.current.scrollLeft = Math.max(0, todayOffset - cw / 2 + 200);
        }
      }, []);
      
      // æŒ‰æ¨¡æ¿èŠ‚ç‚¹é¡ºåºåˆ†ç»„ï¼ˆnodes å·²æŒ‰ order æ’åºï¼‰
      const nodeNameOrder = nodes.length > 0 ? nodes.map(n => n.name) : [];
      
      // çŠ¶æ€ç­›é€‰
      const filteredTasks = tasks.filter(t => {
        if (statusFilter === 'all') return true;
        if (statusFilter === 'overdue') return t.status !== 'å·²å®Œæˆ' && t.dueDate && new Date(t.dueDate) < today;
        if (statusFilter === 'inProgress') return t.status === 'è¿›è¡Œä¸­';
        if (statusFilter === 'pending') return t.status === 'å¾…å¼€å§‹';
        if (statusFilter === 'completed') return t.status === 'å·²å®Œæˆ';
        return true;
      });
      
      const stageOrder = [];
      const stageTaskMap = {};
      
      // å…ˆæŒ‰èŠ‚ç‚¹æ¨¡æ¿é¡ºåºå»ºç«‹ç©ºåˆ†ç»„
      nodeNameOrder.forEach(name => {
        stageTaskMap[name] = [];
        stageOrder.push(name);
      });
      
      // å°†ä»»åŠ¡æ”¾å…¥å¯¹åº”åˆ†ç»„
      filteredTasks.forEach(t => {
        const stage = t.stage || 'æœªåˆ†ç±»';
        if (!stageTaskMap[stage]) { stageTaskMap[stage] = []; stageOrder.push(stage); }
        stageTaskMap[stage].push(t);
      });
      
      // ç§»é™¤ç©ºåˆ†ç»„ï¼ˆç­›é€‰åå¯èƒ½æ²¡æœ‰ä»»åŠ¡çš„èŠ‚ç‚¹ï¼‰
      const visibleStageOrder = stageOrder.filter(s => stageTaskMap[s] && stageTaskMap[s].length > 0);
      
      // ç»Ÿè®¡æ•°é‡ç”¨äºç­›é€‰æŒ‰é’®
      const overdueCount = tasks.filter(t => t.status !== 'å·²å®Œæˆ' && t.dueDate && new Date(t.dueDate) < today).length;
      const inProgressCount = tasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
      const pendingCount = tasks.filter(t => t.status === 'å¾…å¼€å§‹').length;
      const completedCount = tasks.filter(t => t.status === 'å·²å®Œæˆ').length;
      
      const toggleStage = (stage) => setCollapsedStages(prev => ({ ...prev, [stage]: !prev[stage] }));
      
      const getPriorityBadge = (p) => {
        const c = (p || '').replace(/-.*$/, '');
        return { P0: 'bg-red-500', P1: 'bg-orange-500', P2: 'bg-blue-500', P3: 'bg-gray-400' }[c] || 'bg-gray-400';
      };
      
      // èƒŒæ™¯ç½‘æ ¼åˆ—
      const GridCols = () => (
        <div className="absolute inset-0 flex">
          {dateMarkers.map((date, idx) => (
            <div key={idx} className={`border-r border-gray-100 ${isWeekend(date) ? 'bg-gray-100/70' : ''}`} style={{width:`${dayWidth}px`,minWidth:`${dayWidth}px`}} />
          ))}
        </div>
      );
      
      // ä»Šæ—¥çº¿
      const TodayLine = ({ opacity = 0.4 }) => (
        <div className="absolute top-0 bottom-0 w-0.5 bg-red-400 z-10" style={{left:`${todayOffset}px`, opacity}} />
      );
      
      // è®¡åˆ’ä¸Šçº¿æ—¥æœŸçº¿
      const targetDateOffset = product.targetDate ? Math.max(0, (new Date(new Date(product.targetDate).setHours(0,0,0,0)) - minDate) / 86400000) * dayWidth : null;
      const TargetLine = () => targetDateOffset !== null ? (
        <div className="absolute top-0 bottom-0 z-10" style={{left:`${targetDateOffset}px`, width:'2px', background:'repeating-linear-gradient(to bottom, #7c3aed 0, #7c3aed 4px, transparent 4px, transparent 8px)'}} />
      ) : null;
      
      const renderTaskRow = (task, taskIdx) => {
        const assignee = members.find(m => m.id === task.assignee || m.name === task.assigneeName);
        
        let taskStart = task.startDate ? new Date(task.startDate) : (task.plannedStartDate ? new Date(task.plannedStartDate) : null);
        let taskEnd = task.dueDate ? new Date(task.dueDate) : null;
        if (!taskStart && taskEnd) taskStart = new Date(taskEnd.getTime() - 7 * 86400000);
        if (taskStart && !taskEnd) taskEnd = new Date(taskStart.getTime() + 7 * 86400000);
        if (!taskStart && !taskEnd) { taskStart = new Date(today.getTime() - 3*86400000); taskEnd = new Date(today.getTime() + 4*86400000); }
        
        const startOffset = Math.max(0, (taskStart - minDate) / 86400000) * dayWidth;
        const duration = Math.max(1, (taskEnd - taskStart) / 86400000 + 1);
        const barWidth = duration * dayWidth;
        
        const isOverdue = task.status !== 'å·²å®Œæˆ' && taskEnd && taskEnd < today;
        const isDueToday = task.status !== 'å·²å®Œæˆ' && taskEnd && taskEnd.getTime() === today.getTime();
        
        let barBg = '', barStyle = {};
        if (isOverdue) {
          barStyle = { background: 'repeating-linear-gradient(135deg, #ef4444, #ef4444 4px, #dc2626 4px, #dc2626 8px)' };
        } else if (task.status === 'å·²å®Œæˆ') barBg = 'bg-green-500';
        else if (task.status === 'è¿›è¡Œä¸­') barBg = 'bg-blue-500';
        else barBg = 'bg-gray-300';
        
        let progressPct = null;
        if (task.status === 'å·²å®Œæˆ') progressPct = 100;
        else if (task.status === 'è¿›è¡Œä¸­' && taskStart && taskEnd) {
          const t2 = taskEnd - taskStart;
          progressPct = t2 > 0 ? Math.min(100, Math.max(0, Math.round((today - taskStart) / t2 * 100))) : 0;
        }
        
        const priority = (task.priority || '').replace(/-.*$/, '');
        
        return (
          <div key={task.id} className={`flex border-b hover:bg-blue-50/50 transition-colors ${taskIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50/30'}`}>
            <div className="w-56 flex-shrink-0 px-2 py-1 border-r flex items-center gap-1.5">
              <div className={`w-4 h-4 rounded-full flex items-center justify-center text-xs flex-shrink-0 ${
                task.status === 'å·²å®Œæˆ' ? 'bg-green-500 text-white' :
                isOverdue ? 'bg-red-500 text-white' :
                task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500 text-white' :
                'bg-gray-200 text-gray-400'
              }`} style={{fontSize:'9px'}}>
                {task.status === 'å·²å®Œæˆ' ? 'âœ“' : isOverdue ? '!' : task.status === 'è¿›è¡Œä¸­' ? 'â—' : 'â—‹'}
              </div>
              <div className="w-5 h-5 flex-shrink-0">
                {assignee && (assignee.avatarUrl 
                  ? <img src={assignee.avatarUrl} alt="" className="w-5 h-5 rounded-full object-cover" />
                  : <span className="w-5 h-5 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs">{assignee.avatar}</span>
                )}
              </div>
              <div className="flex-1 min-w-0 flex items-center gap-1">
                {priority && <span className={`text-white px-1 rounded flex-shrink-0 ${getPriorityBadge(priority)}`} style={{fontSize:'9px',lineHeight:'13px'}}>{priority}</span>}
                <span className={`text-sm truncate ${task.status === 'å·²å®Œæˆ' ? 'text-gray-400 line-through' : isOverdue ? 'text-red-600 font-medium' : 'text-gray-800'}`}>{task.name}</span>
              </div>
            </div>
            
            <div className="flex-1 relative" style={{height:'34px'}}>
              <GridCols />
              <TodayLine />
              <TargetLine />
              <div 
                className={`absolute top-1/2 -translate-y-1/2 h-5 rounded-md ${barBg} ${isOverdue ? 'ring-2 ring-red-300 ring-offset-1' : isDueToday ? 'ring-2 ring-orange-300' : ''} shadow-sm flex items-center overflow-hidden z-20 cursor-pointer group`}
                style={{ left:`${startOffset}px`, width:`${Math.max(barWidth, 50)}px`, ...barStyle }}
                onMouseEnter={(e) => { setHoveredTask(task); setTooltipPos({x: e.clientX, y: e.clientY}); }}
                onMouseMove={(e) => { setTooltipPos({x: e.clientX, y: e.clientY}); }}
                onMouseLeave={() => { setHoveredTask(null); setTooltipPos(null); }}
              >
                {task.status === 'è¿›è¡Œä¸­' && progressPct !== null && progressPct < 100 && (
                  <div className="absolute inset-0 bg-blue-300 opacity-40" style={{width:`${progressPct}%`}}></div>
                )}
                <div className="relative flex items-center px-1.5 w-full text-xs text-white font-medium">
                  {assignee && (assignee.avatarUrl
                    ? <img src={assignee.avatarUrl} alt="" className="w-3.5 h-3.5 rounded-full object-cover mr-1 flex-shrink-0" />
                    : <span className="w-3.5 h-3.5 rounded-full bg-white/30 flex items-center justify-center mr-1 flex-shrink-0" style={{fontSize:'9px'}}>{assignee.avatar}</span>
                  )}
                  <span className="truncate" style={{fontSize:'11px'}}>{barWidth > 80 ? task.name : ''}</span>
                  {task.status === 'å·²å®Œæˆ' && barWidth > 50 && <span className="ml-auto flex-shrink-0 opacity-80" style={{fontSize:'10px'}}>âœ“</span>}
                  {task.status === 'è¿›è¡Œä¸­' && progressPct !== null && barWidth > 100 && <span className="ml-auto flex-shrink-0 opacity-80" style={{fontSize:'10px'}}>{progressPct}%</span>}
                </div>
                {taskEnd && (
                  <div className={`absolute -right-1 top-1/2 -translate-y-1/2 translate-x-full text-xs px-1 py-0.5 rounded whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity ${isOverdue ? 'bg-red-100 text-red-600' : isDueToday ? 'bg-orange-100 text-orange-600' : 'bg-gray-100 text-gray-500'}`} style={{fontSize:'10px'}}>
                    {formatDate(taskEnd)}{isOverdue ? ' é€¾æœŸ' : isDueToday ? ' ä»Šå¤©' : ''}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="bg-gray-50 rounded-xl overflow-hidden border border-gray-200">
          <div className="flex flex-wrap items-center gap-2 px-4 py-2 bg-white border-b">
            {/* å›¾ä¾‹ */}
            <div className="flex gap-3 text-xs text-gray-500 mr-auto">
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-green-500"></span> å·²å®Œæˆ</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-blue-500"></span> è¿›è¡Œä¸­</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded bg-gray-300"></span> å¾…å¼€å§‹</span>
              <span className="flex items-center gap-1"><span className="w-3 h-3 rounded" style={{background:'repeating-linear-gradient(135deg,#ef4444,#ef4444 2px,#dc2626 2px,#dc2626 4px)'}}></span> é€¾æœŸ</span>
              <span className="flex items-center gap-1"><span className="w-0.5 h-3 bg-red-400"></span> ä»Šå¤©</span>
            </div>
            {/* çŠ¶æ€ç­›é€‰ */}
            <div className="flex gap-1">
              {[
                { key: 'all', label: 'å…¨éƒ¨', count: tasks.length },
                { key: 'overdue', label: 'é€¾æœŸ', count: overdueCount, color: 'text-red-600 bg-red-50 border-red-200' },
                { key: 'inProgress', label: 'è¿›è¡Œä¸­', count: inProgressCount, color: 'text-blue-600 bg-blue-50 border-blue-200' },
                { key: 'pending', label: 'å¾…å¼€å§‹', count: pendingCount, color: 'text-gray-600 bg-gray-50 border-gray-200' },
                { key: 'completed', label: 'å·²å®Œæˆ', count: completedCount, color: 'text-green-600 bg-green-50 border-green-200' },
              ].filter(f => f.count > 0 || f.key === 'all').map(f => (
                <button
                  key={f.key}
                  onClick={() => setStatusFilter(f.key)}
                  className={`text-xs px-2 py-0.5 rounded-full border transition-colors ${
                    statusFilter === f.key
                      ? (f.color || 'text-blue-600 bg-blue-50 border-blue-300') + ' font-medium'
                      : 'text-gray-400 bg-white border-gray-200 hover:bg-gray-50'
                  }`}
                >
                  {f.label}{f.count > 0 ? ` ${f.count}` : ''}
                </button>
              ))}
            </div>
          </div>
          
              {product.targetDate && (() => {
                const td2 = new Date(product.targetDate);
                const now2 = new Date(); now2.setHours(0,0,0,0);
                const daysUntil = Math.ceil((td2 - now2) / 86400000);
                const isLate = daysUntil < 0;
                const isUrgent = daysUntil >= 0 && daysUntil <= 7;
                return (
                  <div className={`flex items-center gap-3 px-4 py-2 rounded-lg mb-3 ${isLate ? 'bg-red-50 border border-red-200' : isUrgent ? 'bg-orange-50 border border-orange-200' : 'bg-purple-50 border border-purple-100'}`}>
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${isLate ? 'bg-red-500' : isUrgent ? 'bg-orange-500' : 'bg-purple-500'}`}>
                      <Icon name="target" size={16} color="#fff" />
                    </div>
                    <div>
                      <div className={`text-sm font-bold ${isLate ? 'text-red-700' : isUrgent ? 'text-orange-700' : 'text-purple-700'}`}>
                        è®¡åˆ’ä¸Šçº¿: {product.targetDate}
                      </div>
                      <div className={`text-xs ${isLate ? 'text-red-500' : isUrgent ? 'text-orange-500' : 'text-purple-400'}`}>
                        {isLate ? `å·²é€¾æœŸ ${Math.abs(daysUntil)} å¤©` : daysUntil === 0 ? 'ä»Šå¤©ä¸Šçº¿ï¼' : `å‰©ä½™ ${daysUntil} å¤©`}
                      </div>
                    </div>
                    {isLate && <span className="ml-auto text-xs font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full animate-pulse">âš ï¸ é€¾æœŸ</span>}
                    {isUrgent && !isLate && <span className="ml-auto text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded-full">â° ç´§æ€¥</span>}
                  </div>
                );
              })()}
          
          <div className="overflow-x-auto" ref={scrollContainerRef}>
            <div style={{ minWidth: `${totalDays * dayWidth + 224}px` }}>
              <div className="flex border-b bg-white sticky top-0 z-30">
                <div className="w-56 flex-shrink-0 px-3 py-1.5 font-medium text-gray-600 border-r bg-gray-50 text-sm">ä»»åŠ¡åç§°</div>
                <div className="flex-1 relative">
                  <div className="flex">
                    {dateMarkers.map((date, idx) => {
                      const isTodayCol = date.getTime() === today.getTime();
                      const isTargetDate = product.targetDate && date.getTime() === new Date(product.targetDate).setHours(0,0,0,0);
                      return (
                        <div key={idx} className={`text-center border-r ${isTargetDate ? 'bg-purple-100' : isWeekend(date) ? 'bg-gray-100' : isTodayCol ? 'bg-red-50' : 'bg-white'}`} style={{width:`${dayWidth}px`,minWidth:`${dayWidth}px`}}>
                          <div className={`text-xs py-0.5 ${isTargetDate ? 'text-purple-600 font-bold' : isTodayCol ? 'text-red-500 font-bold' : 'text-gray-400'}`}>{formatDate(date)}{isTargetDate ? ' ğŸ¯' : ''}</div>
                          <div className={`text-xs pb-0.5 ${isTargetDate ? 'text-purple-500 font-bold' : isWeekend(date) ? 'text-red-400 font-medium' : isTodayCol ? 'text-red-500 font-bold' : 'text-gray-300'}`}>{getWeekday(date)}</div>
                        </div>
                      );
                    })}
                  </div>
                  <div className="absolute top-0 bottom-0 w-0.5 bg-red-500 z-10" style={{left:`${todayOffset}px`}} />
                  <TargetLine />
                </div>
              </div>
              
              {visibleStageOrder.map(stage => {
                const stageTasks = stageTaskMap[stage];
                const isCollapsed = collapsedStages[stage];
                const stageCompletedCount = stageTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
                const stageOverdueCount = stageTasks.filter(t => t.status !== 'å·²å®Œæˆ' && t.dueDate && new Date(t.dueDate) < today).length;
                
                return (
                  <React.Fragment key={stage}>
                    <div className="flex border-b bg-gray-50/80 cursor-pointer hover:bg-gray-100 transition-colors select-none" onClick={() => toggleStage(stage)}>
                      <div className="w-56 flex-shrink-0 px-3 py-1 border-r flex items-center gap-2">
                        <span className="text-gray-400 text-xs">{isCollapsed ? 'â–¶' : 'â–¼'}</span>
                        <span className="text-xs font-semibold text-gray-600">{stage}</span>
                        <span className="text-xs text-gray-400 ml-auto">
                          {stageCompletedCount}/{stageTasks.length}
                          {stageOverdueCount > 0 && <span className="text-red-500 ml-1">âš {stageOverdueCount}</span>}
                        </span>
                      </div>
                      <div className="flex-1 relative" style={{height:'26px'}}>
                        <GridCols />
                        <TodayLine />
              <TargetLine />
                      </div>
                    </div>
                    {!isCollapsed && stageTasks.map((task, idx) => renderTaskRow(task, idx))}
                  </React.Fragment>
                );
              })}
              
              {visibleStageOrder.length === 0 && statusFilter !== 'all' && (
                <div className="flex items-center justify-center py-8 text-gray-400 text-sm">
                  å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ— ä»»åŠ¡
                </div>
              )}
            </div>
          </div>
          
          {hoveredTask && tooltipPos && (
            <div className="fixed z-50 bg-gray-800 text-white text-xs rounded-lg px-3 py-2 shadow-xl pointer-events-none" style={{left: Math.min(tooltipPos.x + 12, window.innerWidth - 260), top: tooltipPos.y - 80, maxWidth:'240px'}}>
              <div className="font-medium mb-1">{hoveredTask.name}</div>
              <div className="text-gray-300">{hoveredTask.startDate || 'æœªè®¾ç½®'} ~ {hoveredTask.dueDate || 'æœªè®¾ç½®'}</div>
              <div className="text-gray-300">{hoveredTask.status}{hoveredTask.priority ? ` Â· ${hoveredTask.priority}` : ''}</div>
              {hoveredTask.assigneeName && <div className="text-gray-300">ğŸ‘¤ {hoveredTask.assigneeName}</div>}
              {hoveredTask.status !== 'å·²å®Œæˆ' && hoveredTask.dueDate && new Date(hoveredTask.dueDate) < today && (
                <div className="text-red-400 mt-1">âš ï¸ é€¾æœŸ {Math.ceil((today - new Date(hoveredTask.dueDate)) / 86400000)} å¤©</div>
              )}
            </div>
          )}
        </div>
      );
    };

    // èŠ‚ç‚¹ä»»åŠ¡è¯¦æƒ…å¼¹çª— - æ”¯æŒæ–°å¢ä»»åŠ¡å’Œä»»åŠ¡æµç¨‹ç®¡ç†
    const NodeTaskModal = ({ node, tasks: propTasks, members, product, nodeRecordId, nodes, skippedNodes = new Set(), pipelineBlocked = null, onClose, onTaskCreated }) => {
      const currentUser = useContext(UserContext);
      const showToast = useToast();
      // === ä»»åŠ¡æ˜¾ç¤ºï¼šç›´æ¥ä½¿ç”¨ propTasksï¼Œä¸åšä¹è§‚æ›´æ–° ===
      // æœ¬åœ°è¡¥ä¸æœºåˆ¶ï¼šAPIæˆåŠŸåç›´æ¥ä¿®æ”¹propTaskså‰¯æœ¬ï¼Œé¿å…ç­‰fetchData
      const [taskPatches, setTaskPatches] = useState({}); // {taskId: {field: value}}
      const [tempTasks, setTempTasks] = useState([]); // ä¸´æ—¶æ–°å»ºçš„ä»»åŠ¡
      
      // åˆå¹¶ propTasks + patches + tempTasks
      const tasks = React.useMemo(() => {
        const patched = propTasks.map(t => {
          const patch = taskPatches[t.id];
          return patch ? { ...t, ...patch } : t;
        });
        return [...patched, ...tempTasks];
      }, [propTasks, taskPatches, tempTasks]);
      
      // å½“ propTasks æ›´æ–°æ—¶ï¼ˆfetchDataå®Œæˆï¼‰ï¼Œæ¸…é™¤å·²åŒæ­¥çš„patcheså’ŒtempTasks
      React.useEffect(() => {
        const propIds = new Set(propTasks.map(t => t.id));
        // æ¸…é™¤tempTasksä¸­å·²è¢«propTasksåŒ…å«çš„
        setTempTasks(prev => prev.filter(t => !propIds.has(t.id)));
        // æ¸…é™¤patchesä¸­å·²è¢«propTasksåæ˜ çš„
        setTaskPatches(prev => {
          const next = { ...prev };
          for (const id of Object.keys(next)) {
            const propTask = propTasks.find(t => t.id === id);
            if (propTask) {
              const patch = next[id];
              // å¦‚æœpropTasksé‡Œçš„çŠ¶æ€å·²ç»åŒ¹é…patchï¼Œè¯´æ˜å·²åŒæ­¥
              if (!patch.status || propTask.status === patch.status) {
                delete next[id];
              }
            }
          }
          return Object.keys(next).length === Object.keys(prev).length ? prev : next;
        });
      }, [propTasks]);
      
      // è¾…åŠ©ï¼šAPI æˆåŠŸåè¡¥ä¸ + åå°é™é»˜åˆ·æ–°
      const patchTaskAndRefresh = (taskId, patch) => {
        setTaskPatches(prev => ({ ...prev, [taskId]: patch }));
        // 2ç§’ååå°é™é»˜åˆ·æ–°
        setTimeout(() => { if (onTaskCreated) onTaskCreated(); }, 2000);
      };
      const addTempTaskAndRefresh = (task) => {
        setTempTasks(prev => [...prev, task]);
        setTimeout(() => { if (onTaskCreated) onTaskCreated(); }, 2000);
      };
      const removeTempTask = (id) => {
        setTempTasks(prev => prev.filter(t => t.id !== id));
      };
      const [showAddForm, setShowAddForm] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [actionTaskId, setActionTaskId] = useState(null); // æ­£åœ¨æ“ä½œçš„ä»»åŠ¡ID
      const [showCompleteForm, setShowCompleteForm] = useState(null); // æ˜¾ç¤ºå®Œæˆè¡¨å•çš„ä»»åŠ¡ID
      const [outputFile, setOutputFile] = useState(null); // ä¿ç•™é¿å…å¼•ç”¨é”™è¯¯
      const [outputLink, setOutputLink] = useState(''); // è¾“å‡ºé“¾æ¥
      const [outputText, setOutputText] = useState(''); // è¾“å‡ºæ–‡å­—å†…å®¹
      const [completeMode, setCompleteMode] = useState('link'); // å®Œæˆæ–¹å¼: link, text
      const [uploadProgress, setUploadProgress] = useState({}); // åŒæ­¥è¿›åº¦
      const [formData, setFormData] = useState({
        name: '',
        priority: 'P2-ä¸­ç­‰',
        assignee: '',
        collaborators: [],
        description: '',
        plannedStartDate: ''
      });
      
      if (!node) return null;

      // æ£€æŸ¥å‰ç½®èŠ‚ç‚¹ä»»åŠ¡æ˜¯å¦å…¨éƒ¨å®Œæˆ
      const checkPredecessorCompleted = () => {
        // å…ˆæ£€æŸ¥å­çº¿å‰ç½®ï¼šå‰ç½®å­çº¿æœªå®Œæˆåˆ™æ•´æ¡çº¿éƒ½é”å®š
        if (pipelineBlocked) {
          return { canAccept: false, blockedBy: 'å‰ç½®å­çº¿', reason: 'pipeline', message: pipelineBlocked.message };
        }
        
        if (!node.prevNode || !nodes) return { canAccept: true, blockedBy: null };
        
        // æ‰¾åˆ°å‰ç½®èŠ‚ç‚¹
        const prevNodeName = node.prevNode;
        
        // å‰ç½®èŠ‚ç‚¹å·²è·³è¿‡ â†’ å…è®¸æ¥å—
        if (skippedNodes.has(prevNodeName)) {
          return { canAccept: true, blockedBy: null };
        }
        
        const prevNodeTasks = tasks.filter(t => t.stage === prevNodeName);
        
        // å‰ç½®èŠ‚ç‚¹æ— ä»»åŠ¡ â†’ ä¸èƒ½æ¥
        if (prevNodeTasks.length === 0) {
          return { canAccept: false, blockedBy: prevNodeName, reason: 'no_tasks', message: `å‰ç½®èŠ‚ç‚¹ã€Œ${prevNodeName}ã€è¿˜æ²¡æœ‰åˆ›å»ºä»»åŠ¡` };
        }
        
        // å‰ç½®èŠ‚ç‚¹æœ‰æœªå®Œæˆä»»åŠ¡ â†’ ä¸èƒ½æ¥
        const unfinished = prevNodeTasks.filter(t => t.status !== 'å·²å®Œæˆ');
        if (unfinished.length > 0) {
          return { canAccept: false, blockedBy: prevNodeName, reason: 'incomplete', message: `å‰ç½®èŠ‚ç‚¹ã€Œ${prevNodeName}ã€è¿˜æœ‰ ${unfinished.length} ä¸ªä»»åŠ¡æœªå®Œæˆ`, unfinishedTasks: unfinished };
        }
        
        return { canAccept: true, blockedBy: null };
      };

      const predecessorCheck = checkPredecessorCompleted();
      
      // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ä»»åŠ¡è´Ÿè´£äºº
      const isTaskAssignee = (task) => {
        if (!currentUser) return false;
        // æ¯”è¾ƒå¤šç§æ–¹å¼ï¼šopen_idã€ä¸­æ–‡åã€è‹±æ–‡å
        return task.assignee === currentUser.open_id ||
               task.assigneeName === currentUser.name ||
               task.assigneeName === currentUser.en_name;
      };
      
      // ç­›é€‰è¯¥èŠ‚ç‚¹çš„ä»»åŠ¡
      const nodeTasks = tasks.filter(t => t.stage === node.name);
      const completedCount = nodeTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
      const inProgressCount = nodeTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
      const pendingCount = nodeTasks.filter(t => t.status === 'å¾…å¼€å§‹' || t.status === 'æœªå¼€å§‹').length;
      const progress = nodeTasks.length > 0 ? Math.round((completedCount / nodeTasks.length) * 100) : 0;

      // æäº¤æ–°ä»»åŠ¡ï¼ˆç®€åŒ–ç‰ˆï¼šä¸å«æ—¥æœŸå’ŒçŠ¶æ€ï¼‰
      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!formData.name.trim()) {
          alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
          return;
        }
        
        const tempId = 'temp_' + Date.now();
        const assigneeMember = members.find(m => m.id === formData.assignee);
        const savedFormData = { ...formData };
        
        // ç«‹å³æ˜¾ç¤ºä¸´æ—¶ä»»åŠ¡
        addTempTaskAndRefresh({
          id: tempId,
          name: savedFormData.name,
          stage: node.name,
          priority: savedFormData.priority,
          status: 'å¾…å¼€å§‹',
          productId: product?.id,
          assignee: savedFormData.assignee,
          assigneeName: assigneeMember?.name || '',
          collaborators: savedFormData.collaborators.map(id => { const m = members.find(mm => mm.id === id); return m?.name || ''; }).filter(Boolean),
          description: savedFormData.description,
          startDate: savedFormData.plannedStartDate || '',
          dueDate: '',
          completeDate: ''
        });
        setShowAddForm(false);
        setFormData({ name: '', priority: 'P2-ä¸­ç­‰', assignee: '', collaborators: [], description: '', plannedStartDate: '' });
        showToast?.('ä»»åŠ¡åˆ›å»ºæˆåŠŸ', 'success');
        
        // åå°å¼‚æ­¥å‘ API
        fetch(API_BASE + '/api/create-task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            app_token: APP_TOKEN,
            table_id: 'tblFwmxmjRJPzVmV',
            task: {
              name: savedFormData.name,
              priority: savedFormData.priority,
              status: 'å¾…å¼€å§‹',
              assignee: savedFormData.assignee,
              collaborators: savedFormData.collaborators,
              description: savedFormData.description,
              plannedStartDate: savedFormData.plannedStartDate,
              projectId: product?.id,
              nodeId: nodeRecordId
            }
          })
        }).then(r => r.json()).then(result => {
          if (!result.success) {
            removeTempTask(tempId);
            showToast?.('åˆ›å»ºå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
          } else if (result.record_id) {
            // ç”¨çœŸå® record_id æ›¿æ¢ä¸´æ—¶ ID
            setTasks(prev => prev.map(t => t.id === tempId ? { ...t, id: result.record_id } : t));
          }
          // fetchData å·²åœ¨ addTempTaskAndRefresh ä¸­å®‰æ’
        }).catch(err => {
          removeTempTask(tempId);
          showToast?.('åˆ›å»ºå¤±è´¥: ' + err.message, 'error');
        });
      };

      // æ¥å—ä»»åŠ¡ï¼šè®¾ç½®å¼€å§‹æ—¥æœŸä¸ºä»Šå¤©ï¼Œæˆªæ­¢æ—¥æœŸæ ¹æ®èŠ‚ç‚¹é¢„è®¡å·¥æ—¶è®¡ç®—ï¼ŒçŠ¶æ€æ”¹ä¸ºè¿›è¡Œä¸­
      const handleAcceptTask = async (task) => {
        // é˜²æ­¢å¯¹ä¸´æ—¶ä»»åŠ¡æ“ä½œï¼ˆç­‰å¾…çœŸå® record_idï¼‰
        if (task.id?.startsWith?.('temp_')) {
          showToast?.('ä»»åŠ¡æ­£åœ¨åˆ›å»ºä¸­ï¼Œè¯·ç¨åå†è¯•', 'error');
          return;
        }
        if (!predecessorCheck.canAccept) {
          showToast?.(`âš ï¸ ${predecessorCheck.message}ï¼Œè¯·ç­‰å¾…å‰ç½®èŠ‚ç‚¹å®Œæˆåå†æ¥å—ä»»åŠ¡`, 'error');
          return;
        }
        
        const nodeDays = parseInt(node.days, 10) || 7;
        if (!confirm(`ç¡®è®¤æ¥å—ä»»åŠ¡ã€Œ${task.name}ã€ï¼Ÿ\n\nå¼€å§‹æ—¥æœŸå°†è®¾ä¸ºä»Šå¤©ï¼Œæˆªæ­¢æ—¥æœŸæ ¹æ®èŠ‚ç‚¹é¢„è®¡å·¥æ—¶ï¼ˆ${nodeDays}å¤©ï¼‰è‡ªåŠ¨è®¡ç®—ã€‚`)) {
          return;
        }
        
        const today = new Date();
        const dueDate = new Date(today);
        dueDate.setDate(dueDate.getDate() + nodeDays);
        const patch = {
          status: 'è¿›è¡Œä¸­',
          startDate: today.toISOString().split('T')[0],
          dueDate: dueDate.toISOString().split('T')[0]
        };
        
        // ç«‹å³è¡¥ä¸ + å®‰æ’åå°åˆ·æ–°
        patchTaskAndRefresh(task.id, patch);
        showToast?.('å·²æ¥å—ä»»åŠ¡', 'success');
        
        // åå°å¼‚æ­¥å‘ API
        fetch(API_BASE + '/api/update-task', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            app_token: APP_TOKEN,
            table_id: 'tblFwmxmjRJPzVmV',
            record_id: task.id,
            fields: patch
          })
        }).then(r => r.json()).then(result => {
          if (!result.success) {
            setTaskPatches(prev => { const n = { ...prev }; delete n[task.id]; return n; });
            showToast?.('æ“ä½œå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
          }
        }).catch(err => {
          setTaskPatches(prev => { const n = { ...prev }; delete n[task.id]; return n; });
          showToast?.('æ“ä½œå¤±è´¥: ' + err.message, 'error');
        });
      };

      // å®Œæˆä»»åŠ¡ï¼šéœ€è¦ä¸Šä¼ è¾“å‡ºæ–‡ä»¶
      const handleCompleteTask = async (task) => {
        if (task.id?.startsWith?.('temp_')) {
          showToast?.('ä»»åŠ¡æ­£åœ¨åˆ›å»ºä¸­ï¼Œè¯·ç¨åå†è¯•', 'error');
          return;
        }
        const hasLink = outputLink.trim() !== '';
        const hasText = outputText.trim() !== '';
        if (!hasLink && !hasText) {
          showToast?.('è¯·æäº¤é“¾æ¥æˆ–æ–‡å­—å†…å®¹ï¼ˆè‡³å°‘ä¸€é¡¹ï¼‰', 'error');
          return;
        }
        
        const savedLink = hasLink ? outputLink.trim() : '';
        const savedText = hasText ? outputText.trim() : '';
        
        // æ„å»ºå®Œæ•´ patchï¼ˆåŒ…å«è¾“å‡ºå†…å®¹ï¼Œè¿™æ ·ç«‹å³èƒ½çœ‹åˆ°ï¼‰
        const patch = {
          status: 'å·²å®Œæˆ',
          completeDate: new Date().toISOString().split('T')[0],
          ...(savedLink ? { outputUrl: savedLink } : {}),
          ...(savedText ? { outputText: savedText } : {})
        };
        
        // ç«‹å³è¡¥ä¸æ˜¾ç¤º + å…³é—­è¡¨å• + æ˜¾ç¤ºè¿›åº¦
        setTaskPatches(prev => ({ ...prev, [task.id]: patch }));
        setShowCompleteForm(null);
        setOutputFile(null);
        setOutputLink('');
        setOutputText('');
        setCompleteMode('link');
        
        // è®¾ç½®åŒæ­¥è¿›åº¦
        setUploadProgress(prev => ({ ...prev, [task.id]: { 
          phase: 'syncing', pct: 10, msg: 'æ­£åœ¨åŒæ­¥...'
        }}));
        
        // åå°å¼‚æ­¥ï¼šçŠ¶æ€æ›´æ–°
        (async () => {
          try {
            const updateFields = { status: 'å·²å®Œæˆ', completeDate: new Date().toISOString().split('T')[0] };
            if (savedLink) updateFields.outputUrl = savedLink;
            if (savedText) updateFields.outputText = savedText;
            
            setUploadProgress(prev => ({ ...prev, [task.id]: { phase: 'syncing', pct: 30, msg: 'æ­£åœ¨åŒæ­¥...' } }));
            const res = await fetch(API_BASE + '/api/update-task', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                app_token: APP_TOKEN,
                table_id: 'tblFwmxmjRJPzVmV',
                record_id: task.id,
                fields: updateFields
              })
            });
            const statusResult = await res.json();
            
            if (!statusResult.success) {
              setTaskPatches(prev => { const n = { ...prev }; delete n[task.id]; return n; });
              setUploadProgress(prev => ({ ...prev, [task.id]: { phase: 'error', pct: 0, msg: 'åŒæ­¥å¤±è´¥' } }));
              showToast?.('æ“ä½œå¤±è´¥: ' + (statusResult.error || ''), 'error');
            } else {
              setUploadProgress(prev => ({ ...prev, [task.id]: { phase: 'done', pct: 100, msg: 'âœ“ å®Œæˆ' } }));
              setTimeout(() => { setUploadProgress(prev => { const n = { ...prev }; delete n[task.id]; return n; }); }, 2500);
              setTimeout(() => { if (onTaskCreated) onTaskCreated(); }, 1500);
            }
          } catch (err) {
            setTaskPatches(prev => { const n = { ...prev }; delete n[task.id]; return n; });
            setUploadProgress(prev => ({ ...prev, [task.id]: { phase: 'error', pct: 0, msg: 'å¤±è´¥: ' + err.message } }));
            showToast?.('æ“ä½œå¤±è´¥: ' + err.message, 'error');
          }
        })();
      };

      // åä½œäººå¤šé€‰å¤„ç†
      const handleCollaboratorChange = (memberId) => {
        setFormData(prev => {
          const exists = prev.collaborators.includes(memberId);
          return {
            ...prev,
            collaborators: exists 
              ? prev.collaborators.filter(id => id !== memberId)
              : [...prev.collaborators, memberId]
          };
        });
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-[60] sm:p-4" onClick={onClose}>
          <div className="bg-white rounded-t-xl sm:rounded-xl max-w-lg w-full max-h-[90vh] sm:max-h-[80vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
            {/* å¤´éƒ¨ */}
            <div className="bg-gradient-to-r from-purple-500 to-indigo-600 text-white p-3 sm:p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center font-bold">
                    {node.order}
                  </div>
                  <div>
                    <h3 className="font-bold text-lg">{node.name}</h3>
                    <div className="text-white/70 text-sm">
                      {node.role && `é»˜è®¤è´Ÿè´£ï¼š${node.role}`}
                      {node.days > 0 && ` Â· é¢„è®¡ ${node.days} å¤©`}
                    </div>
                  </div>
                </div>
                <button onClick={onClose} className="text-white/80 hover:text-white text-xl">Ã—</button>
              </div>
              {node.guideUrl && (
                <a
                  href={node.guideUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="mt-2 inline-flex items-center gap-1.5 px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg text-sm text-white transition-colors"
                >
                  ğŸ“– æŸ¥çœ‹æŒ‡å¯¼è¯´æ˜ï¼ˆSOPï¼‰
                  <svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                </a>
              )}
            </div>

            {/* ç»Ÿè®¡å¡ç‰‡ */}
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 p-3 sm:p-4 bg-gray-50">
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-blue-600">{progress}%</div>
                <div className="text-xs text-gray-500">å®Œæˆç‡</div>
              </div>
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-green-600">{completedCount}</div>
                <div className="text-xs text-gray-500">å·²å®Œæˆ</div>
              </div>
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-orange-600">{inProgressCount}</div>
                <div className="text-xs text-gray-500">è¿›è¡Œä¸­</div>
              </div>
              <div className="bg-white rounded-lg p-3 text-center shadow-sm">
                <div className="text-2xl font-bold text-gray-600">{pendingCount}</div>
                <div className="text-xs text-gray-500">å¾…å¼€å§‹</div>
              </div>
            </div>

            {/* è¿›åº¦æ¡ */}
            <div className="px-4 py-2 bg-gray-50">
              <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-gradient-to-r from-green-400 to-green-500 rounded-full transition-all"
                  style={{ width: `${progress}%` }}
                />
              </div>
            </div>

            {/* ä»»åŠ¡åˆ—è¡¨ */}
            <div className="p-4 max-h-[40vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-3">
                <h4 className="text-sm font-semibold text-gray-700"><Icon name="clipboard" size={13} /> ä»»åŠ¡åˆ—è¡¨ ({nodeTasks.length})</h4>
                <button
                  onClick={() => setShowAddForm(true)}
                  className="px-3 py-1.5 bg-purple-500 hover:bg-purple-600 text-white text-xs rounded-lg flex items-center gap-1 transition-colors"
                >
                  <Icon name="plus" size={12} /> æ–°å¢ä»»åŠ¡
                </button>
              </div>
              
              {/* æ–°å¢ä»»åŠ¡è¡¨å• - ç®€åŒ–ç‰ˆ */}
              {showAddForm && (
                <div className="bg-purple-50 rounded-lg p-4 mb-4 border border-purple-200">
                  <div className="flex items-center justify-between mb-3">
                    <h5 className="font-medium text-purple-700">æ–°å¢ä»»åŠ¡</h5>
                    <button 
                      onClick={() => setShowAddForm(false)}
                      className="text-gray-400 hover:text-gray-600"
                    >Ã—</button>
                  </div>
                  <form onSubmit={handleSubmit} className="space-y-3">
                    {/* ä»»åŠ¡åç§° */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">ä»»åŠ¡åç§° *</label>
                      <input
                        type="text"
                        value={formData.name}
                        onChange={e => setFormData({...formData, name: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none"
                        placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°"
                        required
                      />
                    </div>
                    
                    {/* ä¼˜å…ˆçº§ */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">ä¼˜å…ˆçº§</label>
                      <select
                        value={formData.priority}
                        onChange={e => setFormData({...formData, priority: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none"
                      >
                        <option value="P0-ç´§æ€¥">P0-ç´§æ€¥</option>
                        <option value="P1-é«˜ä¼˜">P1-é«˜ä¼˜</option>
                        <option value="P2-ä¸­ç­‰">P2-ä¸­ç­‰</option>
                        <option value="P3-ä½ä¼˜">P3-ä½ä¼˜</option>
                      </select>
                    </div>
                    
                    {/* é¢„è®¡å¼€å§‹æ—¥æœŸ */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">é¢„è®¡å¼€å§‹æ—¥æœŸ</label>
                      <input
                        type="date"
                        value={formData.plannedStartDate}
                        onChange={e => setFormData({...formData, plannedStartDate: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none"
                      />
                      <div className="text-[10px] text-gray-400 mt-0.5">ç”¨äºè´Ÿè·è§„åˆ’ï¼Œæ¥å—ä»»åŠ¡åè‡ªåŠ¨è°ƒæ•´ä¸ºå®é™…å¼€å§‹æ—¥æœŸ</div>
                    </div>
                    
                    {/* è´Ÿè´£äºº */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">è´Ÿè´£äºº</label>
                      <select
                        value={formData.assignee}
                        onChange={e => setFormData({...formData, assignee: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none"
                      >
                        <option value="">è¯·é€‰æ‹©è´Ÿè´£äºº</option>
                        {members.map(m => (
                          <option key={m.id} value={m.id}>{m.name} - {m.position}</option>
                        ))}
                      </select>
                    </div>
                    
                    {/* åä½œäººï¼ˆå¤šé€‰ï¼‰ */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">åä½œäºº</label>
                      <div className="border rounded-lg p-2 max-h-32 overflow-y-auto">
                        {members.map(m => (
                          <label key={m.id} className="flex items-center gap-2 py-1 px-2 hover:bg-gray-50 rounded cursor-pointer">
                            <input
                              type="checkbox"
                              checked={formData.collaborators.includes(m.id)}
                              onChange={() => handleCollaboratorChange(m.id)}
                              className="rounded text-purple-500 focus:ring-purple-300"
                            />
                            {m.avatarUrl ? (
                              <img src={m.avatarUrl} alt="" className="w-5 h-5 rounded-full object-cover" />
                            ) : (
                              <span className={`w-5 h-5 ${m.color} rounded-full flex items-center justify-center text-white text-xs`}>
                                {m.avatar}
                              </span>
                            )}
                            <span className="text-sm">{m.name}</span>
                          </label>
                        ))}
                      </div>
                      {formData.collaborators.length > 0 && (
                        <div className="text-xs text-gray-400 mt-1">
                          å·²é€‰ {formData.collaborators.length} äºº
                        </div>
                      )}
                    </div>
                    
                    {/* æè¿° */}
                    <div>
                      <label className="block text-xs text-gray-500 mb-1">ä»»åŠ¡æè¿°</label>
                      <textarea
                        value={formData.description}
                        onChange={e => setFormData({...formData, description: e.target.value})}
                        className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 focus:border-purple-400 outline-none resize-none"
                        rows={2}
                        placeholder="è¯·è¾“å…¥ä»»åŠ¡æè¿°ï¼ˆé€‰å¡«ï¼‰"
                      />
                    </div>
                    
                    {/* æäº¤æŒ‰é’® */}
                    <div className="flex gap-2 pt-2">
                      <button
                        type="button"
                        onClick={() => setShowAddForm(false)}
                        className="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg text-sm hover:bg-gray-50 transition-colors"
                      >
                        å–æ¶ˆ
                      </button>
                      <button
                        type="submit"
                        disabled={isSubmitting}
                        className="flex-1 px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                      >
                        {isSubmitting ? 'æäº¤ä¸­...' : 'åˆ›å»ºä»»åŠ¡'}
                      </button>
                    </div>
                  </form>
                </div>
              )}
              
              {nodeTasks.length > 0 ? (
                <div className="space-y-2">
                  {nodeTasks.map(task => {
                    const assignee = members.find(m => m.id === task.assignee || m.name === task.assigneeName);
                    const isActioning = actionTaskId === task.id;
                    
                    return (
                      <div key={task.id} className="bg-gray-50 rounded-lg p-3 hover:bg-gray-100 transition-colors">
                        <div className="flex items-start gap-3">
                          {/* çŠ¶æ€å›¾æ ‡ */}
                          <div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs flex-shrink-0 mt-0.5 ${
                            task.status === 'å·²å®Œæˆ' ? 'bg-green-500 text-white' :
                            task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500 text-white' :
                            'bg-gray-300 text-gray-600'
                          }`}>
                            {task.status === 'å·²å®Œæˆ' ? 'âœ“' : task.status === 'è¿›è¡Œä¸­' ? 'â—' : 'â—‹'}
                          </div>
                          
                          {/* ä»»åŠ¡ä¿¡æ¯ */}
                          <div className="flex-1 min-w-0">
                            <div className={`font-medium ${task.status === 'å·²å®Œæˆ' ? 'text-gray-400 line-through' : 'text-gray-800'}`}>
                              {task.name}
                            </div>
                            <div className="flex items-center gap-2 mt-1 flex-wrap">
                              {assignee ? (
                                <span className="inline-flex items-center gap-1 text-xs bg-white px-2 py-0.5 rounded-full border">
                                  {assignee.avatarUrl ? (
                                    <img src={assignee.avatarUrl} alt="" className="w-4 h-4 rounded-full object-cover" />
                                  ) : (
                                    <span className={`w-4 h-4 ${assignee.color} rounded-full flex items-center justify-center text-white text-xs`}>
                                      {assignee.avatar}
                                    </span>
                                  )}
                                  {assignee.name}
                                </span>
                              ) : task.assigneeName ? (
                                <span className="inline-flex items-center gap-1 text-xs bg-white px-2 py-0.5 rounded-full border">
                                  ğŸ‘¤ {task.assigneeName}
                                </span>
                              ) : null}
                              
                              <span className={`text-xs px-2 py-0.5 rounded-full ${
                                task.priority === 'P0' || task.priority === 'P1' ? 'bg-red-100 text-red-600' :
                                task.priority === 'P2' ? 'bg-yellow-100 text-yellow-600' :
                                'bg-gray-100 text-gray-500'
                              }`}>
                                {task.priority}
                              </span>
                              
                              {task.dueDate && (
                                <span className="text-xs text-gray-400">
                                  {task.dueDate}
                                </span>
                              )}
                            </div>
                            
                            {/* æ“ä½œæŒ‰é’®åŒºåŸŸ */}
                            <div className="mt-2 flex gap-2">
                              {/* å¾…å¼€å§‹çŠ¶æ€ï¼šæ˜¾ç¤ºæ¥å—ä»»åŠ¡æŒ‰é’®ï¼ˆä»…è´Ÿè´£äººå¯è§ï¼‰ */}
                              {(task.status === 'å¾…å¼€å§‹' || task.status === 'æœªå¼€å§‹') && isTaskAssignee(task) && (
                                predecessorCheck.canAccept ? (
                                  <button
                                    onClick={() => handleAcceptTask(task)}
                                    disabled={isActioning}
                                    className="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white text-xs rounded-lg transition-colors disabled:opacity-50"
                                  >
                                    {isActioning ? 'å¤„ç†ä¸­...' : 'ğŸš€ æ¥å—ä»»åŠ¡'}
                                  </button>
                                ) : (
                                  <div className="flex flex-col gap-1">
                                    <span className="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded-lg flex items-center gap-1">
                                      âš ï¸ {predecessorCheck.message}
                                    </span>
                                    {predecessorCheck.unfinishedTasks && (
                                      <div className="text-xs text-gray-400 pl-2">
                                        æœªå®Œæˆ: {predecessorCheck.unfinishedTasks.map(t => t.name).join('ã€')}
                                      </div>
                                    )}
                                  </div>
                                )
                              )}
                              
                              {/* éè´Ÿè´£äººçœ‹åˆ°çš„æç¤º */}
                              {(task.status === 'å¾…å¼€å§‹' || task.status === 'æœªå¼€å§‹') && !isTaskAssignee(task) && (
                                <span className="text-xs text-gray-400 italic flex items-center gap-1">
                                  {assignee?.avatarUrl && (
                                    <img src={assignee.avatarUrl} alt="" className="w-4 h-4 rounded-full" />
                                  )}
                                  ä»… {task.assigneeName || assignee?.name || 'è´Ÿè´£äºº'} å¯æ¥å—
                                </span>
                              )}
                              
                              {/* è¿›è¡Œä¸­çŠ¶æ€ï¼šæ˜¾ç¤ºå®Œæˆä»»åŠ¡æŒ‰é’®ï¼ˆä»…è´Ÿè´£äººå¯è§ï¼‰ */}
                              {task.status === 'è¿›è¡Œä¸­' && isTaskAssignee(task) && (
                                <>
                                  {showCompleteForm === task.id ? (
                                    <div className="flex-1 flex flex-col gap-2">
                                      {/* æ¨¡å¼åˆ‡æ¢æ ‡ç­¾ */}
                                      <div className="flex gap-1 border-b pb-1">
                                        {[
                                          { key: 'link', label: 'ğŸ”— é“¾æ¥', },
                                          { key: 'text', label: 'ğŸ“ æ–‡å­—', },
                                        ].map(m => (
                                          <button 
                                            key={m.key}
                                            onClick={() => setCompleteMode(m.key)} 
                                            className={`px-2 py-1 text-[11px] rounded-t transition-colors ${completeMode === m.key ? 'bg-green-100 text-green-700 font-medium' : 'text-gray-400 hover:text-gray-600'}`}
                                          >
                                            {m.label}
                                          </button>
                                        ))}
                                      </div>
                                      
                                      {/* é“¾æ¥è¾“å…¥ */}
                                      {completeMode === 'link' && (
                                        <input
                                          type="url"
                                          value={outputLink}
                                          onChange={e => setOutputLink(e.target.value)}
                                          className="w-full px-3 py-2 border rounded-lg text-xs focus:ring-2 focus:ring-green-300 outline-none"
                                          placeholder="ç²˜è´´é£ä¹¦æ–‡æ¡£é“¾æ¥ã€ç½‘ç›˜åœ°å€ç­‰..."
                                        />
                                      )}

                                      {/* æ–‡å­—è¾“å…¥ */}
                                      {completeMode === 'text' && (
                                        <textarea
                                          value={outputText}
                                          onChange={e => setOutputText(e.target.value)}
                                          className="w-full px-3 py-2 border rounded-lg text-xs focus:ring-2 focus:ring-green-300 outline-none resize-none"
                                          rows={2}
                                          placeholder="è¾“å…¥äº¤ä»˜è¯´æ˜æˆ–å®Œæˆå†…å®¹..."
                                        />
                                      )}

                                      {/* æäº¤/å–æ¶ˆ */}
                                      <div className="flex items-center gap-2">
                                        <button
                                          onClick={() => handleCompleteTask(task)}
                                          disabled={isActioning || (!outputLink.trim() && !outputText.trim())}
                                          className="px-3 py-1.5 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                          {isActioning ? 'æäº¤ä¸­...' : 'âœ“ æäº¤å®Œæˆ'}
                                        </button>
                                        <button
                                          onClick={() => { setShowCompleteForm(null); setOutputFile(null); setOutputLink(''); setOutputText(''); setCompleteMode('link'); }}
                                          className="px-2 py-1.5 bg-gray-200 hover:bg-gray-300 text-gray-600 text-xs rounded-lg transition-colors"
                                        >
                                          å–æ¶ˆ
                                        </button>
                                        <span className="text-[10px] text-gray-400 ml-auto">é“¾æ¥æˆ–æ–‡å­—ä»»é€‰ä¸€é¡¹</span>
                                      </div>
                                    </div>
                                  ) : (
                                    <button
                                      onClick={() => setShowCompleteForm(task.id)}
                                      className="px-3 py-1 bg-green-500 hover:bg-green-600 text-white text-xs rounded-lg transition-colors"
                                    >
                                      âœ… å®Œæˆä»»åŠ¡
                                    </button>
                                  )}
                                </>
                              )}
                              
                              {/* è¿›è¡Œä¸­çŠ¶æ€ï¼šéè´Ÿè´£äººçœ‹åˆ°çš„æç¤º */}
                              {task.status === 'è¿›è¡Œä¸­' && !isTaskAssignee(task) && (
                                <span className="text-xs text-gray-400 italic flex items-center gap-1">
                                  {assignee?.avatarUrl && (
                                    <img src={assignee.avatarUrl} alt="" className="w-4 h-4 rounded-full" />
                                  )}
                                  ä»… {task.assigneeName || assignee?.name || 'è´Ÿè´£äºº'} å¯å®Œæˆ
                                </span>
                              )}
                              
                              {/* å·²å®ŒæˆçŠ¶æ€ï¼šæ˜¾ç¤ºäº¤ä»˜ç‰©ï¼ˆé“¾æ¥/æ–‡å­—ï¼‰ */}
                              {task.status === 'å·²å®Œæˆ' && (
                                <div className="flex flex-wrap items-center gap-2 mt-1">
                                  {task.outputUrl && (() => {
                                    // é£ä¹¦é“¾æ¥æ™ºèƒ½æ˜¾ç¤ºï¼šæå–æ–‡æ¡£æ ‡é¢˜æˆ–å‹å¥½åç§°
                                    const url = task.outputUrl;
                                    let icon = 'ğŸ”—';
                                    let label = (() => { try { return new URL(url).hostname; } catch { return 'æŸ¥çœ‹é“¾æ¥'; } })();
                                    
                                    // é£ä¹¦æ–‡æ¡£é“¾æ¥
                                    if (url.includes('feishu.cn') || url.includes('larksuite.com')) {
                                      icon = 'ğŸ“„';
                                      // å°è¯•ä» URL è·¯å¾„æå–ç±»å‹
                                      if (url.includes('/docx/')) label = 'é£ä¹¦æ–‡æ¡£';
                                      else if (url.includes('/sheets/') || url.includes('/sheet/')) label = 'é£ä¹¦è¡¨æ ¼';
                                      else if (url.includes('/base/')) label = 'å¤šç»´è¡¨æ ¼';
                                      else if (url.includes('/mindnotes/') || url.includes('/mindnote/')) label = 'é£ä¹¦æ€ç»´å¯¼å›¾';
                                      else if (url.includes('/slides/')) label = 'é£ä¹¦å¹»ç¯ç‰‡';
                                      else if (url.includes('/wiki/')) label = 'é£ä¹¦çŸ¥è¯†åº“';
                                      else if (url.includes('/drive/') || url.includes('/file/')) label = 'é£ä¹¦äº‘ç›˜æ–‡ä»¶';
                                      else if (url.includes('/minutes/')) label = 'é£ä¹¦å¦™è®°';
                                      else label = 'é£ä¹¦æ–‡æ¡£';
                                      
                                      // å°è¯•ä» URL å‚æ•°æˆ– hash æå–æ ‡é¢˜
                                      try {
                                        const u = new URL(url);
                                        const title = u.searchParams.get('title') || u.searchParams.get('name');
                                        if (title) label = decodeURIComponent(title);
                                      } catch {}
                                    }
                                    // å…¶ä»–å¸¸è§é“¾æ¥
                                    else if (url.includes('docs.google.com')) { icon = 'ğŸ“„'; label = 'Google æ–‡æ¡£'; }
                                    else if (url.includes('drive.google.com')) { icon = 'ğŸ“'; label = 'Google äº‘ç›˜'; }
                                    else if (url.includes('notion.so') || url.includes('notion.site')) { icon = 'ğŸ“'; label = 'Notion'; }
                                    
                                    return (
                                      <a 
                                        href={url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="text-xs text-blue-600 hover:text-blue-700 hover:underline inline-flex items-center gap-1 max-w-[200px]"
                                        title={url}
                                      >
                                        {icon} <span className="truncate">{label}</span>
                                      </a>
                                    );
                                  })()}
                                  {task.outputText && (
                                    <span className="text-xs text-gray-500" title={task.outputText}>
                                      ğŸ“ {task.outputText.length > 20 ? task.outputText.slice(0, 20) + '...' : task.outputText}
                                    </span>
                                  )}
                                </div>
                              )}
                              {/* ä¸Šä¼ /åŒæ­¥è¿›åº¦æ¡ */}
                              {uploadProgress[task.id] && (
                                <div className="mt-1.5 w-full">
                                  <div className="flex items-center gap-2">
                                    <div className="flex-1 h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                      <div 
                                        className={`h-full rounded-full transition-all duration-500 ${
                                          uploadProgress[task.id].phase === 'error' ? 'bg-red-400' :
                                          uploadProgress[task.id].phase === 'done' ? 'bg-green-400' :
                                          'bg-blue-400 animate-pulse'
                                        }`}
                                        style={{ width: uploadProgress[task.id].pct + '%' }}
                                      />
                                    </div>
                                    <span className={`text-[10px] flex-shrink-0 ${
                                      uploadProgress[task.id].phase === 'error' ? 'text-red-500' :
                                      uploadProgress[task.id].phase === 'done' ? 'text-green-500' :
                                      'text-blue-500'
                                    }`}>
                                      {uploadProgress[task.id].msg}
                                    </span>
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>

                          {/* çŠ¶æ€æ ‡ç­¾ */}
                          <span className={`text-xs px-2 py-1 rounded flex-shrink-0 ${
                            task.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-600' :
                            task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-100 text-blue-600' :
                            'bg-gray-100 text-gray-500'
                          }`}>
                            {task.status}
                          </span>
                        </div>
                      </div>
                    );
                  })}
                </div>
              ) : !showAddForm && (
                <div className="text-center py-8 text-gray-400">
                  <div className="text-4xl mb-2">ğŸ“­</div>
                  <div>è¯¥èŠ‚ç‚¹æš‚æ— ä»»åŠ¡</div>
                  <button
                    onClick={() => setShowAddForm(true)}
                    className="mt-3 px-4 py-2 bg-purple-100 text-purple-600 rounded-lg text-sm hover:bg-purple-200 transition-colors"
                  >
                    <Icon name="plus" size={12} /> åˆ›å»ºç¬¬ä¸€ä¸ªä»»åŠ¡
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // äº§å“è¯¦æƒ…å¼¹çª— - æ”¯æŒDAGæµç¨‹å›¾ï¼ˆè¡Œè½¨é“å¯¹é½ï¼‰+ èŠ‚ç‚¹ç‚¹å‡»
    const ProductDetailModal = ({ product, products = [], nodes: allNodes, nodeLayers: allNodeLayers, nodeMap: allNodeMap, nodeToLayer: allNodeToLayer, templates = {}, members, tasks, skippedNodes = new Set(), onSkippedNodesChange, onClose, onRefresh, onSelectProduct, viewer }) => {
      // å­çº¿æƒé™ï¼šå½“å‰ç”¨æˆ·æ˜¯å¦å¯æŸ¥çœ‹è¯¥å­é¡¹ç›®ä»»åŠ¡è¯¦æƒ…
      // å…ˆä»æˆå‘˜è¡¨åŒ¹é…å½“å‰ç”¨æˆ·çš„éƒ¨é—¨/ç»„åˆ«/è§’è‰²ä¿¡æ¯
      const viewerMember = viewer ? members.find(m => 
        m.id === viewer.open_id || m.larkUserId === viewer.open_id || 
        m.name === viewer.name || m.name === viewer.en_name
      ) : null;
      const enrichedViewer = viewer ? {
        ...viewer,
        department: viewerMember?.department || '',
        group: viewerMember?.group || '',
        permRole: viewerMember?.permRole || '',
        linkedGroups: viewerMember?.linkedGroups || []
      } : null;
      
      const canViewDetails = (() => {
        if (isParentProject(product)) return true;
        if (!enrichedViewer) return true;
        
        // === å…¨å±€é«˜æƒé™ï¼šæ€»æ˜¯èƒ½çœ‹æ‰€æœ‰å­çº¿è¯¦æƒ… ===
        if (enrichedViewer.permRole === 'ç®¡ç†å‘˜' || enrichedViewer.permRole === 'æ€»ç»ç†') return true;
        if (enrichedViewer.open_id === product.ownerId) return true;
        
        // æ‰¾åˆ°çˆ¶é¡¹ç›®ï¼Œè·å–å‘èµ·ç»„åˆ«
        const parentProduct = products.find(p => p.childIds?.includes(product.id));
        const initiatorGroup = parentProduct?.initiatorGroup || '';
        
        // éƒ¨é—¨ç®¡ç†ï¼šå¦‚æœå‘èµ·ç»„å±äºè‡ªå·±ç®¡è¾–çš„éƒ¨é—¨ â†’ èƒ½çœ‹è¯¥é¡¹ç›®æ‰€æœ‰å­çº¿è¯¦æƒ…
        if (enrichedViewer.permRole === 'éƒ¨é—¨ç®¡ç†' && initiatorGroup) {
          const initiatorMembers = members.filter(m => m.group === initiatorGroup);
          if (initiatorMembers.some(m => m.department === enrichedViewer.department)) return true;
        }
        
        // çˆ¶é¡¹ç›®è´Ÿè´£äººä¹Ÿæœ‰å…¨å±€æƒé™
        if (parentProduct && enrichedViewer.open_id === parentProduct.ownerId) return true;
        
        // === å­çº¿çº§æƒé™ï¼šæ ¹æ®æ¨¡æ¿çš„ã€Œå‚ä¸è§’è‰²ã€é…ç½® ===
        const matchTpl = Object.values(templates).find(t => t.type === product.templateType);
        const roles = matchTpl?.participantRoles || [];
        
        if (roles.length === 0) {
          // æ²¡é…ç½®å‚ä¸è§’è‰² â†’ é™çº§åˆ°æ—§é€»è¾‘ï¼šæŒ‰è´Ÿè´£éƒ¨é—¨
          if (!product.responsibleDept) return true;
          return enrichedViewer.department === product.responsibleDept;
        }
        
        for (const role of roles) {
          switch (role) {
            case 'å‘èµ·ç»„':
              if (initiatorGroup && enrichedViewer.group === initiatorGroup) return true;
              break;
            case 'å¯¹åº”äº§å“ç»„':
              if (initiatorGroup && enrichedViewer.department === 'äº§å“ä¸­å¿ƒ' && 
                  enrichedViewer.linkedGroups?.includes(initiatorGroup)) return true;
              break;
            case 'ä¸­æ¢éƒ¨':
              if (enrichedViewer.department === 'ä¸­æ¢éƒ¨') return true;
              break;
            case 'è¥é”€æ¨å¹¿éƒ¨':
              if (enrichedViewer.department === 'è¥é”€æ¨å¹¿éƒ¨') return true;
              break;
            case 'è®¾è®¡éƒ¨':
              if (enrichedViewer.group === 'è®¾è®¡éƒ¨') return true;
              break;
            case 'è´¢åŠ¡éƒ¨':
              if (enrichedViewer.department === 'è´¢åŠ¡éƒ¨') return true;
              break;
          }
        }
        
        return false;
      })();
      // æ ¹æ®æ¨¡ç‰ˆç±»å‹åŒ¹é…æ¨¡æ¿ï¼Œç­›é€‰å¯¹åº”èŠ‚ç‚¹ï¼ˆçˆ¶é¡¹ç›®ä¸åŒ¹é…æ¨¡æ¿ï¼‰
      const matchType = product.templateType;
      const matchingTemplateId = isParentProject(product) ? null : Object.keys(templates).find(tplId => 
        templates[tplId].type === matchType
      );
      
      // ç­›é€‰å±äºè¯¥æ¨¡æ¿çš„èŠ‚ç‚¹
      const nodes = matchingTemplateId 
        ? allNodes.filter(n => n.templateId === matchingTemplateId)
        : [];
      
      // é‡å»ºåˆ†å±‚ï¼ˆå¦‚æœç­›é€‰äº†èŠ‚ç‚¹ï¼‰
      const nodeLayers = (() => {
        if (!matchingTemplateId) return [];
        const layers = [];
        const visited = new Set();
        const startNodes = nodes.filter(n => !n.prevNode || !nodes.some(nn => nn.name === n.prevNode));
        if (startNodes.length > 0) {
          layers.push(startNodes);
          startNodes.forEach(n => visited.add(n.name));
        }
        let li = 1;
        while (visited.size < nodes.length && li < 20) {
          const nextLayer = nodes.filter(n => {
            if (visited.has(n.name)) return false;
            if (!n.prevNode) return false;
            return visited.has(n.prevNode);
          });
          if (nextLayer.length === 0) break;
          layers.push(nextLayer);
          nextLayer.forEach(n => visited.add(n.name));
          li++;
        }
        return layers;
      })();
      
      const nodeMap = {};
      nodes.forEach(n => { nodeMap[n.name] = n; });
      
      const nodeToLayer = {};
      nodeLayers.forEach((layer, idx) => {
        layer.forEach(n => { nodeToLayer[n.name] = idx; });
      });
      
      const hasMatchingTemplate = matchingTemplateId || allNodes.length === 0;
      const [selectedNode, setSelectedNode] = useState(null);
      const [isCreatingChildren, setIsCreatingChildren] = useState(false);
      const currentUser = useContext(UserContext);
      const showToast = useToast();
      
      if (!product) return null;
      const productTasks = tasks.filter(t => t.productId === product.id);

      // è®¡ç®—å­é¡¹ç›®æ—¶é—´çº¿ï¼ˆç”¨äºèŠ‚ç‚¹ä¸Šæ ‡æ³¨é¢„è®¡æ—¥æœŸï¼‰
      const parentProduct = product.parentId ? products.find(p => p.id === product.parentId) : null;
      const parentStart = parentProduct?.startDate ? new Date(parentProduct.startDate) : null;
      const modalTimeline = calcSubProjectTimeline(product, parentStart, allNodes, templates);
      const timelineMap = {};
      modalTimeline.nodes.forEach(n => { timelineMap[n.name] = n; });

      // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯é¡¹ç›®è´Ÿè´£äººï¼ˆå«çˆ¶é¡¹ç›®è´Ÿè´£äººï¼‰
      const isProjectOwner = !!(enrichedViewer && (
        (product.ownerId && enrichedViewer.open_id === product.ownerId) ||
        (product.ownerName && enrichedViewer.name === product.ownerName) ||
        (product.ownerName && enrichedViewer.en_name === product.ownerName) ||
        (parentProduct?.ownerId && enrichedViewer.open_id === parentProduct.ownerId) ||
        (parentProduct?.ownerName && enrichedViewer.name === parentProduct.ownerName) ||
        (parentProduct?.ownerName && enrichedViewer.en_name === parentProduct.ownerName)
      ));

      // è‡ªåŠ¨è®¡ç®—å½“å‰é˜¶æ®µ
      const getAutoCurrentStage = () => {
        let lastActiveNode = null;
        for (const node of nodes) {
          const nodeTasks = productTasks.filter(t => t.stage === node.name);
          const hasActive = nodeTasks.some(t => t.status === 'è¿›è¡Œä¸­');
          const hasCompleted = nodeTasks.some(t => t.status === 'å·²å®Œæˆ');
          const hasIncomplete = nodeTasks.some(t => t.status !== 'å·²å®Œæˆ');
          if (hasActive || (hasCompleted && hasIncomplete)) {
            lastActiveNode = node.name;
          }
        }
        return lastActiveNode || product.currentStage;
      };
      const autoCurrentStage = getAutoCurrentStage();

      // æ‰¾åˆ°é¡¹ç›®è´Ÿè´£äººçš„æˆå‘˜ä¿¡æ¯
      const ownerMember = members.find(m => m.id === product.ownerId || m.name === product.ownerName || m.larkName === product.ownerName);

      // è‡ªåŠ¨è®¡ç®—é¡¹ç›®è¿›åº¦
      const getAutoProgress = () => {
        // çˆ¶é¡¹ç›®ï¼šèšåˆå­é¡¹ç›®
        if (product.childIds?.length > 0) {
          const childProducts = products.filter(p => product.childIds.includes(p.id));
          if (childProducts.length > 0) {
            const total = childProducts.reduce((sum, c) => sum + calcProjectProgress(c, allNodes, templates, tasks), 0);
            return Math.round(total / childProducts.length);
          }
        }
        if (nodes.length === 0) return product.progress;
        let totalNodeProgress = 0;
        for (const node of nodes) {
          if (skippedNodes.has(node.name)) {
            totalNodeProgress += 100; // è·³è¿‡çš„èŠ‚ç‚¹æŒ‰100%
            continue;
          }
          const nodeTasks = productTasks.filter(t => t.stage === node.name);
          if (nodeTasks.length > 0) {
            const completedCount = nodeTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
            totalNodeProgress += (completedCount / nodeTasks.length) * 100;
          }
        }
        return Math.round(totalNodeProgress / nodes.length);
      };
      const autoProgress = getAutoProgress();

      // è·å–èŠ‚ç‚¹çŠ¶æ€ï¼ˆåŸºäºä»»åŠ¡çŠ¶æ€ï¼‰
      const getNodeStatus = (nodeName) => {
        if (skippedNodes.has(nodeName)) return 'skipped'; // å·²è·³è¿‡
        const nodeTasks = productTasks.filter(t => t.stage === nodeName);
        if (nodeTasks.length === 0) return 'pending'; // æ— ä»»åŠ¡ â†’ ç°è‰²
        const completedCount = nodeTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
        const inProgressCount = nodeTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
        if (completedCount === nodeTasks.length) return 'completed'; // å…¨éƒ¨å®Œæˆ â†’ ç»¿è‰²
        if (inProgressCount > 0 || completedCount > 0) return 'inProgress'; // æœ‰è¿›è¡Œä¸­æˆ–éƒ¨åˆ†å®Œæˆ â†’ çº¢è‰²
        return 'pending'; // å…¨éƒ¨æœªå¼€å§‹ â†’ ç°è‰²
      };

      // è·³è¿‡èŠ‚ç‚¹ï¼ˆä»…é¡¹ç›®è´Ÿè´£äººå¯æ“ä½œï¼‰
      const handleSkipNode = (nodeName, e) => {
        e.stopPropagation();
        if (!isProjectOwner) {
          showToast?.('åªæœ‰é¡¹ç›®è´Ÿè´£äººæ‰èƒ½è·³è¿‡èŠ‚ç‚¹', 'error');
          return;
        }
        const isCurrentlySkipped = skippedNodes.has(nodeName);
        if (!isCurrentlySkipped) {
          if (!confirm(`ç¡®è®¤è·³è¿‡èŠ‚ç‚¹ã€Œ${nodeName}ã€ï¼Ÿ\n\nè·³è¿‡åï¼Œåç»­èŠ‚ç‚¹å°†ä¸å—æ­¤èŠ‚ç‚¹é™åˆ¶ã€‚`)) return;
        }
        onSkippedNodesChange?.(prev => {
          const next = new Set(prev);
          if (next.has(nodeName)) {
            next.delete(nodeName);
          } else {
            next.add(nodeName);
          }
          return next;
        });
        showToast?.(isCurrentlySkipped ? `å·²æ¢å¤èŠ‚ç‚¹ã€Œ${nodeName}ã€` : `èŠ‚ç‚¹ã€Œ${nodeName}ã€å·²è·³è¿‡`, 'success');
      };

      // æ„å»ºæµç¨‹é“¾ï¼ˆæ¯æ¡é“¾æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¡Œï¼‰
      const buildFlowChains = () => {
        if (!nodes || nodes.length === 0) return [];
        
        // æ‰¾åˆ°æ‰€æœ‰èµ·å§‹èŠ‚ç‚¹
        const startNodes = nodes.filter(n => !n.prevNode);
        if (startNodes.length === 0) return [];
        
        const chains = [];
        const visited = new Set();
        
        // é€’å½’æ„å»ºé“¾
        const buildChain = (node, chain = []) => {
          if (!node || visited.has(node.name)) return;
          
          chain.push(node);
          visited.add(node.name);
          
          // è·å–åç»§èŠ‚ç‚¹
          const children = nodes.filter(n => n.prevNode === node.name);
          
          if (children.length === 0) {
            // é“¾ç»“æŸ
            chains.push([...chain]);
          } else if (children.length === 1) {
            // å•ä¸€åç»§ï¼Œç»§ç»­å½“å‰é“¾
            buildChain(children[0], chain);
          } else {
            // å¤šä¸ªåç»§ï¼ˆåˆ†æ”¯ç‚¹ï¼‰ï¼Œä¸ºæ¯ä¸ªåç»§åˆ›å»ºæ–°é“¾
            // å…ˆä¿å­˜å½“å‰é“¾åˆ°åˆ†æ”¯ç‚¹
            const branchPoint = [...chain];
            
            children.forEach((child, idx) => {
              if (idx === 0) {
                // ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ç»§ç»­å½“å‰é“¾
                buildChain(child, chain);
              } else {
                // å…¶ä»–å­èŠ‚ç‚¹å¼€å§‹æ–°é“¾ï¼ˆåŒ…å«çˆ¶èŠ‚ç‚¹è·¯å¾„ï¼‰
                visited.delete(child.name); // å…è®¸é‡æ–°è®¿é—®
                const newChain = [...branchPoint];
                buildChain(child, newChain);
              }
            });
          }
        };
        
        // ä»æ¯ä¸ªèµ·å§‹èŠ‚ç‚¹å¼€å§‹æ„å»º
        startNodes.forEach(startNode => {
          buildChain(startNode, []);
        });
        
        return chains;
      };

      // ä½¿ç”¨ç®€åŒ–çš„ç½‘æ ¼å¸ƒå±€
      const buildGridLayout = () => {
        if (!nodes || nodes.length === 0) return { grid: [], maxCol: 0 };
        
        // è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„åˆ—ä½ç½®ï¼ˆåŸºäºå±‚çº§ï¼‰
        const nodePositions = {};
        nodes.forEach(n => {
          nodePositions[n.name] = {
            node: n,
            col: nodeToLayer[n.name] || 0,
            row: -1
          };
        });
        
        // åˆ†é…è¡Œä½ç½®
        // ç­–ç•¥ï¼šåŒä¸€å‰ç½®èŠ‚ç‚¹çš„å­èŠ‚ç‚¹å ç”¨ä¸åŒè¡Œï¼Œä½†åˆ†æ”¯å»¶ç»­åœ¨åŒä¸€è¡Œ
        let currentRow = 0;
        const assignRows = (nodeName, row) => {
          if (nodePositions[nodeName].row !== -1) return;
          nodePositions[nodeName].row = row;
          
          const children = nodes.filter(n => n.prevNode === nodeName);
          if (children.length === 1) {
            // å•ä¸€åç»§ï¼ŒåŒè¡Œå»¶ç»­
            assignRows(children[0].name, row);
          } else if (children.length > 1) {
            // å¤šä¸ªåç»§ï¼Œåˆ†é…ä¸åŒè¡Œ
            children.forEach((child, idx) => {
              if (idx === 0) {
                assignRows(child.name, row);
              } else {
                currentRow++;
                assignRows(child.name, currentRow);
              }
            });
          }
        };
        
        // ä»èµ·å§‹èŠ‚ç‚¹å¼€å§‹åˆ†é…
        const startNodes = nodes.filter(n => !n.prevNode);
        startNodes.forEach((startNode, idx) => {
          if (idx > 0) currentRow++;
          assignRows(startNode.name, currentRow);
        });
        
        // æ‰¾å‡ºæœ€å¤§åˆ—æ•°å’Œè¡Œæ•°
        const maxCol = Math.max(...Object.values(nodePositions).map(p => p.col)) + 1;
        const maxRow = Math.max(...Object.values(nodePositions).map(p => p.row)) + 1;
        
        // æ„å»ºç½‘æ ¼
        const grid = Array(maxRow).fill(null).map(() => Array(maxCol).fill(null));
        Object.values(nodePositions).forEach(pos => {
          if (pos.row >= 0 && pos.col >= 0) {
            grid[pos.row][pos.col] = pos.node;
          }
        });
        
        return { grid, maxCol, maxRow, nodePositions };
      };

      const { grid, maxCol, maxRow, nodePositions } = buildGridLayout();

      // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”»è¿æ¥çº¿
      const shouldDrawLine = (row, col) => {
        if (col >= maxCol - 1) return false;
        const currentNode = grid[row][col];
        const nextNode = grid[row][col + 1];
        if (!currentNode) return false;
        // æ£€æŸ¥ä¸‹ä¸€åˆ—æ˜¯å¦æœ‰èŠ‚ç‚¹æ˜¯å½“å‰èŠ‚ç‚¹çš„åç»§
        if (nextNode && nextNode.prevNode === currentNode.name) return true;
        // æˆ–è€…å½“å‰èŠ‚ç‚¹æœ‰åç»§åœ¨ä¸‹ä¸€åˆ—
        const hasChildInNextCol = nodes.some(n => n.prevNode === currentNode.name && nodePositions[n.name]?.col === col + 1);
        return hasChildInNextCol;
      };

      return (
        <div className="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50 sm:p-4" onClick={onClose}>
          <div className="bg-white rounded-t-2xl sm:rounded-2xl max-w-6xl w-full max-h-[95vh] sm:max-h-[90vh] overflow-hidden" onClick={e => e.stopPropagation()}>
            <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white p-4 sm:p-6">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3 sm:gap-4 min-w-0 flex-1">
                  <div className="w-10 h-10 sm:w-16 sm:h-16 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                    <Icon name="folder" size={20} color="white" />
                  </div>
                  <div className="min-w-0 flex-1">
                    <h2 className="text-lg sm:text-2xl font-bold truncate">{product.name}</h2>
                    <div className="flex items-center gap-2 mt-1 flex-wrap">
                      <span className="text-white/80 text-sm">{product.templateType || product.category}</span>
                      {product.childIds?.length > 0 && (
                        <span className="text-xs px-1.5 py-0.5 rounded bg-white/20 text-white">ğŸ“‚ {product.childIds.length} å­é¡¹ç›®</span>
                      )}
                      {product.parentId && (
                        <span className="text-xs px-1.5 py-0.5 rounded bg-white/20 text-white/80">â†³ å­é¡¹ç›®</span>
                      )}
                      {product.responsibleDept && (
                        <span className="text-xs px-1.5 py-0.5 rounded bg-white/20 text-white/80">{product.responsibleDept}</span>
                      )}
                      {product.priority && (
                        <span className={`text-xs font-bold px-1.5 py-0.5 rounded ${
                          product.priority === 'P0' ? 'bg-red-500 text-white' :
                          product.priority === 'P1' ? 'bg-orange-500 text-white' :
                          product.priority === 'P2' ? 'bg-yellow-400 text-gray-800' :
                          'bg-white/20 text-white/80'
                        }`}>{product.priority}</span>
                      )}
                      {autoCurrentStage && (
                        <>
                          <span className="text-white/40 text-sm">|</span>
                          <span className="text-white/80 text-sm">ğŸ“ {autoCurrentStage}</span>
                        </>
                      )}
                      {product.ownerName && (
                        <>
                          <span className="text-white/60 text-sm">|</span>
                          <span className="flex items-center gap-1.5 text-sm text-white/90">
                            {ownerMember?.avatarUrl ? (
                              <img src={ownerMember.avatarUrl} alt="" className="w-5 h-5 rounded-full border border-white/30" />
                            ) : (
                              <span className="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center text-xs">
                                {product.ownerName.charAt(0)}
                              </span>
                            )}
                            ğŸ‘¤ {product.ownerName}
                          </span>
                        </>
                      )}
                    </div>
                  </div>
                </div>
                <button onClick={onClose} className="text-white/80 hover:text-white text-2xl">Ã—</button>
              </div>
            </div>

            <div className="p-4 sm:p-6 overflow-y-auto max-h-[calc(95vh-200px)] sm:max-h-[calc(90vh-200px)]">
              
              {/* === çˆ¶é¡¹ç›®è§†å›¾ï¼šæ˜¾ç¤ºå­é¡¹ç›®æ¦‚è§ˆ + è¡¥å»ºå­é¡¹ç›®å…¥å£ === */}
              {isParentProject(product) ? (() => {
                const childProducts = (product.childIds?.length > 0) ? products.filter(p => product.childIds.includes(p.id)) : [];
                const allChildTasks = tasks.filter(t => childProducts.some(c => c.id === t.productId));
                const completedChildTasks = allChildTasks.filter(t => t.status === 'å·²å®Œæˆ');
                const inProgressChildTasks = allChildTasks.filter(t => t.status === 'è¿›è¡Œä¸­');
                const pendingChildTasks = allChildTasks.filter(t => t.status === 'å¾…å¼€å§‹' || t.status === 'æœªå¼€å§‹');
                
                // æŸ¥æ‰¾å¯¹åº”çš„å­æ¨¡æ¿
                const parentTplId = Object.keys(templates).find(id => templates[id].type === product.templateType && templates[id].ownership === 'çˆ¶é¡¹ç›®');
                const parentTplName = parentTplId ? templates[parentTplId].name : '';
                const childTpls = Object.values(templates).filter(t => t.ownership === 'å­é¡¹ç›®' && t.parentTemplate === parentTplName);
                
                return (
                  <>
                    {/* æ£€æµ‹ç¼ºå¤±çš„å­çº¿ */}
                    {(() => {
                      // å·²æœ‰å­é¡¹ç›®çš„æ¨¡æ¿ç±»å‹
                      const existingTypes = new Set(childProducts.map(c => c.templateType));
                      const missingTpls = childTpls.filter(t => !existingTypes.has(t.type));
                      
                      if (childProducts.length === 0 && childTpls.length > 0) {
                        return (
                          <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6">
                            <div className="flex items-center justify-between">
                              <div>
                                <div className="font-medium text-amber-800">âš ï¸ è¯¥çˆ¶é¡¹ç›®æš‚æ— å­é¡¹ç›®</div>
                                <div className="text-sm text-amber-600 mt-1">å¯ä¸€é”®ç”Ÿæˆï¼Œæˆ–åœ¨é£ä¹¦å¤šç»´è¡¨æ‰‹åŠ¨æ·»åŠ å­é¡¹ç›®å¹¶å…³è”ã€Œçˆ¶é¡¹ç›®ã€å­—æ®µï¼Œåˆ·æ–°åè‡ªåŠ¨åŒæ­¥</div>
                              </div>
                          <button
                            disabled={isCreatingChildren}
                            onClick={async () => {
                              if (isCreatingChildren) return;
                              setIsCreatingChildren(true);
                              const deptMap = { 'äº§å“å¼€å‘çº¿': 'äº§å“ä¸­å¿ƒ', 'äº§å“ç«‹é¡¹çº¿': 'äº§å“ä¸­å¿ƒ', 'è¿è¥è®¡åˆ’çº¿': 'è¿è¥ä¸­å¿ƒ', 'ä¸­æ¢åä½œçº¿': 'ä¸­æ¢éƒ¨', 'è¿è¥è½åœ°çº¿': 'è¿è¥ä¸­å¿ƒ', 'è®¾è®¡éœ€æ±‚çº¿': 'è®¾è®¡éƒ¨', 'ç«™å¤–æ¨å¹¿çº¿': 'è¥é”€æ¨å¹¿éƒ¨', 'éœ€æ±‚ç¡®å®šçº¿': 'äº§å“ä¸­å¿ƒ', 'éœ€æ±‚å®¡æ‰¹çº¿': 'ä¸­æ¢éƒ¨', 'ç³»ç»Ÿåˆ¶ä½œçº¿': 'äº§å“ä¸­å¿ƒ' };
                              let created = 0;
                              const startDate = product.startDate ? new Date(product.startDate) : new Date();
                              for (const tpl of childTpls) {
                                const childName = `${product.name.replace(/å»ºè®¾|SOP|é¡¹ç›®/g, '')}-${tpl.name}`;
                                const dept = deptMap[tpl.name] || '';
                                const cycleDays = tpl.cycleDays || 0;
                                let endDate = null;
                                if (cycleDays > 0) {
                                  endDate = new Date(startDate);
                                  let rem = cycleDays;
                                  while (rem > 0) { endDate.setDate(endDate.getDate() + 1); const d = endDate.getDay(); if (d !== 0 && d !== 6) rem--; }
                                }
                                try {
                                  const res = await fetch(API_BASE + '/api/create-record', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ app_token: APP_TOKEN, table_id: 'tblYM02NyVj3rUkR', fields: {
                                      'é¡¹ç›®åç§°': childName, 'é¡¹ç›®ç±»å‹': 'å­é¡¹ç›®', 'æ¨¡ç‰ˆç±»å‹': tpl.type, 'é¡¹ç›®çŠ¶æ€': 'æœªå¼€å§‹', 'è´Ÿè´£éƒ¨é—¨': dept,
                                      'å¼€å§‹æ—¥æœŸ': startDate.getTime(),
                                      ...(endDate ? { 'è®¡åˆ’ä¸Šçº¿æ—¥æœŸ': endDate.getTime() } : {}),
                                      'çˆ¶é¡¹ç›®': [product.id]
                                    }})
                                  });
                                  const result = await res.json();
                                  if (result.success) created++;
                                } catch (e) { console.error(e); }
                              }
                              showToast?.(`âœ… å·²ç”Ÿæˆ ${created} ä¸ªå­é¡¹ç›®`, 'success');
                              if (onRefresh) onRefresh();
                              onClose();
                            }}
                            className={`px-4 py-2 text-white rounded-lg text-sm whitespace-nowrap ${isCreatingChildren ? 'bg-gray-400 cursor-not-allowed' : 'bg-amber-500 hover:bg-amber-600'}`}
                          >
                            {isCreatingChildren ? 'â³ ç”Ÿæˆä¸­...' : `ğŸš€ ç”Ÿæˆ ${childTpls.length} ä¸ªå­é¡¹ç›®`}
                          </button>
                        </div>
                      </div>
                        );
                      }
                      
                      if (childProducts.length === 0 && childTpls.length === 0) {
                        return (
                          <div className="bg-gray-50 rounded-xl p-6 text-center text-gray-400 mb-6">
                            <div className="text-sm">è¯¥é¡¹ç›®æ¨¡ç‰ˆç±»å‹ã€Œ{product.templateType}ã€æš‚æ— å¯¹åº”å­æ¨¡æ¿</div>
                            <div className="text-xs mt-1">è¯·åœ¨é£ä¹¦ã€Œæµç¨‹æ¨¡æ¿ã€è¡¨ä¸­ä¸ºæ­¤ç±»å‹åˆ›å»ºå­æ¨¡æ¿</div>
                          </div>
                        );
                      }
                      
                      if (missingTpls.length > 0) {
                        return (
                          <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                            <div className="flex items-center justify-between">
                              <div>
                                <div className="font-medium text-blue-800">ğŸ“‹ æ£€æµ‹åˆ° {missingTpls.length} æ¡æ–°å¢å­çº¿æœªåŒæ­¥</div>
                                <div className="text-sm text-blue-600 mt-1 flex flex-wrap gap-1">
                                  {missingTpls.map(t => <span key={t.type} className="px-2 py-0.5 bg-blue-100 rounded text-xs">{t.name}</span>)}
                                </div>
                              </div>
                              <button
                                disabled={isCreatingChildren}
                                onClick={async () => {
                                  if (isCreatingChildren) return;
                                  setIsCreatingChildren(true);
                                  const deptMap = { 'äº§å“å¼€å‘çº¿': 'äº§å“ä¸­å¿ƒ', 'äº§å“ç«‹é¡¹çº¿': 'äº§å“ä¸­å¿ƒ', 'è¿è¥è®¡åˆ’çº¿': 'è¿è¥ä¸­å¿ƒ', 'ä¸­æ¢åä½œçº¿': 'ä¸­æ¢éƒ¨', 'è¿è¥è½åœ°çº¿': 'è¿è¥ä¸­å¿ƒ', 'è®¾è®¡éœ€æ±‚çº¿': 'è®¾è®¡éƒ¨', 'ç«™å¤–æ¨å¹¿çº¿': 'è¥é”€æ¨å¹¿éƒ¨', 'éœ€æ±‚ç¡®å®šçº¿': 'äº§å“ä¸­å¿ƒ', 'éœ€æ±‚å®¡æ‰¹çº¿': 'ä¸­æ¢éƒ¨', 'ç³»ç»Ÿåˆ¶ä½œçº¿': 'äº§å“ä¸­å¿ƒ' };
                                  const startDate = product.startDate ? new Date(product.startDate) : new Date();
                                  let created = 0;
                                  for (const tpl of missingTpls) {
                                    const childName = `${product.name.replace(/æ–°å“ä¸Šçº¿|å»ºè®¾|SOP|é¡¹ç›®/g, '')}-${tpl.name}`;
                                    const dept = deptMap[tpl.name] || '';
                                    const cycleDays = tpl.cycleDays || 0;
                                    let endDate = null;
                                    if (cycleDays > 0) {
                                      endDate = new Date(startDate);
                                      let rem = cycleDays;
                                      while (rem > 0) { endDate.setDate(endDate.getDate() + 1); const d = endDate.getDay(); if (d !== 0 && d !== 6) rem--; }
                                    }
                                    try {
                                      const res = await fetch(API_BASE + '/api/create-record', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ app_token: APP_TOKEN, table_id: 'tblYM02NyVj3rUkR', fields: {
                                          'é¡¹ç›®åç§°': childName, 'é¡¹ç›®ç±»å‹': 'å­é¡¹ç›®', 'æ¨¡ç‰ˆç±»å‹': tpl.type, 'é¡¹ç›®çŠ¶æ€': 'æœªå¼€å§‹', 'è´Ÿè´£éƒ¨é—¨': dept,
                                          'å¼€å§‹æ—¥æœŸ': startDate.getTime(),
                                          ...(endDate ? { 'è®¡åˆ’ä¸Šçº¿æ—¥æœŸ': endDate.getTime() } : {}),
                                          'çˆ¶é¡¹ç›®': [product.id]
                                        }})
                                      });
                                      const result = await res.json();
                                      if (result.success) created++;
                                    } catch (e) { console.error(e); }
                                  }
                                  showToast?.(`âœ… å·²è¡¥å»º ${created} ä¸ªå­é¡¹ç›®`, 'success');
                                  if (onRefresh) onRefresh();
                                  onClose();
                                }}
                                className={`px-4 py-2 text-white rounded-lg text-sm whitespace-nowrap ${isCreatingChildren ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-500 hover:bg-blue-600'}`}
                              >
                                {isCreatingChildren ? 'â³ è¡¥å»ºä¸­...' : `â• è¡¥å»º ${missingTpls.length} ä¸ªå­é¡¹ç›®`}
                              </button>
                            </div>
                          </div>
                        );
                      }
                      return null;
                    })()}
                    {childProducts.length > 0 && (
                    <>
                    {/* èšåˆç»Ÿè®¡ */}
                    <div className="grid grid-cols-3 sm:grid-cols-5 gap-2 sm:gap-4 mb-6">
                      <div className="bg-gray-50 rounded-xl p-3 sm:p-4 text-center">
                        <div className="text-2xl sm:text-3xl font-bold text-blue-600">{autoProgress}%</div>
                        <div className="text-xs sm:text-sm text-gray-500">æ•´ä½“è¿›åº¦</div>
                      </div>
                      <div className="bg-gray-50 rounded-xl p-3 sm:p-4 text-center">
                        <div className="text-2xl sm:text-3xl font-bold text-violet-600">{childProducts.length}</div>
                        <div className="text-xs sm:text-sm text-gray-500">ğŸ“‚ å­é¡¹ç›®</div>
                      </div>
                      <div className="bg-gray-50 rounded-xl p-3 sm:p-4 text-center">
                        <div className="text-2xl sm:text-3xl font-bold text-green-600">{completedChildTasks.length}</div>
                        <div className="text-xs sm:text-sm text-gray-500">âœ… å·²å®Œæˆ</div>
                      </div>
                      <div className="bg-gray-50 rounded-xl p-3 sm:p-4 text-center">
                        <div className="text-2xl sm:text-3xl font-bold text-orange-600">{inProgressChildTasks.length}</div>
                        <div className="text-xs sm:text-sm text-gray-500">ğŸ”„ è¿›è¡Œä¸­</div>
                      </div>
                      <div className="bg-gray-50 rounded-xl p-3 sm:p-4 text-center">
                        <div className="text-2xl sm:text-3xl font-bold text-gray-500">{pendingChildTasks.length}</div>
                        <div className="text-xs sm:text-sm text-gray-500">â³ å¾…å¼€å§‹</div>
                      </div>
                    </div>
                    
                    {/* === é¡¹ç›®æµæ°´çº¿æµç¨‹å›¾ === */}
                    {(() => {
                      if (childProducts.length === 0) return null;
                      
                      // æ„å»º name â†’ prerequisite names æ˜ å°„ï¼ˆç›´æ¥ä»æ¨¡æ¿æ•°æ®è¯»å–ï¼‰
                      const prereqMap = {};
                      childTpls.forEach(t => {
                        prereqMap[t.name] = t.prerequisiteNames || [];
                      });
                      
                      // æ‹“æ‰‘æ’åºåˆ†å±‚
                      const getDepth = (name, visited = new Set()) => {
                        if (visited.has(name)) return 0;
                        visited.add(name);
                        const deps = prereqMap[name] || [];
                        if (deps.length === 0) return 0;
                        return 1 + Math.max(...deps.map(d => getDepth(d, new Set(visited))));
                      };
                      
                      const lineDepths = {};
                      childTpls.forEach(t => { lineDepths[t.name] = getDepth(t.name); });
                      const maxDepth = Math.max(...Object.values(lineDepths), 0);
                      
                      // æŒ‰å±‚åˆ†ç»„
                      const stages = [];
                      for (let d = 0; d <= maxDepth; d++) {
                        const linesAtDepth = childTpls.filter(t => lineDepths[t.name] === d);
                        if (linesAtDepth.length === 0) continue;
                        const depNames = new Set();
                        linesAtDepth.forEach(t => (prereqMap[t.name] || []).forEach(n => depNames.add(n)));
                        stages.push({ lines: linesAtDepth, deps: [...depNames] });
                      }
                      
                      if (stages.length === 0) return null;
                      
                      const deptColors = {
                        'äº§å“ä¸­å¿ƒ': { bg: 'bg-blue-50', border: 'border-blue-300', text: 'text-blue-700', dot: 'bg-blue-500', ring: 'ring-blue-200', grad: 'from-blue-500 to-blue-600' },
                        'è¿è¥ä¸­å¿ƒ': { bg: 'bg-green-50', border: 'border-green-300', text: 'text-green-700', dot: 'bg-green-500', ring: 'ring-green-200', grad: 'from-green-500 to-green-600' },
                        'è®¾è®¡éƒ¨': { bg: 'bg-pink-50', border: 'border-pink-300', text: 'text-pink-700', dot: 'bg-pink-500', ring: 'ring-pink-200', grad: 'from-pink-500 to-pink-600' },
                        'ä¸­æ¢éƒ¨': { bg: 'bg-purple-50', border: 'border-purple-300', text: 'text-purple-700', dot: 'bg-purple-500', ring: 'ring-purple-200', grad: 'from-purple-500 to-purple-600' },
                        'è¥é”€æ¨å¹¿éƒ¨': { bg: 'bg-orange-50', border: 'border-orange-300', text: 'text-orange-700', dot: 'bg-orange-500', ring: 'ring-orange-200', grad: 'from-orange-500 to-orange-600' }
                      };
                      const defaultDc = { bg: 'bg-gray-50', border: 'border-gray-300', text: 'text-gray-700', dot: 'bg-gray-500', ring: 'ring-gray-200', grad: 'from-gray-500 to-gray-600' };
                      
                      const getChild = (tpl) => childProducts.find(c => c.templateType === tpl.type);
                      
                      // è®¡ç®—å…³é”®è·¯å¾„æ€»å·¥æœŸ
                      const parentStart = product.startDate ? new Date(product.startDate) : null;
                      let cumulativeDays = 0;
                      stages.forEach(stg => {
                        const maxCycle = Math.max(...stg.lines.map(t => t.cycleDays || 0), 0);
                        cumulativeDays += maxCycle;
                      });
                      const totalProjectDays = cumulativeDays;
                      const targetDate = parentStart ? addWorkingDays(new Date(parentStart), totalProjectDays) : 
                        (product.targetDate ? new Date(product.targetDate) : null);
                      const now = new Date();
                      const elapsedDays = parentStart ? getWorkingDaysBetween(parentStart, now) : 0;
                      const remainingDays = Math.max(0, totalProjectDays - elapsedDays);
                      
                      const stageLabels = ['ğŸš€ å¯åŠ¨é˜¶æ®µ', 'âš™ï¸ å¹¶è¡Œæ‰§è¡Œ', 'ğŸ“¦ å…¨é¢è½åœ°', 'ğŸ¯ æ”¶å°¾é˜¶æ®µ'];
                      
                      return (
                        <div className="mb-6">
                          {/* è®¡åˆ’ä¸Šçº¿é†’ç›®å±•ç¤º */}
                          <div className="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 rounded-2xl p-4 sm:p-5 mb-5 text-white">
                            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                              <div className="flex items-center gap-3">
                                <div className="w-10 h-10 sm:w-14 sm:h-14 rounded-xl bg-white/20 flex items-center justify-center text-2xl sm:text-3xl">ğŸ¯</div>
                                <div>
                                  <div className="text-[10px] sm:text-xs opacity-70 uppercase tracking-wide">è®¡åˆ’ä¸Šçº¿æ—¥æœŸ</div>
                                  <div className="text-xl sm:text-3xl font-bold tracking-tight">
                                    {targetDate ? `${targetDate.getMonth()+1}æœˆ${targetDate.getDate()}æ—¥` : 'æœªè®¾å®š'}
                                  </div>
                                </div>
                              </div>
                              <div className="flex gap-4 sm:gap-6">
                                <div className="text-center">
                                  <div className="text-[10px] sm:text-xs opacity-70">æ€»å·¥æœŸ</div>
                                  <div className="text-lg sm:text-2xl font-bold">{totalProjectDays}<span className="text-xs sm:text-sm font-normal ml-0.5">å¤©</span></div>
                                </div>
                                <div className="text-center">
                                  <div className="text-[10px] sm:text-xs opacity-70">å·²ç”¨</div>
                                  <div className="text-lg sm:text-2xl font-bold">{elapsedDays}<span className="text-xs sm:text-sm font-normal ml-0.5">å¤©</span></div>
                                </div>
                                <div className="text-center">
                                  <div className="text-[10px] sm:text-xs opacity-70">å‰©ä½™</div>
                                  <div className={`text-lg sm:text-2xl font-bold ${remainingDays <= 10 ? 'text-red-300' : ''}`}>{remainingDays}<span className="text-xs sm:text-sm font-normal ml-0.5">å¤©</span></div>
                                </div>
                              </div>
                            </div>
                            {/* æ•´ä½“æ—¶é—´è¿›åº¦æ¡ */}
                            <div className="mt-3 flex items-center gap-3">
                              <div className="flex-1 h-2 bg-white/20 rounded-full overflow-hidden">
                                <div className="h-full bg-white/80 rounded-full transition-all" style={{width: `${Math.min(100, totalProjectDays > 0 ? (elapsedDays / totalProjectDays * 100) : 0)}%`}} />
                              </div>
                              <span className="text-xs opacity-70">{totalProjectDays > 0 ? Math.round(elapsedDays / totalProjectDays * 100) : 0}%</span>
                            </div>
                          </div>
                          
                          {/* æµç¨‹å›¾ */}
                          <h3 className="text-lg font-semibold text-gray-800 mb-4">ğŸ“ é¡¹ç›®æµæ°´çº¿</h3>
                          <div className="relative">
                            {stages.map((stg, si) => {
                              const lineInfos = stg.lines.map(tpl => {
                                const child = getChild(tpl);
                                const progress = child ? calcProjectProgress(child, allNodes, templates, tasks) : 0;
                                const status = child?.status === 'å·²å®Œæˆ' ? 'done' : progress > 0 ? 'active' : 'pending';
                                // å¡ç‰‡é¢œè‰²ï¼šä¼˜å…ˆç”¨å­é¡¹ç›®è´Ÿè´£éƒ¨é—¨ï¼Œå¦åˆ™ä»æ¨¡æ¿å‚ä¸è§’è‰²æ¨æ–­
                                const primaryDept = child?.responsibleDept || (() => {
                                  const roleMap = { 'å‘èµ·ç»„': 'è¿è¥ä¸­å¿ƒ', 'å¯¹åº”äº§å“ç»„': 'äº§å“ä¸­å¿ƒ', 'ä¸­æ¢éƒ¨': 'ä¸­æ¢éƒ¨', 'è¥é”€æ¨å¹¿éƒ¨': 'è¥é”€æ¨å¹¿éƒ¨', 'è®¾è®¡éƒ¨': 'è®¾è®¡éƒ¨', 'è´¢åŠ¡éƒ¨': 'è´¢åŠ¡éƒ¨' };
                                  const firstRole = (tpl.participantRoles || [])[0];
                                  return firstRole ? (roleMap[firstRole] || '') : '';
                                })();
                                const dc = deptColors[primaryDept] || defaultDc;
                                return { tpl, child, progress, status, dc };
                              });
                              
                              const allDone = lineInfos.every(l => l.status === 'done');
                              const anyActive = lineInfos.some(l => l.status === 'active');
                              const stageStatus = allDone ? 'done' : anyActive ? 'active' : 'pending';
                              
                              return (
                                <div key={si}>
                                  {/* é˜¶æ®µæ ‡ç­¾ */}
                                  <div className="flex items-center gap-2 mb-2.5">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold shadow-sm ${
                                      stageStatus === 'done' ? 'bg-green-500 text-white' :
                                      stageStatus === 'active' ? 'bg-blue-500 text-white ring-4 ring-blue-100' :
                                      'bg-gray-200 text-gray-500'
                                    }`}>
                                      {stageStatus === 'done' ? 'âœ“' : si + 1}
                                    </div>
                                    <div>
                                      <span className={`text-sm font-bold ${stageStatus === 'done' ? 'text-green-600' : stageStatus === 'active' ? 'text-blue-600' : 'text-gray-400'}`}>
                                        {stageLabels[si] || `é˜¶æ®µ${si+1}`}
                                      </span>
                                      {stg.deps.length > 0 && (
                                        <span className="text-xs text-gray-400 ml-2">å‰ç½®ï¼š{stg.deps.join(' + ')}</span>
                                      )}
                                    </div>
                                  </div>
                                  
                                  {/* å­çº¿æµç¨‹èŠ‚ç‚¹ */}
                                  <div className={`ml-2 sm:ml-4 ${si < stages.length - 1 ? 'border-l-2 border-dashed border-gray-200 pb-2' : ''} pl-3 sm:pl-6`}>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2.5">
                                      {lineInfos.map((line, li) => (
                                        <div key={li} 
                                          className={`border-2 rounded-xl p-3 cursor-pointer transition-all hover:shadow-lg hover:-translate-y-0.5 ${
                                            line.status === 'done' ? 'border-green-400 bg-green-50' : 
                                            line.status === 'active' ? `${line.dc.border} ${line.dc.bg} ring-2 ${line.dc.ring}` : 
                                            'border-gray-200 bg-white'
                                          }`}
                                          onClick={() => line.child && onSelectProduct?.(line.child)}>
                                          {/* å¤´éƒ¨ï¼šåç§° + è¿›åº¦ */}
                                          <div className="flex items-center justify-between mb-2">
                                            <div className="flex items-center gap-1.5">
                                              <span className={`w-2.5 h-2.5 rounded-full ${
                                                line.status === 'done' ? 'bg-green-500' : line.status === 'active' ? line.dc.dot : 'bg-gray-300'
                                              }`} />
                                              <span className="text-sm font-bold text-gray-800">{line.tpl.name}</span>
                                            </div>
                                            <span className={`text-lg font-black ${
                                              line.progress >= 100 ? 'text-green-500' : line.progress > 0 ? 'text-blue-500' : 'text-gray-300'
                                            }`}>{line.progress}%</span>
                                          </div>
                                          {/* è¿›åº¦æ¡ */}
                                          <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden mb-2">
                                            <div className={`h-full rounded-full transition-all duration-500 ${
                                              line.status === 'done' ? 'bg-green-500' : 
                                              line.status === 'active' ? `bg-gradient-to-r ${line.dc.grad}` : 'bg-gray-200'
                                            }`} style={{width: `${line.progress}%`}} />
                                          </div>
                                          {/* åº•éƒ¨ä¿¡æ¯ */}
                                          <div className="flex items-center justify-between text-xs">
                                            <span className="text-gray-500 flex-shrink-0">
                                              {line.status === 'done' ? 'âœ… å®Œæˆ' : `â± ${line.tpl.cycleDays || '?'}å¤©`}
                                            </span>
                                            <div className="flex gap-0.5 flex-wrap justify-end ml-1">
                                              {(() => {
                                                const roles = line.tpl.participantRoles || [];
                                                if (roles.length === 0) {
                                                  const dept = line.child?.responsibleDept || 'æœªåˆ†é…';
                                                  const dc2 = deptColors[dept] || defaultDc;
                                                  return <span className={`px-1 py-0.5 rounded text-[10px] font-medium ${dc2.bg} ${dc2.text}`}>{dept}</span>;
                                                }
                                                const roleShort = { 'å‘èµ·ç»„': 'å‘èµ·', 'å¯¹åº”äº§å“ç»„': 'äº§å“', 'ä¸­æ¢éƒ¨': 'ä¸­æ¢', 'è¥é”€æ¨å¹¿éƒ¨': 'è¥é”€', 'è®¾è®¡éƒ¨': 'è®¾è®¡', 'è´¢åŠ¡éƒ¨': 'è´¢åŠ¡' };
                                                const roleDeptColors = {
                                                  'å‘èµ·ç»„': deptColors['è¿è¥ä¸­å¿ƒ'] || defaultDc,
                                                  'å¯¹åº”äº§å“ç»„': deptColors['äº§å“ä¸­å¿ƒ'] || defaultDc,
                                                  'ä¸­æ¢éƒ¨': deptColors['ä¸­æ¢éƒ¨'] || defaultDc,
                                                  'è¥é”€æ¨å¹¿éƒ¨': deptColors['è¥é”€æ¨å¹¿éƒ¨'] || defaultDc,
                                                  'è®¾è®¡éƒ¨': deptColors['è®¾è®¡éƒ¨'] || defaultDc,
                                                  'è´¢åŠ¡éƒ¨': defaultDc
                                                };
                                                return roles.map((role, ri) => {
                                                  const dc2 = roleDeptColors[role] || defaultDc;
                                                  return <span key={ri} className={`px-1 py-0.5 rounded text-[9px] font-medium ${dc2.bg} ${dc2.text}`}>{roleShort[role] || role}</span>;
                                                });
                                              })()}
                                            </div>
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                    
                                    {/* é˜¶æ®µè¿æ¥ç®­å¤´ */}
                                    {si < stages.length - 1 && (
                                      <div className="flex items-center gap-1.5 my-2 ml-2">
                                        <svg width="16" height="16" viewBox="0 0 16 16" className="text-gray-300">
                                          <path d="M8 2 L8 10 M4 7 L8 11 L12 7" stroke="currentColor" strokeWidth="2" fill="none" strokeLinecap="round" strokeLinejoin="round"/>
                                        </svg>
                                        <span className="text-xs text-gray-400 font-medium">
                                          {lineInfos.length > 1 ? `å…¨éƒ¨å®Œæˆå â†’` : 'å®Œæˆå â†’'}
                                        </span>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })()}
                    
                    </> 
                    )}
                  </>
                );
              })() : (
              <>
              {/* === å­é¡¹ç›® / æ™®é€šé¡¹ç›®è§†å›¾ï¼šæ˜¾ç¤ºæµç¨‹+ç”˜ç‰¹ === */}
              {canViewDetails ? (
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6">
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-blue-600">{autoProgress}%</div>
                  <div className="text-sm text-gray-500">æ•´ä½“è¿›åº¦</div>
                </div>
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-green-600">
                    {productTasks.filter(t => t.status === 'å·²å®Œæˆ').length}
                  </div>
                  <div className="text-sm text-gray-500">å·²å®Œæˆ</div>
                </div>
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-orange-600">
                    {productTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length}
                  </div>
                  <div className="text-sm text-gray-500">è¿›è¡Œä¸­</div>
                </div>
                <div className="bg-gray-50 rounded-xl p-4 text-center">
                  <div className="text-3xl font-bold text-gray-600">
                    {productTasks.filter(t => t.status === 'å¾…å¼€å§‹' || t.status === 'æœªå¼€å§‹').length}
                  </div>
                  <div className="text-sm text-gray-500">å¾…å¼€å§‹</div>
                </div>
              </div>
              ) : (
              <div className="mb-6">
                <div className="grid grid-cols-2 gap-4 mb-3">
                  <div className="bg-gray-50 rounded-xl p-4 text-center">
                    <div className="text-3xl font-bold text-blue-600">{autoProgress}%</div>
                    <div className="text-sm text-gray-500">æ•´ä½“è¿›åº¦</div>
                  </div>
                  <div className="bg-gray-50 rounded-xl p-4 text-center">
                    <div className="text-3xl font-bold text-gray-400">{productTasks.length}</div>
                    <div className="text-sm text-gray-500">æ€»ä»»åŠ¡æ•°</div>
                  </div>
                </div>
                <div className="bg-amber-50 border border-amber-200 rounded-lg px-4 py-2.5 flex items-center gap-2">
                  <span className="text-amber-600">ğŸ”’</span>
                  <span className="text-sm text-amber-700">ä»»åŠ¡è¯¦æƒ…ä»… <span className="font-semibold">{product.responsibleDept}</span> æˆå‘˜å¯æŸ¥çœ‹ï¼Œå½“å‰æ˜¾ç¤ºæ¦‚è§ˆä¿¡æ¯</span>
                </div>
              </div>
              )}

              {/* æ—¶é—´ç»´åº¦ç»Ÿè®¡ */}
              {canViewDetails && (() => {
                const now = new Date();
                now.setHours(0,0,0,0);
                const completedTasks = productTasks.filter(t => t.status === 'å·²å®Œæˆ');
                const onTimeTasks = completedTasks.filter(t => {
                  if (!t.dueDate) return true; // æ— æˆªæ­¢æ—¥æœŸè§†ä¸ºå‡†æ—¶
                  const due = new Date(t.dueDate); due.setHours(0,0,0,0);
                  const comp = t.completeDate ? new Date(t.completeDate) : new Date();
                  comp.setHours(0,0,0,0);
                  return comp <= due;
                });
                const onTimeRate = completedTasks.length > 0 ? Math.round((onTimeTasks.length / completedTasks.length) * 100) : '-';
                
                const overdueTasks = productTasks.filter(t => {
                  if (t.status === 'å·²å®Œæˆ') return false;
                  if (!t.dueDate) return false;
                  const due = new Date(t.dueDate); due.setHours(0,0,0,0);
                  return now > due;
                });
                
                const avgDelay = (() => {
                  const delayedTasks = completedTasks.filter(t => {
                    if (!t.dueDate || !t.completeDate) return false;
                    const due = new Date(t.dueDate); due.setHours(0,0,0,0);
                    const comp = new Date(t.completeDate); comp.setHours(0,0,0,0);
                    return comp > due;
                  });
                  if (delayedTasks.length === 0) return 0;
                  const totalDelay = delayedTasks.reduce((sum, t) => {
                    const due = new Date(t.dueDate); due.setHours(0,0,0,0);
                    const comp = new Date(t.completeDate); comp.setHours(0,0,0,0);
                    return sum + Math.ceil((comp - due) / 86400000);
                  }, 0);
                  return Math.round(totalDelay / delayedTasks.length * 10) / 10;
                })();

                const urgentTasks = productTasks.filter(t => {
                  if (t.status === 'å·²å®Œæˆ') return false;
                  if (!t.dueDate) return false;
                  const due = new Date(t.dueDate); due.setHours(0,0,0,0);
                  const diff = Math.ceil((due - now) / 86400000);
                  return diff >= 0 && diff <= 3;
                });

                return (
                  <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6">
                    <div className="bg-gray-50 rounded-xl p-4 text-center border-t-2 border-blue-400">
                      <div className={`text-3xl font-bold ${onTimeRate === '-' ? 'text-gray-400' : onTimeRate >= 80 ? 'text-green-600' : onTimeRate >= 50 ? 'text-orange-600' : 'text-red-600'}`}>
                        {onTimeRate === '-' ? '-' : `${onTimeRate}%`}
                      </div>
                      <div className="text-sm text-gray-500">â± å‡†æ—¶ç‡</div>
                      {completedTasks.length > 0 && (
                        <div className="text-xs text-gray-400 mt-1">{onTimeTasks.length}/{completedTasks.length} æŒ‰æ—¶å®Œæˆ</div>
                      )}
                    </div>
                    <div className="bg-gray-50 rounded-xl p-4 text-center border-t-2 border-red-400">
                      <div className={`text-3xl font-bold ${overdueTasks.length > 0 ? 'text-red-600' : 'text-green-600'}`}>
                        {overdueTasks.length}
                      </div>
                      <div className="text-sm text-gray-500">ğŸš¨ é€¾æœŸä»»åŠ¡</div>
                      {overdueTasks.length > 0 && (
                        <div className="text-xs text-red-400 mt-1">éœ€ç«‹å³å¤„ç†</div>
                      )}
                    </div>
                    <div className="bg-gray-50 rounded-xl p-4 text-center border-t-2 border-orange-400">
                      <div className={`text-3xl font-bold ${avgDelay > 0 ? 'text-orange-600' : 'text-green-600'}`}>
                        {avgDelay > 0 ? avgDelay : 0}
                      </div>
                      <div className="text-sm text-gray-500">å¹³å‡å»¶æœŸ(å¤©)</div>
                      {avgDelay === 0 && completedTasks.length > 0 && (
                        <div className="text-xs text-green-400 mt-1">æš‚æ— å»¶æœŸ ğŸ‘</div>
                      )}
                    </div>
                    <div className="bg-gray-50 rounded-xl p-4 text-center border-t-2 border-yellow-400">
                      <div className={`text-3xl font-bold ${urgentTasks.length > 0 ? 'text-yellow-600' : 'text-gray-400'}`}>
                        {urgentTasks.length}
                      </div>
                      <div className="text-sm text-gray-500">âš¡ å³å°†åˆ°æœŸ</div>
                      {urgentTasks.length > 0 && (
                        <div className="text-xs text-yellow-500 mt-1">3å¤©å†…æˆªæ­¢</div>
                      )}
                    </div>
                  </div>
                );
              })()}

              {/* çˆ¶é¡¹ç›®é“¾æ¥ */}
              {product.parentId && (() => {
                const parentProduct = products.find(p => p.id === product.parentId);
                return parentProduct ? (
                  <div className="mb-4 px-4 py-2.5 bg-violet-50 rounded-xl border border-violet-200 flex items-center gap-2 cursor-pointer hover:bg-violet-100 transition-colors"
                    onClick={() => onSelectProduct?.(parentProduct)}>
                    <span className="text-violet-500">ğŸ“‚</span>
                    <span className="text-sm text-violet-700">çˆ¶é¡¹ç›®:</span>
                    <span className="text-sm font-semibold text-violet-800">{parentProduct.name}</span>
                    <span className="text-xs text-violet-400 ml-auto">â† è¿”å›çˆ¶é¡¹ç›®</span>
                  </div>
                ) : null;
              })()}

              {/* å·¥æœŸæ—¶é—´çº¿ */}
              {product.parentId && (() => {
                const parentProduct = products.find(p => p.id === product.parentId);
                const parentStart = parentProduct?.startDate ? new Date(parentProduct.startDate) : null;
                const tl = calcSubProjectTimeline(product, parentStart, allNodes, templates);
                if (!parentStart || !tl.deadline || tl.totalDays === 0) return null;
                
                const now = new Date();
                const elapsed = getWorkingDaysBetween(parentStart, now);
                const timeProgress = Math.min(100, Math.round((elapsed / tl.totalDays) * 100));
                const remaining = getWorkingDaysBetween(now, tl.deadline);
                const isOverdue = now > tl.deadline;
                const isUrgent = remaining <= 3 && !isOverdue;
                
                return (
                  <div className={`mb-4 p-4 rounded-xl border ${
                    isOverdue ? 'bg-red-50 border-red-200' :
                    isUrgent ? 'bg-amber-50 border-amber-200' :
                    'bg-blue-50 border-blue-200'
                  }`}>
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2">
                        <span className="text-lg">{isOverdue ? 'ğŸ”´' : isUrgent ? 'ğŸŸ¡' : 'â±'}</span>
                        <span className={`text-sm font-semibold ${isOverdue ? 'text-red-700' : isUrgent ? 'text-amber-700' : 'text-blue-700'}`}>
                          å·¥æœŸæ—¶é—´çº¿
                        </span>
                      </div>
                      <div className={`text-sm font-bold ${isOverdue ? 'text-red-600' : isUrgent ? 'text-amber-600' : 'text-blue-600'}`}>
                        {isOverdue ? `å·²é€¾æœŸ ${getWorkingDaysBetween(tl.deadline, now)} ä¸ªå·¥ä½œæ—¥` :
                         remaining === 0 ? 'ä»Šå¤©æˆªæ­¢ï¼' :
                         `å‰©ä½™ ${remaining} ä¸ªå·¥ä½œæ—¥`}
                      </div>
                    </div>
                    <div className="flex items-center gap-3 mb-2">
                      <span className="text-[10px] text-gray-500 flex-shrink-0">{parentStart.getMonth()+1}/{parentStart.getDate()}</span>
                      <div className="flex-1 h-2 rounded-full bg-white/80 overflow-hidden relative">
                        {/* æ—¶é—´æµé€è¿›åº¦ */}
                        <div className={`h-full rounded-full absolute left-0 top-0 ${
                          isOverdue ? 'bg-red-400' : isUrgent ? 'bg-amber-400' : 'bg-blue-300'
                        }`} style={{width: `${timeProgress}%`}} />
                        {/* å·¥ä½œå®Œæˆè¿›åº¦ */}
                        <div className="h-full rounded-full bg-green-500 absolute left-0 top-0 opacity-60" style={{width: `${autoProgress}%`}} />
                      </div>
                      <span className="text-[10px] text-gray-500 flex-shrink-0">{tl.deadline.getMonth()+1}/{tl.deadline.getDate()}</span>
                    </div>
                    <div className="flex items-center justify-between text-[10px] text-gray-400">
                      <span>ğŸŸ¦ æ—¶é—´æ¶ˆè€— {timeProgress}% Â· ğŸŸ© å®Œæˆè¿›åº¦ {autoProgress}%</span>
                      <span>æ€»å·¥æœŸ {tl.totalDays} ä¸ªå·¥ä½œæ—¥</span>
                    </div>
                    {timeProgress > autoProgress + 20 && calcProjectStatus(product, tasks, allNodes, templates, products) !== 'å·²å®Œæˆ' && (
                      <div className={`mt-2 text-xs font-medium ${isOverdue ? 'text-red-600' : 'text-amber-600'}`}>
                        âš ï¸ æ—¶é—´æ¶ˆè€—è¶…å‰äºå®Œæˆè¿›åº¦ï¼Œéœ€è¦åŠ é€Ÿæ¨è¿›ï¼
                      </div>
                    )}
                  </div>
                );
              })()}

              <div className="mb-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">ğŸ“ˆ æµç¨‹è¿›åº¦</h3>
                {nodes.length === 0 ? (
                  <div className="bg-gray-50 rounded-xl p-6 text-center text-gray-400">
                    <div className="mb-2"><Icon name="clipboard" size={28} color="var(--c-text-muted)" /></div>
                    <div className="text-sm">è¯¥é¡¹ç›®æ¨¡ç‰ˆç±»å‹ã€Œ{product.templateType || product.category}ã€æš‚æ— å¯¹åº”æµç¨‹æ¨¡æ¿</div>
                    <div className="text-xs mt-1">è¯·åœ¨é£ä¹¦å¤šç»´è¡¨æ ¼ä¸­ä¸ºæ­¤ç±»å‹åˆ›å»ºæµç¨‹æ¨¡æ¿å’ŒèŠ‚ç‚¹</div>
                  </div>
                ) : (
                <>
                <div className="bg-gray-50 rounded-xl p-4 overflow-x-auto">
                  <div className="min-w-max">
                    {/* ç½‘æ ¼å¸ƒå±€ */}
                    {grid.map((row, rowIndex) => (
                      <div key={rowIndex} className="flex items-center mb-3 last:mb-0">
                        {row.map((node, colIndex) => (
                          <div key={colIndex} className="flex items-center">
                            {/* èŠ‚ç‚¹å•å…ƒæ ¼ */}
                            <div className="w-24 flex flex-col items-center">
                              {node ? (
                                <div 
                                  className={`flex flex-col items-center group relative ${canViewDetails ? 'cursor-pointer' : 'cursor-default'}`}
                                  onClick={() => canViewDetails && setSelectedNode(node)}
                                >
                                  <div className={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold transition-all group-hover:scale-110 group-hover:shadow-lg ${
                                    getNodeStatus(node.name) === 'skipped' ? 'bg-yellow-100 text-yellow-600 border-2 border-dashed border-yellow-400' :
                                    getNodeStatus(node.name) === 'completed' ? 'bg-green-500 text-white group-hover:bg-green-600' :
                                    getNodeStatus(node.name) === 'inProgress' ? 'bg-red-500 text-white ring-4 ring-red-200 group-hover:bg-red-600' :
                                    'bg-gray-200 text-gray-400 group-hover:bg-gray-300'
                                  }`}>
                                    {getNodeStatus(node.name) === 'completed' ? 'âœ“' : 
                                     getNodeStatus(node.name) === 'skipped' ? 'â­' : node.order}
                                  </div>
                                  <div className={`text-xs mt-1 text-center leading-tight group-hover:font-semibold ${
                                    getNodeStatus(node.name) === 'skipped' ? 'text-yellow-600 line-through' :
                                    getNodeStatus(node.name) === 'inProgress' ? 'text-red-600 font-semibold' :
                                    getNodeStatus(node.name) === 'completed' ? 'text-green-600' : 'text-gray-500'
                                  }`}>
                                    {node.name}
                                  </div>
                                  {/* é¢„è®¡æ—¥æœŸæ ‡æ³¨ */}
                                  {timelineMap[node.name]?.planEnd && (
                                    <div className={`text-[9px] mt-0.5 ${
                                      (() => {
                                        const pe = timelineMap[node.name].planEnd;
                                        const ns = getNodeStatus(node.name);
                                        if (ns === 'completed' || ns === 'skipped') return 'text-gray-300';
                                        const now = new Date();
                                        if (now > pe) return 'text-red-500 font-semibold';
                                        const remaining = getWorkingDaysBetween(now, pe);
                                        if (remaining <= 2) return 'text-amber-500 font-medium';
                                        return 'text-gray-400';
                                      })()
                                    }`}>
                                      {(() => {
                                        const pe = timelineMap[node.name].planEnd;
                                        return `${pe.getMonth()+1}/${pe.getDate()}`;
                                      })()}
                                      {timelineMap[node.name].workDays > 0 && (
                                        <span className="text-gray-300"> Â· {timelineMap[node.name].workDays}å¤©</span>
                                      )}
                                    </div>
                                  )}
                                  {/* ä»»åŠ¡æ•°é‡å’Œæ—¶é—´çŠ¶æ€æç¤º */}
                                  {(() => {
                                    const nTasks = productTasks.filter(t => t.stage === node.name);
                                    const nodeTaskCount = nTasks.length;
                                    const nowD = new Date(); nowD.setHours(0,0,0,0);
                                    const overdueCount = nTasks.filter(t => {
                                      if (t.status === 'å·²å®Œæˆ' || !t.dueDate) return false;
                                      const d = new Date(t.dueDate); d.setHours(0,0,0,0);
                                      return nowD > d;
                                    }).length;
                                    const urgentCount = nTasks.filter(t => {
                                      if (t.status === 'å·²å®Œæˆ' || !t.dueDate) return false;
                                      const d = new Date(t.dueDate); d.setHours(0,0,0,0);
                                      const diff = Math.ceil((d - nowD) / 86400000);
                                      return diff >= 0 && diff <= 3;
                                    }).length;
                                    return (
                                      <>
                                        {nodeTaskCount > 0 && (
                                          <div className="text-xs text-purple-500 mt-0.5 opacity-70 group-hover:opacity-100">
                                            {nodeTaskCount} ä»»åŠ¡
                                          </div>
                                        )}
                                        {overdueCount > 0 && (
                                          <div className="text-[10px] px-1.5 py-0.5 bg-red-100 text-red-600 rounded-full mt-0.5 font-medium">
                                            ğŸ”´ {overdueCount}é€¾æœŸ
                                          </div>
                                        )}
                                        {urgentCount > 0 && overdueCount === 0 && (
                                          <div className="text-[10px] px-1.5 py-0.5 bg-orange-100 text-orange-600 rounded-full mt-0.5 font-medium">
                                            ğŸŸ  {urgentCount}å³å°†åˆ°æœŸ
                                          </div>
                                        )}
                                      </>
                                    );
                                  })()}
                                  {/* è·³è¿‡æŒ‰é’® - ä»…é¡¹ç›®è´Ÿè´£äººå¯è§ */}
                                  {isProjectOwner && getNodeStatus(node.name) === 'pending' && (
                                    <button
                                      onClick={(e) => handleSkipNode(node.name, e)}
                                      className="absolute -top-1 -right-1 w-5 h-5 bg-yellow-400 text-white rounded-full text-[9px] flex items-center justify-center shadow-sm hover:bg-yellow-500 active:scale-90 transition-all"
                                      title="è·³è¿‡æ­¤èŠ‚ç‚¹"
                                    >
                                      â­
                                    </button>
                                  )}
                                  {/* å–æ¶ˆè·³è¿‡æŒ‰é’® */}
                                  {isProjectOwner && getNodeStatus(node.name) === 'skipped' && (
                                    <button
                                      onClick={(e) => handleSkipNode(node.name, e)}
                                      className="absolute -top-1 -right-1 w-5 h-5 bg-gray-400 text-white rounded-full text-[9px] flex items-center justify-center shadow-sm hover:bg-gray-500 active:scale-90 transition-all"
                                      title="å–æ¶ˆè·³è¿‡"
                                    >
                                      â†©
                                    </button>
                                  )}
                                </div>
                              ) : (
                                <div className="w-10 h-10"></div>
                              )}
                            </div>
                            {/* è¿æ¥çº¿ */}
                            {colIndex < maxCol - 1 && (
                              <div className="w-8 flex items-center justify-center">
                                {node && shouldDrawLine(rowIndex, colIndex) ? (
                                  <div className={`w-full h-0.5 ${
                                    getNodeStatus(node.name) === 'completed' ? 'bg-green-400' : 
                                    getNodeStatus(node.name) === 'inProgress' ? 'bg-red-400' : 'bg-gray-300'
                                  }`}></div>
                                ) : (
                                  <div className="w-full h-0.5 bg-transparent"></div>
                                )}
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    ))}
                  </div>
                </div>
                
                {/* å›¾ä¾‹ */}
                <div className="flex gap-4 mt-3 text-xs text-gray-500 items-center justify-between">
                  <div className="flex gap-4">
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-green-500"></span> å·²å®Œæˆ
                    </span>
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-red-500 ring-2 ring-red-200"></span> è¿›è¡Œä¸­
                    </span>
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-gray-200"></span> å¾…å¼€å§‹
                    </span>
                    <span className="flex items-center gap-1">
                      <span className="w-3 h-3 rounded-full bg-yellow-100 border border-dashed border-yellow-400"></span> å·²è·³è¿‡
                    </span>
                  </div>
                  <span className="text-purple-500">{canViewDetails 
                    ? <>ğŸ’¡ ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…{isProjectOwner && ' | ç‚¹â­è·³è¿‡èŠ‚ç‚¹'}</>
                    : 'ğŸ”’ ä»»åŠ¡è¯¦æƒ…ä»…æœ¬éƒ¨é—¨å¯è§'}</span>
                </div>
                </>
              )}
              </div>

              {canViewDetails ? (
              <div>
                <h3 className="text-lg font-semibold text-gray-800 mb-4"><Icon name="calendar" size={14} /> é¡¹ç›®ç”˜ç‰¹å›¾</h3>
                {productTasks.length > 0 ? (
                  <GanttChart tasks={productTasks} members={members} product={product} nodes={getNodesForProduct(product, allNodes, templates)} />
                ) : (
                  <div className="text-center text-gray-400 py-8 bg-gray-50 rounded-xl">
                    æš‚æ— ä»»åŠ¡æ•°æ®
                  </div>
                )}
              </div>
              ) : (
              <div className="bg-gray-50 rounded-xl p-6 text-center mb-4">
                <div className="text-gray-400 mb-2"><Icon name="lock" size={24} color="var(--c-text-muted)" /></div>
                <div className="text-sm text-gray-500">ğŸ”’ ç”˜ç‰¹å›¾å’Œä»»åŠ¡è¯¦æƒ…ä»… <span className="font-semibold text-gray-700">{product.responsibleDept}</span> æˆå‘˜å¯æŸ¥çœ‹</div>
              </div>
              )}
              </>
              )}
            </div>
          </div>

          {/* èŠ‚ç‚¹ä»»åŠ¡è¯¦æƒ…å¼¹çª— */}
          {selectedNode && canViewDetails && (() => {
            // å­çº¿å‰ç½®æ£€æŸ¥ï¼šè¯¥å­é¡¹ç›®çš„å‰ç½®å­çº¿æ˜¯å¦å…¨éƒ¨å®Œæˆ
            let pipelineBlocked = null;
            if (product.parentId && product.templateType) {
              const matchTpl = Object.values(templates).find(t => t.type === product.templateType);
              const prereqNames = matchTpl?.prerequisiteNames || [];
              if (prereqNames.length > 0) {
                const parentProduct = products.find(p => p.childIds?.includes(product.id));
                if (parentProduct) {
                  const siblingProducts = products.filter(p => parentProduct.childIds?.includes(p.id) && p.id !== product.id);
                  const unfinishedPrereqs = prereqNames.filter(preName => {
                    const preTpl = Object.values(templates).find(t => t.name === preName);
                    if (!preTpl) return false;
                    const preChild = siblingProducts.find(s => s.templateType === preTpl.type);
                    if (!preChild) return true; // å‰ç½®å­çº¿æœªåˆ›å»º
                    const preProgress = calcProjectProgress(preChild, allNodes, templates, tasks);
                    return preChild.status !== 'å·²å®Œæˆ' && preProgress < 100;
                  });
                  if (unfinishedPrereqs.length > 0) {
                    pipelineBlocked = { message: `å‰ç½®å­çº¿ã€Œ${unfinishedPrereqs.join('ã€')}ã€å°šæœªå®Œæˆ`, prereqs: unfinishedPrereqs };
                  }
                }
              }
            }
            return (
            <NodeTaskModal
              node={selectedNode}
              tasks={productTasks}
              members={members}
              product={product}
              nodeRecordId={selectedNode.id}
              nodes={nodes}
              skippedNodes={skippedNodes}
              pipelineBlocked={pipelineBlocked}
              onClose={() => setSelectedNode(null)}
              onTaskCreated={onRefresh}
            />
            );
          })()}
        </div>
      );
    };

    // OKR è§†å›¾ç»„ä»¶ - å±•ç¤ºç›®æ ‡ â†’ å…³é”®ç»“æœ â†’ é¡¹ç›®çš„å±‚çº§å…³ç³»
    const OKROverview = ({ objectives, keyResults, products, tasks = [], nodes = [], templates = {}, members = [], onRefresh }) => {
      const [expandedObjectives, setExpandedObjectives] = useState(new Set());
      const [expandedKRs, setExpandedKRs] = useState(new Set());
      const [showAddObjective, setShowAddObjective] = useState(false);
      const [showAddKR, setShowAddKR] = useState(null); // objectiveId
      const [editingObjective, setEditingObjective] = useState(null);
      const [editingKR, setEditingKR] = useState(null);
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [showAddProject, setShowAddProject] = useState(null); // krId
      const [filterCycle, setFilterCycle] = useState('all');
      const [filterObjStatus, setFilterObjStatus] = useState('all');
      const showToast = useToast();
      const currentUser = useContext(UserContext);
      
      // è¡¨å•æ•°æ®
      const [objectiveForm, setObjectiveForm] = useState({
        name: '', cycle: '2026-Q1', level: 'å…¬å¸çº§', department: '', group: '', status: 'è¿›è¡Œä¸­', owner: '',
        // æ¨¡æ¿åŒ–å‘½åå­—æ®µ
        productCode: '', actionGoal: ''
      });
      const [krForm, setKRForm] = useState({
        name: '', target: 5, current: 0, weight: 1, status: 'æœªå¼€å§‹', objectiveId: '', owner: '',
        // æ¨¡æ¿åŒ–å‘½åå­—æ®µ
        productCode: '', metric: '', operator: 'â‰¥',
        krType: 'project_count' // project_count | metric_value
      });
      const [projectForm, setProjectForm] = useState({
        name: '', templateType: '', targetDate: '', owner: '', priority: '',
        productCode: '', initiatorGroup: ''
      });

      // åˆ›å»ºæ–°é¡¹ç›®ï¼šé€‰æ‹©çˆ¶æ¨¡æ¿åè‡ªåŠ¨åˆ›å»ºçˆ¶+å­é¡¹ç›®
      const handleCreateProject = async (krId) => {
        const missingFields = [];
        if (!projectForm.name.trim()) missingFields.push('é¡¹ç›®åç§°');
        if (!projectForm.templateType) missingFields.push('é¡¹ç›®ç±»å‹');
        if (!projectForm.owner) missingFields.push('è´Ÿè´£äºº');
        if (!projectForm.priority) missingFields.push('é‡è¦ç¨‹åº¦');
        if (!projectForm.targetDate) missingFields.push('è®¡åˆ’ä¸Šçº¿æ—¥æœŸ');
        if (!projectForm.initiatorGroup) missingFields.push('å‘èµ·ç»„');
        if (missingFields.length > 0) {
          showToast?.(`è¯·å¡«å†™: ${missingFields.join('ã€')}`, 'error');
          return;
        }
        setIsSubmitting(true);
        try {
          // æ‰¾åˆ°é€‰ä¸­çš„çˆ¶æ¨¡æ¿
          const parentTplId = Object.keys(templates).find(id => templates[id].type === projectForm.templateType && templates[id].ownership === 'çˆ¶é¡¹ç›®');
          const parentTplName = parentTplId ? templates[parentTplId].name : '';
          
          // æ‰¾åˆ°å…³è”çš„å­æ¨¡æ¿
          const childTpls = Object.entries(templates).filter(([id, t]) => 
            t.ownership === 'å­é¡¹ç›®' && t.parentTemplate === parentTplName
          );

          // 1. åˆ›å»ºçˆ¶é¡¹ç›®
          const parentFields = {
            'é¡¹ç›®åç§°': projectForm.name,
            'é¡¹ç›®ç±»å‹': 'çˆ¶é¡¹ç›®',
            'æ¨¡ç‰ˆç±»å‹': projectForm.templateType,
            'é¡¹ç›®çŠ¶æ€': 'æœªå¼€å§‹',
            'å…³è”KR': [krId],
            'é‡è¦ç¨‹åº¦': projectForm.priority,
            'è®¡åˆ’ä¸Šçº¿æ—¥æœŸ': new Date(projectForm.targetDate).getTime(),
            'å¼€å§‹æ—¥æœŸ': new Date().getTime(),
            'é¡¹ç›®è´Ÿè´£äºº': [{ id: projectForm.owner }],
            ...(projectForm.initiatorGroup ? { 'å‘èµ·ç»„': projectForm.initiatorGroup } : {})
          };
          
          const parentRes = await fetch(API_BASE + '/api/create-record', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ app_token: APP_TOKEN, table_id: 'tblYM02NyVj3rUkR', fields: parentFields })
          });
          const parentResult = await parentRes.json();
          if (!parentResult.success) throw new Error(parentResult.error || 'çˆ¶é¡¹ç›®åˆ›å»ºå¤±è´¥');
          
          const parentRecordId = parentResult.data?.record?.record_id;
          showToast?.(`çˆ¶é¡¹ç›®å·²åˆ›å»ºï¼Œæ­£åœ¨ç”Ÿæˆ ${childTpls.length} ä¸ªå­é¡¹ç›®...`, 'info');

          // 2. æ‰¹é‡åˆ›å»ºå­é¡¹ç›®
          // å­æ¨¡æ¿ â†’ è´Ÿè´£éƒ¨é—¨æ˜ å°„
          const deptMap = {
            'äº§å“ç«‹é¡¹çº¿': 'äº§å“ä¸­å¿ƒ', 'äº§å“å¼€å‘çº¿': 'äº§å“ä¸­å¿ƒ', 'è¿è¥è®¡åˆ’çº¿': 'è¿è¥ä¸­å¿ƒ', 'ä¸­æ¢åä½œçº¿': 'ä¸­æ¢éƒ¨',
            'è¿è¥è½åœ°çº¿': 'è¿è¥ä¸­å¿ƒ', 'è®¾è®¡éœ€æ±‚çº¿': 'è®¾è®¡éƒ¨', 'ç«™å¤–æ¨å¹¿çº¿': 'è¥é”€æ¨å¹¿éƒ¨'
          };
          
          // ä»æ¨¡æ¿æ•°æ®åŠ¨æ€æ„å»ºä¾èµ–å›¾è®¡ç®—æ¯æ¡å­çº¿çš„å¼€å§‹æ—¥æœŸ
          const parentStartDate = new Date();
          const tplByName = {};
          const tplById = {};
          for (const [tplId, tpl] of childTpls) { tplByName[tpl.name] = tpl; tplById[tplId] = tpl; }
          
          // æ„å»º name â†’ prerequisite names
          const prereqMap = {};
          for (const [tplId, tpl] of childTpls) {
            prereqMap[tpl.name] = tpl.prerequisiteNames || [];
          }
          
          // æ‹“æ‰‘æ’åºåˆ†å±‚
          const getDepth = (name, visited = new Set()) => {
            if (visited.has(name)) return 0;
            visited.add(name);
            const deps = prereqMap[name] || [];
            if (deps.length === 0) return 0;
            return 1 + Math.max(...deps.map(d => getDepth(d, new Set(visited))));
          };
          
          const lineDepths = {};
          for (const [tplId, tpl] of childTpls) { lineDepths[tpl.name] = getDepth(tpl.name); }
          const maxDepth = Math.max(...Object.values(lineDepths), 0);
          
          // æŒ‰å±‚è®¡ç®—å¼€å§‹æ—¥æœŸ
          const lineStartDates = {};
          let cumulativeDays = 0;
          for (let d = 0; d <= maxDepth; d++) {
            const linesAtDepth = childTpls.filter(([_, t]) => lineDepths[t.name] === d);
            const stageStart = addWorkingDays(new Date(parentStartDate), cumulativeDays);
            for (const [_, tpl] of linesAtDepth) {
              lineStartDates[tpl.name] = new Date(stageStart);
            }
            const maxCycle = Math.max(...linesAtDepth.map(([_, t]) => t.cycleDays || 0), 0);
            cumulativeDays += maxCycle;
          }
          
          let created = 0;
          for (const [tplId, tpl] of childTpls) {
            const childName = `${projectForm.productCode || projectForm.name.replace(/æ–°å“ä¸Šçº¿|é¡¹ç›®/g, '')}-${tpl.name}`;
            const dept = deptMap[tpl.name] || '';
            const cycleDays = tpl.cycleDays || 0;
            const childStart = lineStartDates[tpl.name] || parentStartDate;
            let childEndDate = null;
            if (cycleDays > 0) {
              childEndDate = addWorkingDays(new Date(childStart), cycleDays);
            }
            const childFields = {
              'é¡¹ç›®åç§°': childName,
              'é¡¹ç›®ç±»å‹': 'å­é¡¹ç›®',
              'æ¨¡ç‰ˆç±»å‹': tpl.type,
              'é¡¹ç›®çŠ¶æ€': 'æœªå¼€å§‹',
              'è´Ÿè´£éƒ¨é—¨': dept,
              'å¼€å§‹æ—¥æœŸ': childStart.getTime(),
              ...(childEndDate ? { 'è®¡åˆ’ä¸Šçº¿æ—¥æœŸ': childEndDate.getTime() } : {}),
              ...(parentRecordId ? { 'çˆ¶é¡¹ç›®': [parentRecordId] } : {})
            };
            
            try {
              const childRes = await fetch(API_BASE + '/api/create-record', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ app_token: APP_TOKEN, table_id: 'tblYM02NyVj3rUkR', fields: childFields })
              });
              const childResult = await childRes.json();
              if (childResult.success) created++;
            } catch (e) {
              console.error(`å­é¡¹ç›® ${tpl.name} åˆ›å»ºå¤±è´¥:`, e);
            }
          }

          showToast?.(`âœ… é¡¹ç›®åˆ›å»ºå®Œæˆ: 1ä¸ªçˆ¶é¡¹ç›® + ${created}ä¸ªå­é¡¹ç›®`, 'success');
          
          setShowAddProject(null);
          setProjectForm({ name: '', templateType: '', targetDate: '', owner: '', priority: '', productCode: '', initiatorGroup: '' });
          if (onRefresh) onRefresh();
        } catch (err) {
          showToast?.('åˆ›å»ºå¤±è´¥: ' + err.message, 'error');
        }
        setIsSubmitting(false);
      };

      // åˆ‡æ¢ç›®æ ‡å±•å¼€çŠ¶æ€
      const toggleObjective = (id) => {
        setExpandedObjectives(prev => {
          const next = new Set(prev);
          if (next.has(id)) next.delete(id);
          else next.add(id);
          return next;
        });
      };

      // åˆ‡æ¢ KR å±•å¼€çŠ¶æ€
      const toggleKR = (id) => {
        setExpandedKRs(prev => {
          const next = new Set(prev);
          if (next.has(id)) next.delete(id);
          else next.add(id);
          return next;
        });
      };

      // è·å–æŸç›®æ ‡ä¸‹çš„å…³é”®ç»“æœ
      const getKRsForObjective = (objectiveId) => {
        return keyResults.filter(kr => kr.objectiveId === objectiveId);
      };

      // è·å–æŸ KR ä¸‹çš„é¡¹ç›®
      const getProjectsForKR = (krId) => {
        return products.filter(p => p.krId === krId);
      };

      // è®¡ç®— KR çš„è‡ªåŠ¨è¿›åº¦å’ŒçŠ¶æ€ï¼ˆåŸºäºå…³è”é¡¹ç›®å®Œæˆæƒ…å†µï¼‰
      const getKRAutoProgress = (kr) => {
        const relatedProjects = getProjectsForKR(kr.id);
        
        // å·¥æœŸæŒ‡æ ‡å‹ï¼šå–å…³è”é¡¹ç›®çš„å®é™…å·¥æœŸ
        if (kr.krType === 'metric_duration' && relatedProjects.length > 0) {
          const allDone = relatedProjects.every(p => calcProjectStatus(p, tasks, nodes, templates, products) === 'å·²å®Œæˆ');
          const anyStarted = relatedProjects.some(p => {
            const pStatus = calcProjectStatus(p, tasks, nodes, templates, products);
            if (pStatus === 'è¿›è¡Œä¸­' || pStatus === 'å·²å®Œæˆ') return true;
            const pt = tasks.filter(t => t.productId === p.id);
            return pt.some(t => t.status === 'è¿›è¡Œä¸­' || t.status === 'å·²å®Œæˆ');
          });
          const completedCount = relatedProjects.filter(p => calcProjectStatus(p, tasks, nodes, templates, products) === 'å·²å®Œæˆ').length;
          const inProgressCount = relatedProjects.filter(p => calcProjectStatus(p, tasks, nodes, templates, products) === 'è¿›è¡Œä¸­').length;
          
          // è®¡ç®—å…³è”é¡¹ç›®çš„å®é™…å·¥æœŸï¼ˆå·¥ä½œæ—¥ï¼‰
          const durations = relatedProjects.map(p => {
            const pStatus = calcProjectStatus(p, tasks, nodes, templates, products);
            if (pStatus === 'å·²å®Œæˆ' && p.startDate) {
              const completedTasks = tasks.filter(t => t.productId === p.id && t.status === 'å·²å®Œæˆ' && t.completeDate);
              const lastComplete = completedTasks.length > 0 
                ? new Date(Math.max(...completedTasks.map(t => new Date(t.completeDate).getTime())))
                : new Date();
              return getWorkingDaysBetween(new Date(p.startDate), lastComplete);
            } else if (p.startDate) {
              return getWorkingDaysBetween(new Date(p.startDate), new Date());
            }
            return 0;
          }).filter(d => d > 0);
          
          const avgDuration = durations.length > 0 ? Math.round(durations.reduce((s, d) => s + d, 0) / durations.length) : 0;
          
          // å·¥æœŸå‹è¿›åº¦ï¼šåªæœ‰é¡¹ç›®å…¨éƒ¨å®Œæˆåæ‰ç”¨å·¥æœŸåˆ¤æ–­è¾¾æ ‡
          // é¡¹ç›®æœªå®Œæˆæ—¶ï¼Œç”¨é¡¹ç›®å¹³å‡è¿›åº¦ä½œä¸ºKRè¿›åº¦
          let progress = 0;
          if (allDone) {
            // å…¨éƒ¨å®Œæˆï¼šç”¨å®é™…å·¥æœŸ vs ç›®æ ‡åˆ¤æ–­
            if (kr.operator === 'â‰¤' && kr.target > 0) {
              progress = avgDuration <= kr.target ? 100 : Math.max(0, Math.round((1 - (avgDuration - kr.target) / kr.target) * 100));
            } else {
              progress = kr.target > 0 ? Math.min(100, Math.round((avgDuration / kr.target) * 100)) : 0;
            }
          } else {
            // æœªå®Œæˆï¼šç”¨é¡¹ç›®å¹³å‡è¿›åº¦
            const projectProgresses = relatedProjects.map(p => calcProjectProgress(p, nodes, templates, tasks, products));
            progress = projectProgresses.length > 0 
              ? Math.round(projectProgresses.reduce((sum, p) => sum + p, 0) / projectProgresses.length)
              : 0;
          }
          
          return {
            current: avgDuration,
            progress: progress,
            autoCalculated: true,
            totalProjects: relatedProjects.length,
            completedProjects: completedCount,
            inProgressProjects: inProgressCount,
            autoStatus: allDone ? 'å·²å®Œæˆ' : anyStarted ? 'è¿›è¡Œä¸­' : 'æœªå¼€å§‹'
          };
        }
        
        // æ•°å€¼æŒ‡æ ‡å‹ï¼ˆ%ã€ä¸‡å…ƒç­‰ï¼‰ï¼šä½¿ç”¨æ‰‹åŠ¨å¡«å†™çš„å½“å‰å€¼ï¼Œæ”¯æŒè¿ç®—ç¬¦æ–¹å‘
        if (kr.krType === 'metric_value') {
          let progress = 0;
          if (kr.operator === 'â‰¤' && kr.target > 0) {
            progress = kr.current <= kr.target ? 100 : Math.max(0, Math.round((1 - (kr.current - kr.target) / kr.target) * 100));
          } else {
            progress = kr.target > 0 ? Math.min(100, Math.round((kr.current / kr.target) * 100)) : 0;
          }
          return {
            current: kr.current,
            progress: progress,
            autoCalculated: false,
            totalProjects: relatedProjects.length,
            completedProjects: 0,
            inProgressProjects: 0,
            autoStatus: progress >= 100 ? 'å·²å®Œæˆ' : kr.current > 0 ? 'è¿›è¡Œä¸­' : kr.status || 'æœªå¼€å§‹'
          };
        }
        
        // é¡¹ç›®è®¡æ•°å‹ï¼ˆé»˜è®¤ï¼‰ï¼šå½“å‰å€¼ = åŸºäºé¡¹ç›®è¿›åº¦çš„ç­‰æ•ˆå€¼
        if (relatedProjects.length > 0) {
          const projectProgresses = relatedProjects.map(p => {
            const autoProgress = calcProjectProgress(p, nodes, templates, tasks, products);
            const pAutoStatus = calcProjectStatus(p, tasks, nodes, templates, products);
            const pTasks = p.childIds?.length > 0 
              ? tasks.filter(t => products.filter(cp => p.childIds.includes(cp.id)).some(cp => cp.id === t.productId))
              : tasks.filter(t => t.productId === p.id);
            const hasProgress = pTasks.some(t => t.status === 'è¿›è¡Œä¸­' || t.status === 'å·²å®Œæˆ');
            return { ...p, autoProgress, hasProgress, autoStatus: pAutoStatus };
          });

          const completedCount = projectProgresses.filter(p => 
            p.autoProgress >= 100 || p.autoStatus === 'å·²å®Œæˆ'
          ).length;
          const hasAnyProgress = projectProgresses.some(p => p.hasProgress || p.autoProgress > 0 || p.autoStatus === 'è¿›è¡Œä¸­');
          const inProgressCount = projectProgresses.filter(p => (p.hasProgress || p.autoProgress > 0 || p.autoStatus === 'è¿›è¡Œä¸­') && p.autoProgress < 100 && p.autoStatus !== 'å·²å®Œæˆ').length;
          
          const avgProgress = projectProgresses.length > 0 
            ? Math.round(projectProgresses.reduce((sum, p) => sum + p.autoProgress, 0) / projectProgresses.length)
            : 0;
          
          const equivCurrent = kr.target > 0 
            ? Math.round((avgProgress / 100) * kr.target * 10) / 10
            : completedCount;
          
          let autoStatus = 'æœªå¼€å§‹';
          if (completedCount >= kr.target || completedCount >= relatedProjects.length) {
            autoStatus = 'å·²å®Œæˆ';
          } else if (hasAnyProgress || completedCount > 0) {
            autoStatus = 'è¿›è¡Œä¸­';
          }
          
          return {
            current: equivCurrent,
            progress: avgProgress,
            autoCalculated: true,
            totalProjects: relatedProjects.length,
            completedProjects: completedCount,
            inProgressProjects: inProgressCount,
            autoStatus: autoStatus
          };
        } else {
          const progress = kr.target > 0 ? Math.min(100, Math.round((kr.current / kr.target) * 100)) : 0;
          return {
            current: kr.current,
            progress: progress,
            autoCalculated: false,
            totalProjects: 0,
            completedProjects: 0,
            inProgressProjects: 0,
            autoStatus: kr.status
          };
        }
      };

      // è®¡ç®—ç›®æ ‡è¿›åº¦å’ŒçŠ¶æ€ï¼ˆåŸºäº KR è¿›åº¦åŠ æƒå¹³å‡ï¼‰
      const calculateObjectiveProgressAndStatus = (objectiveId) => {
        const krs = getKRsForObjective(objectiveId);
        if (krs.length === 0) {
          return { progress: 0, autoStatus: 'æœªå¼€å§‹' };
        }
        
        const totalWeight = krs.reduce((sum, kr) => sum + (kr.weight || 1), 0);
        let allCompleted = true;
        let hasInProgress = false;
        
        const weightedProgress = krs.reduce((sum, kr) => {
          const krAuto = getKRAutoProgress(kr);
          
          // æ£€æŸ¥ KR çŠ¶æ€
          if (krAuto.autoStatus === 'å·²å®Œæˆ') {
            // å·²å®Œæˆ
          } else if (krAuto.autoStatus === 'è¿›è¡Œä¸­') {
            allCompleted = false;
            hasInProgress = true;
          } else {
            allCompleted = false;
          }
          
          return sum + krAuto.progress * (kr.weight || 1);
        }, 0);
        
        const progress = Math.round(weightedProgress / totalWeight);
        
        // è‡ªåŠ¨è®¡ç®—ç›®æ ‡çŠ¶æ€
        let autoStatus = 'æœªå¼€å§‹';
        if (allCompleted && krs.length > 0) {
          autoStatus = 'å·²å®Œæˆ';
        } else if (hasInProgress) {
          autoStatus = 'è¿›è¡Œä¸­';
        }
        
        return { progress, autoStatus };
      };

      // åˆ›å»ºç›®æ ‡
      const handleCreateObjective = async (e) => {
        e.preventDefault();
        if (!objectiveForm.name.trim()) return alert('è¯·è¾“å…¥ç›®æ ‡åç§°');
        if (!objectiveForm.cycle) return alert('è¯·é€‰æ‹©ç›®æ ‡å‘¨æœŸ');
        if (!objectiveForm.level) return alert('è¯·é€‰æ‹©ç›®æ ‡å±‚çº§');
        if (objectiveForm.level === 'éƒ¨é—¨çº§' && !objectiveForm.department) return alert('éƒ¨é—¨çº§ç›®æ ‡è¯·é€‰æ‹©æ‰€å±éƒ¨é—¨');
        if (!objectiveForm.owner) return alert('è¯·é€‰æ‹©è´Ÿè´£äºº');
        
        setIsSubmitting(true);
        try {
          const submitForm = { ...objectiveForm };
          if (submitForm.group) submitForm.department = submitForm.group; // å­˜ç»„åˆ«åˆ°æ‰€å±éƒ¨é—¨
          const res = await fetch(API_BASE + '/api/create-objective', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tbl9TX3RZdLRlEy0',
              objective: submitForm
            })
          });
          const result = await res.json();
          if (result.success) {
            showToast?.('ç›®æ ‡åˆ›å»ºæˆåŠŸ', 'success');
            setShowAddObjective(false);
            setObjectiveForm({ name: '', cycle: '2026-Q1', level: 'å…¬å¸çº§', department: '', group: '', status: 'è¿›è¡Œä¸­', owner: '', productCode: '', actionGoal: '', quantifier: '' });
            onRefresh();
          } else {
            throw new Error(result.error);
          }
        } catch (err) {
          showToast?.('åˆ›å»ºå¤±è´¥: ' + err.message, 'error');
        }
        setIsSubmitting(false);
      };

      // æ›´æ–°ç›®æ ‡
      const handleUpdateObjective = async (e) => {
        e.preventDefault();
        if (objectiveForm.level === 'éƒ¨é—¨çº§' && !objectiveForm.department) {
          showToast?.('éƒ¨é—¨çº§ç›®æ ‡è¯·é€‰æ‹©æ‰€å±éƒ¨é—¨', 'error');
          return;
        }
        setIsSubmitting(true);
        try {
          const res = await fetch(API_BASE + '/api/update-objective', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tbl9TX3RZdLRlEy0',
              record_id: editingObjective.id,
              objective: objectiveForm
            })
          });
          const result = await res.json();
          if (result.success) {
            alert('âœ… ç›®æ ‡æ›´æ–°æˆåŠŸï¼');
            setEditingObjective(null);
            onRefresh();
          } else {
            throw new Error(result.error);
          }
        } catch (err) {
          alert('âŒ æ›´æ–°å¤±è´¥: ' + err.message);
        }
        setIsSubmitting(false);
      };

      // åˆ›å»ºå…³é”®ç»“æœ
      const handleCreateKR = async (e) => {
        e.preventDefault();
        // æ‰€æœ‰å­—æ®µå¿…å¡«æ ¡éªŒ
        const missingFields = [];
        if (!krForm.name.trim()) missingFields.push('KRæè¿°');
        if (!krForm.target && krForm.target !== 0) missingFields.push('ç›®æ ‡å€¼');
        if (!krForm.weight && krForm.weight !== 0) missingFields.push('æƒé‡');
        if (!krForm.owner) missingFields.push('è´Ÿè´£äºº');
        if (missingFields.length > 0) {
          showToast?.(`è¯·å¡«å†™: ${missingFields.join('ã€')}`, 'error');
          return;
        }
        // æƒé‡ä¸Šé™æ ¡éªŒï¼šåŒç›®æ ‡ä¸‹æ‰€æœ‰ KR æƒé‡ä¹‹å’Œ â‰¤ 100
        const existingKRs = keyResults.filter(kr => kr.objectiveId === showAddKR);
        const usedWeight = existingKRs.reduce((sum, kr) => sum + (kr.weight || 0), 0);
        const remaining = 100 - usedWeight;
        if (krForm.weight > remaining) {
          showToast?.(`æƒé‡è¶…å‡ºä¸Šé™ï¼è¯¥ç›®æ ‡å·²ç”¨æƒé‡ ${usedWeight}ï¼Œå‰©ä½™å¯åˆ†é… ${remaining}`, 'error');
          return;
        }
        
        setIsSubmitting(true);
        try {
          // ç›´æ¥ä½¿ç”¨ create-record APIï¼Œç¡®ä¿æ‰€æœ‰å­—æ®µæ­£ç¡®æ˜ å°„
          const krFields = {
            'KRæè¿°': krForm.name,
            'ç›®æ ‡å€¼': krForm.target,
            'å½“å‰å€¼': krForm.current || 0,
            'æƒé‡': krForm.weight,
            'çŠ¶æ€': krForm.status || 'æœªå¼€å§‹',
            'æ‰€å±ç›®æ ‡': [showAddKR],
            'è´Ÿè´£äºº': [{ id: krForm.owner }],
            'å•ä½': krForm.unit || 'ä¸ª'
          };
          
          const res = await fetch(API_BASE + '/api/create-record', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblW7yKqbgxH0bZV',
              fields: krFields
            })
          });
          const result = await res.json();
          if (result.success) {
            showToast?.('å…³é”®ç»“æœåˆ›å»ºæˆåŠŸ', 'success');
            setShowAddKR(null);
            setKRForm({ name: '', target: 5, current: 0, weight: 1, status: 'æœªå¼€å§‹', objectiveId: '', owner: '', productCode: '', metric: '', operator: 'â‰¥', krType: 'project_count', unit: 'ä¸ª' });
            onRefresh();
          } else {
            throw new Error(result.error);
          }
        } catch (err) {
          showToast?.('åˆ›å»ºå¤±è´¥: ' + err.message, 'error');
        }
        setIsSubmitting(false);
      };

      // æ›´æ–°å…³é”®ç»“æœ
      const handleUpdateKR = async (e) => {
        e.preventDefault();
        // æƒé‡ä¸Šé™æ ¡éªŒï¼šåŒç›®æ ‡ä¸‹å…¶ä»– KR æƒé‡ä¹‹å’Œ + æ–°æƒé‡ â‰¤ 100
        if (editingKR) {
          const siblingKRs = keyResults.filter(kr => kr.objectiveId === editingKR.objectiveId && kr.id !== editingKR.id);
          const usedWeight = siblingKRs.reduce((sum, kr) => sum + (kr.weight || 0), 0);
          const remaining = 100 - usedWeight;
          if (krForm.weight > remaining) {
            showToast?.(`æƒé‡è¶…å‡ºä¸Šé™ï¼å…¶ä»– KR å·²ç”¨æƒé‡ ${usedWeight}ï¼Œå‰©ä½™å¯åˆ†é… ${remaining}`, 'error');
            return;
          }
        }
        setIsSubmitting(true);
        try {
          const krFields = {
            'KRæè¿°': krForm.name,
            'ç›®æ ‡å€¼': krForm.target,
            'å½“å‰å€¼': krForm.current || 0,
            'æƒé‡': krForm.weight,
            'çŠ¶æ€': krForm.status || 'æœªå¼€å§‹',
            ...(krForm.owner ? { 'è´Ÿè´£äºº': [{ id: krForm.owner }] } : {}),
            'å•ä½': krForm.unit || 'ä¸ª'
          };
          
          const res = await fetch(API_BASE + '/api/update-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblW7yKqbgxH0bZV',
              record_id: editingKR.id,
              fields: krFields
            })
          });
          const result = await res.json();
          if (result.success) {
            alert('âœ… å…³é”®ç»“æœæ›´æ–°æˆåŠŸï¼');
            setEditingKR(null);
            onRefresh();
          } else {
            throw new Error(result.error);
          }
        } catch (err) {
          alert('âŒ æ›´æ–°å¤±è´¥: ' + err.message);
        }
        setIsSubmitting(false);
      };

      // å¼€å§‹ç¼–è¾‘ç›®æ ‡
      const startEditObjective = (obj) => {
        if (!currentUser || (currentUser.open_id !== obj.ownerId && currentUser.name !== obj.ownerName)) {
          showToast?.('åªæœ‰ç›®æ ‡è´Ÿè´£äººæ‰èƒ½ä¿®æ”¹', 'error');
          return;
        }
        setEditingObjective(obj);
        setObjectiveForm({
          name: obj.name,
          cycle: obj.cycle || '2026-Q1',
          level: obj.level || 'å…¬å¸çº§',
          department: obj.department || '',
          status: obj.status || 'è¿›è¡Œä¸­'
        });
      };

      // å¼€å§‹ç¼–è¾‘ KRï¼ˆä»…ç›®æ ‡è´Ÿè´£äººå¯ç¼–è¾‘ï¼‰
      const startEditKR = (kr) => {
        const obj = objectives.find(o => o.id === kr.objectiveId);
        if (obj && currentUser.open_id !== obj.ownerId && currentUser.name !== obj.ownerName) {
          showToast?.('ä»…ç›®æ ‡è´Ÿè´£äººå¯ç¼–è¾‘ KR', 'error');
          return;
        }
        setEditingKR(kr);
        setKRForm({
          name: kr.name,
          target: kr.target || 100,
          current: kr.current || 0,
          weight: kr.weight || 1,
          status: kr.status || 'æœªå¼€å§‹',
          productCode: '', metric: '', operator: kr.operator || 'â‰¥',
          krType: kr.krType || 'project_count',
          unit: kr.unit || 'ä¸ª'
        });
      };

      // è¿›åº¦é¢œè‰²
      const getProgressColor = (progress) => {
        if (progress >= 80) return 'bg-green-500';
        if (progress >= 50) return 'bg-blue-500';
        if (progress >= 20) return 'bg-yellow-500';
        return 'bg-gray-300';
      };

      // çŠ¶æ€é¢œè‰²
      const getStatusColor = (status) => {
        switch (status) {
          case 'å·²å®Œæˆ': return 'bg-green-100 text-green-700';
          case 'è¿›è¡Œä¸­': return 'bg-blue-100 text-blue-700';
          case 'æœ‰é£é™©': return 'bg-red-100 text-red-700';
          default: return 'bg-gray-100 text-gray-600';
        }
      };

      return (
        <div className="space-y-4">
          {/* é¡¶éƒ¨æ“ä½œæ  */}
          <div className="card-flat flex items-center justify-between px-3 sm:px-5 py-2.5 sm:py-3 mb-1 flex-wrap gap-2">
            <div className="flex items-center gap-2 sm:gap-3 flex-wrap">
              <span className="section-header">OKR ç›®æ ‡ç®¡ç†</span>
              <select value={filterCycle} onChange={e => setFilterCycle(e.target.value)}
                className="px-2 py-1 rounded-lg text-[11px] sm:text-xs outline-none" style={{background:'var(--c-bg)', border:'1px solid var(--c-border)'}}>
                <option value="all">å…¨éƒ¨å‘¨æœŸ</option>
                {[...new Set(objectives.map(o => o.cycle).filter(Boolean))].sort().map(c => (
                  <option key={c} value={c}>{c}</option>
                ))}
              </select>
              <select value={filterObjStatus} onChange={e => setFilterObjStatus(e.target.value)}
                className="px-2 py-1 rounded-lg text-[11px] sm:text-xs outline-none" style={{background:'var(--c-bg)', border:'1px solid var(--c-border)'}}>
                <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                <option value="è¿›è¡Œä¸­">è¿›è¡Œä¸­</option>
                <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
                <option value="æœªå¼€å§‹">æœªå¼€å§‹</option>
              </select>
            </div>
            <button
              onClick={() => setShowAddObjective(true)}
              className="tab-btn active text-xs"
            >
              <Icon name="plus" size={12} /> æ–°å»ºç›®æ ‡
            </button>
          </div>

          {/* æ–°å»ºç›®æ ‡è¡¨å• */}
          {showAddObjective && (
            <div className="card-flat p-5" style={{background:'var(--c-accent-bg)'}}>
              <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold text-sm" style={{color:'var(--c-accent)'}}><Icon name="plus" size={14} /> æ–°å»ºç›®æ ‡</h3>
                <button onClick={() => setShowAddObjective(false)} className="text-gray-400 hover:text-gray-600">âœ•</button>
              </div>
              <form onSubmit={handleCreateObjective} className="space-y-4">
                <div>
                  <label className="block text-sm text-gray-600 mb-1">ç›®æ ‡å‘½å *</label>
                  <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2">
                    <input
                      type="text"
                      value={objectiveForm.productCode}
                      onChange={e => {
                        const pc = e.target.value;
                        const dept = objectiveForm.group || objectiveForm.department;
                        const parts = [objectiveForm.cycle?.replace('-', ''), dept, pc, objectiveForm.actionGoal].filter(Boolean);
                        setObjectiveForm({ ...objectiveForm, productCode: pc, name: parts.join(' ') });
                      }}
                      className="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 outline-none"
                      placeholder="ä¸»é¢˜ å¦‚ HG04/é£æ§ä½“ç³»"
                    />
                    <input
                      type="text"
                      value={objectiveForm.actionGoal}
                      onChange={e => {
                        const ag = e.target.value;
                        const dept = objectiveForm.group || objectiveForm.department;
                        const parts = [objectiveForm.cycle?.replace('-', ''), dept, objectiveForm.productCode, ag].filter(Boolean);
                        setObjectiveForm({ ...objectiveForm, actionGoal: ag, name: parts.join(' ') });
                      }}
                      className="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 outline-none"
                      placeholder="ç›®æ ‡ å¦‚ ä¸Šçº¿å¼€å”®"
                      required
                    />
                    <input
                      type="text"
                      value={objectiveForm.quantifier || ''}
                      onChange={e => {
                        const q = e.target.value;
                        const dept = objectiveForm.group || objectiveForm.department;
                        const parts = [objectiveForm.cycle?.replace('-', ''), dept, objectiveForm.productCode, objectiveForm.actionGoal, q].filter(Boolean);
                        setObjectiveForm({ ...objectiveForm, quantifier: q, name: parts.join(' ') });
                      }}
                      className="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 outline-none"
                      placeholder="é‡åŒ– å¦‚ 7ä¸ª/10K+"
                    />
                  </div>
                  {/* é¢„è§ˆ + å¯ç¼–è¾‘ */}
                  <div className="relative">
                    <input
                      type="text"
                      value={objectiveForm.name}
                      onChange={e => setObjectiveForm({ ...objectiveForm, name: e.target.value })}
                      className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-purple-300 outline-none bg-purple-50 font-medium"
                      placeholder="è‡ªåŠ¨ç”Ÿæˆçš„ç›®æ ‡åç§°ï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰"
                      required
                    />
                    <span className="absolute right-3 top-2.5 text-[10px] text-purple-400">âœ¨ è‡ªåŠ¨æ‹¼æ¥</span>
                  </div>
                  <div className="text-[10px] text-gray-400 mt-1">ç¤ºä¾‹: 2026Q2 æ¸¸æˆç»„ HG04 ä¸Šçº¿å¼€å”® Â· 2026Q1 é£æ§ä½“ç³»1.0è½åœ° Â· 2026Q2 å„¿ç«¥ç»„ å®Œæˆ7ä¸ªäº§å“ä¸Šçº¿</div>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">ç›®æ ‡å‘¨æœŸ *</label>
                    <select
                      value={objectiveForm.cycle}
                      onChange={e => {
                        const cycle = e.target.value;
                        const parts = [cycle.replace('-', ''), objectiveForm.group || objectiveForm.department, objectiveForm.productCode, objectiveForm.actionGoal, objectiveForm.quantifier].filter(Boolean);
                        setObjectiveForm({ ...objectiveForm, cycle, name: parts.join(' ') });
                      }}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-300 outline-none"
                    >
                      {(() => {
                        // ä»å·²æœ‰ç›®æ ‡åŠ¨æ€æå–å‘¨æœŸ + è‡ªåŠ¨ç”Ÿæˆå½“å‰å¹´ä»½å‰åçš„å­£åº¦
                        const existing = [...new Set(objectives.map(o => o.cycle).filter(Boolean))];
                        const now = new Date();
                        const y = now.getFullYear();
                        const q = Math.ceil((now.getMonth() + 1) / 3);
                        const generated = [];
                        for (let yr = y - 1; yr <= y + 1; yr++) {
                          for (let qt = 1; qt <= 4; qt++) {
                            generated.push(`${yr}-Q${qt}`);
                          }
                        }
                        const all = [...new Set([...generated, ...existing])].sort();
                        return all.map(c => <option key={c}>{c}</option>);
                      })()}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">ç›®æ ‡å±‚çº§ *</label>
                    <select
                      value={objectiveForm.level}
                      onChange={e => setObjectiveForm({ ...objectiveForm, level: e.target.value, department: e.target.value !== 'éƒ¨é—¨çº§' ? '' : objectiveForm.department })}
                      className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-300 outline-none"
                    >
                      <option>å…¬å¸çº§</option>
                      <option>éƒ¨é—¨çº§</option>
                      <option>ä¸ªäººçº§</option>
                    </select>
                  </div>
                </div>
                {objectiveForm.level === 'éƒ¨é—¨çº§' && (
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                    <div>
                      <label className="block text-sm text-gray-600 mb-1">æ‰€å±éƒ¨é—¨ *</label>
                      <select
                        value={objectiveForm.department}
                        onChange={e => {
                          const dept = e.target.value;
                          const parts = [objectiveForm.cycle?.replace('-', ''), dept, objectiveForm.productCode, objectiveForm.actionGoal, objectiveForm.quantifier].filter(Boolean);
                          setObjectiveForm({ ...objectiveForm, department: dept, group: '', name: parts.join(' ') });
                        }}
                        className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-300 outline-none"
                      >
                        <option value="">è¯·é€‰æ‹©éƒ¨é—¨</option>
                        {[...new Set(members.map(m => m.department).filter(Boolean))].sort().map(d => (
                          <option key={d} value={d}>{d}</option>
                        ))}
                      </select>
                    </div>
                    {objectiveForm.department && (() => {
                      const deptGroups = [...new Set(members.filter(m => m.department === objectiveForm.department).map(m => m.group).filter(g => g && g !== objectiveForm.department))];
                      if (deptGroups.length === 0) return null;
                      return (
                        <div>
                          <label className="block text-sm text-gray-600 mb-1">æ‰€å±ç»„åˆ«</label>
                          <select
                            value={objectiveForm.group || ''}
                            onChange={e => {
                              const grp = e.target.value;
                              const displayName = grp || objectiveForm.department;
                              const parts = [objectiveForm.cycle?.replace('-', ''), displayName, objectiveForm.productCode, objectiveForm.actionGoal, objectiveForm.quantifier].filter(Boolean);
                              setObjectiveForm({ ...objectiveForm, group: grp, name: parts.join(' ') });
                            }}
                            className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-300 outline-none"
                          >
                            <option value="">éƒ¨é—¨æ•´ä½“</option>
                            {deptGroups.sort().map(g => (
                              <option key={g} value={g}>{g}</option>
                            ))}
                          </select>
                        </div>
                      );
                    })()}
                  </div>
                )}
                <div>
                  <label className="block text-sm text-gray-600 mb-1">è´Ÿè´£äºº *</label>
                  <select
                    value={objectiveForm.owner}
                    onChange={e => setObjectiveForm({ ...objectiveForm, owner: e.target.value })}
                    className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-300 outline-none"
                  >
                    <option value="">è¯·é€‰æ‹©è´Ÿè´£äºº</option>
                    {currentUser && (
                      <option value={currentUser.open_id}>ğŸ‘¤ {currentUser.name}ï¼ˆæˆ‘ï¼‰</option>
                    )}
                    {members.filter(m => m.id !== currentUser?.open_id).map(m => (
                      <option key={m.id} value={m.id}>{m.name}</option>
                    ))}
                  </select>
                </div>
                <div className="text-xs text-purple-600 bg-purple-100 px-3 py-2 rounded-lg">
                  ğŸ’¡ çŠ¶æ€è‡ªåŠ¨è®¡ç®—ï¼šæœ‰è¿›è¡Œä¸­çš„KRâ†’è¿›è¡Œä¸­ï¼Œæ‰€æœ‰KRå®Œæˆâ†’å·²å®Œæˆ
                </div>
                <div className="flex gap-2 pt-2">
                  <button type="button" onClick={() => setShowAddObjective(false)} className="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">å–æ¶ˆ</button>
                  <button type="submit" disabled={isSubmitting} className="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 disabled:opacity-50">
                    {isSubmitting ? 'åˆ›å»ºä¸­...' : 'åˆ›å»ºç›®æ ‡'}
                  </button>
                </div>
              </form>
            </div>
          )}

          {/* OKR æ€»è§ˆä»ªè¡¨ç›˜ */}
          {objectives.length > 0 && (() => {
            const allObjData = objectives
              .filter(o => filterCycle === 'all' || o.cycle === filterCycle)
              .map(o => {
                const { progress, autoStatus } = calculateObjectiveProgressAndStatus(o.id);
                return { ...o, progress, autoStatus };
              });
            if (allObjData.length === 0) return null;
            
            const levels = [
              { key: 'å…¬å¸çº§', label: 'å…¬å¸çº§', gradient: ['#8b5cf6', '#6366f1'], bg: 'bg-purple-50' },
              { key: 'éƒ¨é—¨çº§', label: 'éƒ¨é—¨çº§', gradient: ['#3b82f6', '#06b6d4'], bg: 'bg-blue-50' },
              { key: 'ä¸ªäººçº§', label: 'ä¸ªäººçº§', gradient: ['#10b981', '#14b8a6'], bg: 'bg-green-50' }
            ];
            
            return (
              <div className="card-flat px-5 py-3 mb-2">
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-6">
                    {levels.map(lv => {
                      const items = allObjData.filter(o => o.level === lv.key);
                      if (items.length === 0) return null;
                      const avg = Math.round(items.reduce((s, o) => s + o.progress, 0) / items.length);
                      const done = items.filter(o => o.autoStatus === 'å·²å®Œæˆ').length;
                      return (
                        <div key={lv.key} className="flex items-center gap-2.5">
                          <div className="relative w-11 h-11">
                            <svg className="w-11 h-11 -rotate-90" viewBox="0 0 36 36">
                              <circle cx="18" cy="18" r="14.5" fill="none" stroke="#e5e7eb" strokeWidth="2.5" />
                              <circle cx="18" cy="18" r="14.5" fill="none" strokeWidth="2.5" strokeLinecap="round"
                                stroke={`url(#grad-${lv.key})`}
                                strokeDasharray={`${avg * 0.91} 100`} />
                              <defs><linearGradient id={`grad-${lv.key}`}><stop offset="0%" stopColor={lv.gradient[0]} /><stop offset="100%" stopColor={lv.gradient[1]} /></linearGradient></defs>
                            </svg>
                            <span className="absolute inset-0 flex items-center justify-center text-[10px] font-bold text-gray-700">{avg}%</span>
                          </div>
                          <div>
                            <div className="text-xs font-semibold text-gray-700">{lv.label}</div>
                            <div className="text-[11px] text-gray-400">{items.length}ä¸ª {done > 0 ? `Â· ${done}å®Œæˆ` : ''}</div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  <button
                    onClick={() => {
                      if (expandedObjectives.size > 0) setExpandedObjectives(new Set());
                      else setExpandedObjectives(new Set(allObjData.map(o => o.id)));
                    }}
                    className="text-[11px] px-2.5 py-1 rounded-lg border text-gray-500 hover:bg-gray-50"
                  >
                    {expandedObjectives.size > 0 ? 'å…¨éƒ¨æ”¶èµ·' : 'å…¨éƒ¨å±•å¼€'}
                  </button>
                </div>
              </div>
            );
          })()}

          {/* ç›®æ ‡åˆ—è¡¨ */}
          {objectives.length === 0 ? (
            <div className="bg-white rounded-xl p-12 text-center">
              <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gIYSUNDX1BST0ZJTEUAAQEAAAIIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAAGRyWFlaAAABVAAAABRnWFlaAAABaAAAABRiWFlaAAABfAAAABR3dHB0AAABkAAAABRyVFJDAAABpAAAAChnVFJDAAABpAAAAChiVFJDAAABpAAAAChjcHJ0AAABzAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAEYAAAAcAEQAaQBzAHAAbABhAHkAIABQADMAIABHAGEAbQB1AHQAIAB3AGkAdABoACAAcwBSAEcAQgAgAFQAcgBhAG4AcwBmAGUAcgAAWFlaIAAAAAAAAIPfAAA9v////7tYWVogAAAAAAAASr8AALE3AAAKuVhZWiAAAAAAAAAoOAAAEQsAAMi5WFlaIAAAAAAAAPbWAAEAAAAA0y1wYXJhAAAAAAAEAAAAAmZmAADypwAADVkAABPQAAAKWwAAAAAAAAAAbWx1YwAAAAAAAAABAAAADGVuVVMAAAAgAAAAHABHAG8AbwBnAGwAZQAgAEkAbgBjAC4AIAAyADAAMQA2/9sAQwABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEB/9sAQwEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEB/8AAEQgCZgLmAwEiAAIRAQMRAf/EAB8AAQABAwUBAQAAAAAAAAAAAAALAwkKAQIEBQgGB//EADsQAAEEAgIBAwIDBQcEAgMBAAABAgMEBQYHEQgJEiETMQpBURQiYXGBFTKRobHB0RYjJOEXchgl8FL/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8Az+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//Z" className="w-16 h-16 rounded-2xl mx-auto mb-4" style={{background:'white',padding:'4px',boxShadow:'0 4px 20px rgba(108,92,231,0.15)'}} alt="å¾®é“¸" />
              <div className="text-gray-500 mb-4">æš‚æ— ç›®æ ‡ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªç›®æ ‡</div>
            </div>
          ) : (
            <div className="space-y-4">
              {(() => {
                const filteredObjectives = objectives.filter(o => {
                  if (filterCycle !== 'all' && o.cycle !== filterCycle) return false;
                  if (filterObjStatus !== 'all') {
                    const { autoStatus } = calculateObjectiveProgressAndStatus(o.id);
                    if (autoStatus !== filterObjStatus) return false;
                  }
                  return true;
                });
                if (filteredObjectives.length === 0) {
                  return (
                    <div className="text-center py-12 text-gray-400">
                      <div className="mb-3"><Icon name="target" size={40} color="var(--c-text-muted)" /></div>
                      <div>æ²¡æœ‰ç¬¦åˆç­›é€‰æ¡ä»¶çš„ç›®æ ‡</div>
                    </div>
                  );
                }
                
                // æŒ‰å±‚çº§åˆ†ç»„
                const levelConfig = [
                  { key: 'å…¬å¸çº§', icon: 'building', color: 'from-purple-600 to-indigo-600', bg: 'bg-purple-50', border: 'border-purple-200', badge: 'bg-purple-100 text-purple-700' },
                  { key: 'éƒ¨é—¨çº§', icon: 'dept', color: 'from-blue-600 to-cyan-600', bg: 'bg-blue-50', border: 'border-blue-200', badge: 'bg-blue-100 text-blue-700' },
                  { key: 'ä¸ªäººçº§', icon: 'user', color: 'from-green-600 to-teal-600', bg: 'bg-green-50', border: 'border-green-200', badge: 'bg-green-100 text-green-700' }
                ];
                
                const grouped = {};
                filteredObjectives.forEach(o => {
                  const lv = o.level || 'æœªåˆ†ç±»';
                  if (!grouped[lv]) grouped[lv] = [];
                  grouped[lv].push(o);
                });
                
                // æŒ‰éƒ¨é—¨çº§å†ç»†åˆ†
                const renderObjectiveCard = (objective) => {
                const krs = getKRsForObjective(objective.id);
                const { progress, autoStatus } = calculateObjectiveProgressAndStatus(objective.id);
                const isExpanded = expandedObjectives.has(objective.id);
                const isEditing = editingObjective?.id === objective.id;
                const objOwnerMember = members.find(m => m.id === objective.ownerId || m.name === objective.ownerName);
                const levelCfg = levelConfig.find(l => l.key === objective.level) || levelConfig[0];

                // æŠ˜å æ€ï¼šç´§å‡‘å¡ç‰‡
                if (!isExpanded && !isEditing) {
                  return (
                    <div key={objective.id} id={'obj-' + objective.id}
                      className="bg-white rounded-xl border border-gray-100 hover:shadow-md hover:border-gray-200 transition-all cursor-pointer p-3.5 flex flex-col justify-between"
                      style={{minHeight: '110px'}}
                      onClick={() => toggleObjective(objective.id)}
                    >
                      <div>
                        <div className="flex items-start justify-between gap-2 mb-2">
                          <h3 className="text-sm font-semibold text-gray-800 line-clamp-2 leading-tight flex-1">{objective.name}</h3>
                          <span className={`text-[10px] px-1.5 py-0.5 rounded-full flex-shrink-0 ${getStatusColor(autoStatus)}`}>{autoStatus}</span>
                        </div>
                        <div className="flex items-center gap-1.5 flex-wrap">
                          <span className="px-1.5 py-0.5 bg-gray-100 rounded text-[10px] text-gray-500">{objective.cycle}</span>
                          {objOwnerMember && (
                            <span className="flex items-center gap-0.5">
                              {objOwnerMember.avatarUrl ? (
                                <img src={objOwnerMember.avatarUrl} className="w-3.5 h-3.5 rounded-full" alt="" />
                              ) : (
                                <span className="w-3.5 h-3.5 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-[9px]">{objective.ownerName?.charAt(0)}</span>
                              )}
                              <span className="text-[10px] text-gray-400">{objective.ownerName}</span>
                            </span>
                          )}
                          <span className="text-[10px] text-gray-400">{krs.length} KR</span>
                        </div>
                      </div>
                      <div className="mt-2.5">
                        <div className="flex items-center justify-between mb-1">
                          <span className={`text-lg font-bold ${progress >= 80 ? 'text-green-600' : progress >= 40 ? 'text-blue-600' : progress > 0 ? 'text-purple-600' : 'text-gray-300'}`}>{progress}%</span>
                        </div>
                        <div className="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden">
                          <div className={`h-full rounded-full transition-all bg-gradient-to-r ${levelCfg.color}`} style={{ width: `${progress}%` }} />
                        </div>
                      </div>
                    </div>
                  );
                }

                // å±•å¼€æ€ï¼šå…¨å®½è¯¦æƒ…
                return (
                  <div key={objective.id} id={'obj-' + objective.id} className="bg-white rounded-xl shadow-sm overflow-hidden hover:shadow-md transition-shadow col-span-full border border-gray-100">
                    <div className="flex">
                    {/* å·¦ä¾§å½©æ¡ */}
                    <div className={`w-1 flex-shrink-0 bg-gradient-to-b ${levelCfg.color}`} />
                    <div className="flex-1 min-w-0">
                    {/* ç›®æ ‡å¤´éƒ¨ */}
                    <div 
                      className="px-4 py-3 cursor-pointer hover:bg-gray-50/50 transition-colors"
                      onClick={() => !isEditing && toggleObjective(objective.id)}
                    >
                      {isEditing ? (
                        <form onSubmit={handleUpdateObjective} className="space-y-2" onClick={e => e.stopPropagation()}>
                          <input
                            type="text"
                            value={objectiveForm.name}
                            onChange={e => setObjectiveForm({ ...objectiveForm, name: e.target.value })}
                            className="w-full px-3 py-1.5 border rounded-lg focus:ring-2 focus:ring-purple-300 outline-none text-sm font-semibold"
                          />
                          <div className="flex items-center gap-2 flex-wrap">
                            <select
                              value={objectiveForm.cycle}
                              onChange={e => setObjectiveForm({ ...objectiveForm, cycle: e.target.value })}
                              className="px-2 py-1 border rounded text-xs"
                            >
                              {(() => {
                                const existing = [...new Set(objectives.map(o => o.cycle).filter(Boolean))];
                                const y = new Date().getFullYear();
                                const generated = [];
                                for (let yr = y - 1; yr <= y + 1; yr++) {
                                  for (let qt = 1; qt <= 4; qt++) generated.push(`${yr}-Q${qt}`);
                                }
                                return [...new Set([...generated, ...existing])].sort().map(c => <option key={c}>{c}</option>);
                              })()}
                            </select>
                            <select
                              value={objectiveForm.level}
                              onChange={e => setObjectiveForm({ ...objectiveForm, level: e.target.value, department: e.target.value !== 'éƒ¨é—¨çº§' ? '' : objectiveForm.department })}
                              className="px-2 py-1 border rounded text-xs"
                            >
                              <option>å…¬å¸çº§</option>
                              <option>éƒ¨é—¨çº§</option>
                              <option>ä¸ªäººçº§</option>
                            </select>
                            {objectiveForm.level === 'éƒ¨é—¨çº§' && (
                              <select
                                value={objectiveForm.department}
                                onChange={e => setObjectiveForm({ ...objectiveForm, department: e.target.value })}
                                className={`px-2 py-1 border rounded text-xs ${!objectiveForm.department ? 'text-gray-400 border-orange-300' : ''}`}
                              >
                                <option value="">é€‰æ‹©éƒ¨é—¨ *</option>
                                {[...new Set(members.map(m => m.department).filter(Boolean))].sort().map(d => (
                                  <option key={d} value={d}>{d}</option>
                                ))}
                              </select>
                            )}
                            <button type="button" onClick={() => setEditingObjective(null)} className="px-2 py-1 border rounded text-xs hover:bg-gray-50 ml-auto">å–æ¶ˆ</button>
                            <button type="submit" disabled={isSubmitting} className="px-3 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600 disabled:opacity-50">
                              {isSubmitting ? '...' : 'ä¿å­˜'}
                            </button>
                          </div>
                        </form>
                      ) : (
                        <div className="flex items-center gap-4">
                          <div className="text-xl text-gray-400">{isExpanded ? 'â–¼' : 'â–¶'}</div>
                          <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 flex-wrap">
                              <h3 className="text-base font-bold text-gray-800">{objective.name}</h3>
                              <span className={`text-[10px] px-2 py-0.5 rounded-full ${getStatusColor(autoStatus)}`}>{autoStatus}</span>
                            </div>
                            <div className="flex items-center gap-2 mt-1.5 flex-wrap">
                              <span className="px-1.5 py-0.5 bg-gray-100 rounded text-[11px] text-gray-500">{objective.cycle}</span>
                              {objective.level === 'éƒ¨é—¨çº§' && objective.department && (
                                <span className={`px-1.5 py-0.5 rounded text-[11px] ${levelCfg.badge}`}>{objective.department}</span>
                              )}
                              {objOwnerMember && (
                                <span className="flex items-center gap-1">
                                  {objOwnerMember.avatarUrl ? (
                                    <img src={objOwnerMember.avatarUrl} className="w-4 h-4 rounded-full" alt="" />
                                  ) : (
                                    <span className="w-4 h-4 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center text-[10px]">{objective.ownerName?.charAt(0)}</span>
                                  )}
                                  <span className="text-[11px] text-gray-500">{objective.ownerName}</span>
                                </span>
                              )}
                              <span className="text-[11px] text-gray-400">{krs.length} KR</span>
                            </div>
                          </div>
                          <div className="text-right flex-shrink-0">
                            <div className={`text-xl font-bold ${progress >= 80 ? 'text-green-600' : progress >= 50 ? 'text-blue-600' : 'text-purple-600'}`}>{progress}%</div>
                            <div className="w-24 h-1.5 bg-gray-200 rounded-full mt-1 overflow-hidden">
                              <div className={`h-full ${getProgressColor(progress)} transition-all`} style={{ width: `${progress}%` }} />
                            </div>
                          </div>
                          {currentUser && (currentUser.open_id === objective.ownerId || currentUser.name === objective.ownerName) && (
                          <button
                            onClick={(e) => { e.stopPropagation(); startEditObjective(objective); }}
                            className="p-1.5 text-gray-300 hover:text-purple-600 hover:bg-purple-50 rounded-lg"
                            title="ç¼–è¾‘ç›®æ ‡"
                          >
                            <Icon name="edit" size={13} />
                          </button>
                          )}
                        </div>
                      )}
                    </div>

                    {/* å…³é”®ç»“æœåˆ—è¡¨ */}
                    {isExpanded && !isEditing && (
                      <div className="border-t bg-gray-50/80 px-4 py-3">
                        {/* æ·»åŠ  KR æŒ‰é’® */}
                        <div className="flex items-center justify-between mb-3">
                          <h4 className="text-sm font-semibold text-gray-600"><Icon name="key" size={13} /> å…³é”®ç»“æœ ({krs.length})</h4>
                          <button
                            onClick={() => setShowAddKR(objective.id)}
                            className="text-xs px-3 py-1.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                          >
                            <Icon name="plus" size={12} /> æ·»åŠ  KR
                          </button>
                        </div>

                        {/* æ–°å»º KR è¡¨å• */}
                        {showAddKR === objective.id && (
                          <div className="bg-blue-50 rounded-lg p-4 mb-4 border border-blue-200">
                            <form onSubmit={handleCreateKR} className="space-y-3">
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">å…³é”®ç»“æœå‘½å *</label>
                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-2">
                                  <input
                                    type="text"
                                    value={krForm.productCode}
                                    onChange={e => {
                                      const pc = e.target.value;
                                      const auto = `${pc}${krForm.metric ? ' ' + krForm.metric : ''}${krForm.target ? ' ' + krForm.operator + krForm.target : ''}`;
                                      setKRForm({ ...krForm, productCode: pc, name: auto.trim() });
                                    }}
                                    className="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-300 outline-none"
                                    placeholder="äº§å“ä»£å·"
                                  />
                                  <input
                                    type="text"
                                    value={krForm.metric}
                                    onChange={e => {
                                      const m = e.target.value;
                                      const auto = `${krForm.productCode}${m ? ' ' + m : ''}${krForm.target ? ' ' + krForm.operator + krForm.target : ''}`;
                                      setKRForm({ ...krForm, metric: m, name: auto.trim() });
                                    }}
                                    className="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-300 outline-none"
                                    placeholder="æŒ‡æ ‡ å¦‚ è¯„è®ºæ•°"
                                    required
                                  />
                                  <select
                                    value={krForm.operator}
                                    onChange={e => {
                                      const op = e.target.value;
                                      const auto = `${krForm.productCode}${krForm.metric ? ' ' + krForm.metric : ''}${krForm.target ? ' ' + op + krForm.target : ''}`;
                                      setKRForm({ ...krForm, operator: op, name: auto.trim() });
                                    }}
                                    className="px-3 py-2 border rounded-lg text-sm"
                                  >
                                    <option value="â‰¥">â‰¥ å¤§äºç­‰äº</option>
                                    <option value="=">= ç­‰äº</option>
                                    <option value="â‰¤">â‰¤ å°äºç­‰äº</option>
                                    <option value="è¾¾åˆ°">è¾¾åˆ°</option>
                                    <option value="å®Œæˆ">å®Œæˆ</option>
                                  </select>
                                </div>
                                <div className="relative">
                                  <input
                                    type="text"
                                    value={krForm.name}
                                    onChange={e => setKRForm({ ...krForm, name: e.target.value })}
                                    className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-300 outline-none bg-blue-50 font-medium"
                                    placeholder="è‡ªåŠ¨ç”Ÿæˆï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰"
                                    required
                                  />
                                  <span className="absolute right-3 top-2.5 text-[10px] text-blue-400">âœ¨ è‡ªåŠ¨æ‹¼æ¥</span>
                                </div>
                              </div>
                              <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                                <div>
                                  <label className="block text-xs text-gray-600 mb-1">ç›®æ ‡å€¼ *</label>
                                  <input
                                    type="number"
                                    value={krForm.target}
                                    onChange={e => {
                                      const t = Number(e.target.value);
                                      const auto = `${krForm.productCode}${krForm.metric ? ' ' + krForm.metric : ''}${t ? ' ' + krForm.operator + t : ''}`;
                                      setKRForm({ ...krForm, target: t, name: auto.trim() });
                                    }}
                                    className="w-full px-3 py-2 border rounded-lg text-sm"
                                    placeholder="å¦‚: 5"
                                    required
                                  />
                                  <div className="text-xs text-gray-400 mt-1">
                                    {krForm.metric ? `${krForm.metric}çš„ç›®æ ‡æ•°å€¼` : 'éœ€å®Œæˆçš„é¡¹ç›®æ•°é‡'}
                                  </div>
                                </div>
                                <div>
                                  <label className="block text-xs text-gray-600 mb-1">æƒé‡ *</label>
                                  <input
                                    type="number"
                                    value={krForm.weight}
                                    onChange={e => setKRForm({ ...krForm, weight: Number(e.target.value) })}
                                    className="w-full px-3 py-2 border rounded-lg text-sm"
                                    min="1" max="100"
                                    required
                                  />
                                  {(() => {
                                    const objId = editingKR ? editingKR.objectiveId : showAddKR;
                                    const siblingKRs = keyResults.filter(kr => kr.objectiveId === objId && kr.id !== editingKR?.id);
                                    const usedWeight = siblingKRs.reduce((sum, kr) => sum + (kr.weight || 0), 0);
                                    const remaining = 100 - usedWeight;
                                    const wouldExceed = krForm.weight > remaining;
                                    return (
                                      <div className={`text-xs mt-1 ${wouldExceed ? 'text-red-500 font-medium' : 'text-gray-400'}`}>
                                        {wouldExceed 
                                          ? `âš ï¸ è¶…å‡ºä¸Šé™ï¼å·²ç”¨ ${usedWeight}ï¼Œå‰©ä½™ ${remaining}`
                                          : `å·²ç”¨ ${usedWeight}/100ï¼Œå‰©ä½™å¯åˆ†é… ${remaining}`
                                        }
                                      </div>
                                    );
                                  })()}
                                </div>
                              </div>
                              <div>
                                <label className="block text-xs text-gray-600 mb-1">è´Ÿè´£äºº *</label>
                                <select
                                  value={krForm.owner}
                                  onChange={e => setKRForm({ ...krForm, owner: e.target.value })}
                                  className="w-full px-3 py-2 border rounded-lg text-sm"
                                  required
                                >
                                  <option value="">è¯·é€‰æ‹©è´Ÿè´£äºº</option>
                                  {currentUser && (
                                    <option value={currentUser.open_id}>ğŸ‘¤ {currentUser.name}ï¼ˆæˆ‘ï¼‰</option>
                                  )}
                                  {members.filter(m => m.id !== currentUser?.open_id).map(m => (
                                    <option key={m.id} value={m.id}>{m.name}</option>
                                  ))}
                                </select>
                              </div>
                              <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                                <div>
                                  <label className="block text-xs text-gray-600 mb-1">å•ä½</label>
                                  <select
                                    value={krForm.unit || 'ä¸ª'}
                                    onChange={e => {
                                      const unit = e.target.value;
                                      const krType = unit === 'å¤©' ? 'metric_duration' : (unit === '%' || unit === 'ä¸‡å…ƒ') ? 'metric_value' : 'project_count';
                                      setKRForm({ ...krForm, unit, krType });
                                    }}
                                    className="w-full px-3 py-2 border rounded-lg text-sm"
                                  >
                                    <option value="ä¸ª">ğŸ“¦ ä¸ªï¼ˆé¡¹ç›®è®¡æ•°ï¼‰</option>
                                    <option value="å¤©">ğŸ“… å¤©ï¼ˆå·¥æœŸï¼‰</option>
                                    <option value="%">ğŸ“Š %ï¼ˆç™¾åˆ†æ¯”ï¼‰</option>
                                    <option value="ä¸‡å…ƒ">ğŸ’° ä¸‡å…ƒï¼ˆé‡‘é¢ï¼‰</option>
                                  </select>
                                </div>
                                <div className={`rounded-lg p-3 text-xs ${
                                  (krForm.unit === 'å¤©') ? 'bg-purple-50 text-purple-600' :
                                  (krForm.unit === '%' || krForm.unit === 'ä¸‡å…ƒ') ? 'bg-amber-50 text-amber-600' :
                                  'bg-blue-50 text-blue-600'
                                }`}>
                                  {krForm.unit === 'å¤©' ? (
                                    <>
                                      <strong>ğŸ“… å·¥æœŸè‡ªåŠ¨è¿½è¸ª</strong>
                                      <br />å…³è”é¡¹ç›®åï¼Œè‡ªåŠ¨è®¡ç®—å®é™…å·¥æœŸ
                                      <br />è¿ç®—ç¬¦ã€Œâ‰¤ã€= è¶ŠçŸ­è¶Šå¥½
                                    </>
                                  ) : (krForm.unit === '%' || krForm.unit === 'ä¸‡å…ƒ') ? (
                                    <>
                                      <strong>ğŸ“Š æ‰‹åŠ¨æ›´æ–°å½“å‰å€¼</strong>
                                      <br />éœ€åœ¨ KR å¡ç‰‡ä¸Šæ‰‹åŠ¨æ›´æ–°è¿›åº¦
                                    </>
                                  ) : (
                                    <>
                                      <strong>ğŸ“¦ é¡¹ç›®è®¡æ•°</strong>
                                      <br />å½“å‰å€¼ = å…³è”å·²å®Œæˆé¡¹ç›®æ•°
                                      <br />è‡ªåŠ¨è®¡ç®—è¿›åº¦å’ŒçŠ¶æ€
                                    </>
                                  )}
                                </div>
                              </div>
                              <div className="flex gap-2">
                                <button type="button" onClick={() => setShowAddKR(null)} className="flex-1 px-3 py-2 border rounded-lg text-sm hover:bg-gray-50">å–æ¶ˆ</button>
                                <button type="submit" disabled={isSubmitting} className="flex-1 px-3 py-2 bg-blue-500 text-white rounded-lg text-sm hover:bg-blue-600 disabled:opacity-50">
                                  {isSubmitting ? 'åˆ›å»ºä¸­...' : 'åˆ›å»º KR'}
                                </button>
                              </div>
                            </form>
                          </div>
                        )}

                        {/* KR åˆ—è¡¨ */}
                        {krs.length === 0 ? (
                          <div className="text-center py-6 text-gray-400 text-sm">
                            æš‚æ— å…³é”®ç»“æœï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ 
                          </div>
                        ) : (
                          <div className="space-y-3">
                            {krs.map(kr => {
                              const krAuto = getKRAutoProgress(kr);
                              const krProgress = krAuto.progress;
                              const krCurrent = krAuto.current;
                              const krProjects = getProjectsForKR(kr.id);
                              const isKRExpanded = expandedKRs.has(kr.id);
                              const isKREditing = editingKR?.id === kr.id;

                              return (
                                <div key={kr.id} className="bg-white rounded-lg border overflow-hidden">
                                  {/* KR å¤´éƒ¨ */}
                                  <div 
                                    className="p-3 cursor-pointer hover:bg-gray-50"
                                    onClick={() => !isKREditing && toggleKR(kr.id)}
                                  >
                                    {isKREditing ? (
                                      <form onSubmit={handleUpdateKR} className="space-y-3" onClick={e => e.stopPropagation()}>
                                        <input
                                          type="text"
                                          value={krForm.name}
                                          onChange={e => setKRForm({ ...krForm, name: e.target.value })}
                                          className="w-full px-3 py-2 border rounded-lg text-sm"
                                        />
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                                          <input
                                            type="number"
                                            value={krForm.target}
                                            onChange={e => setKRForm({ ...krForm, target: Number(e.target.value) })}
                                            className="px-3 py-2 border rounded-lg text-sm"
                                            placeholder="ç›®æ ‡å€¼"
                                          />
                                          <input
                                            type="number"
                                            value={krForm.weight}
                                            onChange={e => setKRForm({ ...krForm, weight: Number(e.target.value) })}
                                            className="px-3 py-2 border rounded-lg text-sm"
                                            placeholder="æƒé‡"
                                          />
                                        </div>
                                        <div className="text-xs text-gray-500">ğŸ’¡ çŠ¶æ€å’Œå½“å‰å€¼æ ¹æ®å…³è”é¡¹ç›®è‡ªåŠ¨è®¡ç®—</div>
                                        <div className="flex gap-2">
                                          <button type="button" onClick={() => setEditingKR(null)} className="px-3 py-1.5 border rounded text-xs hover:bg-gray-50">å–æ¶ˆ</button>
                                          <button type="submit" disabled={isSubmitting} className="px-3 py-1.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 disabled:opacity-50">
                                            {isSubmitting ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜'}
                                          </button>
                                        </div>
                                      </form>
                                    ) : (
                                      <div className="flex items-center gap-3">
                                        <div className="text-sm text-gray-400">{isKRExpanded ? 'â–¼' : 'â–¶'}</div>
                                        <div className="flex-1">
                                          <div className="flex items-center gap-2">
                                            <Icon name="key" size={16} color="var(--c-accent)" />
                                            <span className="font-medium text-gray-800">{kr.name}</span>
                                            <span className={`text-[10px] px-2 py-0.5 rounded-full ${getStatusColor(krAuto.autoStatus)}`}>
                                              {krAuto.autoStatus}
                                            </span>
                                            {kr.weight > 1 && (
                                              <span className="text-xs px-2 py-0.5 bg-purple-100 text-purple-600 rounded-full">
                                                æƒé‡ {kr.weight}
                                              </span>
                                            )}
                                          </div>
                                          <div className="flex items-center gap-4 mt-1 text-xs text-gray-500">
                                            <span>ç›®æ ‡: {kr.target}{kr.unit || ''}</span>
                                            <span className={krAuto.autoCalculated ? 'text-green-600 font-medium' : ''}>
                                              å½“å‰: {krCurrent}{kr.unit || ''}
                                              {krAuto.autoCalculated && ' âš¡'}
                                            </span>
                                            {kr.ownerName && (() => {
                                              const krOwnerMember = members.find(m => m.id === kr.ownerId || m.name === kr.ownerName);
                                              return (
                                                <span className="flex items-center gap-1">
                                                  {krOwnerMember?.avatarUrl ? (
                                                    <img src={krOwnerMember.avatarUrl} className="w-3.5 h-3.5 rounded-full" alt="" />
                                                  ) : (
                                                    <span className="w-3.5 h-3.5 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-[9px]">{kr.ownerName.charAt(0)}</span>
                                                  )}
                                                  {kr.ownerName}
                                                </span>
                                              );
                                            })()}
                                            <span>{krProjects.length} ä¸ªé¡¹ç›® {krAuto.autoCalculated && `(${krAuto.completedProjects}å·²å®Œæˆ)`}</span>
                                          </div>
                                        </div>
                                        <div className="text-right">
                                          <div className="text-xl font-bold text-blue-600">{krProgress}%</div>
                                          <div className="w-24 h-1.5 bg-gray-200 rounded-full mt-1 overflow-hidden">
                                            <div className={`h-full ${getProgressColor(krProgress)} transition-all`} style={{ width: `${krProgress}%` }} />
                                          </div>
                                        </div>
                                        {(currentUser.open_id === objective.ownerId || currentUser.name === objective.ownerName) && (
                                        <button
                                          onClick={(e) => { e.stopPropagation(); startEditKR(kr); }}
                                          className="p-1.5 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded"
                                          title="ç¼–è¾‘ KRï¼ˆä»…ç›®æ ‡è´Ÿè´£äººï¼‰"
                                        >
                                          <Icon name="edit" size={13} />
                                        </button>
                                        )}
                                      </div>
                                    )}
                                  </div>

                                  {/* é¡¹ç›®åˆ—è¡¨ */}
                                  {isKRExpanded && !isKREditing && (
                                    <div className="border-t bg-gray-50 p-3">
                                      <div className="flex items-center justify-between mb-2">
                                        <div className="text-xs font-semibold text-gray-500">
                                          å…³è”é¡¹ç›® ({krProjects.length}) 
                                          {krAuto.autoCalculated && (
                                            <span className="ml-2 text-green-600">
                                              âœ… {krAuto.completedProjects}/{krProjects.length} å·²å®Œæˆ
                                            </span>
                                          )}
                                        </div>
                                        <button
                                          onClick={(e) => { e.stopPropagation(); setShowAddProject(showAddProject === kr.id ? null : kr.id); }}
                                          className="text-xs px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors"
                                        >
                                          <Icon name="plus" size={12} /> æ·»åŠ é¡¹ç›®
                                        </button>
                                      </div>
                                      
                                      {/* æ·»åŠ é¡¹ç›®è¡¨å• */}
                                      {showAddProject === kr.id && (
                                        <div className="bg-white rounded-lg border p-3 mb-3" onClick={e => e.stopPropagation()}>
                                          <div className="space-y-2">
                                            <div className="grid grid-cols-2 gap-2">
                                              <select
                                                value={projectForm.templateType}
                                                onChange={e => {
                                                  const tt = e.target.value;
                                                  const tplLabel = tt ? tt.replace('æ–°å“å¼€å‘', 'æ–°å“ä¸Šçº¿') : '';
                                                  const auto = projectForm.productCode + (tplLabel ? tplLabel : '');
                                                  setProjectForm({ ...projectForm, templateType: tt, name: auto });
                                                }}
                                                className={`px-3 py-2 border rounded-lg text-sm ${!projectForm.templateType ? 'text-gray-400' : ''}`}
                                                required
                                              >
                                                <option value="">æ¨¡ç‰ˆç±»å‹ *</option>
                                                {(() => {
                                                  const parentTpls = Object.values(templates).filter(t => t.ownership === 'çˆ¶é¡¹ç›®' && t.type);
                                                  return parentTpls.map(t => <option key={t.type} value={t.type}>{t.name}</option>);
                                                })()}
                                              </select>
                                              <input
                                                type="text"
                                                value={projectForm.productCode}
                                                onChange={e => {
                                                  const pc = e.target.value;
                                                  const tplLabel = projectForm.templateType ? projectForm.templateType.replace('æ–°å“å¼€å‘', 'æ–°å“ä¸Šçº¿') : '';
                                                  const auto = pc + (tplLabel ? tplLabel : '');
                                                  setProjectForm({ ...projectForm, productCode: pc, name: auto });
                                                }}
                                                className="px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-300 outline-none"
                                                placeholder="é¡¹ç›®ä¸»é¢˜ * å¦‚ HG04/å®¢æˆ·ç•™å­˜ç³»ç»Ÿ"
                                                required
                                              />
                                            </div>
                                            <div className="relative">
                                              <input
                                                type="text"
                                                value={projectForm.name}
                                                onChange={e => setProjectForm({ ...projectForm, name: e.target.value })}
                                                className={`w-full px-3 py-2 border rounded-lg text-sm bg-green-50 font-medium ${!projectForm.name.trim() ? 'border-orange-300' : ''}`}
                                                placeholder="è‡ªåŠ¨ç”Ÿæˆï¼ˆå¯æ‰‹åŠ¨ä¿®æ”¹ï¼‰"
                                                required
                                              />
                                              <span className="absolute right-3 top-2.5 text-[10px] text-green-400">âœ¨ è‡ªåŠ¨æ‹¼æ¥</span>
                                            </div>
                                            <div className="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                              <select
                                                value={projectForm.initiatorGroup}
                                                onChange={e => setProjectForm({ ...projectForm, initiatorGroup: e.target.value })}
                                                className={`px-3 py-2 border rounded-lg text-sm ${!projectForm.initiatorGroup ? 'text-gray-400' : ''}`}
                                              >
                                                <option value="">å‘èµ·ç»„ *</option>
                                                {['å„¿ç«¥ç»„','æ¸¸æˆç»„','VCç»„','acerç»„','è¯åŠ¡ä¸€ç»„','è¯åŠ¡äºŒç»„','å¤šå¹³å°ç»„'].map(g => (
                                                  <option key={g} value={g}>{g}</option>
                                                ))}
                                              </select>
                                              <select
                                                value={projectForm.priority}
                                                onChange={e => setProjectForm({ ...projectForm, priority: e.target.value })}
                                                className={`px-3 py-2 border rounded-lg text-sm ${!projectForm.priority ? 'text-gray-400' : ''}`}
                                                required
                                              >
                                                <option value="">é‡è¦ç¨‹åº¦ *</option>
                                                <option value="P0">ğŸ”´ P0 æœ€é«˜</option>
                                                <option value="P1">ğŸŸ  P1 é«˜</option>
                                                <option value="P2">ğŸ”µ P2 ä¸­</option>
                                                <option value="P3">âšª P3 ä½</option>
                                              </select>
                                              <select
                                                value={projectForm.owner}
                                                onChange={e => setProjectForm({ ...projectForm, owner: e.target.value })}
                                                className={`px-3 py-2 border rounded-lg text-sm ${!projectForm.owner ? 'text-gray-400' : ''}`}
                                                required
                                              >
                                                <option value="">è´Ÿè´£äºº *</option>
                                                {currentUser && (
                                                  <option value={currentUser.open_id}>{currentUser.name}ï¼ˆæˆ‘ï¼‰</option>
                                                )}
                                                {members.filter(m => m.id !== currentUser?.open_id).map(m => (
                                                  <option key={m.id} value={m.id}>{m.name}</option>
                                                ))}
                                              </select>
                                              <input
                                                type="date"
                                                value={projectForm.targetDate}
                                                onChange={e => setProjectForm({ ...projectForm, targetDate: e.target.value })}
                                                className={`px-3 py-2 border rounded-lg text-sm ${!projectForm.targetDate ? 'text-gray-400' : ''}`}
                                                placeholder="ä¸Šçº¿æ—¥æœŸ *"
                                                required
                                              />
                                            </div>
                                            {/* å­æ¨¡æ¿é¢„è§ˆ */}
                                            {projectForm.templateType && (() => {
                                              const parentTplId = Object.keys(templates).find(id => templates[id].type === projectForm.templateType && templates[id].ownership === 'çˆ¶é¡¹ç›®');
                                              const parentTplName = parentTplId ? templates[parentTplId].name : '';
                                              const childTpls = Object.values(templates).filter(t => t.ownership === 'å­é¡¹ç›®' && t.parentTemplate === parentTplName);
                                              if (childTpls.length === 0) return null;
                                              const deptMap = { 'äº§å“å¼€å‘çº¿': 'äº§å“ä¸­å¿ƒ', 'è¿è¥è®¡åˆ’çº¿': 'è¿è¥ä¸­å¿ƒ', 'ä¸­æ¢åä½œçº¿': 'ä¸­æ¢éƒ¨', 'è¿è¥è½åœ°çº¿': 'è¿è¥ä¸­å¿ƒ', 'è®¾è®¡éœ€æ±‚çº¿': 'è®¾è®¡éƒ¨', 'ç«™å¤–æ¨å¹¿çº¿': 'è¥é”€æ¨å¹¿éƒ¨' };
                                              const deptDotColors = { 'äº§å“ä¸­å¿ƒ': 'bg-blue-500', 'è¿è¥ä¸­å¿ƒ': 'bg-green-500', 'ä¸­æ¢éƒ¨': 'bg-purple-500', 'è®¾è®¡éƒ¨': 'bg-pink-500', 'è¥é”€æ¨å¹¿éƒ¨': 'bg-orange-500' };
                                              return (
                                                <div className="bg-violet-50 rounded-lg p-2.5 border border-violet-200">
                                                  <div className="text-[10px] text-violet-600 font-medium mb-1.5">ğŸ“‚ å°†è‡ªåŠ¨åˆ›å»º {childTpls.length} ä¸ªå­é¡¹ç›®:</div>
                                                  <div className="flex flex-wrap gap-1.5">
                                                    {childTpls.map(t => {
                                                      const dept = deptMap[t.name] || '';
                                                      return (
                                                        <span key={t.type} className="inline-flex items-center gap-1 px-2 py-0.5 bg-white rounded text-[10px] text-gray-600 border border-violet-100">
                                                          <span className={`w-1.5 h-1.5 rounded-full ${deptDotColors[dept] || 'bg-gray-400'}`} />
                                                          {t.name}
                                                          {t.cycleDays > 0 && <span className="text-gray-300">{t.cycleDays}å¤©</span>}
                                                        </span>
                                                      );
                                                    })}
                                                  </div>
                                                </div>
                                              );
                                            })()}
                                            <div className="flex gap-2">
                                              <button 
                                                onClick={() => setShowAddProject(null)} 
                                                className="px-3 py-1.5 border rounded text-xs hover:bg-gray-50"
                                              >
                                                å–æ¶ˆ
                                              </button>
                                              <button 
                                                onClick={() => handleCreateProject(kr.id)} 
                                                disabled={isSubmitting}
                                                className="px-3 py-1.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 disabled:opacity-50 flex-1"
                                              >
                                                {isSubmitting ? 'ğŸ”„ åˆ›å»ºä¸­...' : (() => {
                                                  const parentTplId = Object.keys(templates).find(id => templates[id].type === projectForm.templateType && templates[id].ownership === 'çˆ¶é¡¹ç›®');
                                                  const parentTplName = parentTplId ? templates[parentTplId].name : '';
                                                  const childCount = Object.values(templates).filter(t => t.ownership === 'å­é¡¹ç›®' && t.parentTemplate === parentTplName).length;
                                                  return childCount > 0 ? `ğŸš€ ä¸€é”®åˆ›å»º (1+${childCount}é¡¹ç›®)` : 'åˆ›å»ºé¡¹ç›®';
                                                })()}
                                              </button>
                                            </div>
                                          </div>
                                        </div>
                                      )}
                                      
                                      {krProjects.length === 0 && showAddProject !== kr.id ? (
                                        <div className="text-xs text-gray-400 text-center py-3">
                                          æš‚æ— å…³è”é¡¹ç›® - ç‚¹å‡»ä¸Šæ–¹ã€Œæ·»åŠ é¡¹ç›®ã€åˆ›å»º
                                        </div>
                                      ) : (
                                        <div className="grid grid-cols-2 gap-2">
                                          {krProjects.map(project => {
                                            const pAutoProgress = calcProjectProgress(project, nodes, templates, tasks, products);
                                            const pAutoStage = project.childIds?.length > 0 ? '' : calcCurrentStage(project, nodes, templates, tasks);
                                            const pAutoStatus = calcProjectStatus(project, tasks, nodes, templates, products);
                                            const isCompleted = pAutoStatus === 'å·²å®Œæˆ';
                                            return (
                                              <div key={project.id} className={`bg-white rounded-lg p-3 border flex items-center gap-3 ${isCompleted ? 'border-green-300 bg-green-50' : ''}`}>
                                                <div className="flex-1 min-w-0">
                                                  <div className="font-medium text-sm text-gray-800 truncate">{project.name}</div>
                                                  <div className="flex items-center gap-2 text-xs text-gray-500">
                                                    {project.childIds?.length > 0 ? (
                                                      <span className="text-violet-600">ğŸ“‚ {project.childIds.length} å­é¡¹ç›®</span>
                                                    ) : (
                                                      <span>{pAutoStage || project.templateType || project.category}</span>
                                                    )}
                                                    {project.ownerName && (() => {
                                                      const pOwner = members.find(m => m.id === project.ownerId || m.name === project.ownerName);
                                                      return (
                                                        <span className="flex items-center gap-0.5">
                                                          {pOwner?.avatarUrl ? (
                                                            <img src={pOwner.avatarUrl} className="w-3.5 h-3.5 rounded-full" alt="" />
                                                          ) : (
                                                            <span className="w-3.5 h-3.5 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center text-[9px]">{project.ownerName.charAt(0)}</span>
                                                          )}
                                                          {project.ownerName}
                                                        </span>
                                                      );
                                                    })()}
                                                  </div>
                                                </div>
                                                <div className="text-right">
                                                  {isCompleted ? (
                                                    <div className="text-sm font-bold text-green-600">âœ… å®Œæˆ</div>
                                                  ) : (
                                                    <div className="text-sm font-bold text-blue-600">{pAutoProgress}%</div>
                                                  )}
                                                </div>
                                              </div>
                                            );
                                          })}
                                        </div>
                                      )}
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                  </div>
                  </div>
                );
                };
                
                // æŒ‰å±‚çº§åˆ†ç»„æ¸²æŸ“
                return levelConfig.filter(lc => grouped[lc.key]?.length > 0).map(lc => {
                  const objs = grouped[lc.key];
                  // éƒ¨é—¨çº§ç›®æ ‡ï¼šæŒ‰å¤§éƒ¨é—¨â†’ç»„åˆ«ä¸¤çº§åˆ†ç»„
                  const deptGroups = lc.key === 'éƒ¨é—¨çº§' ? (() => {
                    // ä»æˆå‘˜è¡¨å»ºç«‹ ç»„åˆ«â†’å¤§éƒ¨é—¨ æ˜ å°„
                    const groupToDeptMap = {};
                    members.forEach(m => {
                      if (m.group && m.department) {
                        groupToDeptMap[m.group] = m.department;
                      }
                      // ç»„åˆ«=éƒ¨é—¨å â†’ éƒ¨é—¨è´Ÿè´£äºº/éƒ¨é—¨æœ¬èº«
                      if (m.department) groupToDeptMap[m.department] = m.department;
                    });
                    
                    // æŒ‰å¤§éƒ¨é—¨åˆ†ç»„
                    const deptMap = {};
                    objs.forEach(o => {
                      const objGroup = o.department || 'æœªåˆ†é…'; // ç›®æ ‡çš„"æ‰€å±éƒ¨é—¨"å®é™…å­˜çš„æ˜¯ç»„åˆ«
                      const parentDept = groupToDeptMap[objGroup] || objGroup;
                      if (!deptMap[parentDept]) deptMap[parentDept] = {};
                      if (!deptMap[parentDept][objGroup]) deptMap[parentDept][objGroup] = [];
                      deptMap[parentDept][objGroup].push(o);
                    });
                    return deptMap;
                  })() : null;
                  
                  return (
                    <div key={lc.key} className="mb-5">
                      <div className="flex items-center gap-2 mb-2.5 pb-2" style={{borderBottom: `2px solid ${lc.key === 'å…¬å¸çº§' ? 'var(--c-accent)' : lc.key === 'éƒ¨é—¨çº§' ? 'var(--c-info)' : 'var(--c-success)'}`}}>
                        <Icon name={lc.icon} size={16} color={lc.key === "å…¬å¸çº§" ? "var(--c-accent)" : lc.key === "éƒ¨é—¨çº§" ? "var(--c-info)" : "var(--c-success)"} />
                        <span className="text-sm font-semibold" style={{color:'var(--c-text-secondary)'}}>{lc.key}</span>
                        <span className="badge badge-gray">{objs.length}</span>
                      </div>
                      {deptGroups ? (
                        Object.keys(deptGroups).sort().map(parentDept => {
                          const subGroups = deptGroups[parentDept];
                          const subKeys = Object.keys(subGroups).sort();
                          const totalInDept = subKeys.reduce((s, k) => s + subGroups[k].length, 0);
                          // åªæœ‰ä¸€ä¸ªå­ç»„ä¸”å­ç»„å=å¤§éƒ¨é—¨å â†’ ä¸éœ€è¦äºŒçº§
                          const isSingleLevel = subKeys.length === 1 && subKeys[0] === parentDept;
                          
                          return (
                            <div key={parentDept} className="mb-4">
                              {/* å¤§éƒ¨é—¨æ ‡é¢˜ */}
                              <div className="flex items-center gap-2 mb-2 ml-1">
                                <span className="text-sm font-semibold text-blue-700 bg-blue-50 px-2 py-0.5 rounded-lg">{parentDept}</span>
                                <span className="text-[10px]" style={{color:'var(--c-text-muted)'}}>{totalInDept} ä¸ªç›®æ ‡</span>
                              </div>
                              
                              {isSingleLevel ? (
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2.5 sm:gap-3 ml-1">
                                  {subGroups[subKeys[0]].map(o => renderObjectiveCard(o))}
                                </div>
                              ) : (
                                subKeys.map(groupName => {
                                  const groupObjs = subGroups[groupName];
                                  return (
                                    <div key={groupName} className="mb-3 ml-3">
                                      {/* ç»„åˆ«æ ‡é¢˜ */}
                                      <div className="flex items-center gap-2 mb-1.5">
                                        <span className="w-1.5 h-1.5 rounded-full bg-blue-400" />
                                        <span className="text-xs font-medium text-gray-600">{groupName}</span>
                                        <span className="text-[10px]" style={{color:'var(--c-text-muted)'}}>{groupObjs.length} ä¸ªç›®æ ‡</span>
                                      </div>
                                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2.5 sm:gap-3">
                                        {groupObjs.map(o => renderObjectiveCard(o))}
                                      </div>
                                    </div>
                                  );
                                })
                              )}
                            </div>
                          );
                        })
                      ) : (
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2.5 sm:gap-3">
                          {objs.map(o => renderObjectiveCard(o))}
                        </div>
                      )}
                    </div>
                  );
                });
              })()}
            </div>
          )}
        </div>
      );
    };

    // äº§å“æ€»è§ˆ
    const ProductOverview = ({ objectives = [], keyResults = [], products, nodes, nodeLayers, nodeMap, nodeToLayer, templates = {}, members, tasks, onRefresh, currentUser }) => {
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [filterStatus, setFilterStatus] = useState('all');
      const [filterPriority, setFilterPriority] = useState('all');
      const [searchProject, setSearchProject] = useState('');
      const showToast = useToast();

      // è·³è¿‡èŠ‚ç‚¹çŠ¶æ€ - ä»é¡¹ç›®æ•°æ®è¯»å–ï¼Œä¿å­˜åˆ°é£ä¹¦
      const getSkippedNodes = (productId) => {
        const product = products.find(p => p.id === productId);
        return new Set(product?.skippedNodes || []);
      };

      const setSkippedNodes = async (productId, updater) => {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        const current = new Set(product.skippedNodes || []);
        const next = typeof updater === 'function' ? updater(current) : updater;
        const newArr = [...next];
        // ç«‹å³æ›´æ–°æœ¬åœ°æ•°æ®
        product.skippedNodes = newArr;
        // ä¿å­˜åˆ°é£ä¹¦
        try {
          const res = await fetch(API_BASE + '/api/update-task', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              app_token: APP_TOKEN,
              table_id: 'tblYM02NyVj3rUkR',
              record_id: product.id,
              fields: { 'è·³è¿‡èŠ‚ç‚¹': JSON.stringify(newArr) }
            })
          });
          if (!res.ok) {
            const errText = await res.text();
            console.error('[Skip Save Error]', res.status, errText);
            showToast?.('ä¿å­˜è·³è¿‡çŠ¶æ€å¤±è´¥: ' + res.status, 'error');
          } else {
            console.log('[Skip Save OK]', productId, newArr);
          }
        } catch (e) {
          console.error('[Skip Save Error]', e);
          showToast?.('ä¿å­˜è·³è¿‡çŠ¶æ€å¤±è´¥', 'error');
        }
      };

      // è‡ªåŠ¨è®¡ç®—é¡¹ç›®è¿›åº¦ï¼ˆå…¨å±€å‡½æ•°å·²å¤„ç†çˆ¶é¡¹ç›®èšåˆï¼‰
      const getAutoProgress = (product) => calcProjectProgress(product, nodes, templates, tasks, products);
      const getAutoStatus = (product) => calcProjectStatus(product, tasks, nodes, templates, products);

      // === å¤åˆé‡è¦æ€§è¯„åˆ† - ä½¿ç”¨å…¨å±€å‡½æ•° ===
      const priorityColorMap = { 'P0': { bg: '#FEE2E2', text: '#DC2626', dot: 'ğŸ”´' }, 'P1': { bg: '#FFF7ED', text: '#EA580C', dot: 'ğŸŸ ' }, 'P2': { bg: '#EFF6FF', text: '#2563EB', dot: 'ğŸ”µ' }, 'P3': { bg: '#F3F4F6', text: '#6B7280', dot: 'âšª' } };

      const getProjectImportance = (product) => {
        const kr = keyResults.find(k => k.id === product.krId);
        const objective = kr ? objectives.find(o => o.id === kr.objectiveId) : null;
        const composite = calcProjectImportanceScore(product, objectives, keyResults);
        return { composite, kr, objective };
      };

      // ç­›é€‰
      const filteredProducts = (() => {
        let list = products;
        if (searchProject) {
          list = list.filter(p => p.name?.includes(searchProject) || p.templateType?.includes(searchProject) || p.category?.includes(searchProject) || p.ownerName?.includes(searchProject));
        }
        if (filterPriority !== 'all') {
          list = list.filter(p => p.priority === filterPriority);
        }
        if (filterStatus !== 'all') {
          if (filterStatus === 'é€¾æœŸ') {
            list = list.filter(p => {
              if (getAutoStatus(p) === 'å·²å®Œæˆ') return false;
              if (!p.targetDate) return false;
              return new Date(p.targetDate) < new Date();
            });
          } else {
            list = list.filter(p => getAutoStatus(p) === filterStatus);
          }
        }
        return list;
      })();

      // æŒ‰é‡è¦æ€§æ’åºï¼ˆå­é¡¹ç›®ä¸åœ¨ä¸»åˆ—è¡¨æ˜¾ç¤ºï¼Œåœ¨çˆ¶é¡¹ç›®å¼¹çª—å†…å±•ç¤ºï¼‰
      const sortedProducts = [...filteredProducts]
        .filter(p => !p.parentId) // æ’é™¤å­é¡¹ç›®
        .sort((a, b) => {
          const impA = getProjectImportance(a);
          const impB = getProjectImportance(b);
          return impB.composite - impA.composite;
        });

      // è‡ªåŠ¨è®¡ç®—å½“å‰é˜¶æ®µ
      const getProductAutoStage = (product) => {
        const productTasks = tasks.filter(t => t.productId === product.id);
        let lastActiveNode = null;
        for (const node of nodes) {
          const nodeTasks = productTasks.filter(t => t.stage === node.name);
          const hasActive = nodeTasks.some(t => t.status === 'è¿›è¡Œä¸­');
          const hasCompleted = nodeTasks.some(t => t.status === 'å·²å®Œæˆ');
          const hasIncomplete = nodeTasks.some(t => t.status !== 'å·²å®Œæˆ');
          if (hasActive || (hasCompleted && hasIncomplete)) {
            lastActiveNode = node.name;
          }
        }
        return lastActiveNode || product.currentStage;
      };

      // é¡¹ç›®å¡ç‰‡ï¼ˆå« OKR ä»å±é¢åŒ…å±‘ + é‡è¦æ€§åˆ†ï¼‰
      const ProjectCard = ({ product, rank }) => {
        const progress = getAutoProgress(product);
        const status = getAutoStatus(product);
        const isParent = isParentProject(product);
        const pTasks = isParent ? [] : tasks.filter(t => t.productId === product.id);
        const completedCount = pTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
        const daysRemaining = product.targetDate 
          ? Math.ceil((new Date(product.targetDate) - new Date()) / (1000 * 60 * 60 * 24))
          : null;
        const isOverdue = daysRemaining !== null && daysRemaining < 0 && status !== 'å·²å®Œæˆ';
        const ownerMember = members.find(m => m.id === product.ownerId || m.name === product.ownerName || m.larkName === product.ownerName);
        const importance = getProjectImportance(product);
        const priColor = priorityColorMap[product.priority] || priorityColorMap['P3'];

        // å­é¡¹ç›®åˆ—è¡¨
        const childProducts = isParent ? products.filter(p => product.childIds.includes(p.id)) : [];
        // çˆ¶é¡¹ç›®èšåˆä»»åŠ¡ç»Ÿè®¡
        const allChildTasks = isParent ? tasks.filter(t => childProducts.some(c => c.id === t.productId)) : [];
        const totalTaskCount = isParent ? allChildTasks.length : pTasks.length;
        const totalCompletedCount = isParent ? allChildTasks.filter(t => t.status === 'å·²å®Œæˆ').length : completedCount;

        return (
          <div className={`card ${isOverdue ? 'ring-2 ring-red-300 animate-pulse-subtle' : ''}`}
            style={{ borderLeftWidth: '3px', borderLeftColor: status === 'å·²å®Œæˆ' ? 'var(--c-success)' : isOverdue ? 'var(--c-danger)' : status === 'è¿›è¡Œä¸­' ? 'var(--c-info)' : 'var(--c-border)' }}
          >
            {/* ä¸»å¡ç‰‡å†…å®¹ï¼ˆå¯ç‚¹å‡»æ‰“å¼€å¼¹çª—ï¼‰ */}
            <div className="p-4 cursor-pointer" onClick={() => setSelectedProduct(product)}>
              {/* é¡¶éƒ¨ï¼šæ’å + OKRé¢åŒ…å±‘ */}
              <div className="flex items-center gap-2 mb-2">
                <span className="text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0" style={{
                  background: rank <= 3 ? 'linear-gradient(135deg, #F59E0B, #EF4444)' : 'var(--c-bg)',
                  color: rank <= 3 ? '#fff' : 'var(--c-text-muted)'
                }}>
                  {rank}
                </span>
                <div className="flex items-center gap-1 text-[10px] min-w-0 flex-1 overflow-hidden" style={{color:'var(--c-text-muted)'}}>
                  {importance.objective ? (
                    <>
                      <span className={`px-1 py-0.5 rounded flex-shrink-0 ${
                        importance.objective.level === 'å…¬å¸çº§' ? 'bg-purple-50 text-purple-600' :
                        importance.objective.level === 'éƒ¨é—¨çº§' ? 'bg-blue-50 text-blue-600' : 'bg-green-50 text-green-600'
                      }`}>{importance.objective.level}</span>
                      <span className="truncate">{importance.objective.name}</span>
                      <span className="flex-shrink-0">â€º</span>
                    </>
                  ) : null}
                  {importance.kr ? (
                    <span className="truncate">KR: {importance.kr.name}</span>
                  ) : (
                    <span className="text-gray-300">æœªå…³è”OKR</span>
                  )}
                </div>
              </div>

              {/* é¡¹ç›®åç§° + æ ‡ç­¾è¡Œ */}
              <div className="flex items-center gap-2.5 mb-2.5">
                <div className="flex-1 min-w-0">
                  <div className="font-semibold text-sm text-gray-800 truncate">
                    {isParent ? 'ğŸ“‚ ' : ''}{product.name}
                  </div>
                  <div className="flex items-center gap-1.5 mt-0.5 flex-wrap">
                    <span className="badge badge-gray">{product.templateType || product.category || 'æœªåˆ†ç±»'}</span>
                    <span className={`badge ${status === 'å·²å®Œæˆ' ? 'badge-green' : status === 'è¿›è¡Œä¸­' ? 'badge-blue' : 'badge-gray'}`}>{status}</span>
                    {product.priority && (
                      <span className="px-1.5 py-0.5 rounded text-[10px] font-semibold" style={{background: priColor.bg, color: priColor.text}}>
                        {product.priority}
                      </span>
                    )}
                    {importance.kr && (
                      <span className="px-1.5 py-0.5 rounded text-[10px] bg-amber-50 text-amber-700">
                        æƒé‡{importance.kr.weight || 1}
                      </span>
                    )}
                    {isParent && (
                      <span className="px-1.5 py-0.5 rounded text-[10px] bg-violet-50 text-violet-600">
                        {childProducts.length} å­é¡¹ç›®
                      </span>
                    )}
                  </div>
                </div>
                <div className="text-right flex-shrink-0">
                  <div className={`text-lg font-bold ${progress >= 100 ? 'text-green-600' : 'text-blue-600'}`}>{progress}%</div>
                  <div className="text-[10px] font-medium" style={{color: importance.composite >= 70 ? '#DC2626' : importance.composite >= 50 ? '#EA580C' : '#6B7280'}}>
                    {Math.round(importance.composite)}åˆ†
                  </div>
                </div>
              </div>
              <div className="h-1 rounded-full overflow-hidden mb-2.5" style={{background:'var(--c-border)'}}>
                <div className={`h-full rounded-full transition-all ${progress >= 100 ? 'bg-green-500' : 'bg-blue-500'}`} style={{ width: `${progress}%` }} />
              </div>
              <div className="flex items-center justify-between text-[11px]" style={{color:'var(--c-text-muted)'}}>
                <div className="flex items-center gap-2">
                  <span><Icon name="clipboard" size={11} /> {totalCompletedCount}/{totalTaskCount}</span>
                  {product.ownerName && (
                    <span className="flex items-center gap-1">
                      {ownerMember?.avatarUrl ? (
                        <img src={ownerMember.avatarUrl} className="w-3.5 h-3.5 rounded-full" alt="" />
                      ) : (
                        <span className="w-3.5 h-3.5 rounded-full flex items-center justify-center text-[9px]" style={{background:'var(--c-accent-bg)', color:'var(--c-accent)'}}>{product.ownerName.charAt(0)}</span>
                      )}
                      {product.ownerName}
                    </span>
                  )}
                </div>
                {status === 'å·²å®Œæˆ' ? (
                  <span className="badge badge-green">âœ“ å®Œæˆ</span>
                ) : isOverdue ? (
                  <span className="badge badge-red">é€¾æœŸ {Math.abs(daysRemaining)}å¤©</span>
                ) : daysRemaining !== null ? (
                  <span className="text-[11px]" style={{color:'var(--c-text-muted)'}}>å‰©ä½™ {daysRemaining} å¤©</span>
                ) : null}
              </div>
            </div>

            {/* å­é¡¹ç›®æµç¨‹å›¾æ‘˜è¦ï¼ˆçˆ¶é¡¹ç›®ï¼‰ */}
            {isParent && childProducts.length > 0 && (
              <div className="border-t px-4 py-3 cursor-pointer" style={{borderColor:'var(--c-border)'}} onClick={() => setSelectedProduct(product)}>
                {(() => {
                  // ä»æ¨¡æ¿æ„å»ºé˜¶æ®µ
                  const parentTplName = Object.values(templates).find(t => t.type === product.templateType && t.ownership === 'çˆ¶é¡¹ç›®')?.name || '';
                  const cTpls = Object.values(templates).filter(t => t.ownership === 'å­é¡¹ç›®' && t.parentTemplate === parentTplName);
                  
                  const prereqMap = {};
                  cTpls.forEach(t => { prereqMap[t.name] = t.prerequisiteNames || []; });
                  
                  const getDepth = (name, v = new Set()) => {
                    if (v.has(name)) return 0; v.add(name);
                    const deps = prereqMap[name] || [];
                    return deps.length === 0 ? 0 : 1 + Math.max(...deps.map(d => getDepth(d, new Set(v))));
                  };
                  
                  const lineDepths = {};
                  cTpls.forEach(t => { lineDepths[t.name] = getDepth(t.name); });
                  const maxDepth = Math.max(...Object.values(lineDepths), 0);
                  
                  const stages = [];
                  for (let d = 0; d <= maxDepth; d++) {
                    const linesAtDepth = cTpls.filter(t => lineDepths[t.name] === d);
                    if (linesAtDepth.length === 0) continue;
                    stages.push(linesAtDepth);
                  }
                  
                  if (stages.length === 0) return null;
                  
                  const getChild = (tpl) => childProducts.find(c => c.templateType === tpl.type);
                  const stageLabels = ['å¯åŠ¨', 'æ‰§è¡Œ', 'è½åœ°', 'æ”¶å°¾'];
                  const deptDots = { 'äº§å“ä¸­å¿ƒ': 'bg-blue-500', 'è¿è¥ä¸­å¿ƒ': 'bg-green-500', 'è®¾è®¡éƒ¨': 'bg-pink-500', 'ä¸­æ¢éƒ¨': 'bg-purple-500', 'è¥é”€æ¨å¹¿éƒ¨': 'bg-orange-500' };
                  
                  // æ‰¾å‡ºå½“å‰æ´»è·ƒé˜¶æ®µ
                  let activeStageIdx = 0;
                  for (let si = 0; si < stages.length; si++) {
                    const allDone = stages[si].every(tpl => {
                      const c = getChild(tpl);
                      return c ? (c.status === 'å·²å®Œæˆ' || calcProjectProgress(c, nodes, templates, tasks) >= 100) : false;
                    });
                    if (allDone) activeStageIdx = si + 1;
                  }
                  if (activeStageIdx >= stages.length) activeStageIdx = stages.length - 1;
                  
                  return (
                    <div>
                      {/* é˜¶æ®µè¿›åº¦æŒ‡ç¤ºå™¨ */}
                      <div className="flex items-center gap-1 mb-2">
                        {stages.map((stg, si) => {
                          const allDone = stg.every(tpl => {
                            const c = getChild(tpl);
                            return c ? (c.status === 'å·²å®Œæˆ' || calcProjectProgress(c, nodes, templates, tasks) >= 100) : false;
                          });
                          const isActive = si === activeStageIdx;
                          return (
                            <React.Fragment key={si}>
                              <div className={`flex items-center gap-1 px-1.5 py-0.5 rounded ${
                                allDone ? 'bg-green-50' : isActive ? 'bg-blue-50' : ''
                              }`}>
                                <div className={`w-4 h-4 rounded-full flex items-center justify-center text-[9px] font-bold ${
                                  allDone ? 'bg-green-500 text-white' :
                                  isActive ? 'bg-blue-500 text-white' :
                                  'bg-gray-200 text-gray-400'
                                }`}>{allDone ? 'âœ“' : si + 1}</div>
                                <span className={`text-[10px] font-medium ${
                                  allDone ? 'text-green-600' : isActive ? 'text-blue-600' : 'text-gray-400'
                                }`}>{stageLabels[si] || `S${si+1}`}</span>
                              </div>
                              {si < stages.length - 1 && (
                                <div className={`flex-1 h-px ${allDone ? 'bg-green-300' : 'bg-gray-200'}`} />
                              )}
                            </React.Fragment>
                          );
                        })}
                      </div>
                      
                      {/* å½“å‰æ´»è·ƒå­çº¿æ˜ç»†ï¼ˆæ˜¾ç¤ºè¿›è¡Œä¸­å’Œä¸‹ä¸€æ‰¹å¾…å¼€å§‹çš„ï¼‰ */}
                      <div className="flex gap-1.5 flex-wrap">
                        {(() => {
                          // æ”¶é›†æ‰€æœ‰æœªå®Œæˆçš„å­çº¿ï¼ŒæŒ‰é˜¶æ®µé¡ºåº
                          const activeLines = [];
                          for (let si = 0; si < stages.length; si++) {
                            for (const tpl of stages[si]) {
                              const child = getChild(tpl);
                              const progress = child ? calcProjectProgress(child, nodes, templates, tasks) : 0;
                              const isDone = child?.status === 'å·²å®Œæˆ' || progress >= 100;
                              if (!isDone) activeLines.push({ tpl, child, progress, stageIdx: si });
                            }
                          }
                          // å¦‚æœå…¨éƒ¨å®Œæˆï¼Œæ˜¾ç¤ºæœ€åé˜¶æ®µ
                          if (activeLines.length === 0) {
                            const lastStage = stages[stages.length - 1];
                            return lastStage.map((tpl, li) => {
                              const child = getChild(tpl);
                              const dc = deptDots[child?.responsibleDept] || 'bg-gray-400';
                              return (
                                <div key={li} className="flex items-center gap-1.5 px-2 py-1 rounded-lg border text-[10px] bg-green-50 border-green-200">
                                  <span className={`w-1.5 h-1.5 rounded-full ${dc}`} />
                                  <span className="font-medium text-gray-700">{tpl.name}</span>
                                  <span className="font-bold text-green-500">100%</span>
                                </div>
                              );
                            });
                          }
                          // æ˜¾ç¤ºæœ€é å‰é˜¶æ®µçš„æœªå®Œæˆå­çº¿ï¼ˆåŒä¸€é˜¶æ®µçš„éƒ½æ˜¾ç¤ºï¼‰
                          const firstActiveStage = activeLines[0].stageIdx;
                          const showLines = activeLines.filter(l => l.stageIdx === firstActiveStage);
                          return showLines.map(({ tpl, child, progress }, li) => {
                            const dc = deptDots[child?.responsibleDept] || 'bg-gray-400';
                            const isInProgress = progress > 0;
                            return (
                              <div key={li} className={`flex items-center gap-1.5 px-2 py-1 rounded-lg border text-[10px] ${
                                isInProgress ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-100'
                              }`}>
                                <span className={`w-1.5 h-1.5 rounded-full ${dc}`} />
                                <span className="font-medium text-gray-700">{tpl.name}</span>
                                <span className={`font-bold ${isInProgress ? 'text-blue-500' : 'text-gray-300'}`}>{progress}%</span>
                              </div>
                            );
                          });
                        })()}
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}
          </div>
        );
      };

      return (
        <div>
          {/* ç­›é€‰æ  */}
          <div className="card-flat px-3 sm:px-5 py-2.5 sm:py-3 mb-4 sm:mb-5">
            <div className="flex gap-1 items-center flex-wrap">
              {['all', 'è¿›è¡Œä¸­', 'å·²å®Œæˆ', 'é€¾æœŸ'].map(status => (
                <button
                  key={status}
                  onClick={() => setFilterStatus(status)}
                  className={`px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg text-[11px] sm:text-xs font-medium transition-all ${
                    filterStatus === status ? 'text-white shadow-sm' : 'text-gray-500 hover:text-gray-700'
                  }`}
                  style={filterStatus === status ? {background:'var(--c-accent)'} : {background:'var(--c-bg)'}}
                >
                  {status === 'all' ? `å…¨éƒ¨(${products.length})` : status}
                </button>
              ))}
              <span className="w-px h-4 bg-gray-200 mx-0.5 hidden sm:block" />
              {['all', 'P0', 'P1', 'P2', 'P3'].map(pri => (
                <button
                  key={pri}
                  onClick={() => setFilterPriority(pri)}
                  className={`px-1.5 sm:px-2 py-1 sm:py-1.5 rounded-lg text-[11px] sm:text-xs font-medium transition-all ${
                    filterPriority === pri ? 'text-white shadow-sm' : 'text-gray-500 hover:text-gray-700'
                  }`}
                  style={filterPriority === pri ? {background: pri === 'all' ? 'var(--c-accent)' : (priorityColorMap[pri]?.text || 'var(--c-accent)')} : {background:'var(--c-bg)'}}
                >
                  {pri === 'all' ? 'å…¨ç­‰çº§' : pri}
                </button>
              ))}
              <input 
                type="text" value={searchProject} onChange={e => setSearchProject(e.target.value)}
                placeholder="ğŸ” æœç´¢é¡¹ç›®..." 
                className="px-2 sm:px-3 py-1 sm:py-1.5 rounded-lg text-[11px] sm:text-xs w-28 sm:w-36 outline-none ml-0.5 sm:ml-1" style={{background:'var(--c-bg)', border:'1px solid var(--c-border)'}}
              />
            </div>
          </div>

          {/* æ’åºè¯´æ˜ */}
          <div className="text-[11px] px-1 mb-3 flex items-center gap-2" style={{color:'var(--c-text-muted)'}}>
            <Icon name="info" size={12} />
            æŒ‰é‡è¦æ€§æ’åº: ç›®æ ‡å±‚çº§(35%) + KRæƒé‡(30%) + é¡¹ç›®ä¼˜å…ˆçº§(35%)
          </div>

          {/* é¡¹ç›®å¡ç‰‡ - æŒ‰éƒ¨é—¨/ç»„åˆ«åˆ†ç»„ */}
          {(() => {
            // å»ºç«‹ ç»„åˆ«â†’å¤§éƒ¨é—¨ æ˜ å°„
            const groupToDeptMap = {};
            members.forEach(m => {
              if (m.group && m.department) groupToDeptMap[m.group] = m.department;
              if (m.department) groupToDeptMap[m.department] = m.department;
            });
            
            // æŒ‰é¡¹ç›®å…³è”çš„ç›®æ ‡å±‚çº§+éƒ¨é—¨åˆ†ç»„
            const companyProjects = [];
            const deptMap = {};  // { å¤§éƒ¨é—¨: { ç»„åˆ«: [products] } }
            const personalProjects = [];
            const unlinkedProjects = [];
            
            sortedProducts.forEach(product => {
              const imp = getProjectImportance(product);
              const obj = imp.objective;
              
              if (!obj) {
                unlinkedProjects.push(product);
              } else if (obj.level === 'å…¬å¸çº§') {
                companyProjects.push(product);
              } else if (obj.level === 'ä¸ªäººçº§') {
                personalProjects.push(product);
              } else {
                // éƒ¨é—¨çº§
                const objGroup = obj.department || 'æœªåˆ†é…';
                const parentDept = groupToDeptMap[objGroup] || objGroup;
                if (!deptMap[parentDept]) deptMap[parentDept] = {};
                if (!deptMap[parentDept][objGroup]) deptMap[parentDept][objGroup] = [];
                deptMap[parentDept][objGroup].push(product);
              }
            });
            
            // æ¯ä¸ªåˆ†ç»„å†…éƒ¨ç‹¬ç«‹ç¼–å·
            const assignGroupRank = (list) => list.forEach((p, i) => { p._rank = i + 1; });
            assignGroupRank(companyProjects);
            assignGroupRank(personalProjects);
            assignGroupRank(unlinkedProjects);
            Object.values(deptMap).forEach(subGroups => {
              Object.values(subGroups).forEach(list => assignGroupRank(list));
            });
            
            const sections = [];
            
            // å…¬å¸çº§é¡¹ç›®
            if (companyProjects.length > 0) {
              sections.push(
                <div key="company" className="mb-5">
                  <div className="flex items-center gap-2 mb-2.5 pb-2" style={{borderBottom:'2px solid var(--c-accent)'}}>
                    <Icon name="target" size={14} color="var(--c-accent)" />
                    <span className="text-sm font-semibold" style={{color:'var(--c-text-secondary)'}}>å…¬å¸çº§é¡¹ç›®</span>
                    <span className="badge badge-gray">{companyProjects.length}</span>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {companyProjects.map(p => <ProjectCard key={p.id} product={p} rank={p._rank} />)}
                  </div>
                </div>
              );
            }
            
            // éƒ¨é—¨çº§é¡¹ç›® - æŒ‰å¤§éƒ¨é—¨â†’ç»„åˆ«
            const deptKeys = Object.keys(deptMap).sort();
            if (deptKeys.length > 0) {
              sections.push(
                <div key="dept" className="mb-5">
                  <div className="flex items-center gap-2 mb-2.5 pb-2" style={{borderBottom:'2px solid var(--c-info)'}}>
                    <Icon name="folder" size={14} color="var(--c-info)" />
                    <span className="text-sm font-semibold" style={{color:'var(--c-text-secondary)'}}>éƒ¨é—¨çº§é¡¹ç›®</span>
                    <span className="badge badge-gray">{deptKeys.reduce((s, d) => s + Object.values(deptMap[d]).reduce((s2, arr) => s2 + arr.length, 0), 0)}</span>
                  </div>
                  {deptKeys.map(parentDept => {
                    const subGroups = deptMap[parentDept];
                    const subKeys = Object.keys(subGroups).sort();
                    const totalInDept = subKeys.reduce((s, k) => s + subGroups[k].length, 0);
                    const isSingleLevel = subKeys.length === 1 && subKeys[0] === parentDept;
                    
                    return (
                      <div key={parentDept} className="mb-4">
                        <div className="flex items-center gap-2 mb-2 ml-1">
                          <span className="text-sm font-semibold text-blue-700 bg-blue-50 px-2 py-0.5 rounded-lg">{parentDept}</span>
                          <span className="text-[10px]" style={{color:'var(--c-text-muted)'}}>{totalInDept} ä¸ªé¡¹ç›®</span>
                        </div>
                        {isSingleLevel ? (
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 ml-1">
                            {subGroups[subKeys[0]].map(p => <ProjectCard key={p.id} product={p} rank={p._rank} />)}
                          </div>
                        ) : (
                          subKeys.map(groupName => (
                            <div key={groupName} className="mb-3 ml-3">
                              <div className="flex items-center gap-2 mb-1.5">
                                <span className="w-1.5 h-1.5 rounded-full bg-blue-400" />
                                <span className="text-xs font-medium text-gray-600">{groupName}</span>
                                <span className="text-[10px]" style={{color:'var(--c-text-muted)'}}>{subGroups[groupName].length} ä¸ªé¡¹ç›®</span>
                              </div>
                              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                {subGroups[groupName].map(p => <ProjectCard key={p.id} product={p} rank={p._rank} />)}
                              </div>
                            </div>
                          ))
                        )}
                      </div>
                    );
                  })}
                </div>
              );
            }
            
            // ä¸ªäººçº§é¡¹ç›®
            if (personalProjects.length > 0) {
              sections.push(
                <div key="personal" className="mb-5">
                  <div className="flex items-center gap-2 mb-2.5 pb-2" style={{borderBottom:'2px solid var(--c-success)'}}>
                    <Icon name="check" size={14} color="var(--c-success)" />
                    <span className="text-sm font-semibold" style={{color:'var(--c-text-secondary)'}}>ä¸ªäººçº§é¡¹ç›®</span>
                    <span className="badge badge-gray">{personalProjects.length}</span>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {personalProjects.map(p => <ProjectCard key={p.id} product={p} rank={p._rank} />)}
                  </div>
                </div>
              );
            }
            
            // æœªå…³è”é¡¹ç›®
            if (unlinkedProjects.length > 0) {
              sections.push(
                <div key="unlinked" className="mb-5">
                  <div className="flex items-center gap-2 mb-2.5 pb-2" style={{borderBottom:'2px solid var(--c-border)'}}>
                    <Icon name="info" size={14} color="var(--c-text-muted)" />
                    <span className="text-sm font-semibold" style={{color:'var(--c-text-muted)'}}>æœªå…³è”ç›®æ ‡</span>
                    <span className="badge badge-gray">{unlinkedProjects.length}</span>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {unlinkedProjects.map(p => <ProjectCard key={p.id} product={p} rank={p._rank} />)}
                  </div>
                </div>
              );
            }
            
            return sections.length > 0 ? sections : (
              <div className="text-center text-gray-400 py-12">æš‚æ— åŒ¹é…çš„é¡¹ç›®</div>
            );
          })()}

                    {selectedProduct && (
            <ProductDetailModal
              product={selectedProduct}
              products={products}
              nodes={nodes}
              nodeLayers={nodeLayers}
              nodeMap={nodeMap}
              nodeToLayer={nodeToLayer}
              templates={templates}
              members={members}
              tasks={tasks}
              skippedNodes={getSkippedNodes(selectedProduct?.id)}
              onSkippedNodesChange={(updater) => setSkippedNodes(selectedProduct?.id, updater)}
              onClose={() => setSelectedProduct(null)}
              onRefresh={onRefresh}
              onSelectProduct={setSelectedProduct}
              viewer={currentUser}
            />
          )}
        </div>
      );
    };

    // äººå‘˜ä»»åŠ¡å¡ç‰‡
    const MemberTaskCard = ({ member, tasks, products }) => {
      const memberTasks = tasks.filter(t => t.assignee === member.id || t.assigneeName === member.name);
      const completedCount = memberTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
      const inProgressCount = memberTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
      const completionRate = memberTasks.length > 0 ? Math.round((completedCount / memberTasks.length) * 100) : 0;

      return (
        <div className="bg-white rounded-xl card-shadow overflow-hidden">
          <div className={`${member.color} p-4 text-white`}>
            <div className="flex items-center gap-3">
              {/* ä¼˜å…ˆä½¿ç”¨é£ä¹¦å¤´åƒï¼Œæ— åˆ™ä½¿ç”¨ emoji */}
              {member.avatarUrl ? (
                <img 
                  src={member.avatarUrl} 
                  alt={member.name}
                  className="w-12 h-12 rounded-full object-cover border-2 border-white/30"
                />
              ) : (
                <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-2xl">
                  {member.avatar}
                </div>
              )}
              <div>
                <div className="font-bold text-lg">{member.name}</div>
                <div className="text-white/80 text-sm">{member.position}</div>
                <div className="flex gap-2 mt-1">
                  <span className="text-white/60 text-xs bg-white/20 px-1.5 py-0.5 rounded">{member.department}</span>
                  <span className="text-white/60 text-xs bg-white/20 px-1.5 py-0.5 rounded">{member.group}</span>
                </div>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-3 divide-x border-b">
            <div className="p-3 text-center">
              <div className="text-xl font-bold text-gray-800">{memberTasks.length}</div>
              <div className="text-xs text-gray-500">æ€»ä»»åŠ¡</div>
            </div>
            <div className="p-3 text-center">
              <div className="text-xl font-bold text-blue-600">{inProgressCount}</div>
              <div className="text-xs text-gray-500">è¿›è¡Œä¸­</div>
            </div>
            <div className="p-3 text-center">
              <div className="text-xl font-bold text-green-600">{completedCount}</div>
              <div className="text-xs text-gray-500">å·²å®Œæˆ</div>
            </div>
          </div>

          <div className="px-4 py-3">
            <div className="flex items-center justify-between text-sm mb-1">
              <span className="text-gray-500">å®Œæˆç‡</span>
              <span className="font-medium">{completionRate}%</span>
            </div>
            <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
              <div className={`h-full ${member.color} rounded-full`} style={{ width: `${completionRate}%` }} />
            </div>
          </div>

          <div className="p-4 max-h-48 overflow-y-auto border-t">
            {memberTasks.slice(0, 5).map(task => {
              const product = products.find(p => p.id === task.productId);
              return (
                <div key={task.id} className="flex items-center justify-between py-2 border-b last:border-0">
                  <div className="flex-1 min-w-0">
                    <div className="text-sm text-gray-800 truncate">{task.name}</div>
                    <div className="text-xs text-gray-400">{product?.name}</div>
                  </div>
                  <span className={`text-xs px-2 py-0.5 rounded ml-2 ${
                    task.status === 'å·²å®Œæˆ' ? 'bg-green-100 text-green-600' :
                    task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-100 text-blue-600' :
                    'bg-gray-100 text-gray-500'
                  }`}>
                    {task.status}
                  </span>
                </div>
              );
            })}
            {memberTasks.length === 0 && (
              <div className="text-center text-gray-400 py-4">æš‚æ— ä»»åŠ¡</div>
            )}
          </div>
        </div>
      );
    };

    // äººå‘˜ä»»åŠ¡æ€»è§ˆ - éƒ¨é—¨ä¸€çº§ + ç»„åˆ«äºŒçº§ç­›é€‰
    const TeamTaskOverview = ({ members, tasks, products, objectives = [], keyResults = [], groups, nodes = [], templates = {}, onRefresh }) => {
      const [filterDept, setFilterDept] = useState('all');
      const [filterGroup, setFilterGroup] = useState('all');
      const [showAll, setShowAll] = useState(false);
      const [expandedMember, setExpandedMember] = useState(null);
      const [detailMember, setDetailMember] = useState(null);
      const [searchName, setSearchName] = useState('');
      const [sortBy, setSortBy] = useState('overdue');
      const showToast = useToast();
      const currentUser = useContext(UserContext);

      // è¯»å–è·³è¿‡èŠ‚ç‚¹æ•°æ®ï¼ˆä»é¡¹ç›®æ•°æ®è¯»å–ï¼Œä¸ ProductOverview å…±äº«ï¼‰
      const getSkippedNodes = (productId) => {
        const product = products.find(p => p.id === productId);
        return new Set(product?.skippedNodes || []);
      };
      
      // å®Œæˆä»»åŠ¡å¼¹çª—çŠ¶æ€
      const [completeTask, setCompleteTask] = React.useState(null);
      const [outputFile, setOutputFile] = React.useState(null);
      const [isSubmitting, setIsSubmitting] = React.useState(false);

      const departments = [...new Set(members.map(m => m.department).filter(d => d))];
      const availableGroups = filterDept === 'all' 
        ? groups 
        : [...new Set(members.filter(m => m.department === filterDept).map(m => m.group).filter(g => g))];

      const handleDeptChange = (dept) => {
        setFilterDept(dept);
        setFilterGroup('all');
      };

      const now = new Date();

      // ä¸ºæ¯ä¸ªæˆå‘˜è®¡ç®—ä»»åŠ¡ç»Ÿè®¡ï¼ˆå«å¾…å¼€å§‹å’Œé€¾æœŸï¼‰
      const membersWithStats = members.map(member => {
        const memberTasks = tasks.filter(t => t.assignee === member.id || t.assigneeName === member.name);
        const completed = memberTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
        const inProgress = memberTasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
        const pending = memberTasks.filter(t => t.status !== 'å·²å®Œæˆ' && t.status !== 'è¿›è¡Œä¸­').length;
        const overdue = memberTasks.filter(t => {
          if (t.status === 'å·²å®Œæˆ') return false;
          if (!t.dueDate) return false;
          return new Date(t.dueDate) < now;
        }).length;
        const rate = memberTasks.length > 0 ? Math.round((completed / memberTasks.length) * 100) : 0;
        
        // === æ—¶é—´åŠ æƒè´Ÿè·è®¡ç®— ===
        const activeTasks = memberTasks.filter(t => t.status !== 'å·²å®Œæˆ');
        const priorityWeight = { 'P0': 1.5, 'P1': 1.2, 'P2': 1.0, 'P3': 0.8 };
        
        // è®¡ç®—æ¯æ—¥å¹¶è¡Œä»»åŠ¡åŠ æƒæ•°ï¼ˆä»ä»Šå¤©åˆ°æœ€æ™šæˆªæ­¢æ—¥ï¼‰
        let workloadIndex = 0;
        let peakLoad = 0;
        let dailyLoads = [];
        
        if (activeTasks.length > 0) {
          const today = new Date(); today.setHours(0,0,0,0);
          
          // æ‰¾æœ€æ™šæˆªæ­¢æ—¥
          const dueDates = activeTasks.filter(t => t.dueDate).map(t => { const d = new Date(t.dueDate); d.setHours(0,0,0,0); return d; });
          
          // æœ€æ™šæˆªæ­¢æ—¥ï¼Œå¦‚æœå…¨éƒ¨æ— æˆªæ­¢æ—¥åˆ™çœ‹æœªæ¥14å¤©
          let endDate;
          if (dueDates.length > 0) {
            endDate = new Date(Math.max(...dueDates));
            // è‡³å°‘çœ‹7å¤©
            const min7 = new Date(today); min7.setDate(min7.getDate() + 7);
            if (endDate < min7) endDate = min7;
          } else {
            endDate = new Date(today); endDate.setDate(endDate.getDate() + 14);
          }
          
          const totalDays = Math.max(1, Math.ceil((endDate - today) / 86400000) + 1);
          
          // éå†æ¯ä¸€å¤©ï¼Œè®¡ç®—è¯¥å¤©çš„åŠ æƒå¹¶è¡Œä»»åŠ¡æ•°
          for (let d = 0; d < totalDays; d++) {
            const checkDate = new Date(today); checkDate.setDate(checkDate.getDate() + d);
            let dayLoad = 0;
            
            activeTasks.forEach(t => {
              // ä»»åŠ¡çš„æ—¶é—´èŒƒå›´ï¼šå¼€å§‹æ—¥æœŸ > é¢„è®¡å¼€å§‹æ—¥æœŸ > ä»Šå¤©
              let startD = t.startDate ? new Date(t.startDate) : t.plannedStartDate ? new Date(t.plannedStartDate) : new Date(today);
              startD.setHours(0,0,0,0);
              if (startD < today) startD = new Date(today);
              
              let endD = t.dueDate ? new Date(t.dueDate) : new Date(endDate);
              endD.setHours(0,0,0,0);
              // å·²é€¾æœŸçš„ä»»åŠ¡ï¼šåˆ°æœŸæ—¥å·²è¿‡ï¼Œä½†ä»æœªå®Œæˆï¼Œç®—åˆ°ä»Šå¤©
              if (endD < today) endD = new Date(today);
              
              if (checkDate >= startD && checkDate <= endD) {
                const pw = priorityWeight[t.priority] || 1.0;
                dayLoad += pw;
              }
            });
            
            dailyLoads.push(Math.round(dayLoad * 10) / 10);
            if (dayLoad > peakLoad) peakLoad = dayLoad;
          }
          
          // å¹³å‡æ—¥è´Ÿè·
          workloadIndex = dailyLoads.length > 0 ? Math.round((dailyLoads.reduce((s,v) => s+v, 0) / dailyLoads.length) * 10) / 10 : 0;
          peakLoad = Math.round(peakLoad * 10) / 10;
        }
        
        // è´Ÿè·ç­‰çº§
        let workloadLevel, workloadColor, workloadLabel;
        if (peakLoad <= 0) {
          workloadLevel = 'idle'; workloadColor = 'text-gray-400'; workloadLabel = 'ç©ºé—²';
        } else if (peakLoad <= 2) {
          workloadLevel = 'light'; workloadColor = 'text-green-600'; workloadLabel = 'è½»æ¾';
        } else if (peakLoad <= 4) {
          workloadLevel = 'normal'; workloadColor = 'text-blue-600'; workloadLabel = 'æ­£å¸¸';
        } else if (peakLoad <= 6) {
          workloadLevel = 'heavy'; workloadColor = 'text-orange-600'; workloadLabel = 'è¾ƒé‡';
        } else {
          workloadLevel = 'overload'; workloadColor = 'text-red-600'; workloadLabel = 'è¶…è´Ÿè·';
        }
        
        // æŒ‰ç»¼åˆç´§æ€¥åº¦æ’åºï¼šé€¾æœŸä¼˜å…ˆï¼Œç„¶åæŒ‰ç´§æ€¥åº¦è¯„åˆ†é™åºï¼Œå·²å®Œæˆæ’æœ€å
        const sortedTasks = [...memberTasks].sort((a, b) => {
          // å·²å®Œæˆçš„æ°¸è¿œæ’æœ€å
          if (a.status === 'å·²å®Œæˆ' && b.status !== 'å·²å®Œæˆ') return 1;
          if (b.status === 'å·²å®Œæˆ' && a.status !== 'å·²å®Œæˆ') return -1;
          if (a.status === 'å·²å®Œæˆ' && b.status === 'å·²å®Œæˆ') return 0;
          // æœªå®Œæˆä»»åŠ¡æŒ‰ç»¼åˆç´§æ€¥åº¦è¯„åˆ†
          const urgA = calcTaskUrgencyScore(a, products, objectives, keyResults);
          const urgB = calcTaskUrgencyScore(b, products, objectives, keyResults);
          return urgB.composite - urgA.composite;
        });
        
        return { ...member, memberTasks: sortedTasks, total: memberTasks.length, completed, inProgress, pending, overdue, rate,
          workloadIndex, peakLoad, workloadLevel, workloadColor, workloadLabel, dailyLoads };
      });

      // ç­›é€‰
      let filtered = membersWithStats.filter(m => {
        const deptMatch = filterDept === 'all' || m.department === filterDept;
        const groupMatch = filterGroup === 'all' || m.group === filterGroup;
        const nameMatch = !searchName || m.name?.includes(searchName) || m.larkName?.includes(searchName);
        return deptMatch && groupMatch && nameMatch;
      });

      const activeMembers = filtered.filter(m => m.total > 0);
      const inactiveMembers = filtered.filter(m => m.total === 0);
      const displayMembers = showAll ? [...activeMembers, ...inactiveMembers] : activeMembers;
      
      // æ’åº
      const sortFns = {
        overdue: (a, b) => b.overdue - a.overdue || b.inProgress - a.inProgress || b.total - a.total,
        total: (a, b) => b.total - a.total || b.overdue - a.overdue,
        workload: (a, b) => b.peakLoad - a.peakLoad || b.workloadIndex - a.workloadIndex || b.total - a.total,
        rate: (a, b) => a.rate - b.rate || b.total - a.total,
        name: (a, b) => (a.name || '').localeCompare(b.name || '', 'zh-CN')
      };
      displayMembers.sort(sortFns[sortBy] || sortFns.overdue);

      // äººå‡ä»»åŠ¡æ•°
      const avgTasks = activeMembers.length > 0 ? (filtered.reduce((s, m) => s + m.total, 0) / activeMembers.length) : 0;

      // æ±‡æ€»ç»Ÿè®¡
      const totalActive = activeMembers.length;
      const totalTasks = filtered.reduce((s, m) => s + m.total, 0);
      const totalInProgress = filtered.reduce((s, m) => s + m.inProgress, 0);
      const totalCompleted = filtered.reduce((s, m) => s + m.completed, 0);
      const totalPending = filtered.reduce((s, m) => s + m.pending, 0);
      const totalOverdue = filtered.reduce((s, m) => s + m.overdue, 0);

      // å·¥ä½œé‡æ¡å½¢å›¾ - å¸¦è´Ÿè·çƒ­åŠ›æŒ‡ç¤º
      const WorkloadBar = ({ member }) => {
        if (member.total === 0) return <div className="h-2 bg-gray-100 rounded-full" />;
        const cW = (member.completed / member.total) * 100;
        const iW = (member.inProgress / member.total) * 100;
        const pW = (member.pending / member.total) * 100;
        
        // è´Ÿè·ç­‰çº§é¢œè‰²æ˜ å°„
        const levelBg = { idle: 'bg-gray-100', light: 'bg-green-50', normal: 'bg-blue-50', heavy: 'bg-orange-50', overload: 'bg-red-50' };
        const levelBorder = { idle: '', light: '', normal: '', heavy: 'border border-orange-200', overload: 'border border-red-200' };
        const levelEmoji = { idle: 'Â·', light: 'â—', normal: 'â—', heavy: 'â—', overload: 'â—' };
        
        return (
          <div className={`rounded-lg p-1.5 ${levelBg[member.workloadLevel]} ${levelBorder[member.workloadLevel]}`}>
            <div className="flex h-2 rounded-full overflow-hidden bg-gray-100/80" title={`å·²å®Œæˆ ${member.completed} | è¿›è¡Œä¸­ ${member.inProgress} | å¾…å¼€å§‹ ${member.pending}`}>
              {cW > 0 && <div className="bg-green-500 transition-all" style={{ width: `${cW}%` }} />}
              {iW > 0 && <div className="bg-blue-500 transition-all" style={{ width: `${iW}%` }} />}
              {pW > 0 && <div className="bg-gray-300 transition-all" style={{ width: `${pW}%` }} />}
            </div>
            <div className="flex items-center justify-between mt-1">
              <div className="flex items-center gap-1.5">
                <div className="flex items-center gap-0.5 text-[10px] text-gray-400">
                  <span className="w-1.5 h-1.5 rounded-full bg-green-500 inline-block" />{member.completed}
                </div>
                <div className="flex items-center gap-0.5 text-[10px] text-gray-400">
                  <span className="w-1.5 h-1.5 rounded-full bg-blue-500 inline-block" />{member.inProgress}
                </div>
                <div className="flex items-center gap-0.5 text-[10px] text-gray-400">
                  <span className="w-1.5 h-1.5 rounded-full bg-gray-300 inline-block" />{member.pending}
                </div>
              </div>
              <div className={`text-[10px] font-medium ${member.workloadColor}`} title={`å³°å€¼è´Ÿè·: ${member.peakLoad} | å¹³å‡è´Ÿè·: ${member.workloadIndex}`}>
                {levelEmoji[member.workloadLevel]} {member.workloadLabel}
                {member.peakLoad > 0 && <span className="text-gray-400 ml-0.5">({member.peakLoad})</span>}
              </div>
            </div>
          </div>
        );
      };

      return (
        <div>
          {/* ç­›é€‰æ  */}
          <div className="card-flat flex items-center gap-1.5 sm:gap-2 px-3 sm:px-5 py-2.5 sm:py-3 mb-4 flex-wrap">
            <select value={filterDept} onChange={e => handleDeptChange(e.target.value)}
              className="px-2.5 py-1 rounded-lg text-xs outline-none" style={{background:'var(--c-bg)', border:'1px solid var(--c-border)'}}>
              <option value="all">å…¨éƒ¨éƒ¨é—¨</option>
              {departments.map(d => <option key={d} value={d}>{d}</option>)}
            </select>
            <select value={filterGroup} onChange={e => setFilterGroup(e.target.value)}
              className="px-2.5 py-1 rounded-lg text-xs outline-none" style={{background:'var(--c-bg)', border:'1px solid var(--c-border)'}}>
              <option value="all">å…¨éƒ¨ç»„åˆ«</option>
              {availableGroups.map(g => <option key={g} value={g}>{g}</option>)}
            </select>
            <input 
              type="text" value={searchName} onChange={e => setSearchName(e.target.value)}
              placeholder="ğŸ” æœç´¢æˆå‘˜..." 
              className="px-2.5 py-1 rounded-lg text-xs w-32 outline-none" style={{background:'var(--c-bg)', border:'1px solid var(--c-border)'}}
            />
            <select value={sortBy} onChange={e => setSortBy(e.target.value)}
              className="px-2.5 py-1 rounded-lg text-xs outline-none" style={{background:'var(--c-bg)', border:'1px solid var(--c-border)'}}>
              <option value="overdue">æŒ‰é€¾æœŸæ’åº</option>
              <option value="workload">æŒ‰è´Ÿè·æ’åº</option>
              <option value="total">æŒ‰ä»»åŠ¡é‡æ’åº</option>
              <option value="rate">æŒ‰å®Œæˆç‡æ’åº</option>
              <option value="name">æŒ‰å§“åæ’åº</option>
            </select>
            <label className="flex items-center gap-1.5 text-xs cursor-pointer ml-auto" style={{color:'var(--c-text-muted)'}}>
              <input type="checkbox" checked={showAll} onChange={e => setShowAll(e.target.checked)} className="rounded" />
              æ˜¾ç¤ºæ— ä»»åŠ¡æˆå‘˜
            </label>
          </div>

          {/* æ±‡æ€»æ¡ - 6æ ¼ */}
          <div className="grid grid-cols-3 sm:grid-cols-6 gap-2 sm:gap-3 mb-4">
            <div className="stat-card purple text-center">
              <div className="text-lg sm:text-xl font-bold text-gray-800">{totalActive}</div>
              <div className="text-[10px] sm:text-[11px]" style={{color:'var(--c-text-muted)'}}>æ´»è·ƒæˆå‘˜</div>
              <div className="text-[9px] sm:text-[10px]" style={{color:'var(--c-text-muted)'}}>äººå‡ {avgTasks.toFixed(1)}</div>
            </div>
            <div className="stat-card blue text-center">
              <div className="text-lg sm:text-xl font-bold text-gray-800">{totalTasks}</div>
              <div className="text-[10px] sm:text-[11px]" style={{color:'var(--c-text-muted)'}}>æ€»ä»»åŠ¡</div>
            </div>
            <div className="stat-card indigo text-center">
              <div className="text-lg sm:text-xl font-bold text-blue-600">{totalInProgress}</div>
              <div className="text-[10px] sm:text-[11px]" style={{color:'var(--c-text-muted)'}}>è¿›è¡Œä¸­</div>
            </div>
            <div className="stat-card blue text-center">
              <div className="text-lg sm:text-xl font-bold text-gray-500">{totalPending}</div>
              <div className="text-[10px] sm:text-[11px]" style={{color:'var(--c-text-muted)'}}>å¾…å¼€å§‹</div>
            </div>
            <div className="stat-card green text-center">
              <div className="text-lg sm:text-xl font-bold text-green-600">{totalCompleted}</div>
              <div className="text-[10px] sm:text-[11px]" style={{color:'var(--c-text-muted)'}}>å·²å®Œæˆ</div>
            </div>
            <div className={`stat-card ${totalOverdue > 0 ? 'red' : 'green'} text-center`}>
              <div className={`text-lg sm:text-xl font-bold ${totalOverdue > 0 ? 'text-red-600' : 'text-gray-400'}`}>{totalOverdue}</div>
              <div className="text-[10px] sm:text-[11px]" style={{color:'var(--c-text-muted)'}}>é€¾æœŸä»»åŠ¡</div>
            </div>
          </div>

          {/* æˆå‘˜å¡ç‰‡ç½‘æ ¼ */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {displayMembers.map(member => {
              const isExpanded = expandedMember === member.id;
              return (
                <div key={member.id} className={`card-flat overflow-hidden transition-all ${member.total === 0 ? 'opacity-50' : ''}`}>
                  {/* å¡ç‰‡å¤´éƒ¨ */}
                  <div className="flex items-center gap-3 px-4 py-3 cursor-pointer hover:bg-gray-50 transition-colors"
                    onClick={() => member.total > 0 && setExpandedMember(isExpanded ? null : member.id)}>
                    {member.avatarUrl ? (
                      <img src={member.avatarUrl} className="w-10 h-10 rounded-full" alt="" />
                    ) : (
                      <span className={`w-10 h-10 ${member.color} rounded-full flex items-center justify-center text-white text-sm`}>
                        {member.avatar}
                      </span>
                    )}
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span className="font-semibold text-sm text-gray-800 cursor-pointer hover:text-blue-600"
                          onClick={(e) => { e.stopPropagation(); if (member.total > 0) setDetailMember(member); }}
                        >{member.name}</span>
                        <span className="text-[10px] text-gray-400">{member.position}</span>
                      </div>
                      <div className="flex items-center gap-1 mt-0.5">
                        <span className="px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px]">{member.department}</span>
                        {member.group && <span className="px-1.5 py-0.5 bg-purple-50 text-purple-600 rounded text-[10px]">{member.group}</span>}
                      </div>
                    </div>
                    {member.total > 0 && (
                      <span className="text-gray-400 text-xs">{isExpanded ? 'â–¼' : 'â–¶'}</span>
                    )}
                  </div>
                  
                  {/* ç»Ÿè®¡æ¡ */}
                  <div className="grid grid-cols-5 divide-x border-t border-b" style={{background:'var(--c-bg)'}}>
                    <div className="py-2 text-center">
                      <div className="text-sm font-bold text-gray-700">{member.total || '-'}</div>
                      <div className="text-[10px] text-gray-400">å…¨éƒ¨</div>
                    </div>
                    <div className="py-2 text-center">
                      <div className="text-sm font-bold text-blue-600">{member.inProgress || '-'}</div>
                      <div className="text-[10px] text-gray-400">è¿›è¡Œ</div>
                    </div>
                    <div className="py-2 text-center">
                      <div className="text-sm font-bold text-gray-500">{member.pending || '-'}</div>
                      <div className="text-[10px] text-gray-400">å¾…å§‹</div>
                    </div>
                    <div className="py-2 text-center">
                      <div className="text-sm font-bold text-green-600">{member.completed || '-'}</div>
                      <div className="text-[10px] text-gray-400">å®Œæˆ</div>
                    </div>
                    <div className="py-2 text-center">
                      {member.overdue > 0 ? (
                        <div className="text-sm font-bold text-red-600">{member.overdue}</div>
                      ) : (
                        <div className="text-sm font-bold text-gray-300">-</div>
                      )}
                      <div className="text-[10px] text-gray-400">é€¾æœŸ</div>
                    </div>
                  </div>
                  
                  {/* å·¥ä½œé‡æ¡ */}
                  <div className="px-4 py-2">
                    <WorkloadBar member={member} />
                  </div>
                  
                  {/* å±•å¼€ä»»åŠ¡è¯¦æƒ… */}
                  {isExpanded && member.total > 0 && (() => {
                    const overdueTasks = member.memberTasks.filter(t => t.status !== 'å·²å®Œæˆ' && t.dueDate && new Date(t.dueDate) < now);
                    const inProgressTasks = member.memberTasks.filter(t => t.status === 'è¿›è¡Œä¸­' && !(t.dueDate && new Date(t.dueDate) < now));
                    const pendingTasks = member.memberTasks.filter(t => t.status !== 'å·²å®Œæˆ' && t.status !== 'è¿›è¡Œä¸­' && !(t.dueDate && new Date(t.dueDate) < now));
                    const completedTasks = member.memberTasks.filter(t => t.status === 'å·²å®Œæˆ');
                    
                    const TaskItem = ({ task, isOverdue }) => {
                      const product = products.find(p => p.id === task.productId);
                      let timeTag = null;
                      const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                      
                      if (task.status === 'å·²å®Œæˆ') {
                        const doneDate = task.completeDate ? new Date(task.completeDate) : null;
                        if (dueDate && doneDate) {
                          const diffDays = Math.ceil((dueDate - doneDate) / (1000*60*60*24));
                          if (diffDays >= 0) {
                            timeTag = { text: diffDays === 0 ? 'æŒ‰æ—¶' : `æå‰${diffDays}å¤©`, cls: 'bg-green-50 text-green-600' };
                          } else {
                            timeTag = { text: `é€¾æœŸ${Math.abs(diffDays)}å¤©`, cls: 'bg-orange-50 text-orange-600' };
                          }
                        }
                      } else if (dueDate) {
                        const diffDays = Math.ceil((dueDate - now) / (1000*60*60*24));
                        if (diffDays < 0) timeTag = { text: `é€¾æœŸ${Math.abs(diffDays)}å¤©`, cls: 'bg-red-100 text-red-600 font-medium' };
                        else if (diffDays <= 2) timeTag = { text: diffDays === 0 ? 'ä»Šå¤©æˆªæ­¢' : `å‰©${diffDays}å¤©`, cls: 'bg-yellow-50 text-yellow-700' };
                        else timeTag = { text: `å‰©${diffDays}å¤©`, cls: 'bg-gray-50 text-gray-400' };
                      }
                      
                      // å¿«æ·æ“ä½œ
                      const taskProduct = products.find(p => p.id === task.productId);
                      const taskNodes = taskProduct ? getNodesForProduct(taskProduct, nodes, templates) : [];
                      const taskNode = taskNodes.find(n => n.name === task.stage);
                      const productSkipped = taskProduct ? getSkippedNodes(taskProduct.id) : new Set();
                      
                      const checkPredecessor = () => {
                        if (!taskNode || !taskNode.prevNode) return { canAccept: true };
                        const prevNodeName = taskNode.prevNode;
                        if (productSkipped.has(prevNodeName)) return { canAccept: true };
                        const productTasks = tasks.filter(t => t.productId === task.productId);
                        const prevNodeTasks = productTasks.filter(t => t.stage === prevNodeName);
                        if (prevNodeTasks.length === 0) return { canAccept: false, message: `å‰ç½®èŠ‚ç‚¹ã€Œ${prevNodeName}ã€è¿˜æ²¡æœ‰åˆ›å»ºä»»åŠ¡` };
                        const unfinished = prevNodeTasks.filter(t => t.status !== 'å·²å®Œæˆ');
                        if (unfinished.length > 0) return { canAccept: false, message: `å‰ç½®èŠ‚ç‚¹ã€Œ${prevNodeName}ã€è¿˜æœ‰ ${unfinished.length} ä¸ªä»»åŠ¡æœªå®Œæˆ` };
                        return { canAccept: true };
                      };
                      
                      const predecessorStatus = checkPredecessor();
                      
                      const handleQuickAction = async (e, action) => {
                        e.stopPropagation();
                        if (action === 'è¿›è¡Œä¸­') {
                          if (!predecessorStatus.canAccept) {
                            showToast?.(predecessorStatus.message, 'error');
                            return;
                          }
                        }
                        if (action === 'å·²å®Œæˆ') {
                          setCompleteTask(task);
                          return;
                        }
                        try {
                          const res = await fetch(API_BASE + '/api/update-task', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                              app_token: APP_TOKEN,
                              table_id: 'tblFwmxmjRJPzVmV',
                              record_id: task.id,
                              fields: { status: action, ...(action === 'è¿›è¡Œä¸­' ? { startDate: new Date().toISOString().split('T')[0] } : {}) }
                            })
                          });
                          const result = await res.json();
                          if (result.success) { onRefresh?.(); showToast?.('çŠ¶æ€å·²æ›´æ–°'); }
                          else throw new Error(result.error);
                        } catch (err) { showToast?.('æ“ä½œå¤±è´¥: ' + err.message, 'error'); }
                      };
                      
                      return (
                        <div className={`flex items-center gap-2 py-1.5 px-2 rounded-lg text-xs ${isOverdue ? 'bg-red-50' : 'hover:bg-gray-50'}`}>
                          <span className={`w-1.5 h-1.5 rounded-full flex-shrink-0 ${task.status === 'å·²å®Œæˆ' ? 'bg-green-500' : task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500' : 'bg-gray-300'}`} />
                          <span className="truncate flex-1 text-gray-700">{task.name}</span>
                          {product && <span className="text-[10px] text-gray-400 truncate max-w-[60px]">{product.name}</span>}
                          {timeTag && <span className={`text-[10px] px-1 py-0.5 rounded whitespace-nowrap ${timeTag.cls}`}>{timeTag.text}</span>}
                          {/* å¿«æ·æ“ä½œæŒ‰é’® */}
                          {task.status === 'å¾…å¼€å§‹' && (
                            <button onClick={(e) => handleQuickAction(e, 'è¿›è¡Œä¸­')}
                              className={`text-[10px] px-1.5 py-0.5 rounded whitespace-nowrap ${predecessorStatus.canAccept ? 'bg-blue-50 text-blue-600 hover:bg-blue-100' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}`}
                              title={predecessorStatus.canAccept ? 'å¼€å§‹ä»»åŠ¡' : predecessorStatus.message}
                            >â–¶ å¼€å§‹</button>
                          )}
                          {task.status === 'è¿›è¡Œä¸­' && (
                            <button onClick={(e) => handleQuickAction(e, 'å·²å®Œæˆ')}
                              className="text-[10px] px-1.5 py-0.5 rounded bg-green-50 text-green-600 hover:bg-green-100 whitespace-nowrap"
                            >âœ“ å®Œæˆ</button>
                          )}
                        </div>
                      );
                    };
                    
                    return (
                      <div className="border-t px-3 py-2 space-y-2 max-h-64 overflow-y-auto" style={{background:'var(--c-bg)'}}>
                        {overdueTasks.length > 0 && (
                          <div>
                            <div className="text-[10px] font-medium text-red-600 mb-1">ğŸš¨ é€¾æœŸ ({overdueTasks.length})</div>
                            {overdueTasks.map(t => <TaskItem key={t.id} task={t} isOverdue={true} />)}
                          </div>
                        )}
                        {inProgressTasks.length > 0 && (
                          <div>
                            <div className="text-[10px] font-medium text-blue-600 mb-1">ğŸ”µ è¿›è¡Œä¸­ ({inProgressTasks.length})</div>
                            {inProgressTasks.map(t => <TaskItem key={t.id} task={t} isOverdue={false} />)}
                          </div>
                        )}
                        {pendingTasks.length > 0 && (
                          <div>
                            <div className="text-[10px] font-medium text-gray-500 mb-1">â³ å¾…å¼€å§‹ ({pendingTasks.length})</div>
                            {pendingTasks.map(t => <TaskItem key={t.id} task={t} isOverdue={false} />)}
                          </div>
                        )}
                        {completedTasks.length > 0 && (
                          <details className="group">
                            <summary className="text-[10px] font-medium text-green-600 mb-1 cursor-pointer list-none flex items-center gap-1">
                              <span className="group-open:rotate-90 transition-transform inline-block">â–¶</span>
                              âœ… å·²å®Œæˆ ({completedTasks.length})
                            </summary>
                            <div className="mt-1">
                              {completedTasks.map(t => <TaskItem key={t.id} task={t} isOverdue={false} />)}
                            </div>
                          </details>
                        )}
                      </div>
                    );
                  })()}
                </div>
              );
            })}
          </div>
          {displayMembers.length === 0 && (
            <div className="text-center text-gray-400 py-12">
              {showAll ? 'æš‚æ— æˆå‘˜æ•°æ®' : 'æš‚æ— æœ‰ä»»åŠ¡çš„æˆå‘˜ï¼Œå‹¾é€‰ã€Œæ˜¾ç¤ºæ— ä»»åŠ¡æˆå‘˜ã€æŸ¥çœ‹å…¨éƒ¨'}
            </div>
          )}
          
          {/* å®Œæˆä»»åŠ¡å¼¹çª— - éœ€è¦ä¸Šä¼ æ–‡ä»¶ */}
          {completeTask && (
            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => { setCompleteTask(null); }}>
              <div className="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4" onClick={e => e.stopPropagation()}>
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-gray-800">âœ… å®Œæˆä»»åŠ¡</h3>
                  <button onClick={() => { setCompleteTask(null); }} className="text-gray-400 hover:text-gray-600 text-xl">âœ•</button>
                </div>
                
                <div className="bg-gray-50 rounded-xl p-3 mb-4">
                  <div className="font-medium text-gray-800">{completeTask.name}</div>
                  <div className="text-xs text-gray-500 mt-1">
                    {completeTask.stage && <span className="mr-2">{completeTask.stage}</span>}
                    {completeTask.priority && <span className="mr-2">âš¡ {completeTask.priority}</span>}
                  </div>
                </div>
                
                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    ğŸ”— ç²˜è´´äº¤ä»˜é“¾æ¥
                  </label>
                  <input
                    type="url"
                    value={outputLink}
                    onChange={e => setOutputLink(e.target.value)}
                    className="w-full px-3 py-2.5 border rounded-xl text-sm focus:ring-2 focus:ring-green-300 outline-none"
                    placeholder="ç²˜è´´é£ä¹¦æ–‡æ¡£é“¾æ¥ã€ç½‘ç›˜åœ°å€ç­‰..."
                    autoFocus
                  />
                </div>
                
                <div className="flex gap-3">
                  <button
                    onClick={() => { setCompleteTask(null); setOutputLink(''); }}
                    className="flex-1 py-2 px-4 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl transition-colors"
                  >
                    å–æ¶ˆ
                  </button>
                  <button
                    onClick={async () => {
                      if (!outputLink.trim()) {
                        showToast?.('è¯·ç²˜è´´äº¤ä»˜é“¾æ¥', 'error');
                        return;
                      }
                      setIsSubmitting(true);
                      try {
                        const res = await fetch(API_BASE + '/api/update-task', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            app_token: APP_TOKEN,
                            table_id: 'tblFwmxmjRJPzVmV',
                            record_id: completeTask.id,
                            fields: {
                              status: 'å·²å®Œæˆ',
                              completeDate: new Date().toISOString().split('T')[0],
                              outputUrl: outputLink.trim()
                            }
                          })
                        });
                        const result = await res.json();
                        if (result.success) {
                          showToast?.('ä»»åŠ¡å·²å®Œæˆ', 'success');
                          setCompleteTask(null);
                          setOutputLink('');
                          onRefresh?.();
                        } else throw new Error(result.error);
                      } catch (err) {
                        showToast?.('æ“ä½œå¤±è´¥: ' + err.message, 'error');
                      }
                      setIsSubmitting(false);
                    }}
                    disabled={!outputLink.trim() || isSubmitting}
                    className="flex-1 py-2 px-4 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white rounded-xl font-medium transition-colors flex items-center justify-center gap-1"
                  >
                    {isSubmitting ? (
                      <><span className="loading-spinner inline-block w-4 h-4 border-2 border-white/30 border-t-white rounded-full" /> æäº¤ä¸­...</>
                    ) : (
                      <>âœ… ç¡®è®¤å®Œæˆ</>
                    )}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ä¸ªäººä»»åŠ¡è¯¦æƒ…å¼¹çª— */}
          {detailMember && (() => {
            const m = detailMember;
            const mTasks = m.memberTasks || [];
            const today = new Date(); today.setHours(0,0,0,0);
            const completedTasks = mTasks.filter(t => t.status === 'å·²å®Œæˆ');
            const onTimeTasks = completedTasks.filter(t => {
              if (!t.dueDate) return true;
              const due = new Date(t.dueDate); due.setHours(0,0,0,0);
              const comp = t.completeDate ? new Date(t.completeDate) : new Date(); comp.setHours(0,0,0,0);
              return comp <= due;
            });
            const onTimeRate = completedTasks.length > 0 ? Math.round((onTimeTasks.length / completedTasks.length) * 100) : null;
            const overdueTasks = mTasks.filter(t => t.status !== 'å·²å®Œæˆ' && t.dueDate && new Date(t.dueDate) < today);
            const inProgressTasks = mTasks.filter(t => t.status === 'è¿›è¡Œä¸­' && (!t.dueDate || new Date(t.dueDate) >= today));
            const pendingTasks = mTasks.filter(t => t.status !== 'å·²å®Œæˆ' && t.status !== 'è¿›è¡Œä¸­' && (!t.dueDate || new Date(t.dueDate) >= today));
            const doneTasks = mTasks.filter(t => t.status === 'å·²å®Œæˆ');
            const projectDist = {};
            mTasks.forEach(t => {
              const product = products.find(p => p.id === t.productId);
              const pName = product ? product.name : 'æœªåˆ†é…';
              if (!projectDist[pName]) projectDist[pName] = { total:0, completed:0, inProgress:0, pending:0, overdue:0 };
              projectDist[pName].total++;
              if (t.status === 'å·²å®Œæˆ') projectDist[pName].completed++;
              else if (t.status === 'è¿›è¡Œä¸­') projectDist[pName].inProgress++;
              else projectDist[pName].pending++;
              if (t.status !== 'å·²å®Œæˆ' && t.dueDate && new Date(t.dueDate) < today) projectDist[pName].overdue++;
            });
            const projectColors = ['bg-blue-500','bg-purple-500','bg-teal-500','bg-orange-500','bg-pink-500','bg-indigo-500'];
            const heatData = m.dailyLoads || [];
            const heatMax = Math.max(...heatData, 1);
            const TaskRow = ({ task }) => {
              const isOD = task.status !== 'å·²å®Œæˆ' && task.dueDate && new Date(task.dueDate) < today;
              const dLeft = task.dueDate ? Math.ceil((new Date(task.dueDate) - today) / 86400000) : null;
              const urgency = task.status !== 'å·²å®Œæˆ' ? calcTaskUrgencyScore(task, products, objectives, keyResults) : null;
              const taskProduct = products.find(p => p.id === task.productId);
              return (
                <div className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm ${isOD ? 'bg-red-50' : 'hover:bg-gray-50'} transition-colors`}>
                  <span className={`w-2 h-2 rounded-full flex-shrink-0 ${task.status === 'å·²å®Œæˆ' ? 'bg-green-500' : task.status === 'è¿›è¡Œä¸­' ? 'bg-blue-500' : 'bg-gray-300'}`} />
                  {urgency && (
                    <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold flex-shrink-0 ${urgency.composite >= 70 ? 'bg-red-100 text-red-700' : urgency.composite >= 50 ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-500'}`}>
                      {urgency.composite}
                    </span>
                  )}
                  <span className={`px-1.5 py-0.5 text-[10px] font-medium rounded flex-shrink-0 ${task.priority === 'P0' ? 'bg-red-100 text-red-700' : task.priority === 'P1' ? 'bg-orange-100 text-orange-700' : task.priority === 'P2' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-600'}`}>{task.priority || 'P2'}</span>
                  <span className="flex-1 text-gray-800 truncate">{task.name}</span>
                  {taskProduct && <span className="text-[10px] text-purple-600 bg-purple-50 px-1.5 py-0.5 rounded truncate max-w-[120px]">{taskProduct.name}</span>}
                  {task.stage && <span className="text-[10px] text-gray-400 bg-gray-50 px-1.5 py-0.5 rounded">{task.stage}</span>}
                  {task.dueDate && (<span className={`text-xs flex-shrink-0 ${isOD ? 'text-red-600 font-medium' : dLeft !== null && dLeft <= 3 ? 'text-orange-600' : 'text-gray-400'}`}>{isOD ? `é€¾æœŸ${Math.abs(dLeft)}å¤©` : dLeft === 0 ? 'ä»Šå¤©æˆªæ­¢' : dLeft !== null ? `å‰©${dLeft}å¤©` : ''}</span>)}
                </div>
              );
            };
            return (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[60] p-4" onClick={() => setDetailMember(null)}>
                <div className="bg-white rounded-2xl max-w-2xl w-full max-h-[85vh] overflow-hidden shadow-2xl" onClick={e => e.stopPropagation()}>
                  <div className="bg-gradient-to-r from-blue-500 to-indigo-600 text-white p-5">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-4">
                        {m.avatarUrl ? (<img src={m.avatarUrl} className="w-14 h-14 rounded-full border-2 border-white/30" alt="" />) : (<span className={`w-14 h-14 ${m.color} rounded-full flex items-center justify-center text-white text-xl font-bold border-2 border-white/30`}>{m.avatar}</span>)}
                        <div>
                          <h2 className="text-xl font-bold">{m.name}</h2>
                          <div className="text-white/70 text-sm flex items-center gap-2 mt-0.5">
                            {m.position && <span>{m.position}</span>}
                            {m.department && <span>Â· {m.department}</span>}
                            {m.group && <span>Â· {m.group}</span>}
                          </div>
                        </div>
                      </div>
                      <div className="flex items-center gap-3">
                        <div className={`px-3 py-1.5 rounded-full text-sm font-medium ${m.workloadLevel === 'overload' ? 'bg-red-500/30' : m.workloadLevel === 'heavy' ? 'bg-orange-500/30' : m.workloadLevel === 'normal' ? 'bg-blue-500/30' : 'bg-green-500/30'} text-white`}>{m.workloadLabel} Â· å³°å€¼ {m.peakLoad}</div>
                        <button onClick={() => setDetailMember(null)} className="text-white/80 hover:text-white text-2xl">Ã—</button>
                      </div>
                    </div>
                  </div>
                  <div className="p-5 overflow-y-auto max-h-[calc(85vh-100px)]">
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 mb-4 sm:mb-5">
                      <div className="bg-gray-50 rounded-xl p-3 text-center"><div className="text-2xl font-bold text-gray-800">{m.total}</div><div className="text-xs text-gray-500">æ€»ä»»åŠ¡</div></div>
                      <div className="bg-gray-50 rounded-xl p-3 text-center"><div className={`text-2xl font-bold ${onTimeRate === null ? 'text-gray-400' : onTimeRate >= 80 ? 'text-green-600' : onTimeRate >= 50 ? 'text-orange-600' : 'text-red-600'}`}>{onTimeRate !== null ? `${onTimeRate}%` : '-'}</div><div className="text-xs text-gray-500">å‡†æ—¶ç‡</div>{completedTasks.length > 0 && <div className="text-[10px] text-gray-400">{onTimeTasks.length}/{completedTasks.length}</div>}</div>
                      <div className="bg-gray-50 rounded-xl p-3 text-center"><div className={`text-2xl font-bold ${m.workloadColor}`}>{m.workloadIndex}</div><div className="text-xs text-gray-500">æ—¥å‡è´Ÿè·</div></div>
                      <div className={`rounded-xl p-3 text-center ${m.overdue > 0 ? 'bg-red-50' : 'bg-gray-50'}`}><div className={`text-2xl font-bold ${m.overdue > 0 ? 'text-red-600' : 'text-gray-400'}`}>{m.overdue}</div><div className={`text-xs ${m.overdue > 0 ? 'text-red-500' : 'text-gray-500'}`}>é€¾æœŸä»»åŠ¡</div></div>
                    </div>
                    {/* ä»»åŠ¡æ—¶é—´è½´ */}
                    {(() => {
                      const allTasks = [...overdueTasks, ...inProgressTasks, ...pendingTasks, ...doneTasks];
                      if (allTasks.length === 0) return <div className="text-center text-gray-400 py-8">æš‚æ— ä»»åŠ¡</div>;
                      
                      // è®¡ç®—æ—¶é—´èŒƒå›´
                      const allDates = [];
                      allTasks.forEach(t => {
                        if (t.startDate) allDates.push(new Date(t.startDate));
                        if (t.dueDate) allDates.push(new Date(t.dueDate));
                      });
                      allDates.push(new Date(today));
                      const tlStart = new Date(Math.min(...allDates)); tlStart.setHours(0,0,0,0);
                      let tlEnd = new Date(Math.max(...allDates)); tlEnd.setHours(0,0,0,0);
                      // è‡³å°‘æ˜¾ç¤º14å¤©
                      const min14 = new Date(today); min14.setDate(min14.getDate() + 14);
                      if (tlEnd < min14) tlEnd = min14;
                      const totalDays = Math.max(1, Math.ceil((tlEnd - tlStart) / 86400000) + 1);
                      
                      const dayToPos = (d) => {
                        const dt = new Date(d); dt.setHours(0,0,0,0);
                        return Math.max(0, Math.min(100, ((dt - tlStart) / (tlEnd - tlStart)) * 100));
                      };
                      const todayPos = dayToPos(today);
                      
                      // è´Ÿè·çƒ­åŠ›æ¡ï¼ˆé¡¶éƒ¨ï¼‰
                      const loadBars = heatData.slice(0, totalDays).map((load, i) => {
                        const d = new Date(today); d.setDate(d.getDate() + i);
                        const left = dayToPos(d);
                        const w = Math.max(0.5, 100 / totalDays);
                        const c = load <= 0 ? '#e5e7eb' : load <= 2 ? '#4ade80' : load <= 4 ? '#60a5fa' : load <= 6 ? '#fb923c' : '#ef4444';
                        return { left, w, c, load, label: `${d.getMonth()+1}/${d.getDate()}` };
                      });
                      
                      // æ—¥æœŸåˆ»åº¦
                      const ticks = [];
                      for (let i = 0; i <= totalDays; i += Math.max(1, Math.floor(totalDays / 8))) {
                        const d = new Date(tlStart); d.setDate(d.getDate() + i);
                        ticks.push({ pos: dayToPos(d), label: `${d.getMonth()+1}/${d.getDate()}` });
                      }
                      
                      // ä»»åŠ¡æ¡é¢œè‰²
                      const barColor = (t) => {
                        if (t.status === 'å·²å®Œæˆ') return 'bg-green-400';
                        const isOD = t.dueDate && new Date(t.dueDate) < today;
                        if (isOD) return 'bg-red-400';
                        if (t.status === 'è¿›è¡Œä¸­') return 'bg-blue-400';
                        return 'bg-gray-300';
                      };
                      const barBorder = (t) => {
                        if (t.status === 'å·²å®Œæˆ') return 'border-green-500';
                        const isOD = t.dueDate && new Date(t.dueDate) < today;
                        if (isOD) return 'border-red-500';
                        if (t.status === 'è¿›è¡Œä¸­') return 'border-blue-500';
                        return 'border-gray-400';
                      };
                      
                      return (
                        <div className="mb-5">
                          <h4 className="text-sm font-semibold text-gray-700 mb-3"><Icon name="calendar" size={13} /> ä»»åŠ¡æ—¶é—´è½´</h4>
                          <div className="bg-gray-50 rounded-xl p-4 overflow-x-auto">
                            
                            {/* æ—¥æœŸåˆ»åº¦ï¼ˆé¡¶éƒ¨ï¼‰ */}
                            <div className="relative h-5 ml-[120px] mr-[64px] mb-1">
                              {ticks.map((t, i) => (
                                <div key={i} className="absolute text-[9px] text-gray-400 font-medium" style={{ left: `${t.pos}%`, transform: 'translateX(-50%)' }}>{t.label}</div>
                              ))}
                            </div>
                            
                            {/* ä»»åŠ¡ç”˜ç‰¹æ¡ - å¸¦çƒ­åŠ›èƒŒæ™¯ */}
                            <div className="space-y-1">
                              {allTasks.map(t => {
                                const tStart = t.startDate ? new Date(t.startDate) : t.plannedStartDate ? new Date(t.plannedStartDate) : new Date(today);
                                const tEnd = t.dueDate ? new Date(t.dueDate) : new Date(tlEnd);
                                let left = dayToPos(tStart);
                                let right = dayToPos(tEnd);
                                let width = Math.max(1.5, right - left);
                                const isOD = t.status !== 'å·²å®Œæˆ' && t.dueDate && new Date(t.dueDate) < today;
                                const dLeft = t.dueDate ? Math.ceil((new Date(t.dueDate) - today) / 86400000) : null;
                                
                                return (
                                  <div key={t.id} className="flex items-center gap-2 group" style={{ minHeight: '28px' }}>
                                    <div className="w-28 flex-shrink-0 flex items-center gap-1.5 pr-1">
                                      <span className={`px-1 py-0 text-[9px] font-medium rounded ${t.priority === 'P0' ? 'bg-red-100 text-red-700' : t.priority === 'P1' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>{t.priority || 'P2'}</span>
                                      <span className="text-xs text-gray-700 truncate">{t.name}</span>
                                    </div>
                                    <div className="flex-1 relative h-6">
                                      {/* è´Ÿè·çƒ­åŠ›èƒŒæ™¯åˆ— */}
                                      {loadBars.map((b, i) => (
                                        <div key={i} className="absolute top-0 bottom-0" style={{ left: `${b.left}%`, width: `${b.w}%`, backgroundColor: b.c, opacity: 0.15 }} />
                                      ))}
                                      {/* ä»Šå¤©æ ‡è®°çº¿ */}
                                      <div className="absolute top-0 bottom-0 w-[1.5px] bg-red-400 z-10" style={{ left: `${todayPos}%` }} />
                                      {/* ç”˜ç‰¹æ¡ */}
                                      <div className={`absolute top-1 h-4 rounded-full ${barColor(t)} border ${barBorder(t)} ${!t.startDate && t.plannedStartDate ? 'opacity-50 border-dashed' : 'opacity-80'} hover:opacity-100 transition-all cursor-default group z-[5]`} 
                                        style={{ left: `${left}%`, width: `${width}%`, minWidth: '8px' }}>
                                        <div className="absolute bottom-full mb-1 left-1/2 -translate-x-1/2 hidden group-hover:block bg-gray-800 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-20">
                                          {t.name}<br/>
                                          {t.startDate || t.plannedStartDate || 'æœªè®¾ç½®'} ~ {t.dueDate || 'æœªè®¾ç½®'}
                                          {!t.startDate && t.plannedStartDate && <span className="text-yellow-300"> (é¢„è®¡)</span>}
                                          {isOD && <span className="text-red-300"> Â· é€¾æœŸ{Math.abs(dLeft)}å¤©</span>}
                                          {!isOD && dLeft !== null && dLeft >= 0 && <span className="text-green-300"> Â· å‰©{dLeft}å¤©</span>}
                                        </div>
                                      </div>
                                      {/* æˆªæ­¢æ—¥æ ‡è®° */}
                                      {t.dueDate && (
                                        <div className={`absolute top-0 h-6 w-[1.5px] ${isOD ? 'bg-red-500' : 'bg-gray-300'}`} style={{ left: `${dayToPos(t.dueDate)}%` }} />
                                      )}
                                    </div>
                                    <div className="w-16 flex-shrink-0 text-right">
                                      {t.dueDate ? (
                                        <span className={`text-[10px] ${isOD ? 'text-red-600 font-medium' : dLeft !== null && dLeft <= 3 ? 'text-orange-500' : 'text-gray-400'}`}>
                                          {isOD ? `é€¾æœŸ${Math.abs(dLeft)}å¤©` : dLeft === 0 ? 'ä»Šå¤©' : `å‰©${dLeft}å¤©`}
                                        </span>
                                      ) : <span className="text-[10px] text-gray-300">æ— æœŸé™</span>}
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                            
                            {/* å›¾ä¾‹ */}
                            <div className="flex items-center justify-between mt-3 text-[10px] text-gray-400 ml-[120px]">
                              <div className="flex items-center gap-3">
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded bg-red-400" />é€¾æœŸ</span>
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded bg-blue-400" />è¿›è¡Œä¸­</span>
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded bg-gray-300" />å¾…å¼€å§‹</span>
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded bg-green-400" />å·²å®Œæˆ</span>
                              </div>
                              <div className="flex items-center gap-2">
                                <span>èƒŒæ™¯è´Ÿè·:</span>
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded" style={{backgroundColor:'#4ade80',opacity:0.4}} />â‰¤2</span>
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded" style={{backgroundColor:'#60a5fa',opacity:0.4}} />â‰¤4</span>
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded" style={{backgroundColor:'#fb923c',opacity:0.4}} />â‰¤6</span>
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded" style={{backgroundColor:'#ef4444',opacity:0.4}} />&gt;6</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                    
                    {/* é¡¹ç›®åˆ†å¸ƒ */}
                    {Object.keys(projectDist).length > 0 && (<div className="mb-5"><h4 className="text-sm font-semibold text-gray-700 mb-3">é¡¹ç›®åˆ†å¸ƒ</h4><div className="bg-gray-50 rounded-xl p-4"><div className="flex h-3 rounded-full overflow-hidden mb-3">{Object.entries(projectDist).map(([name, data], i) => (<div key={name} className={`${projectColors[i % projectColors.length]} transition-all`} style={{ width: `${(data.total / m.total) * 100}%` }} title={`${name}: ${data.total}é¡¹`} />))}</div><div className="grid grid-cols-2 gap-2">{Object.entries(projectDist).map(([name, data], i) => (<div key={name} className="flex items-center gap-2 text-sm"><span className={`w-2.5 h-2.5 rounded-full ${projectColors[i % projectColors.length]} flex-shrink-0`} /><span className="text-gray-700 truncate flex-1">{name}</span><span className="text-gray-400 text-xs">{data.total}é¡¹</span>{data.overdue > 0 && <span className="text-red-500 text-[10px]">{data.overdue}é€¾æœŸ</span>}<span className="text-xs text-gray-300">{data.completed}/{data.total}</span></div>))}</div></div></div>)}
                  </div>
                </div>
              </div>
            );
          })()}
        </div>
      );
    };


    // ç»Ÿè®¡å¡ç‰‡
    // Unified SVG Icon system - Apple-style line icons
    const Icon = ({ name, size = 16, color = 'currentColor', className = '' }) => {
      const icons = {
        target: <><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>,
        key: <><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.78 7.78 5.5 5.5 0 0 1 7.78-7.78L15 14l2-2 4-4"/><path d="M14 4l3 3"/></>,
        chart: <><path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/></>,
        check: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
        shield: <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></>,
        alert: <><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>,
        building: <><rect x="4" y="2" width="16" height="20" rx="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M8 10h.01"/><path d="M16 10h.01"/><path d="M8 14h.01"/><path d="M16 14h.01"/></>,
        dept: <><path d="M2 7a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2z"/><path d="M12 2v3"/><path d="M2 10h20"/></>,
        user: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
        users: <><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>,
        edit: <><path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></>,
        calendar: <><rect width="18" x="3" y="4" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></>,
        clipboard: <><rect width="8" height="4" x="8" y="2" rx="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></>,
        folder: <><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></>,
        plus: <><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>,
        clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
      };
      return (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round" className={className} style={{display:'inline-block',verticalAlign:'middle',flexShrink:0}}>
          {icons[name] || icons.target}
        </svg>
      );
    };

    const StatIcons = {
      target: (color) => (
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
          <circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/>
        </svg>
      ),
      key: (color) => (
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
          <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.78 7.78 5.5 5.5 0 0 1 7.78-7.78L15 14l2-2 4-4"/><path d="M14 4l3 3"/><path d="M18 8l3-3"/>
        </svg>
      ),
      chart: (color) => (
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
          <path d="M18 20V10"/><path d="M12 20V4"/><path d="M6 20v-6"/>
        </svg>
      ),
      check: (color) => (
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
      ),
      shield: (color) => (
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
      ),
      alert: (color) => (
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      )
    };

    const StatCard = ({ title, value, subtitle, color, iconKey, accent, onClick }) => {
      const iconColors = { purple: '#6c5ce7', blue: '#007aff', indigo: '#5856d6', green: '#34c759', red: '#ff3b30' };
      const iconBg = { purple: '#f0eeff', blue: '#e8f0fe', indigo: '#eeeeff', green: '#e5f8ed', red: '#ffeae8' };
      const ac = accent || 'purple';
      const iconFn = StatIcons[iconKey] || StatIcons.target;
      return (
        <div className={`stat-card ${ac} ${onClick ? 'cursor-pointer hover:shadow-md transition-shadow' : ''}`} onClick={onClick}>
          <div className="flex items-center justify-between">
            <div>
              <div className="text-[11px] font-medium uppercase tracking-wider" style={{color:'var(--c-text-muted)'}}>{title}</div>
              <div className={`text-2xl font-bold mt-1.5 ${color}`}>{value}</div>
              {subtitle && <div className="text-[11px] mt-0.5" style={{color:'var(--c-text-muted)'}}>{subtitle}</div>}
            </div>
            <div className="w-10 h-10 rounded-xl flex items-center justify-center" style={{background: iconBg[ac]}}>
              {iconFn(iconColors[ac])}
            </div>
          </div>
        </div>
      );
    };

    // ä¸»åº”ç”¨
    // ç™»å½•é¡µé¢ç»„ä»¶
    const LoginPage = () => {
      const [loading, setLoading] = useState(false);
      
      const handleLogin = () => {
        setLoading(true);
        window.location.href = getLarkLoginUrl();
      };
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-purple-600 to-blue-500 flex items-center justify-center">
          <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div className="text-center">
              <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gIYSUNDX1BST0ZJTEUAAQEAAAIIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAAGRyWFlaAAABVAAAABRnWFlaAAABaAAAABRiWFlaAAABfAAAABR3dHB0AAABkAAAABRyVFJDAAABpAAAAChnVFJDAAABpAAAAChiVFJDAAABpAAAAChjcHJ0AAABzAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAEYAAAAcAEQAaQBzAHAAbABhAHkAIABQADMAIABHAGEAbQB1AHQAIAB3AGkAdABoACAAcwBSAEcAQgAgAFQAcgBhAG4AcwBmAGUAcgAAWFlaIAAAAAAAAIPfAAA9v////7tYWVogAAAAAAAASr8AALE3AAAKuVhZWiAAAAAAAAAoOAAAEQsAAMi5WFlaIAAAAAAAAPbWAAEAAAAA0y1wYXJhAAAAAAAEAAAAAmZmAADypwAADVkAABPQAAAKWwAAAAAAAAAAbWx1YwAAAAAAAAABAAAADGVuVVMAAAAgAAAAHABHAG8AbwBnAGwAZQAgAEkAbgBjAC4AIAAyADAAMQA2/9sAQwABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEB/9sAQwEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEB/8AAEQgCZgLmAwEiAAIRAQMRAf/EAB8AAQABAwUBAQAAAAAAAAAAAAALAwkKAQIEBQgGB//EADsQAAEEAgIBAwIDBQcEAgMBAAABAgMEBQYHEQgJEiETMQpBURQiYXGBFTKRobHB0RYjJOEXchgl8FL/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8Az+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//Z" className="w-16 h-16 rounded-2xl mx-auto mb-4" style={{background:'white',padding:'4px',boxShadow:'0 4px 20px rgba(108,92,231,0.15)'}} alt="å¾®é“¸" />
              <h1 className="text-2xl font-bold text-gray-800 mb-2">å¾®é“¸é¡¹ç›®ç®¡ç†</h1>
              <p className="text-gray-500 mb-6">ä½¿ç”¨é£ä¹¦è´¦å·ç™»å½•</p>
              
              <button
                onClick={handleLogin}
                disabled={loading}
                className="w-full py-3 px-6 bg-blue-500 hover:bg-blue-600 text-white rounded-xl font-medium transition-colors flex items-center justify-center gap-2 disabled:opacity-50"
              >
                {loading ? (
                  <>
                    <span className="loading-spinner inline-block w-5 h-5 border-2 border-white/30 border-t-white rounded-full" />
                    æ­£åœ¨è·³è½¬...
                  </>
                ) : (
                  <>
                    <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                    </svg>
                    é£ä¹¦ç™»å½•
                  </>
                )}
              </button>
              
              <p className="mt-6 text-xs text-gray-400">
                ç™»å½•åå¯æŸ¥çœ‹å’Œç®¡ç†é¡¹ç›®ä»»åŠ¡
              </p>
            </div>
          </div>
        </div>
      );
    };

    const App = () => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [activeTab, setActiveTab] = useState('okr');
      const [lastUpdate, setLastUpdate] = useState(null);
      const [currentUser, setCurrentUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [showOverduePopup, setShowOverduePopup] = useState(false);
      const [chinaTime, setChinaTime] = useState('');
      const [chinaDate, setChinaDate] = useState('');
      const [weatherInfo, setWeatherInfo] = useState(null);

      // ä¸­å›½æ—¶é—´å®æ—¶æ—¶é’Ÿ
      useEffect(() => {
        const weekDays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
        const updateClock = () => {
          const now = new Date();
          const cn = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
          const h = String(cn.getHours()).padStart(2, '0');
          const m = String(cn.getMinutes()).padStart(2, '0');
          const s = String(cn.getSeconds()).padStart(2, '0');
          setChinaTime(`${h}:${m}:${s}`);
          setChinaDate(`${cn.getFullYear()}å¹´${cn.getMonth()+1}æœˆ${cn.getDate()}æ—¥ å‘¨${weekDays[cn.getDay()]}`);
        };
        updateClock();
        const timer = setInterval(updateClock, 1000);
        return () => clearInterval(timer);
      }, []);

      // è·å–å¤©æ°”ï¼ˆæ·±åœ³ï¼‰
      useEffect(() => {
        const fetchWeather = async () => {
          try {
            const res = await fetch('https://wttr.in/Shenzhen?format=j1&lang=zh');
            const data = await res.json();
            const cur = data.current_condition?.[0];
            if (cur) {
              const weatherDesc = cur.lang_zh?.[0]?.value || cur.weatherDesc?.[0]?.value || '';
              const weatherCode = parseInt(cur.weatherCode || '0');
              let icon = 'â˜€ï¸';
              if (weatherCode >= 176 && weatherCode <= 299) icon = 'ğŸŒ§ï¸';
              else if (weatherCode >= 300 && weatherCode <= 399) icon = 'ğŸŒ¦ï¸';
              else if (weatherCode >= 200 && weatherCode <= 232) icon = 'â›ˆï¸';
              else if (weatherCode === 116) icon = 'â›…';
              else if (weatherCode === 119 || weatherCode === 122) icon = 'â˜ï¸';
              else if (weatherCode === 143 || weatherCode === 248 || weatherCode === 260) icon = 'ğŸŒ«ï¸';
              else if (weatherCode === 113) icon = 'â˜€ï¸';
              setWeatherInfo({
                temp: cur.temp_C,
                feels: cur.FeelsLikeC,
                desc: weatherDesc,
                icon,
                humidity: cur.humidity,
                wind: cur.windspeedKmph
              });
            }
          } catch (e) { /* ignore weather errors */ }
        };
        fetchWeather();
        const wTimer = setInterval(fetchWeather, 30 * 60 * 1000); // 30min refresh
        return () => clearInterval(wTimer);
      }, []);

      // å¤„ç†ç™»å½•çŠ¶æ€
      useEffect(() => {
        const initAuth = async () => {
          // æ£€æŸ¥ URL ä¸­æ˜¯å¦æœ‰ OAuth å›è°ƒçš„ code
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get('code');
          
          if (code) {
            // å¤„ç† OAuth å›è°ƒ
            const user = await handleOAuthCallback(code);
            if (user) {
              setCurrentUser(user);
            }
          } else {
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç™»å½•çŠ¶æ€
            const user = checkLoginStatus();
            setCurrentUser(user);
          }
          setAuthLoading(false);
        };
        
        initAuth();
      }, []);

      const fetchData = async (background = false) => {
        if (!background) {
          setLoading(true);
          setError(null);
        }
        try {
          const res = await fetch(API_BASE + '/api/lark?app_token=' + APP_TOKEN);
          const json = await res.json();
          
          if (json.success) {
            const transformed = transformData(json.data);
            setData(transformed);
            setLastUpdate(new Date().toLocaleTimeString());
          } else {
            throw new Error(json.error || 'æ•°æ®åŠ è½½å¤±è´¥');
          }
        } catch (err) {
          if (!background) setError(err.message);
        }
        if (!background) setLoading(false);
      };

      useEffect(() => {
        if (currentUser) {
          fetchData();
          const interval = setInterval(() => fetchData(true), 5 * 60 * 1000);
          return () => clearInterval(interval);
        }
      }, [currentUser]);

      // è®¤è¯åŠ è½½ä¸­
      if (authLoading) return <LoadingScreen />;
      
      // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
      if (!currentUser) return <LoginPage />;
      
      // æ•°æ®åŠ è½½ä¸­
      if (loading && !data) return <LoadingScreen />;

      // ===== æƒé™ç³»ç»Ÿ =====
      // æ ¹æ®ã€Œæƒé™è®¾ç½®ã€å­—æ®µåˆ¤æ–­è§’è‰²ï¼Œè¿‡æ»¤å¯è§æ•°æ®
      const permissionData = data ? (() => {
        // 1. æ‰¾åˆ°å½“å‰ç™»å½•ç”¨æˆ·åœ¨æˆå‘˜è¡¨ä¸­çš„è®°å½•
        const me = data.members.find(m => 
          m.id === currentUser.open_id || 
          m.name === currentUser.name || 
          m.larkName === currentUser.name
        );
        
        const myPermRole = me?.permRole || 'ç»„å‘˜';
        const myGroup = me?.group || '';
        const myDept = me?.department || '';
        
        // 2. åˆ¤æ–­è§’è‰²å±‚çº§ï¼ˆåŸºäºã€Œæƒé™è®¾ç½®ã€å­—æ®µï¼‰
        const isAdmin = myPermRole === 'ç®¡ç†å‘˜' || myPermRole === 'æ€»ç»ç†';
        const isDeptHead = myPermRole === 'éƒ¨é—¨ç®¡ç†';
        const isGroupHead = myPermRole === 'ç»„åˆ«ç®¡ç†';
        const isRegular = myPermRole === 'ç»„å‘˜';
        
        // 3. ç¡®å®šå¯è§çš„æˆå‘˜IDé›†åˆ
        let visibleMembers;
        let roleName;
        // å…³è”ç»„åˆ«ï¼šäº§å“éƒ¨å¯é¢å¤–çœ‹åˆ°å…³è”è¿è¥ç»„åˆ«çš„é¡¹ç›®+ä»»åŠ¡
        const myLinkedGroups = me?.linkedGroups || [];
        
        if (isAdmin) {
          visibleMembers = new Set(data.members.map(m => m.id));
          roleName = 'ç®¡ç†å‘˜';
        } else if (isDeptHead) {
          // éƒ¨é—¨ç®¡ç†ï¼šèƒ½çœ‹æœ¬éƒ¨é—¨æ‰€æœ‰ç»„åˆ«
          visibleMembers = new Set(
            data.members.filter(m => m.department === myDept).map(m => m.id)
          );
          roleName = 'éƒ¨é—¨ç®¡ç†';
        } else {
          // ç»„åˆ«ç®¡ç† / ç»„å‘˜ï¼šåªèƒ½çœ‹æœ¬ç»„åˆ«
          visibleMembers = new Set(
            data.members.filter(m => m.group === myGroup).map(m => m.id)
          );
          roleName = isGroupHead ? 'ç»„åˆ«ç®¡ç†' : 'ç»„å‘˜';
        }
        
        // 4. å…³è”ç»„åˆ«çš„æˆå‘˜ï¼ˆç”¨äºé¡¹ç›®+ä»»åŠ¡æ‰©å±•å¯è§æ€§ï¼Œä½†ä¸æ‰©å±•äººå‘˜åˆ—è¡¨ï¼‰
        let linkedMemberIds = new Set();
        if (myLinkedGroups.length > 0 && !isAdmin) {
          data.members.forEach(m => {
            if (myLinkedGroups.includes(m.group)) {
              linkedMemberIds.add(m.id);
            }
          });
        }
        
        // 5. è¿‡æ»¤æ•°æ®
        if (isAdmin) {
          // ç®¡ç†å‘˜çœ‹å…¨éƒ¨
          return { ...data, _role: roleName, _scope: 'å…¨å…¬å¸', _isAdmin: true, _isDeptHead: false, _me: me, _linkedGroups: [] };
        }
        
        const filteredMembers = data.members.filter(m => visibleMembers.has(m.id));
        const filteredGroups = [...new Set(filteredMembers.map(m => m.group))].filter(Boolean);
        
        // é¡¹ç›®+ä»»åŠ¡çš„æ‰©å±•å¯è§èŒƒå›´ = æœ¬ç»„å¯è§ + å…³è”ç»„åˆ«
        const extendedVisibleIds = new Set([...visibleMembers, ...linkedMemberIds]);
        const linkedMembers = myLinkedGroups.length > 0 
          ? data.members.filter(m => myLinkedGroups.includes(m.group)) 
          : [];
        
        // è¿‡æ»¤é¡¹ç›®ï¼šè´Ÿè´£äººåœ¨æ‰©å±•å¯è§èŒƒå›´å†…ï¼ˆæœ¬ç»„ + å…³è”ç»„åˆ«ï¼‰
        // åŒæ—¶æ”¯æŒçˆ¶å­é¡¹ç›®ï¼šå­é¡¹ç›®æŒ‰è´Ÿè´£éƒ¨é—¨è¿‡æ»¤ï¼Œçˆ¶é¡¹ç›®åœ¨æœ‰å¯è§å­é¡¹ç›®æ—¶æ˜¾ç¤º
        const directVisibleProducts = new Set();
        data.products.forEach(p => {
          const ownerVisible = extendedVisibleIds.has(p.ownerId) ||
            [...filteredMembers, ...linkedMembers].some(m => m.name === p.ownerName || m.id === p.ownerId);
          // å­é¡¹ç›®æŒ‰è´Ÿè´£éƒ¨é—¨åŒ¹é…
          const deptVisible = p.responsibleDept && p.responsibleDept === myDept;
          if (ownerVisible || deptVisible) directVisibleProducts.add(p.id);
        });
        
        // å¦‚æœèƒ½çœ‹åˆ°å­é¡¹ç›®ï¼Œä¹Ÿè¦èƒ½çœ‹åˆ°å…¶çˆ¶é¡¹ç›®
        data.products.forEach(p => {
          if (directVisibleProducts.has(p.id) && p.parentId) {
            directVisibleProducts.add(p.parentId);
          }
        });
        // å¦‚æœèƒ½çœ‹åˆ°çˆ¶é¡¹ç›®ï¼ˆæœ‰å­é¡¹ç›®çš„ï¼‰ï¼Œä¹Ÿè¦æŠŠå±äºè‡ªå·±éƒ¨é—¨çš„å­é¡¹ç›®åŠ è¿›æ¥
        data.products.forEach(p => {
          if (p.parentId && directVisibleProducts.has(p.parentId)) {
            if (p.responsibleDept === myDept || !p.responsibleDept) {
              directVisibleProducts.add(p.id);
            }
          }
        });
        
        // è¿‡æ»¤ä»»åŠ¡ï¼šè´Ÿè´£äººåœ¨æ‰©å±•å¯è§èŒƒå›´å†… + å±äºå¯è§é¡¹ç›®çš„ä»»åŠ¡ + è‡ªå·±çš„ä»»åŠ¡æ°¸è¿œå¯è§
        const filteredTasks = data.tasks.filter(t => {
          // è‡ªå·±çš„ä»»åŠ¡æ°¸è¿œå¯è§
          if (me && (t.assignee === me.id || t.assigneeName === me.name || t.assigneeName === me.larkName)) return true;
          // å±äºå¯è§é¡¹ç›®çš„ä»»åŠ¡
          if (t.productId && directVisibleProducts.has(t.productId)) return true;
          // è´Ÿè´£äººåœ¨å¯è§èŒƒå›´å†…
          return extendedVisibleIds.has(t.assignee) || 
            [...filteredMembers, ...linkedMembers].some(m => m.name === t.assigneeName);
        });
        
        const filteredProducts = data.products.filter(p => directVisibleProducts.has(p.id));
        
        // è¿‡æ»¤OKRï¼šå…¬å¸çº§éƒ½èƒ½çœ‹ï¼Œå…¶ä»–æŒ‰æƒé™
        const filteredObjectives = data.objectives.filter(o => {
          if (o.level === 'å…¬å¸çº§') return true;
          if (o.level === 'ä¸ªäººçº§') {
            return filteredMembers.some(m => m.name === o.ownerName || m.id === o.ownerId);
          }
          // éƒ¨é—¨çº§
          if (isDeptHead) {
            const deptGroups = data.members.filter(m => m.department === myDept).map(m => m.group);
            return deptGroups.includes(o.department);
          } else {
            return o.department === myGroup;
          }
        });
        
        const filteredObjIds = new Set(filteredObjectives.map(o => o.id));
        const filteredKRs = data.keyResults.filter(kr => filteredObjIds.has(kr.objectiveId));
        
        return {
          ...data,
          members: filteredMembers,
          groups: filteredGroups,
          tasks: filteredTasks,
          products: filteredProducts,
          objectives: filteredObjectives,
          keyResults: filteredKRs,
          _role: roleName,
          _scope: isDeptHead ? myDept : myGroup,
          _isAdmin: false,
          _isDeptHead: isDeptHead,
          _me: me,
          _linkedGroups: myLinkedGroups
        };
      })() : null;

      const stats = permissionData ? (() => {
        // ç›®æ ‡è¾¾æˆ
        const totalObjectives = permissionData.objectives.length;
        const completedObjectives = permissionData.objectives.filter(o => o.status === 'å·²å®Œæˆ').length;
        
        // KR å®Œæˆ
        const totalKRs = permissionData.keyResults.length;
        const completedKRs = permissionData.keyResults.filter(kr => kr.status === 'å·²å®Œæˆ').length;
        
        // é¡¹ç›®å¹³å‡è¿›åº¦ï¼ˆåªç®—é¡¶çº§é¡¹ç›®ï¼Œçˆ¶é¡¹ç›®è‡ªåŠ¨èšåˆå­é¡¹ç›®ï¼‰
        const topLevelProducts = permissionData.products.filter(p => !p.parentId);
        const avgProgress = topLevelProducts.length > 0 
          ? Math.round(topLevelProducts.reduce((sum, p) => {
              return sum + calcProjectProgress(p, permissionData.processNodes, permissionData.templates, permissionData.tasks, permissionData.products);
            }, 0) / topLevelProducts.length) 
          : 0;
        
        // ä»»åŠ¡å®Œæˆ
        const completedTasks = permissionData.tasks.filter(t => t.status === 'å·²å®Œæˆ').length;
        const totalTasks = permissionData.tasks.length;
        
        // é€¾æœŸé¢„è­¦ï¼šå·²è¿‡æœŸä¸”æœªå®Œæˆçš„é¡¹ç›®æ•°ï¼ˆåªçœ‹é¡¶çº§ï¼‰
        const now = new Date();
        const overdueProjects = topLevelProducts.filter(p => {
          const pStatus = calcProjectStatus(p, permissionData.tasks, permissionData.processNodes, permissionData.templates, permissionData.products);
          if (pStatus === 'å·²å®Œæˆ') return false;
          if (!p.targetDate) return false;
          return new Date(p.targetDate) < now;
        }).length;
        
        return {
          totalObjectives, completedObjectives,
          totalKRs, completedKRs,
          avgProgress,
          completedTasks, totalTasks,
          overdueProjects,
          totalProducts: topLevelProducts.length,
          completedProducts: topLevelProducts.filter(p => calcProjectStatus(p, permissionData.tasks, permissionData.processNodes, permissionData.templates, permissionData.products) === 'å·²å®Œæˆ').length
        };
      })() : {};

      return (
        <UserContext.Provider value={currentUser}>
        <div className="min-h-screen bg-gray-50">
          <div className="gradient-bg text-white py-3 px-3 sm:py-4 sm:px-8">
            <div className="max-w-7xl mx-auto flex items-center justify-between gap-2">
              <div className="flex items-center gap-2 sm:gap-3">
                <img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gIYSUNDX1BST0ZJTEUAAQEAAAIIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAAGRyWFlaAAABVAAAABRnWFlaAAABaAAAABRiWFlaAAABfAAAABR3dHB0AAABkAAAABRyVFJDAAABpAAAAChnVFJDAAABpAAAAChiVFJDAAABpAAAAChjcHJ0AAABzAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAEYAAAAcAEQAaQBzAHAAbABhAHkAIABQADMAIABHAGEAbQB1AHQAIAB3AGkAdABoACAAcwBSAEcAQgAgAFQAcgBhAG4AcwBmAGUAcgAAWFlaIAAAAAAAAIPfAAA9v////7tYWVogAAAAAAAASr8AALE3AAAKuVhZWiAAAAAAAAAoOAAAEQsAAMi5WFlaIAAAAAAAAPbWAAEAAAAA0y1wYXJhAAAAAAAEAAAAAmZmAADypwAADVkAABPQAAAKWwAAAAAAAAAAbWx1YwAAAAAAAAABAAAADGVuVVMAAAAgAAAAHABHAG8AbwBnAGwAZQAgAEkAbgBjAC4AIAAyADAAMQA2/9sAQwABAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEB/9sAQwEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEB/8AAEQgCZgLmAwEiAAIRAQMRAf/EAB8AAQABAwUBAQAAAAAAAAAAAAALAwkKAQIEBQgGB//EADsQAAEEAgIBAwIDBQcEAgMBAAABAgMEBQYHEQgJEiETMQpBURQiYXGBFTKRobHB0RYjJOEXchgl8FL/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8Az+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA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AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//Z" className="w-8 h-8 rounded-lg" style={{background:'white',padding:'2px'}} alt="å¾®é“¸" />
                <div>
                  <h1 className="text-lg font-semibold" style={{letterSpacing:"-0.025em"}}>å¾®é“¸é¡¹ç›®ç®¡ç†</h1>
                  <p className="text-white/50 text-[11px]" style={{letterSpacing:"0.01em"}}>é£ä¹¦åŒæ­¥ Â· å®æ—¶æ•°æ®</p>
                </div>
              </div>
              <div className="flex items-center gap-2.5">
                {/* æ—¶é—´ + æ—¥æœŸ + å¤©æ°” ä¸€ä½“åŒ–é¢æ¿ - éšè—åœ¨å°å± */}
                <div className="hidden md:flex items-center bg-white/10 rounded-2xl px-4 py-2 backdrop-blur-md border border-white/15 gap-3">
                  {/* æ—¶é’Ÿ */}
                  <div className="flex flex-col items-end">
                    <span className="text-base font-mono font-bold tracking-widest leading-none" style={{letterSpacing:'0.12em',textShadow:'0 1px 4px rgba(0,0,0,0.2)'}}>{chinaTime || '--:--:--'}</span>
                    <span className="text-[10px] text-white/55 mt-0.5 leading-none">{chinaDate || 'åŠ è½½ä¸­...'}</span>
                  </div>
                  {/* åˆ†éš”çº¿ */}
                  {weatherInfo && <div className="w-px h-9 bg-gradient-to-b from-transparent via-white/25 to-transparent" />}
                  {/* å¤©æ°” */}
                  {weatherInfo && (
                    <div className="flex items-center gap-2 cursor-default" title={`æ·±åœ³ Â· ä½“æ„Ÿ${weatherInfo.feels}Â°C Â· æ¹¿åº¦${weatherInfo.humidity}% Â· é£é€Ÿ${weatherInfo.wind}km/h`}>
                      <span className="text-2xl leading-none" style={{filter:'drop-shadow(0 1px 2px rgba(0,0,0,0.2))'}}>{weatherInfo.icon}</span>
                      <div className="flex flex-col">
                        <div className="flex items-baseline gap-1">
                          <span className="text-sm font-bold leading-none">{weatherInfo.temp}</span>
                          <span className="text-[10px] text-white/50 leading-none">Â°C</span>
                        </div>
                        <span className="text-[10px] text-white/50 leading-none mt-0.5">{weatherInfo.desc} Â· æ·±åœ³</span>
                      </div>
                    </div>
                  )}
                </div>
                
                {/* åˆ·æ–°æŒ‰é’® */}
                <button 
                  onClick={fetchData}
                  className="w-9 h-9 bg-white/10 hover:bg-white/20 active:scale-95 rounded-xl flex items-center justify-center backdrop-blur-md border border-white/15 transition-all hover:shadow-lg hover:shadow-white/5"
                  title={lastUpdate ? `ä¸Šæ¬¡æ›´æ–°: ${lastUpdate}` : 'åˆ·æ–°æ•°æ®'}
                >
                  <span className="text-base">ğŸ”„</span>
                </button>
                
                {/* ç”¨æˆ·ä¿¡æ¯ */}
                <div className="flex items-center gap-2 bg-white/10 rounded-2xl px-3 py-2 backdrop-blur-md border border-white/15">
                  {currentUser.avatar_url ? (
                    <img src={currentUser.avatar_url} className="w-7 h-7 rounded-full ring-2 ring-white/30" alt="" />
                  ) : (
                    <div className="w-7 h-7 rounded-full bg-white/30 flex items-center justify-center text-xs font-bold">
                      {currentUser.name?.charAt(0) || 'ğŸ‘¤'}
                    </div>
                  )}
                  <div className="flex flex-col">
                    <div className="flex items-center gap-1.5">
                      <span className="text-xs font-semibold leading-none">{currentUser.name}</span>
                      {permissionData && (
                        <span className={`text-[8px] px-1.5 py-0.5 rounded-full leading-none font-medium ${
                          permissionData._isAdmin ? 'bg-yellow-400/30 text-yellow-200' :
                          permissionData._isDeptHead ? 'bg-blue-400/30 text-blue-200' :
                          'bg-white/15 text-white/50'
                        }`} title={`æƒé™èŒƒå›´: ${permissionData._scope}`}>
                          {permissionData._role}
                        </span>
                      )}
                    </div>
                    <div className="flex items-center gap-2">
                      {permissionData && !permissionData._isAdmin && (
                        <span className="text-[9px] text-white/35 leading-none mt-0.5">{permissionData._scope}</span>
                      )}
                      <button 
                        onClick={logout}
                        className="text-[10px] text-white/40 hover:text-white/80 leading-none mt-0.5 text-left transition-colors"
                        title="é€€å‡ºç™»å½•"
                      >
                        é€€å‡º
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {error && (
            <div className="max-w-7xl mx-auto px-8 py-2">
              <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-2 rounded-lg text-sm">
                âš ï¸ {error}
              </div>
            </div>
          )}

          {/* æƒé™èŒƒå›´æç¤º */}
          {permissionData && !permissionData._isAdmin && (
            <div className="max-w-7xl mx-auto px-3 sm:px-8 pt-3">
              <div className={`flex flex-wrap items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-2 rounded-lg text-xs sm:text-sm ${
                permissionData._isDeptHead 
                  ? 'bg-blue-50 border border-blue-200 text-blue-700' 
                  : 'bg-gray-50 border border-gray-200 text-gray-600'
              }`}>
                <span>{permissionData._isDeptHead ? 'ğŸ¢' : 'ğŸ‘¥'}</span>
                <span>
                  å½“å‰: <strong>{permissionData._scope}</strong>
                  <span className="hidden sm:inline">
                  {permissionData._isDeptHead 
                    ? ' (éƒ¨é—¨ç®¡ç† - å¯æŸ¥çœ‹éƒ¨é—¨å†…æ‰€æœ‰ç»„åˆ«)' 
                    : permissionData._role === 'ç»„åˆ«ç®¡ç†' 
                      ? ' (ç»„åˆ«ç®¡ç† - å¯æŸ¥çœ‹æœ¬ç»„æ‰€æœ‰æˆå‘˜)' 
                      : ' (ç»„å‘˜ - ä»…æŸ¥çœ‹æœ¬ç»„æ•°æ®)'}
                  </span>
                  {permissionData._linkedGroups?.length > 0 && (
                    <span className="ml-1 hidden sm:inline">
                      Â· å…³è”: <strong>{permissionData._linkedGroups.join('ã€')}</strong>
                    </span>
                  )}
                </span>
                <span className="text-[10px] sm:text-xs ml-auto opacity-60 whitespace-nowrap">
                  {permissionData.members.length}äºº Â· {permissionData.products.length}é¡¹ç›®
                </span>
              </div>
            </div>
          )}

          {permissionData && (
            <div className="max-w-7xl mx-auto px-3 sm:px-8 py-4 sm:py-6">
              <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2.5 sm:gap-4 mb-6">
                <StatCard title="ç›®æ ‡è¾¾æˆ" value={`${stats.completedObjectives}/${stats.totalObjectives}`} subtitle={stats.completedObjectives > 0 ? `${Math.round(stats.completedObjectives/stats.totalObjectives*100)}% è¾¾æˆç‡` : 'æ¨è¿›ä¸­'} color="text-purple-600" iconKey="target" accent="purple" />
                <StatCard title="KR å®Œæˆ" value={`${stats.completedKRs}/${stats.totalKRs}`} subtitle={stats.totalKRs > 0 ? `${Math.round(stats.completedKRs/stats.totalKRs*100)}% å®Œæˆç‡` : 'æš‚æ— '} color="text-blue-600" iconKey="key" accent="blue" />
                <StatCard title="é¡¹ç›®è¿›åº¦" value={`${stats.avgProgress}%`} subtitle={`${stats.totalProducts} ä¸ªé¡¹ç›®`} color="text-indigo-600" iconKey="chart" accent="indigo" />
                <StatCard title="ä»»åŠ¡å®Œæˆ" value={`${stats.completedTasks}/${stats.totalTasks}`} subtitle={stats.totalTasks > 0 ? `${Math.round(stats.completedTasks/stats.totalTasks*100)}% å®Œæˆç‡` : 'æš‚æ— ä»»åŠ¡'} color="text-green-600" iconKey="check" accent="green" />
                <StatCard title="é€¾æœŸé¢„è­¦" value={stats.overdueProjects} subtitle={stats.overdueProjects > 0 ? 'éœ€è¦å…³æ³¨' : 'ä¸€åˆ‡æ­£å¸¸'} color={stats.overdueProjects > 0 ? 'text-red-600' : 'text-green-600'} iconKey={stats.overdueProjects > 0 ? 'alert' : 'shield'} accent={stats.overdueProjects > 0 ? 'red' : 'green'}
                  onClick={stats.overdueProjects > 0 ? () => setShowOverduePopup(true) : undefined}
                />
              </div>

              {/* é€¾æœŸé¡¹ç›®å¼¹çª— */}
              {showOverduePopup && (() => {
                const now = new Date();
                const overdueList = permissionData.products.filter(p => {
                  if (p.parentId) return false; // åªçœ‹é¡¶çº§é¡¹ç›®
                  const pStatus = calcProjectStatus(p, permissionData.tasks, permissionData.processNodes, permissionData.templates, permissionData.products);
                  if (pStatus === 'å·²å®Œæˆ') return false;
                  if (!p.targetDate) return false;
                  return new Date(p.targetDate) < now;
                }).map(p => {
                  const overdueDays = Math.ceil((now - new Date(p.targetDate)) / 86400000);
                  // çˆ¶é¡¹ç›®èšåˆå­é¡¹ç›®ä»»åŠ¡
                  let pTasks;
                  if (p.childIds?.length > 0) {
                    const childIds = permissionData.products.filter(cp => p.childIds.includes(cp.id)).map(cp => cp.id);
                    pTasks = permissionData.tasks.filter(t => childIds.includes(t.productId));
                  } else {
                    pTasks = permissionData.tasks.filter(t => t.productId === p.id);
                  }
                  const completed = pTasks.filter(t => t.status === 'å·²å®Œæˆ').length;
                  const owner = permissionData.members.find(m => m.id === p.ownerId || m.name === p.ownerName);
                  const progress = calcProjectProgress(p, permissionData.processNodes, permissionData.templates, permissionData.tasks, permissionData.products);
                  return { ...p, overdueDays, taskCount: pTasks.length, completedTasks: completed, owner, progress };
                }).sort((a, b) => b.overdueDays - a.overdueDays);
                
                return (
                  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50" onClick={() => setShowOverduePopup(false)}>
                    <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden" onClick={e => e.stopPropagation()}>
                      <div className="bg-gradient-to-r from-red-500 to-orange-500 px-6 py-4 text-white flex items-center justify-between">
                        <div>
                          <div className="font-bold text-lg">é€¾æœŸé¢„è­¦</div>
                          <div className="text-white/80 text-sm">{overdueList.length} ä¸ªé¡¹ç›®å·²é€¾æœŸ</div>
                        </div>
                        <button onClick={() => setShowOverduePopup(false)} className="text-white/80 hover:text-white text-xl">âœ•</button>
                      </div>
                      <div className="p-4 max-h-96 overflow-y-auto space-y-3">
                        {overdueList.map(p => (
                          <div key={p.id} className="border border-red-200 rounded-xl p-3 bg-red-50/50 hover:bg-red-50 cursor-pointer transition-colors"
                            onClick={() => { setShowOverduePopup(false); setActiveTab('products'); setTimeout(() => setSelectedProduct?.(p), 200); }}>
                            <div className="flex items-center justify-between mb-1.5">
                              <span className="font-semibold text-gray-800 text-sm">{p.name}</span>
                              <span className="text-xs font-bold text-red-600 bg-red-100 px-2 py-0.5 rounded-full">
                                é€¾æœŸ {p.overdueDays} å¤©
                              </span>
                            </div>
                            <div className="flex items-center gap-3 text-xs text-gray-500">
                              <span>ğŸ“… è®¡åˆ’: {p.targetDate}</span>
                              <span>ğŸ“‹ {p.completedTasks}/{p.taskCount} ä»»åŠ¡</span>
                              {p.owner && (
                                <span className="flex items-center gap-1">
                                  {p.owner.avatarUrl ? <img src={p.owner.avatarUrl} className="w-4 h-4 rounded-full" alt="" /> : null}
                                  {p.owner.name || p.ownerName}
                                </span>
                              )}
                            </div>
                            {/* è¿›åº¦æ¡ */}
                            <div className="mt-2 h-1.5 bg-red-100 rounded-full overflow-hidden">
                              <div className="h-full bg-red-400 rounded-full" style={{ width: `${p.progress}%` }} />
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                );
              })()}

              <div className="flex gap-1 mb-4 sm:mb-6 p-1 rounded-xl" style={{background:'var(--c-border)'}}>
                {[
                  { key: 'okr', label: 'OKR è§†å›¾', shortLabel: 'OKR', icon: 'target' },
                  { key: 'products', label: 'é¡¹ç›®ç®¡ç†', shortLabel: 'é¡¹ç›®', icon: 'folder' },
                  { key: 'team', label: 'äººå‘˜ä»»åŠ¡', shortLabel: 'å›¢é˜Ÿ', icon: 'users' }
                ].map(tab => (
                  <button
                    key={tab.key}
                    onClick={() => setActiveTab(tab.key)}
                    className={`flex-1 py-2 rounded-lg font-medium text-xs sm:text-sm transition-all ${
                      activeTab === tab.key 
                        ? 'bg-white text-gray-800 shadow-sm' 
                        : 'text-gray-500 hover:text-gray-700'
                    }`}
                  >
                    {<Icon name={tab.icon} size={14} />} <span className="hidden sm:inline">{tab.label}</span><span className="sm:hidden">{tab.shortLabel}</span>
                  </button>
                ))}
              </div>

              {activeTab === 'okr' && (
                <OKROverview
                  objectives={permissionData.objectives}
                  keyResults={permissionData.keyResults}
                  products={permissionData.products}
                  tasks={permissionData.tasks}
                  nodes={permissionData.processNodes}
                  templates={permissionData.templates}
                  members={permissionData.members}
                  onRefresh={fetchData}
                />
              )}

              {activeTab === 'products' && (
                <ProductOverview
                  objectives={permissionData.objectives}
                  keyResults={permissionData.keyResults}
                  products={permissionData.products}
                  nodes={permissionData.processNodes}
                  nodeLayers={permissionData.processNodeLayers}
                  nodeMap={permissionData.nodeMap}
                  nodeToLayer={permissionData.nodeToLayer}
                  templates={permissionData.templates}
                  members={permissionData.members}
                  tasks={permissionData.tasks}
                  onRefresh={fetchData}
                  currentUser={currentUser}
                />
              )}

              {activeTab === 'team' && (
                <TeamTaskOverview
                  members={permissionData.members}
                  tasks={permissionData.tasks}
                  products={permissionData.products}
                  objectives={permissionData.objectives}
                  keyResults={permissionData.keyResults}
                  groups={permissionData.groups}
                  nodes={permissionData.processNodes}
                  templates={permissionData.templates}
                  onRefresh={fetchData}
                />
              )}
            </div>
          )}

          <div className="text-center py-5 text-xs" style={{color:'var(--c-text-muted)'}}>
            é£ä¹¦å¤šç»´è¡¨æ ¼ Â· æ¯5åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥
          </div>
        </div>
        </UserContext.Provider>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(
      <ToastContainer>
        <App />
      </ToastContainer>
    );
  </script>
</body>
</html>
